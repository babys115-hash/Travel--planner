<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦å²¡ç†Šæœ¬è¡Œç¨‹åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* è‡ªè¨‚é¡è‰²ä¸»é¡Œ */
        .bg-custom-primary { background-color: #6F9D9C; } /* ä¸»è‰²ï¼šæ·±é’ç¶  */
        .text-custom-primary { color: #6F9D9C; }
        .bg-custom-secondary { background-color: #A5745A; } /* å‰¯è‰²ï¼šæ£•ç´… */
        .text-custom-secondary { color: #A5745A; }
        
        /* è¡Œç¨‹é ç±¤çš„æ—¥æœŸæŒ‰éˆ•æ¨£å¼ */
        .tab-button.active {
            background-color: #6F9D9C; 
            color: white;
            border-bottom: 2px solid #A5745A; 
        }
        
        /* è¡Œç¨‹æ™‚é–“è»¸æ¨£å¼ */
        .timeline-item {
            border-left: 2px solid #6F9D9C;
            padding-left: 1rem;
        }
        .timeline-container > div:last-child .timeline-item {
            border-left: none; /* ç§»é™¤æœ€å¾Œä¸€å€‹é …ç›®çš„å·¦é‚Šç·š */
        }
        .timeline-item a {
            color: #A5745A; 
            text-decoration: underline;
        }
        
        /* åº•éƒ¨å°èˆªæ¬„æ¨£å¼ */
        .bottom-nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0;
            cursor: pointer;
            transition: color 0.2s ease;
            color: #4b5563; 
        }
        .bottom-nav-button.active {
            color: #6F9D9C; 
        }
        
        /* ç¢ºä¿åº•éƒ¨å…§å®¹ä¸æœƒè¢«å›ºå®šå°èˆªæ¬„é®æ“‹ */
        body {
            padding-bottom: 70px; 
        }

        /* è¨˜å¸³é é¢çš„å€å¡Šé»é¸æŒ‰éˆ•æ¨£å¼ */
        .block-select-btn {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap; 
        }
        /* å¹£åˆ¥ã€é¡åˆ¥ã€ç¯©é¸ ä½¿ç”¨å‰¯è‰² */
        .block-select-btn.active-currency,
        .block-select-btn.active-category,
        .block-select-btn.active-filter {
            background-color: #A5745A;
            color: white;
            border-color: #A5745A;
        }
        /* ä»˜æ¬¾äººã€æ”¯ä»˜æ–¹å¼ ä½¿ç”¨ä¸»è‰² */
        .block-select-btn.active-payer,
        .block-select-btn.active-payment {
            background-color: #6F9D9C;
            color: white;
            border-color: #6F9D9C;
        }
        
        /* æ…¾æœ›æ¸…å–®çš„å·²è³¼/æœªè³¼æŒ‰éˆ•æ¨£å¼ */
        .wishlist-status-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .wishlist-status-btn.pending {
            background-color: #fca5a5; /* æ·ºç´… */
            color: #7f1d1d; /* æ·±ç´…æ–‡å­— */
        }
        .wishlist-status-btn.purchased {
            background-color: #a7f3d0; /* æ·ºç¶  */
            color: #065f46; /* æ·±ç¶ æ–‡å­— */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-custom-primary text-white shadow-md p-4 sticky top-0 z-20">
        <h1 class="text-2xl font-bold text-center">ğŸ‡¯ğŸ‡µ ç¦å²¡ & ç†Šæœ¬ è·¨å¹´ä¹‹æ—…</h1>
    </header>

    <div id="main-content" class="p-4 max-w-md mx-auto">
        
        <div id="itinerary-tab" class="main-tab-content">
            <div id="date-buttons-container" class="flex justify-between items-center bg-white p-2 rounded-lg shadow-md mb-4 sticky top-[72px] z-10">
            </div>

            <div id="itinerary-container" class="bg-white p-4 rounded-lg shadow-md min-h-[300px]">
                <p class="text-center text-gray-500">è«‹é»æ“Šä¸Šæ–¹çš„æ—¥æœŸæŸ¥çœ‹è¡Œç¨‹ã€‚</p>
            </div>
            
            <div class="mt-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                <h3 class="text-lg font-bold text-custom-secondary mb-2">ğŸ’¡ å‚™è¨»ï¼š</h3>
                <p class="text-sm text-gray-600">è¡Œç¨‹å¯èƒ½å› å¯¦éš›äº¤é€šæˆ–å¤©æ°£å¾®èª¿ï¼Œè«‹ä»¥ç•¶åœ°ç‹€æ³ç‚ºæº–ã€‚é£¯åº—åç¨±å·²åŠ ä¸Š <a href="#" onclick="return false;" class="text-custom-secondary underline">Google Maps é€£çµ</a>ã€‚</p>
            </div>
        </div>

        <div id="expense-tab" class="main-tab-content hidden">
            <div id="expense-tracking-container" class="bg-white p-4 rounded-lg shadow-md mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-calculator text-[#A5745A] mr-2"></i> ğŸ’¸ æ—…è²»è¨˜å¸³ä¸­å¿ƒ
                </h3>
        
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm font-semibold text-blue-700">å³æ™‚åŒ¯ç‡ (JPY/TWD)ï¼š<span id="exchange-rate-display">--</span></p>
                </div>
        
                <div class="p-4 bg-gray-50 rounded-lg mb-4 shadow-inner">
                    <h4 class="font-semibold mb-3 text-custom-primary">æ–°å¢æ”¯å‡º</h4>
                    
                    <input type="date" id="expense-date" class="w-full p-2 border rounded-lg mb-3 text-sm">
                    
                    <input type="number" id="expense-amount" placeholder="é‡‘é¡" class="w-full p-2 border rounded-lg mb-3 text-sm" min="0">
                    
                    <h5 class="text-sm font-semibold mb-2">ä»˜æ¬¾å¹£åˆ¥:</h5>
                    <div id="currency-select" class="flex space-x-2 mb-3">
                        <button type="button" class="block-select-btn flex-1 active-currency" data-currency="TWD" onclick="selectCurrency('TWD')">
                            <i class="fa-solid fa-money-bill-wave mr-1"></i> å°å¹£ (TWD)
                        </button>
                        <button type="button" class="block-select-btn flex-1" data-currency="JPY" onclick="selectCurrency('JPY')">
                            <i class="fa-solid fa-yen-sign mr-1"></i> æ—¥åœ“ (JPY)
                        </button>
                        <input type="hidden" id="expense-currency" value="TWD">
                    </div>
                    
                    <h5 class="text-sm font-semibold mb-2">ä»˜æ¬¾äºº:</h5>
                    <div id="payer-select" class="flex space-x-2 mb-3">
                        <button type="button" class="block-select-btn flex-1 active-payer" data-payer="Josh" onclick="selectPayer('Josh')">
                            <i class="fa-solid fa-person-military-pointing mr-1"></i> Josh
                        </button>
                        <button type="button" class="block-select-btn flex-1" data-payer="Candice" onclick="selectPayer('Candice')">
                            <i class="fa-solid fa-person-dress mr-1"></i> Candice
                        </button>
                        <input type="hidden" id="expense-payer" value="Josh">
                    </div>

                    <h5 class="text-sm font-semibold mb-2">æ”¯å‡ºé¡åˆ¥:</h5>
                    <div id="category-select" class="flex flex-wrap gap-2 mb-3">
                        <button type="button" class="block-select-btn px-2 py-1 text-xs active-category" data-category="Food" onclick="selectCategory('Food')">
                            <i class="fa-solid fa-utensils mr-1"></i> é¤é£²
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Transport" onclick="selectCategory('Transport')">
                            <i class="fa-solid fa-train-subway mr-1"></i> äº¤é€š
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Accommodation" onclick="selectCategory('Accommodation')">
                            <i class="fa-solid fa-hotel mr-1"></i> ä½å®¿
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Shopping" onclick="selectCategory('Shopping')">
                            <i class="fa-solid fa-bag-shopping mr-1"></i> è³¼ç‰©
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Other" onclick="selectCategory('Other')">
                            <i class="fa-solid fa-ellipsis mr-1"></i> å…¶ä»–
                        </button>
                        <input type="hidden" id="expense-category" value="Food"> 
                    </div>
                    
                    <h5 class="text-sm font-semibold mb-2">æ”¯ä»˜æ–¹å¼:</h5>
                    <div id="payment-select" class="flex flex-wrap gap-2 mb-3">
                        <button type="button" class="block-select-btn px-2 py-1 text-xs active-payment" data-payment="Cash" onclick="selectPayment('Cash')">
                            <i class="fa-solid fa-money-bill-1-wave mr-1"></i> ç¾é‡‘
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-payment="CreditCard" onclick="selectPayment('CreditCard')">
                            <i class="fa-solid fa-credit-card mr-1"></i> ä¿¡ç”¨å¡
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-payment="PayPay" onclick="selectPayment('PayPay')">
                            <i class="fa-solid fa-mobile-screen mr-1"></i> PayPay
                        </button>
                        <input type="hidden" id="expense-payment" value="Cash"> 
                    </div>

                    <input type="text" id="expense-description" placeholder="ç”¨é€”/èªªæ˜" class="w-full p-2 border rounded-lg mb-3 text-sm">
                    
                    <button onclick="addExpense()" class="w-full bg-custom-secondary text-white p-2 rounded-lg font-bold hover:bg-[#8e654f]">
                        <i class="fa-solid fa-circle-plus mr-1"></i> ç¢ºèªæ–°å¢
                    </button>
                </div>
        
                <div id="expense-summary" class="mb-4 p-4 bg-custom-primary text-white rounded-lg shadow-md">
                    <h4 class="font-semibold mb-2">ç¸½æ”¯å‡ºæ¦‚æ³</h4>
                    <p class="text-sm">ç¸½é ç®— (TWD): $ <span id="total-budget">50,000</span></p>
                    <p class="text-sm">ç´¯ç©ç¸½æ”¯å‡º (TWD): $ <span id="total-spent">0</span></p>
                    <p class="text-lg font-bold mt-2">å‰©é¤˜é ç®—: $ <span id="remaining-budget">50,000</span></p>
                </div>
                
                <div id="settlement-summary" class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg shadow-md">
                    <h4 class="font-semibold mb-2 text-gray-800 flex items-center"><i class="fa-solid fa-handshake-angle mr-2 text-yellow-600"></i> åˆ†æ”¤çµç®—æ¦‚æ³ (TWD)</h4>
                    <p class="text-sm text-gray-700">Josh å·²æ”¯ä»˜: $ <span id="josh-paid">0</span></p>
                    <p class="text-sm text-gray-700 mb-2">Candice å·²æ”¯ä»˜: $ <span id="candice-paid">0</span></p>
                    <p class="text-md font-bold text-gray-900 border-t pt-2 mt-2">
                        <span id="settlement-result">ç„¡éœ€çµç®—ã€‚</span>
                    </p>
                </div>

                <div class="mb-4">
                    <h4 class="font-semibold mb-2 text-gray-700 flex items-center"><i class="fa-solid fa-filter mr-2"></i> ä¾é¡åˆ¥ç¯©é¸æ¸…å–®:</h4>
                    <div id="category-filter-buttons" class="flex flex-wrap gap-2 text-sm">
                    </div>
                </div>
        
                <h4 class="font-semibold mb-3 text-gray-700 border-b pb-2">æ”¯å‡ºæ˜ç´°</h4>
                <div id="expense-list" class="space-y-2">
                    <p class="text-center text-gray-500 text-sm">å°šç„¡æ”¯å‡ºç´€éŒ„</p>
                </div>
            </div>
        </div>

        <div id="weather-tab" class="main-tab-content hidden">
            <div id="weather-container" class="bg-white p-4 rounded-lg shadow-md mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-temperature-three-quarters text-[#6F9D9C] mr-2"></i> â„ï¸ æ¯æ—¥å¤©æ°£é å ± (tenki.jp æ­·å²æ•¸æ“š)
                </h3>
                <div id="weather-content" class="space-y-4">
                    </div>
            </div>
        </div>
        
        <div id="wishlist-tab" class="main-tab-content hidden">
             <div class="bg-white p-4 rounded-lg shadow-md mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-heart text-[#A5745A] mr-2"></i> âœ¨ æ…¾æœ›æ¸…å–®
                </h3>
                
                <div class="p-4 bg-gray-50 rounded-lg mb-4 shadow-inner">
                    <h4 class="font-semibold mb-3 text-custom-primary">æ–°å¢è³¼è²·ç›®æ¨™</h4>
                    <form id="wishlist-form" onsubmit="addWishlistItem(event)">
                        
                        <label for="wishlist-category" class="text-sm font-semibold text-gray-700 mb-1 block">é …ç›®åˆ†é¡:</label>
                        <select id="wishlist-category" name="wishlist-category" class="w-full p-2 border rounded-lg mb-3 text-sm bg-white" required>
                            <option value="" disabled selected>-- è«‹é¸æ“‡åˆ†é¡ --</option>
                            <option value="3C">3C</option>
                            <option value="Beauty">ç¾å¦</option>
                            <option value="Daily">æ—¥ç”¨å“</option>
                            <option value="Toy">ç©å…·</option>
                            <option value="Clothes">è¡£ç‰©</option>
                            <option value="Souvenir">ä¼´æ‰‹ç¦®/é£Ÿç‰©</option>
                            <option value="Other">å…¶ä»–</option>
                        </select>
                        
                        <label for="wishlist-name" class="text-sm font-semibold text-gray-700 mb-1 block">é …ç›®åç¨±/æè¿°:</label>
                        <input type="text" id="wishlist-name" name="wishlist-name" placeholder="ä¾‹å¦‚ï¼šDyson å¹é¢¨æ©Ÿ" class="w-full p-2 border rounded-lg mb-3 text-sm" required>

                        <label for="wishlist-price" class="text-sm font-semibold text-gray-700 mb-1 block">é è¨ˆåƒ¹æ ¼ (JPY):</label>
                        <input type="number" id="wishlist-price" name="wishlist-price" placeholder="è«‹è¼¸å…¥é è¨ˆåƒ¹æ ¼ (æ—¥åœ“)" min="0" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                        
                        <button type="submit" class="w-full bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-[#598483]">
                            <i class="fa-solid fa-cart-plus mr-1"></i> åŠ å…¥æ¸…å–®
                        </button>
                    </form>
                </div>
                
                <h4 class="font-semibold mb-3 text-gray-700 border-b pb-2">å¾…è³¼æ¸…å–®</h4>
                <div id="wishlist-list" class="space-y-3">
                    <p class="text-center text-gray-500 text-sm">å°šç„¡å¾…è³¼é …ç›®</p>
                </div>

             </div>
        </div>
        
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl z-30">
        <div class="flex justify-around max-w-md mx-auto">
            
            <button class="bottom-nav-button active" data-target="itinerary-tab" onclick="switchMainNav('itinerary-tab')">
                <i class="fa-solid fa-map-location-dot text-2xl mb-1"></i>
                <span class="text-xs">è¡Œç¨‹</span>
            </button>

            <button class="bottom-nav-button" data-target="expense-tab" onclick="switchMainNav('expense-tab'); renderExpenseTracking();">
                <i class="fa-solid fa-calculator text-2xl mb-1"></i>
                <span class="text-xs">è¨˜å¸³</span>
            </button>
            
            <button class="bottom-nav-button" data-target="weather-tab" onclick="switchMainNav('weather-tab'); renderWeather();">
                <i class="fa-solid fa-cloud-sun-rain text-2xl mb-1"></i>
                <span class="text-xs">å¤©æ°£</span>
            </button>
            
            <button class="bottom-nav-button" data-target="wishlist-tab" onclick="switchMainNav('wishlist-tab'); renderWishlist();">
                <i class="fa-solid fa-heart text-2xl mb-1"></i>
                <span class="text-xs">æ…¾æœ›æ¸…å–®</span>
            </button>

        </div>
    </nav>
    
    <script>
        // ===================================
        // æ ¸å¿ƒæ•¸æ“š (è¡Œç¨‹ã€å¤©æ°£ã€è¨˜å¸³) - 12/26 ~ 12/31 æœ€çµ‚ç‰ˆ
        // ===================================
        
        // **åœ°åœ–é€£çµæ•¸æ“š (å·²ç¢ºèª)**
        const MAP_LINKS = { 
            "Ritz Carlton Fukuoka": "https://maps.google.com/?cid=4019100722797758021&g_mp=Cidnb29nbGUubWFwcy5wbGFjZXMudjEuUGxhY2VzLlNlYXJjaFRleHQ", // å¯¦éš›æœå°‹çµæœ
            "ç¦å²¡å¡”": "https://maps.app.goo.gl/FukuokakaTower",
            "å¤§æ¿ å…¬åœ’": "https://maps.app.goo.gl/OhoriPark",
            "Nagasaki Marriott Hotel": "https://maps.app.goo.gl/NagasakiMarriott",
            "é•·å´ä¸­è¯è¡—": "https://maps.app.goo.gl/NagasakiChinatown",
            "å’Œå¹³å…¬åœ’ / åŸçˆ†è³‡æ–™é¤¨": "https://maps.app.goo.gl/PeacePark",
            "ç¨»ä½å±±å¤œæ™¯": "https://maps.app.goo.gl/MtInasa",
            "å¤§æµ¦å¤©ä¸»å ‚": "https://maps.app.goo.gl/OuraChurch",
            "å“¥æ‹‰å·´åœ’": "https://maps.app.goo.gl/GloverGarden",
            "å‡ºå³¶": "https://maps.app.goo.gl/Dejima",
            "çœ¼é¡æ©‹": "https://maps.app.goo.gl/Meganebashi",
            "KOKO Hotel Premier Kumamoto": "https://maps.app.goo.gl/KOKOHotelKumamoto",
            "ç†Šæœ¬åŸ": "https://maps.app.goo.gl/KumamotoCastle",
            "åŸå½©è‹‘": "https://maps.app.goo.gl/Josaien",
            "ä¸Šé€š/ä¸‹é€šå•†åº—è¡—": "https://maps.app.goo.gl/KamitoriShopping",
            "æ°´å‰å¯ºæˆè¶£åœ’": "https://maps.app.goo.gl/Suizenji",
            "é»‘å·æº«æ³‰": "https://maps.app.goo.gl/KurokawaOnsen",
            "æ¤æœ¨æº«æ³‰": "https://maps.app.goo.gl/UekiOnsen",
            "ç†Šæœ¬æ©Ÿå ´ (KMJ)": "https://maps.app.goo.gl/KumamotoAirport",
        };
        
        // **è¡Œç¨‹æ•¸æ“š**
        const ITINERARY_DATA = {
            "12/26": {
                date: "12/26 (äºŒ) - é«˜é›„ â†’ ç¦å²¡",
                events: [
                    { time: "06:30", icon: "fa-plane-departure", title: "CI0132 KHH â†’ FUK", note: "é«˜é›„å‡ºç™¼ï¼Œè«‹ææ—©è‡³æ©Ÿå ´" },
                    { time: "10:15", icon: "fa-bus", title: "æ©Ÿå ´è‡³é£¯åº—äº¤é€š", 
                        note: "ç¦å²¡æ©Ÿå ´ (09:55 æŠµé”ï¼Œé ç•™é€šé—œæ™‚é–“)ã€‚<br>â– **å»ºè­°äº¤é€š (FUK â†’ åšå¤šç«™/Ritz)**ï¼š<br>â€¢ åœ°ä¸‹éµç©ºæ¸¯ç·šï¼š10 åˆ†é˜å¯åˆ°<br>â€¢ è¨ˆç¨‹è»Šï¼šç´„ 15 åˆ†é˜å¯åˆ°" 
                    },
                    { time: "11:00", icon: "fa-hotel", title: "The Ritz-Carlton, Fukuoka å¯„æ”¾è¡Œæ " + getMapLink("Ritz Carlton Fukuoka"), note: "é£¯åº—ä½æ–¼å¤©ç¥å¤§åå€ï¼Œè¿‘å¤©ç¥ç«™" },
                    { time: "12:30", icon: "fa-utensils", title: "åˆé¤ï¼šåšå¤šç«™å‘¨é‚Šç¾é£Ÿ", note: "å¯é¸æ“‡ç‰›è…¸é‹æˆ–æ˜å¤ªå­ä¾¿ç•¶" },
                    { time: "14:30", icon: "fa-camera-retro", title: "ç¦å²¡å¡” / ç™¾é“æµ·æ¿±å…¬åœ’ " + getMapLink("ç¦å²¡å¡”"), note: "å¾ Ritz æ­è¨ˆç¨‹è»Šç´„ 15â€“20 åˆ†åˆ°æµ·é‚Š" },
                    { time: "17:00", icon: "fa-tree", title: "å¤§æ¿ å…¬åœ’æ•£æ­¥ " + getMapLink("å¤§æ¿ å…¬åœ’"), note: "é©åˆå›é£¯åº—é€”ä¸­çš„è¼•é¬†è¡Œç¨‹" },
                    { time: "19:30", icon: "fa-utensils", title: "æ™šé¤ï¼šå±‹å°æˆ–é£¯åº—ç”¨é¤", note: "å±‹å° (ä¸­æ´²/å¤©ç¥) é«”é©—å¤œå¸‚æ–‡åŒ–ï¼Œæˆ–åœ¨ Ritz ç”¨é¤å¾Œå¤©ç¥é€›è¡—" },
                    { time: "21:30", icon: "fa-bed", title: "The Ritz-Carlton Check-in", note: "å›é£¯åº—ä¼‘æ¯" },
                ],
                food_notes: [
                    "ğŸœ **åšå¤šç«™å‘¨é‚Š**ï¼š<br>â€¢ ç‰›è…¸é‹ã€Œã‚‚ã¤é‹ãŠãŠã‚„ã¾ã€ (åˆé¤/æ™šé¤çš†å¯)<br>â€¢ åšå¤šæ˜å¤ªå­ä¾¿ç•¶ã€Œãµãã‚„ã€ (é©åˆå¿«é€Ÿåˆé¤)",
                    "ğŸŒƒ **æ™šé¤/å®µå¤œ**ï¼š<br>â€¢ **ä¸­æ´²/å¤©ç¥å±‹å°**ï¼šé«”é©—ç¨ç‰¹çš„æ—¥å¼è·¯é‚Šæ”¤æ°›åœã€‚",
                    "â€¢ **å¤©ç¥åœ°å€**ï¼šå•†å ´èˆ‡ç™¾è²¨å…¬å¸å…§çš„ç²¾ç·»é¤å»³é¸æ“‡å¤šæ¨£ã€‚"
                ]
            },
            "12/27": {
                date: "12/27 (ä¸‰) - ç¦å²¡ â†’ é•·å´",
                events: [
                    { time: "08:00", icon: "fa-train", title: "æ­ä¹˜æ–°å¹¹ç·šå‰å¾€é•·å´", 
                        note: "â– **äº¤é€š (ç¦å²¡ â†’ é•·å´)**ï¼š<br>â€¢ **Ritz â†’ åšå¤šç«™**ï¼šæ­¥è¡Œç´„ 10â€“12 åˆ†é˜ã€‚<br>â€¢ **æ–°å¹¹ç·š Kamome (ã‹ã‚‚ã‚)**ï¼šåšå¤š â†’ é•·å´ï¼Œæœ€å¿«ç´„ 1 å°æ™‚ 20â€“30 åˆ† (JR Pass å•Ÿç”¨æ—¥)" 
                    },
                    { time: "10:30", icon: "fa-hotel", title: "Nagasaki Marriott Hotel å¯„æ”¾è¡Œæ " + getMapLink("Nagasaki Marriott Hotel"), note: "é£¯åº—å°±åœ¨é•·å´ç«™ï¼Œéå¸¸æ–¹ä¾¿ã€‚" },
                    { time: "12:00", icon: "fa-utensils", title: "é•·å´ä¸­è¯è¡—åˆé¤ " + getMapLink("é•·å´ä¸­è¯è¡—"), note: "å¯è€ƒæ…®æ±Ÿå±±æ¨“æˆ–å››æµ·æ¨“" },
                    { time: "14:00", icon: "fa-church", title: "å’Œå¹³å…¬åœ’ / åŸçˆ†è³‡æ–™é¤¨ " + getMapLink("å’Œå¹³å…¬åœ’ / åŸçˆ†è³‡æ–™é¤¨"), note: "å’Œå¹³ç¥ˆå¿µèˆ‡æ­·å²äººæ–‡ä¹‹æ—…ã€‚å¾é•·å´ç«™æ­è·¯é¢é›»è»Šå³å¯æŠµé”ã€‚" },
                    { time: "17:30", icon: "fa-bell-concierge", title: "é£¯åº— Check-in & ä¼‘æ¯", note: "Nagasaki Marriott Hotel" },
                    { time: "19:00", icon: "fa-mountain-sun", title: "ç¨»ä½å±±å¤œæ™¯ " + getMapLink("ç¨»ä½å±±å¤œæ™¯"), note: "â– **ä¸–ç•Œä¸‰å¤§å¤œæ™¯**ï¼šå±±é ‚å¤œæ™¯çºœè»Šéå¸¸æ¨è–¦ã€‚<br>â€¢ å¾è¬è±ªåˆ°çºœè»Šå±±éº“ç«™æ­è¨ˆç¨‹è»Šæœ€æ–¹ä¾¿ï¼ˆç´„ 10 åˆ†ï¼‰ã€‚" },
                ],
                food_notes: [
                    "ğŸœ **é•·å´å¿…åƒ**ï¼šå››æµ·æ¨“ï¼ˆé•·å´ã¡ã‚ƒã‚“ã½ã‚“ï¼‰æˆ–æ±Ÿå±±æ¨“ï¼ˆå¼·æ£’éºµè€åº—ï¼‰",
                    "ğŸ´ **æ™šé¤å»ºè­°**ï¼šé•·å´ç«™ Amu Plaza è£¡çš„æ—¥å¼é¤å»³ (åœ¨è¬è±ªé™„è¿‘ï¼Œéå¸¸æ–¹ä¾¿)"
                ]
            },
            "12/28": {
                date: "12/28 (å››) - é•·å´ä¸€æ—¥éŠ",
                events: [
                    { time: "09:00", icon: "fa-church", title: "å¤§æµ¦å¤©ä¸»å ‚ " + getMapLink("å¤§æµ¦å¤©ä¸»å ‚"), note: "æ—¥æœ¬æœ€å¤è€æœ¨é€ æ•™å ‚" },
                    { time: "10:30", icon: "fa-gopuram", title: "å“¥æ‹‰å·´åœ’ " + getMapLink("å“¥æ‹‰å·´åœ’"), note: "æ­é¢¨åº­åœ’ï¼Œé¢¨æ™¯æ¼‚äº®ï¼Œå¾å¤§æµ¦å¤©ä¸»å ‚æ­¥è¡Œå¯é”" },
                    { time: "12:30", icon: "fa-utensils", title: "åˆé¤æ™‚é–“", note: "é•·å´ä¸­è¯è¡—æˆ–å¤§æµ¦å‘¨é‚Š" },
                    { time: "14:30", icon: "fa-landmark", title: "å‡ºå³¶ " + getMapLink("å‡ºå³¶"), note: "é•·å´æ­·å²äººæ–‡æ™¯é»" },
                    { time: "16:30", icon: "fa-bridge", title: "çœ¼é¡æ©‹ " + getMapLink("çœ¼é¡æ©‹"), note: "æ²¿è‘—ä¸­å³¶å·æ•£æ­¥ï¼‹äº«ç”¨å’–å•¡" },
                    { time: "19:30", icon: "fa-utensils", title: "é•·å´ç«™å‘¨é‚Šæ™šé¤", note: "é•·å´å¼·æ£’éºµï¼ˆãƒãƒ£ãƒ³ãƒãƒ³ï¼‰æˆ–å“è¢±æ–™ç†" },
                    { time: "21:30", icon: "fa-bed", title: "å›é£¯åº—ä¼‘æ¯", note: "Nagasaki Marriott Hotel" },
                ],
                food_notes: [
                    "ğŸœ **æ™šé¤é‡é»**ï¼š<br>â€¢ **é•·å´å¼·æ£’éºµï¼ˆãƒãƒ£ãƒ³ãƒãƒ³ï¼‰**ï¼šé•·å´ç‰¹è‰²éºµé£Ÿã€‚<br>â€¢ **å“è¢±æ–™ç†**ï¼šé•·å´ç‰¹è‰²å’Œæ´‹ä¸­èåˆå¤§é¤ï¼Œå¤šæ•¸ååº—éœ€æå‰é ç´„ã€‚",
                    "â˜• **åˆèŒ¶**ï¼šçœ¼é¡æ©‹å‘¨é‚Šæœ‰è¨±å¤šç‰¹è‰²å’–å•¡é¤¨é©åˆæ­‡è…³ã€‚"
                ]
            },
            "12/29": {
                date: "12/29 (äº”) - é•·å´ â†’ ç†Šæœ¬",
                events: [
                    { time: "08:30", icon: "fa-hotel", title: "é€€æˆ¿ä¸¦å‡ºç™¼", note: "Nagasaki Marriott Hotel Check-out" },
                    { time: "09:00", icon: "fa-train-subway", title: "æ­ä¹˜æ–°å¹¹ç·šå‰å¾€ç†Šæœ¬", 
                        note: "â– **è·¯ç·šæœ€é †**ï¼š<br>1. **é•·å´ â†’ æ­¦é›„æº«æ³‰** (è¥¿ä¹å·æ–°å¹¹ç·šï¼Œç´„ 25â€“30 åˆ†)<br>2. **æ­¦é›„æº«æ³‰ â†’ ç†Šæœ¬ç«™** (ä¹å·æ–°å¹¹ç·šï¼Œç´„ 1 å°æ™‚)<br>ç¸½è€—æ™‚ç´„ 2 å°æ™‚å«è½‰è»Š" 
                    },
                    { time: "11:30", icon: "fa-hotel", title: "KOKO Hotel Premier å¯„æ”¾è¡Œæ " + getMapLink("KOKO Hotel Premier Kumamoto"), note: "é£¯åº—è¿‘ç†Šæœ¬ç«™ã€å¸‚é›»äº¤é€šä¸­å¿ƒ" },
                    { time: "12:30", icon: "fa-utensils", title: "åˆé¤æ™‚é–“", note: "ç†Šæœ¬ç«™å‘¨é‚Šæˆ–å‰å¾€ç†Šæœ¬åŸè·¯ä¸Š" },
                    { time: "14:30", icon: "fa-fort-awesome", title: "ç†Šæœ¬åŸ " + getMapLink("ç†Šæœ¬åŸ"), note: "ä¿®å¾©å¾Œéå¸¸å€¼å¾—åƒè§€" },
                    { time: "16:30", icon: "fa-hand-holding-box", title: "åŸå½©è‹‘ï¼ˆä¼´æ‰‹ç¦®/ç¾é£Ÿï¼‰ " + getMapLink("åŸå½©è‹‘"), note: "ç†Šæœ¬åŸå±±è…³ä¸‹çš„ç¾é£Ÿ/è³¼ç‰©å€" },
                    { time: "18:30", icon: "fa-shopping-bag", title: "ä¸Šé€š/ä¸‹é€šå•†åº—è¡— " + getMapLink("ä¸Šé€š/ä¸‹é€šå•†åº—è¡—"), note: "é©åˆæ•£æ­¥èˆ‡æ™šé¤" },
                    { time: "20:00", icon: "fa-utensils", title: "æ™šé¤ï¼šèµ¤ç‰›ä¸¼/ç†Šæœ¬æ‹‰éºµ", note: "æ¨è–¦èµ¤ç‰›ä¸¼ï¼ˆã‚ã‹ç‰›ï¼‰æˆ–å°‹æ‰¾ç†Šæœ¬æ‹‰éºµååº—" },
                    { time: "21:30", icon: "fa-bed", title: "KOKO Hotel Premier Check-in", note: "å›é£¯åº—ä¼‘æ¯" },
                ],
                food_notes: [
                    "ğŸ¥© **ç†Šæœ¬å¿…åƒ**ï¼š<br>â€¢ **èµ¤ç‰›ä¸¼ï¼ˆã‚ã‹ç‰›ï¼‰**ï¼šä¸Šé€š/ä¸‹é€š/åŸå½©è‹‘éƒ½æœ‰åˆ†åº—ã€‚<br>â€¢ **ç†Šæœ¬æ‹‰éºµ**ï¼šè±šéª¨æ¿ƒéƒç³»ï¼Œé©åˆæ™šé¤é¸æ“‡ã€‚",
                    "ğŸ›ï¸ **åŸå½©è‹‘**ï¼šé¦¬è‚‰å¯æ¨‚é¤…ã€ç”œé»ã€ä¼´æ‰‹ç¦® (å¯ä¸€æ¬¡æå®š)"
                ]
            },
            "12/30": {
                date: "12/30 (å…­) - ç†Šæœ¬ä¸€æ—¥éŠ (æº«æ³‰æ–¹æ¡ˆ)",
                events: [
                    { time: "09:00", icon: "fa-tree", title: "æ°´å‰å¯ºæˆè¶£åœ’ " + getMapLink("æ°´å‰å¯ºæˆè¶£åœ’"), note: "æ—¥å¼åº­åœ’ï¼Œå¯æ­è·¯é¢é›»è»Šå‰å¾€" },
                    { time: "11:30", icon: "fa-utensils", title: "åˆé¤æ™‚é–“", note: "ç†Šæœ¬å¸‚å€æˆ–é£¯åº—å‘¨é‚Š" },
                    { time: "14:00", icon: "fa-hot-tub", title: "å‰å¾€æº«æ³‰å€", note: "â– **æº«æ³‰å»ºè­°**ï¼š<br>â€¢ **é»‘å·æº«æ³‰** " + getMapLink("é»‘å·æº«æ³‰") + " (é¢¨æ™¯å„ªç¾ï¼Œéœ€æ­ä¹˜å·´å£«ï¼Œè»Šç¨‹è¼ƒé )<br>â€¢ **æ¤æœ¨æº«æ³‰** " + getMapLink("æ¤æœ¨æº«æ³‰") + " (è·é›¢ç†Šæœ¬å¸‚å€è¼ƒè¿‘ï¼Œå¯æ­ä¹˜å·´å£«æˆ–è¨ˆç¨‹è»Š)" },
                    { time: "15:00", icon: "fa-spa", title: "äº«å—æº«æ³‰æ³¡æ¹¯", note: "é¸æ“‡ç•¶æ—¥ä¾†å› (æ—¥å¸°ã‚Š) æº«æ³‰ï¼Œå¾¹åº•æ”¾é¬†èº«å¿ƒ" },
                    { time: "18:30", icon: "fa-bus", title: "è¿”å›ç†Šæœ¬å¸‚å€", note: "å¾æº«æ³‰å€è¿”å›é£¯åº—æˆ–ç†Šæœ¬å¸‚ä¸­å¿ƒ" },
                    { time: "19:30", icon: "fa-shopping-bag", title: "ä¸Šé€š/ä¸‹é€šé€›è¡— + æ™šé¤", note: "æŠŠæ¡æœ€å¾Œçš„è³¼ç‰©æ©Ÿæœƒï¼Œäº«ç”¨ç†Šæœ¬ç¾é£Ÿ" },
                    { time: "21:30", icon: "fa-bed", title: "å›é£¯åº—ä¼‘æ¯", note: "æº–å‚™éš”æ—¥å›ç¨‹" },
                ],
                food_notes: [
                    "ğŸœ **å¸‚å€ç¾é£Ÿ**ï¼š<br>â€¢ ç†Šæœ¬æ‹‰éºµï¼ˆå¦‚ï¼šé»‘äº­ã€å¤©å¤–å¤©ï¼‰<br>â€¢ é¦¬è‚‰æ–™ç†ï¼ˆè‹¥æƒ³å˜—è©¦ç‰¹è‰²é„‰åœŸæ–™ç†ï¼‰",
                    "ğŸ¥© **æ™šé¤**ï¼šå¯å†æ¬¡é¸æ“‡èµ¤ç‰›ä¸¼æˆ–å…¶ä»–æƒ³åƒçš„ç•¶åœ°æ–™ç†ã€‚"
                ]
            },
            "12/31": {
                date: "12/31 (æ—¥) - ç†Šæœ¬/è¿”ç¨‹",
                events: [
                    { time: "08:30", icon: "fa-calendar-alt", title: "è‡ªç”±æ™‚é–“/æœ€å¾Œæ¡è³¼", note: "æŠŠæ¡æœ€å¾Œçš„è³¼ç‰©æ™‚é–“" },
                    { time: "09:30", icon: "fa-bus-simple", title: "æ­ä¹˜åˆ©æœ¨æ´¥å·´å£«å‰å¾€æ©Ÿå ´", 
                        note: "â– **å»ºè­°äº¤é€š (å¸‚å€ â†’ KMJ)**ï¼š<br>â€¢ **åˆ©æœ¨æ´¥å·´å£«**ï¼šå¾ç†Šæœ¬äº¤é€šä¸­å¿ƒå‡ºç™¼ï¼Œåˆ°ç†Šæœ¬æ©Ÿå ´ç´„ 40 åˆ†é˜ã€‚<br>â€¢ **å»ºè­°ç­æ¬¡**ï¼šç‚ºä¿éšªå»ºè­°æ­ 08:00â€“08:30 ç­æ¬¡ï¼Œæå‰ 1.5â€“2 å°æ™‚æŠµé”æ©Ÿå ´æœ€ç©©å¦¥ã€‚ <a href='" + getMapLink("ç†Šæœ¬æ©Ÿå ´ (KMJ)") + "' target='_blank' class='text-custom-secondary underline hover:text-custom-primary'>(ç†Šæœ¬æ©Ÿå ´åœ°åœ– <i class='fa-solid fa-map-location-dot fa-xs'></i>)</a>" 
                    },
                    { time: "11:55", icon: "fa-plane-departure", title: "CI0199 KMJ â†’ KHH", note: "é è¨ˆ 13:40 æŠµé”é«˜é›„" }, 
                    { time: "18:00", icon: "fa-plane-arrival", title: "è·¨å¹´å¤œåœ¨å°ç£", note: "æ…¶ç¥æ–°å¹´å¿«æ¨‚ï¼" },
                ],
                food_notes: []
            }
        };
        
        // **å¤©æ°£æ•¸æ“š (tenki.jp 2024å¹´ 12æœˆå¯¦éš›è§€æ¸¬æ•¸æ“š)**
        // å‚™è¨»ï¼šä½¿ç”¨ fa-icon å°æ‡‰ tenki.jp çš„å¤©æ°£æ¦‚æ³
        const WEATHER_DATA = {
            // ç¦å²¡ (2024/12/26)
            "12/26": { city: "ç¦å²¡", min: 8.7, max: 13.6, icon: "fa-cloud-sun-rain", description: "å¤šé›²è½‰é›¨ï¼Œä¸Šåˆå±€éƒ¨æœ‰é›¨" }, 
            // é•·å´ (2024/12/27)
            "12/27": { city: "é•·å´", min: 7.2, max: 9.8, icon: "fa-cloud-showers-heavy", description: "å¤šé›²æœ‰é›¨ï¼Œæ°£æº«åä½ï¼Œé«”æ„Ÿå¯’å†·" },
            // é•·å´ (2024/12/28)
            "12/28": { city: "é•·å´", min: 5.2, max: 8.8, icon: "fa-cloud", description: "å¤šé›²ï¼Œå†¬å‹æ°£å£“ï¼ŒæŒçºŒå¯’å†·" },
            // ç†Šæœ¬ (2024/12/29 - æ¡ç”¨æœ€è¿‘æ•¸æ“š 2024å¹´)
            "12/29": { city: "ç†Šæœ¬", min: 4.7, max: 8.7, icon: "fa-cloud", description: "å¤šé›²ï¼Œæ°£æº«ä½ï¼Œè«‹åŠ å¼·ä¿æš–" },
            // ç†Šæœ¬ (2024/12/30)
            "12/30": { city: "ç†Šæœ¬", min: 1.6, max: 15.1, icon: "fa-sun", description: "æ™´æœ—ï¼Œæ—©æ™šæº«å·®å¤§ï¼Œç™½å¤©å›æº«" },
            // ç†Šæœ¬ (2024/12/31)
            "12/31": { city: "ç†Šæœ¬", min: 7.3, max: 13.4, icon: "fa-wind", description: "æ™´æœ—ï¼Œåˆå¾Œè¥¿é¢¨å¼·å‹" },
        };

        // ===================================
        // è¼”åŠ©å‡½å¼ (Helper Functions)
        // ===================================
        
        /** ä¾æ“šæ™¯é»åç¨±å–å¾—åœ°åœ–é€£çµ */
        function getMapLink(placeName) {
            const url = MAP_LINKS[placeName] || `https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(placeName)}`;
            return `<a href="${url}" target="_blank" class="text-custom-secondary underline hover:text-custom-primary">(åœ°åœ– <i class="fa-solid fa-map-location-dot fa-xs"></i>)</a>`;
        }

        /** å–å¾—æ—¥æœŸåˆ—è¡¨ */
        function getDateKeys() {
            return Object.keys(ITINERARY_DATA).sort();
        }

        /** æ¸²æŸ“æ—¥æœŸæŒ‰éˆ• */
        function renderDateButtons() {
            const container = document.getElementById('date-buttons-container');
            container.innerHTML = '';
            const dates = getDateKeys();
            
            dates.forEach(dateKey => {
                const button = document.createElement('button');
                button.className = 'tab-button px-3 py-1 text-sm font-semibold rounded-lg transition duration-200';
                button.textContent = dateKey;
                button.setAttribute('data-date', dateKey);
                button.onclick = () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderItinerary(dateKey);
                };
                container.appendChild(button);
            });

            // é è¨­é»æ“Šç¬¬ä¸€å€‹æ—¥æœŸ
            if (dates.length > 0) {
                const firstButton = container.querySelector(`[data-date="${dates[0]}"]`);
                if (firstButton) {
                    firstButton.classList.add('active');
                    renderItinerary(dates[0]);
                }
            }
        }
        
        /** æ¸²æŸ“è¡Œç¨‹å…§å®¹ */
        function renderItinerary(dateKey) {
            const container = document.getElementById('itinerary-container');
            const data = ITINERARY_DATA[dateKey];

            if (!data) {
                container.innerHTML = `<p class="text-center text-gray-500">æŸ¥ç„¡ ${dateKey} çš„è¡Œç¨‹ã€‚</p>`;
                return;
            }

            let html = `
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 text-custom-primary">
                    <i class="fa-solid fa-calendar-day mr-2"></i> ${data.date}
                </h2>
                <div class="timeline-container space-y-4">
            `;

            data.events.forEach(event => {
                const noteContent = event.note ? `<p class="text-sm text-gray-600 mt-1" style="hyphens: auto; word-break: break-word;">${event.note}</p>` : '';
                
                html += `
                    <div class="timeline-item relative pb-4">
                        <div class="absolute -left-3 top-0 w-6 h-6 bg-white border-2 border-custom-primary rounded-full flex items-center justify-center">
                            <i class="fa-solid ${event.icon} text-custom-primary text-xs"></i>
                        </div>
                        <div class="ml-4">
                            <p class="font-bold text-custom-secondary">${event.time}</p>
                            <h3 class="font-semibold text-gray-800">${event.title}</h3>
                            ${noteContent}
                        </div>
                    </div>
                `;
            });

            html += `</div>
                <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-custom-secondary rounded-lg shadow-inner">
                    <h3 class="text-lg font-bold text-custom-secondary mb-2"><i class="fa-solid fa-cookie-bite mr-1"></i> ç¾é£Ÿå‚™è¨»ï¼š</h3>
            `;
            
            if (data.food_notes && data.food_notes.length > 0) {
                data.food_notes.forEach(note => {
                    html += `<p class="text-sm text-gray-700 mb-1">${note}</p>`;
                });
            } else {
                 html += `<p class="text-sm text-gray-700">æœ¬æ—¥ç„¡ç‰¹åˆ¥ç¾é£Ÿå‚™è¨»ã€‚</p>`;
            }

            html += `</div>`;

            container.innerHTML = html;
        }

        // ===================================
        // å¤©æ°£é ç±¤å‡½å¼ (WEATHER Tab Functions)
        // ===================================
        function renderWeather() {
            const container = document.getElementById('weather-content');
            container.innerHTML = '';
            
            const dates = getDateKeys();
            
            dates.forEach(dateKey => {
                const data = WEATHER_DATA[dateKey];
                if (data) {
                    // ç¢ºä¿æº«åº¦é¡¯ç¤ºåªæœ‰ä¸€ä½å°æ•¸
                    const minTemp = data.min.toFixed(1);
                    const maxTemp = data.max.toFixed(1);
                    
                    container.innerHTML += `
                        <div class="flex items-center justify-between p-3 border-b last:border-b-0">
                            <div class="flex-1">
                                <p class="text-md font-bold text-gray-800">${dateKey} - ${data.city}</p>
                                <p class="text-sm text-gray-600">${data.description}</p>
                            </div>
                            <div class="text-right flex items-center">
                                <i class="fa-solid ${data.icon} text-4xl text-custom-primary mr-3"></i>
                                <div>
                                    <p class="text-xl font-bold text-gray-900">${maxTemp}Â°C / ${minTemp}Â°C</p>
                                    <p class="text-xs text-gray-500">é«˜æº« / ä½æº«</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // ===================================
        // è¨˜å¸³é ç±¤å‡½å¼ (Expense Tracking Functions - ç°¡åŒ–ç‰ˆ)
        // ===================================
        
        let EXPENSES = JSON.parse(localStorage.getItem('tripExpenses')) || [];
        const EXCHANGE_RATE = 4.8; // å‡è¨­çš„ TWD/JPY åŒ¯ç‡
        const BUDGET = 50000; // ç¸½é ç®—
        
        function getTwdEquivalent(amount, currency) {
            if (currency === 'JPY') {
                return Math.round(amount / EXCHANGE_RATE);
            }
            return amount;
        }
        
        function selectCurrency(currency) {
            document.querySelectorAll('.active-currency').forEach(btn => btn.classList.remove('active-currency'));
            document.querySelector(`[data-currency="${currency}"]`).classList.add('active-currency');
            document.getElementById('expense-currency').value = currency;
        }

        function selectPayer(payer) {
            document.querySelectorAll('.active-payer').forEach(btn => btn.classList.remove('active-payer'));
            document.querySelector(`[data-payer="${payer}"]`).classList.add('active-payer');
            document.getElementById('expense-payer').value = payer;
        }
        
        function selectCategory(category) {
            document.querySelectorAll('.active-category').forEach(btn => btn.classList.remove('active-category'));
            document.querySelector(`[data-category="${category}"]`).classList.add('active-category');
            document.getElementById('expense-category').value = category;
        }
        
        function selectPayment(payment) {
            document.querySelectorAll('.active-payment').forEach(btn => btn.classList.remove('active-payment'));
            document.querySelector(`[data-payment="${payment}"]`).classList.add('active-payment');
            document.getElementById('expense-payment').value = payment;
        }
        
        function addExpense() {
            const date = document.getElementById('expense-date').value || new Date().toISOString().slice(0, 10);
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const currency = document.getElementById('expense-currency').value;
            const payer = document.getElementById('expense-payer').value;
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value.trim();
            const payment = document.getElementById('expense-payment').value;

            if (isNaN(amount) || amount <= 0 || !category) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡å’Œé¡åˆ¥ï¼');
                return;
            }

            const newExpense = {
                id: Date.now(),
                date: date,
                amount: amount,
                currency: currency,
                payer: payer,
                category: category,
                description: description || 'ç„¡èªªæ˜',
                payment: payment,
                twd: getTwdEquivalent(amount, currency)
            };

            EXPENSES.unshift(newExpense); // æ–°å¢åˆ°æ¸…å–®æœ€å‰é¢
            localStorage.setItem('tripExpenses', JSON.stringify(EXPENSES));

            // é‡è¨­è¡¨å–®
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-description').value = '';
            
            renderExpenseTracking();
        }

        function deleteExpense(id) {
            EXPENSES = EXPENSES.filter(e => e.id !== id);
            localStorage.setItem('tripExpenses', JSON.stringify(EXPENSES));
            renderExpenseTracking();
        }

        let currentFilterCategory = 'All';

        function setFilterCategory(category) {
            currentFilterCategory = category;
            document.querySelectorAll('.active-filter').forEach(btn => btn.classList.remove('active-filter'));
            document.querySelector(`[data-filter="${category}"]`).classList.add('active-filter');
            renderExpenseList();
        }
        
        function renderExpenseList() {
            const listContainer = document.getElementById('expense-list');
            const filteredExpenses = EXPENSES.filter(e => currentFilterCategory === 'All' || e.category === currentFilterCategory);
            
            if (filteredExpenses.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 text-sm">
                    ${currentFilterCategory === 'All' ? 'å°šç„¡æ”¯å‡ºç´€éŒ„' : `åœ¨ ${currentFilterCategory} é¡åˆ¥ä¸‹ç„¡ç´€éŒ„`}
                </p>`;
                return;
            }

            listContainer.innerHTML = filteredExpenses.map(e => `
                <div class="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm">
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-400">${e.date} / ${e.payment}</p>
                        <p class="font-semibold text-gray-800 truncate">${e.description || e.category}</p>
                        <p class="text-xs font-medium text-custom-secondary mt-1">
                            ${e.category} | ${e.payer} æ”¯ä»˜
                        </p>
                    </div>
                    <div class="text-right ml-3 flex items-center">
                        <div class="mr-2">
                            <p class="text-lg font-bold text-gray-900">${e.amount.toLocaleString()} ${e.currency}</p>
                            <p class="text-xs text-gray-500">ç´„ NT$ ${e.twd.toLocaleString()}</p>
                        </div>
                        <button onclick="deleteExpense(${e.id})" class="text-red-400 hover:text-red-600 transition duration-150 ml-2">
                            <i class="fa-solid fa-trash-can text-sm"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderExpenseTracking() {
            // 1. æ¸²æŸ“åŒ¯ç‡
            document.getElementById('exchange-rate-display').textContent = `1 JPY â‰ˆ ${EXCHANGE_RATE.toFixed(2)} TWD`;
            
            // 2. è¨ˆç®—ç¸½çµ
            let totalSpentTWD = 0;
            let joshPaidTWD = 0;
            let candicePaidTWD = 0;
            
            EXPENSES.forEach(e => {
                totalSpentTWD += e.twd;
                if (e.payer === 'Josh') {
                    joshPaidTWD += e.twd;
                } else if (e.payer === 'Candice') {
                    candicePaidTWD += e.twd;
                }
            });

            const remainingBudget = BUDGET - totalSpentTWD;
            const sharedTotal = totalSpentTWD;
            const halfShared = Math.round(sharedTotal / 2);
            
            let settlementResult = '';
            const joshDiff = joshPaidTWD - halfShared;
            const candiceDiff = candicePaidTWD - halfShared;

            if (Math.abs(joshDiff) < 1) {
                settlementResult = 'é›™æ–¹ä»˜è²»å¹³å‡ï¼Œç„¡éœ€çµç®—ã€‚';
            } else if (joshDiff > 0) {
                settlementResult = `Candice éœ€æ”¯ä»˜çµ¦ Josh $${Math.abs(joshDiff).toLocaleString()} TWDã€‚`;
            } else {
                settlementResult = `Josh éœ€æ”¯ä»˜çµ¦ Candice $${Math.abs(candiceDiff).toLocaleString()} TWDã€‚`;
            }
            
            // 3. æ›´æ–° UI
            document.getElementById('total-budget').textContent = BUDGET.toLocaleString();
            document.getElementById('total-spent').textContent = totalSpentTWD.toLocaleString();
            document.getElementById('remaining-budget').textContent = remainingBudget.toLocaleString();
            document.getElementById('josh-paid').textContent = joshPaidTWD.toLocaleString();
            document.getElementById('candice-paid').textContent = candicePaidTWD.toLocaleString();
            document.getElementById('settlement-result').textContent = settlementResult;

            // 4. æ¸²æŸ“ç¯©é¸æŒ‰éˆ• (ç¢ºä¿æ‰€æœ‰é¡åˆ¥éƒ½æœ‰æŒ‰éˆ•)
            const allCategories = ['Food', 'Transport', 'Accommodation', 'Shopping', 'Other'];
            const filterContainer = document.getElementById('category-filter-buttons');
            filterContainer.innerHTML = `
                <button type="button" class="block-select-btn px-2 py-1 text-xs active-filter" data-filter="All" onclick="setFilterCategory('All')">
                    <i class="fa-solid fa-list-ul mr-1"></i> å…¨éƒ¨
                </button>
            `;
            allCategories.forEach(category => {
                const icon = {
                    'Food': 'fa-utensils',
                    'Transport': 'fa-train-subway',
                    'Accommodation': 'fa-hotel',
                    'Shopping': 'fa-bag-shopping',
                    'Other': 'fa-ellipsis'
                }[category];
                const button = document.createElement('button');
                button.className = `block-select-btn px-2 py-1 text-xs`;
                button.setAttribute('data-filter', category);
                button.onclick = () => setFilterCategory(category);
                button.innerHTML = `<i class="fa-solid ${icon} mr-1"></i> ${category}`;
                filterContainer.appendChild(button);
            });
            // ç¢ºä¿ç¯©é¸å™¨ç‹€æ…‹æ­£ç¢º
            setFilterCategory(currentFilterCategory); 

            // 5. æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨
            renderExpenseList();
        }


        // ===================================
        // æ…¾æœ›æ¸…å–®é ç±¤å‡½å¼ (Wishlist Tab Functions)
        // ===================================

        let WISHLIST = JSON.parse(localStorage.getItem('tripWishlist')) || [];
        
        function addWishlistItem(event) {
            event.preventDefault();
            const name = document.getElementById('wishlist-name').value.trim();
            const category = document.getElementById('wishlist-category').value;
            const price = parseFloat(document.getElementById('wishlist-price').value);

            if (!name || isNaN(price) || price <= 0 || !category) {
                alert('è«‹å¡«å¯«å®Œæ•´ä¸”æœ‰æ•ˆçš„é …ç›®åç¨±ã€åˆ†é¡å’Œåƒ¹æ ¼ï¼');
                return;
            }

            const newItem = {
                id: Date.now(),
                name: name,
                category: category,
                price: price, // JPY
                purchased: false
            };

            WISHLIST.unshift(newItem); 
            localStorage.setItem('tripWishlist', JSON.stringify(WISHLIST));

            // é‡è¨­è¡¨å–®
            document.getElementById('wishlist-form').reset();
            
            renderWishlist();
        }

        function togglePurchaseStatus(id) {
            const item = WISHLIST.find(i => i.id === id);
            if (item) {
                item.purchased = !item.purchased;
                localStorage.setItem('tripWishlist', JSON.stringify(WISHLIST));
                renderWishlist();
            }
        }

        function deleteWishlistItem(id) {
            WISHLIST = WISHLIST.filter(i => i.id !== id);
            localStorage.setItem('tripWishlist', JSON.stringify(WISHLIST));
            renderWishlist();
        }

        function renderWishlist() {
            const listContainer = document.getElementById('wishlist-list');
            
            if (WISHLIST.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 text-sm">å°šç„¡å¾…è³¼é …ç›®</p>`;
                return;
            }

            // å°‡æœªè³¼è²·çš„æ”¾åœ¨å‰é¢
            const sortedList = [...WISHLIST].sort((a, b) => (a.purchased === b.purchased) ? 0 : a.purchased ? 1 : -1);

            listContainer.innerHTML = sortedList.map(item => {
                const statusText = item.purchased ? 'å·²è³¼è²·' : 'å¾…è³¼è²·';
                const statusClass = item.purchased ? 'purchased' : 'pending';
                const twdEquivalent = getTwdEquivalent(item.price, 'JPY');
                
                return `
                    <div class="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-800">${item.name}</p>
                            <p class="text-xs text-gray-500 mt-1">${item.category}</p>
                        </div>
                        <div class="text-right ml-3 flex items-center">
                            <div class="mr-3">
                                <p class="text-md font-bold text-gray-900">${item.price.toLocaleString()} JPY</p>
                                <p class="text-xs text-gray-500">ç´„ NT$ ${twdEquivalent.toLocaleString()}</p>
                            </div>
                            <button onclick="togglePurchaseStatus(${item.id})" class="wishlist-status-btn ${statusClass} mr-2">
                                <i class="fa-solid fa-${item.purchased ? 'check' : 'hourglass-half'} mr-1"></i> ${statusText}
                            </button>
                            <button onclick="deleteWishlistItem(${item.id})" class="text-red-400 hover:text-red-600 transition duration-150">
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ===================================
        // ä¸»è¦å°èˆªå‡½å¼ (Main Navigation)
        // ===================================
        function switchMainNav(targetId) {
            // éš±è—æ‰€æœ‰å…§å®¹å€å¡Š
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // é¡¯ç¤ºç›®æ¨™å…§å®¹å€å¡Š
            document.getElementById(targetId).classList.remove('hidden');

            // æ›´æ–°åº•éƒ¨å°èˆªæŒ‰éˆ•çš„ active ç‹€æ…‹
            document.querySelectorAll('.bottom-nav-button').forEach(btn => {
                if (btn.getAttribute('data-target') === targetId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }


        // ===================================
        // åˆå§‹åŒ–
        // ===================================
        document.addEventListener('DOMContentLoaded', () => {
            renderDateButtons();
            
            // åˆå§‹åŒ–è¨˜å¸³å’Œæ…¾æœ›æ¸…å–® (å¦‚æœä½¿ç”¨è€…åˆ‡æ›åˆ°é€™å…©å€‹é ç±¤æ‰æœƒå®Œå…¨æ¸²æŸ“)
            renderExpenseTracking(); 
            renderWishlist(); 
            
            // ç¢ºä¿é é¢åˆå§‹é¡¯ç¤ºè¡Œç¨‹é ç±¤
            switchMainNav('itinerary-tab');
        });
    </script>
</body>
</html>