<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>福岡熊本行程助手</title>
    <script type="module">
/* =========================
  Firebase 初始化
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
 getFirestore,
 collection,
 doc,
 setDoc,
 addDoc,
 deleteDoc,
 onSnapshot,
 serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import {
 getAuth,
 signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
const firebaseConfig = {
 apiKey: "AIzaSyBRjYjvwvCNTRHdI8vH8n3GPabzSnSDbvI",
 authDomain: "jp-b0e03.firebaseapp.com",
 projectId: "jp-b0e03",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
/* =========================
  ?? 登入（無 UI）
  Josh / Candice 共用帳密
========================= */
await signInWithEmailAndPassword(
 auth,
 "candice@email.com",   // ← 換成你 Firebase Auth 建的帳號
 "你的密碼"
);
const OWNER_EMAIL = auth.currentUser.email;
/* =========================
  Firestore 路徑
========================= */
const tripRoot = "trip/kyushu";
const itineraryCol = collection(db, `${tripRoot}/itinerary`);
const expenseCol = collection(db, `${tripRoot}/expenses`);
const wishlistCol = collection(db, `${tripRoot}/wishlist`);
/* =========================
  全域資料
========================= */
let ITINERARY_DATA = {};
let EXPENSES = [];
let WISHLIST = [];
/* =========================
  ?? 即時同步 - 行程
========================= */
onSnapshot(itineraryCol, snap => {
 ITINERARY_DATA = {};
 snap.forEach(d => ITINERARY_DATA[d.id] = d.data());
 renderDateButtons();
});
/* =========================
  ?? 即時同步 - 記帳
========================= */
onSnapshot(expenseCol, snap => {
 EXPENSES = snap.docs.map(d => ({ id: d.id, ...d.data() }));
 renderExpenseTracking();
});
/* =========================
  ?? 即時同步 - Wishlist
========================= */
onSnapshot(wishlistCol, snap => {
 WISHLIST = snap.docs.map(d => ({ id: d.id, ...d.data() }));
 renderWishlist();
});
/* =========================
  ?? 行程 CRUD（改你原本的）
========================= */
async function saveItinerary(dateKey, dateLabel, events) {
 await setDoc(
   doc(db, `${tripRoot}/itinerary`, dateKey),
   {
     date: dateLabel,
     events,
     updatedBy: OWNER_EMAIL,
     updatedAt: serverTimestamp()
   }
 );
}
/* =========================
  ?? 新增支出
========================= */
async function addExpense() {
 const amount = parseFloat(document.getElementById("expense-amount").value);
 const payer = document.getElementById("expense-payer").value;
 if (isNaN(amount)) return alert("金額錯誤");
 await addDoc(expenseCol, {
   amount,
   payer,
   ownerEmail: OWNER_EMAIL,
   createdAt: serverTimestamp()
 });
}
/* =========================
  ?? Wishlist
========================= */
async function addWishlistItem(event) {
 event.preventDefault();
 const name = document.getElementById("wishlist-name").value;
 const price = parseFloat(document.getElementById("wishlist-price").value);
 const category = document.getElementById("wishlist-category").value;
 await addDoc(wishlistCol, {
   name,
   price,
   category,
   purchased: false,
   ownerEmail: OWNER_EMAIL,
   createdAt: serverTimestamp()
 });
 event.target.reset();
}
async function togglePurchaseStatus(id, purchased) {
 await setDoc(
   doc(db, `${tripRoot}/wishlist`, id),
   { purchased: !purchased },
   { merge: true }
 );
}
async function deleteWishlistItem(id) {
 await deleteDoc(doc(db, `${tripRoot}/wishlist`, id));
}
</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* 自訂顏色主題 (清新/現代感配色) */
        .bg-custom-primary { background-color: #4A90E2; } /* 主色：深天空藍 */
        .text-custom-primary { color: #4A90E2; }
        .bg-custom-secondary { background-color: #F5A623; } /* 副色：暖金橘 */
        .text-custom-secondary { color: #F5A623; }
        
        /* 行程頁籤的日期按鈕樣式 */
        .tab-button.active {
            background-color: #4A90E2; 
            color: white;
            border-bottom: none !important; 
        }
        
        /* 行程時間軸樣式 */
        .timeline-item {
            border-left: 2px solid #4A90E2; /* 使用新的主色 */
            padding-left: 1rem;
            cursor: pointer; /* **新增：讓使用者知道可以點擊** */
            transition: background-color 0.2s;
        }
        .timeline-item:hover {
            background-color: #f0f8ff; /* 點擊時有淺色提示 */
        }
        .timeline-container > div:last-child .timeline-item {
            border-left: none; /* 移除最後一個項目的左邊線 */
        }
        .timeline-item a {
            color: #F5A623; /* 使用新的副色 */
            text-decoration: underline;
        }
        
        /* 底部導航欄樣式 */
        .bottom-nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0;
            cursor: pointer;
            transition: color 0.2s ease;
            color: #4b5563; 
        }
        .bottom-nav-button.active {
            color: #4A90E2; /* 使用新的主色 */
        }
        
        /* 確保底部內容不會被固定導航欄遮擋 */
        body {
            padding-bottom: 70px; 
        }

        /* 記帳頁面的區塊點選按鈕樣式 */
        .block-select-btn {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap; 
        }
        /* 幣別、類別、篩選 使用副色 (暖金橘) */
        .block-select-btn.active-currency,
        .block-select-btn.active-category,
        .block-select-btn.active-filter {
            background-color: #F5A623;
            color: white;
            border-color: #F5A623;
        }
        /* 付款人、支付方式 使用主色 (天空藍) */
        .block-select-btn.active-payer,
        .block-select-btn.active-payment {
            background-color: #4A90E2;
            color: white;
            border-color: #4A90E2;
        }
        
        /* 慾望清單的已購/未購按鈕樣式 */
        .wishlist-status-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .wishlist-status-btn.pending {
            background-color: #fca5a5; /* 淺紅 */
            color: #7f1d1d; /* 深紅文字 */
        }
        .wishlist-status-btn.purchased {
            background-color: #a7f3d0; /* 淺綠 */
            color: #065f46; /* 深綠文字 */
        }

        /* Modal 樣式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* 預設隱藏 */
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* 行程日期按鈕的容器樣式 (配合圖片) */
        #itinerary-overview-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        #itinerary-overview-buttons .tab-button {
            border-radius: 9999px; /* 圓角膠囊形 */
            background-color: #E8F3FF; /* 淺藍白背景 */
            color: #4A90E2; /* 藍色文字 */
            padding: 0.4rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            border-bottom: none !important; /* 移除原本的底線 */
        }
        #itinerary-overview-buttons .tab-button.active {
            background-color: #4A90E2; /* 主色 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-custom-primary text-white shadow-md p-4 sticky top-0 z-20">
        <h1 class="text-2xl font-bold text-center">Josh&Candice北九州聖誕跨年之旅 (12/26 - 12/31)</h1>
    </header>

    <div id="main-content" class="p-4 max-w-md mx-auto">
        
        <div id="itinerary-tab" class="main-tab-content">
            
            <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-cloud-sun text-custom-primary mr-2"></i> 行程天氣總覽 (tenki.jp)
                </h2>

                <div class="flex justify-around items-stretch mb-4 space-x-2">
                    <div class="flex-1 text-center p-3 border rounded-lg bg-gray-50 shadow-sm">
                        <p class="text-sm font-semibold text-gray-700 mb-1">福岡 (26日)</p>
                        <i id="weather-icon-fukuoka" class="fa-solid fa-cloud-sun-rain text-3xl text-custom-primary mb-1"></i>
                        <p id="weather-temp-fukuoka" class="text-lg font-bold text-gray-800">8°C / 13°C</p>
                        <p id="weather-rain-fukuoka" class="text-xs text-red-500 mt-1">降雨率: 20%</p>
                    </div>

                    <div class="flex-1 text-center p-3 border rounded-lg bg-gray-50 shadow-sm">
                        <p class="text-sm font-semibold text-gray-700 mb-1">長崎 (27-28日)</p>
                        <i id="weather-icon-nagasaki" class="fa-solid fa-sun text-3xl text-custom-secondary mb-1"></i> 
                        <p id="weather-temp-nagasaki" class="text-lg font-bold text-gray-800">5°C / 10°C</p>
                        <p id="weather-rain-nagasaki" class="text-xs text-gray-500 mt-1">降雨率: 0%</p>
                    </div>

                    <div class="flex-1 text-center p-3 border rounded-lg bg-gray-50 shadow-sm">
                        <p class="text-sm font-semibold text-gray-700 mb-1">熊本 (29-31日)</p>
                        <i id="weather-icon-kumamoto" class="fa-solid fa-cloud-showers-heavy text-3xl text-custom-primary mb-1"></i>
                        <p id="weather-temp-kumamoto" class="text-lg font-bold text-gray-800">3°C / 9°C</p>
                        <p id="weather-rain-kumamoto" class="text-xs text-red-500 mt-1">降雨率: 40%</p>
                    </div>
                </div>

                <a href="https://www.tenki.jp/" target="_blank" class="w-full block text-center bg-gray-200 text-gray-700 p-2 rounded-lg font-semibold hover:bg-gray-300 transition duration-200">
                    點擊查看 tenki.jp 詳細預報
                </a>
            </div>
            
            <div id="itinerary-overview-buttons" class="bg-white p-4 rounded-lg shadow-md sticky top-[72px] z-10">
                <h3 class="font-bold text-gray-800 mb-2">?? 行程總覽</h3>
                <div id="date-buttons-container" class="flex flex-wrap justify-center items-center gap-2">
                    </div>
            </div>

            <div id="itinerary-container" class="bg-white p-4 rounded-lg shadow-md mt-4 min-h-[300px]">
                <p class="text-center text-gray-500">請點擊上方的日期查看行程。</p>
            </div>
            
            <button onclick="openModal('addItineraryModal')" class="fixed right-4 bottom-20 bg-custom-primary text-white p-4 rounded-full shadow-lg hover:bg-[#3A7AD0] transition z-20">
                <i class="fa-solid fa-circle-plus text-2xl"></i>
            </button>
            
            <div class="mt-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                <h3 class="text-lg font-bold text-custom-secondary mb-2">?? 備註：</h3>
                <p class="text-sm text-gray-600">行程點擊後即可進行修改或刪除。飯店名稱已加上 <a href="#" onclick="return false;" class="text-custom-secondary underline">Google Maps 連結</a>。</p>
            </div>
        </div>
        

        <div id="expense-tab" class="main-tab-content hidden">
            <div id="expense-tracking-container" class="bg-white p-4 rounded-lg shadow-md mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-calculator text-[#F5A623] mr-2"></i> ?? 旅費記帳中心
                </h3>
        
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm font-semibold text-blue-700">即時匯率 (JPY/TWD)：<span id="exchange-rate-display">--</span></p>
                </div>
        
                <div class="p-4 bg-gray-50 rounded-lg mb-4 shadow-inner">
                    <h4 class="font-semibold mb-3 text-custom-primary">新增支出</h4>
                    
                    <input type="date" id="expense-date" class="w-full p-2 border rounded-lg mb-3 text-sm">
                    
                    <input type="number" id="expense-amount" placeholder="金額" class="w-full p-2 border rounded-lg mb-3 text-sm" min="0">
                    
                    <h5 class="text-sm font-semibold mb-2">付款幣別:</h5>
                    <div id="currency-select" class="flex space-x-2 mb-3">
                        <button type="button" class="block-select-btn flex-1 active-currency" data-currency="TWD" onclick="selectCurrency('TWD')">
                            <i class="fa-solid fa-money-bill-wave mr-1"></i> 台幣 (TWD)
                        </button>
                        <button type="button" class="block-select-btn flex-1" data-currency="JPY" onclick="selectCurrency('JPY')">
                            <i class="fa-solid fa-yen-sign mr-1"></i> 日圓 (JPY)
                        </button>
                        <input type="hidden" id="expense-currency" value="TWD">
                    </div>
                    
                    <h5 class="text-sm font-semibold mb-2">付款人:</h5>
                    <div id="payer-select" class="flex space-x-2 mb-3">
                        <button type="button" class="block-select-btn flex-1 active-payer" data-payer="Josh" onclick="selectPayer('Josh')">
                            <i class="fa-solid fa-person-military-pointing mr-1"></i> Josh
                        </button>
                        <button type="button" class="block-select-btn flex-1" data-payer="Candice" onclick="selectPayer('Candice')">
                            <i class="fa-solid fa-person-dress mr-1"></i> Candice
                        </button>
                        <input type="hidden" id="expense-payer" value="Josh">
                    </div>

                    <h5 class="text-sm font-semibold mb-2">支出類別:</h5>
                    <div id="category-select" class="flex flex-wrap gap-2 mb-3">
                        <button type="button" class="block-select-btn px-2 py-1 text-xs active-category" data-category="Food" onclick="selectCategory('Food')">
                            <i class="fa-solid fa-utensils mr-1"></i> 餐飲
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Transport" onclick="selectCategory('Transport')">
                            <i class="fa-solid fa-train-subway mr-1"></i> 交通
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Accommodation" onclick="selectCategory('Accommodation')">
                            <i class="fa-solid fa-hotel mr-1"></i> 住宿
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Shopping" onclick="selectCategory('Shopping')">
                            <i class="fa-solid fa-bag-shopping mr-1"></i> 購物
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Other" onclick="selectCategory('Other')">
                            <i class="fa-solid fa-ellipsis mr-1"></i> 其他
                        </button>
                        <input type="hidden" id="expense-category" value="Food"> 
                    </div>
                    
                    <h5 class="text-sm font-semibold mb-2">支付方式:</h5>
                    <div id="payment-select" class="flex flex-wrap gap-2 mb-3">
                        <button type="button" class="block-select-btn px-2 py-1 text-xs active-payment" data-payment="Cash" onclick="selectPayment('Cash')">
                            <i class="fa-solid fa-money-bill-1-wave mr-1"></i> 現金
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-payment="CreditCard" onclick="selectPayment('CreditCard')">
                            <i class="fa-solid fa-credit-card mr-1"></i> 信用卡
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-payment="PayPay" onclick="selectPayment('PayPay')">
                            <i class="fa-solid fa-mobile-screen mr-1"></i> PayPay
                        </button>
                        <input type="hidden" id="expense-payment" value="Cash"> 
                    </div>

                    <input type="text" id="expense-description" placeholder="用途/說明" class="w-full p-2 border rounded-lg mb-3 text-sm">
                    
                    <button onclick="addExpense()" class="w-full bg-custom-secondary text-white p-2 rounded-lg font-bold hover:bg-[#db8f1f]">
                        <i class="fa-solid fa-circle-plus mr-1"></i> 確認新增
                    </button>
                </div>
        
                <div id="expense-summary" class="mb-4 p-4 bg-custom-primary text-white rounded-lg shadow-md">
                    <h4 class="font-semibold mb-2">總支出概況</h4>
                    <p class="text-sm">總預算 (TWD): $ <span id="total-budget">50,000</span></p>
                    <p class="text-sm">累積總支出 (TWD): $ <span id="total-spent">0</span></p>
                    <p class="text-lg font-bold mt-2">剩餘預算: $ <span id="remaining-budget">50,000</span></p>
                </div>
                
                <div id="settlement-summary" class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg shadow-md">
                    <h4 class="font-semibold mb-2 text-gray-800 flex items-center"><i class="fa-solid fa-handshake-angle mr-2 text-yellow-600"></i> 分攤結算概況 (TWD)</h4>
                    <p class="text-sm text-gray-700">Josh 已支付: $ <span id="josh-paid">0</span></p>
                    <p class="text-sm text-gray-700 mb-2">Candice 已支付: $ <span id="candice-paid">0</span></p>
                    <p class="text-md font-bold text-gray-900 border-t pt-2 mt-2">
                        <span id="settlement-result">無需結算。</span>
                    </p>
                </div>

                <div class="mb-4">
                    <h4 class="font-semibold mb-2 text-gray-700 flex items-center"><i class="fa-solid fa-filter mr-2"></i> 依類別篩選清單:</h4>
                    <div id="category-filter-buttons" class="flex flex-wrap gap-2 text-sm">
                    </div>
                </div>
        
                <h4 class="font-semibold mb-3 text-gray-700 border-b pb-2">支出明細</h4>
                <div id="expense-list" class="space-y-2">
                    <p class="text-center text-gray-500 text-sm">尚無支出紀錄</p>
                </div>
            </div>
        </div>

        <div id="weather-tab" class="main-tab-content hidden">
            <div id="weather-container" class="bg-white p-4 rounded-lg shadow-md mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-temperature-three-quarters text-[#4A90E2] mr-2"></i> ?? 每日天氣預報 (tenki.jp 歷史數據)
                </h3>
                <div id="weather-content" class="space-y-4">
                    </div>
            </div>
        </div>
        
        <div id="wishlist-tab" class="main-tab-content hidden">
             <div class="bg-white p-4 rounded-lg shadow-md mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-heart text-[#F5A623] mr-2"></i> ? 慾望清單
                </h3>
                
                <div class="p-4 bg-gray-50 rounded-lg mb-4 shadow-inner">
                    <h4 class="font-semibold mb-3 text-custom-primary">新增購買目標</h4>
                    <form id="wishlist-form" onsubmit="addWishlistItem(event)">
                        
                        <label for="wishlist-category" class="text-sm font-semibold text-gray-700 mb-1 block">項目分類:</label>
                        <select id="wishlist-category" name="wishlist-category" class="w-full p-2 border rounded-lg mb-3 text-sm bg-white" required>
                            <option value="" disabled selected>-- 請選擇分類 --</option>
                            <option value="3C">3C</option>
                            <option value="Beauty">美妝</option>
                            <option value="Daily">日用品</option>
                            <option value="Toy">玩具</option>
                            <option value="Clothes">衣物</option>
                            <option value="Souvenir">伴手禮/食物</option>
                            <option value="Other">其他</option>
                        </select>
                        
                        <label for="wishlist-name" class="text-sm font-semibold text-gray-700 mb-1 block">項目名稱/描述:</label>
                        <input type="text" id="wishlist-name" name="wishlist-name" placeholder="例如：Dyson 吹風機" class="w-full p-2 border rounded-lg mb-3 text-sm" required>

                        <label for="wishlist-price" class="text-sm font-semibold text-gray-700 mb-1 block">預計價格 (JPY):</label>
                        <input type="number" id="wishlist-price" name="wishlist-price" placeholder="請輸入預計價格 (日圓)" min="0" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                        
                        <button type="submit" class="w-full bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-[#3A7AD0]">
                            <i class="fa-solid fa-cart-plus mr-1"></i> 加入清單
                        </button>
                    </form>
                </div>
                
                <h4 class="font-semibold mb-3 text-gray-700 border-b pb-2">待購清單</h4>
                <div id="wishlist-list" class="space-y-3">
                    <p class="text-center text-gray-500 text-sm">尚無待購項目</p>
                </div>

             </div>
        </div>
        
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl z-30">
        <div class="flex justify-around max-w-md mx-auto">
            
            <button class="bottom-nav-button active" data-target="itinerary-tab" onclick="switchMainNav('itinerary-tab')">
                <i class="fa-solid fa-map-location-dot text-2xl mb-1"></i>
                <span class="text-xs">行程</span>
            </button>

            <button class="bottom-nav-button" data-target="expense-tab" onclick="switchMainNav('expense-tab'); renderExpenseTracking();">
                <i class="fa-solid fa-calculator text-2xl mb-1"></i>
                <span class="text-xs">記帳</span>
            </button>
            
            <button class="bottom-nav-button" data-target="weather-tab" onclick="switchMainNav('weather-tab'); renderWeather();">
                <i class="fa-solid fa-cloud-sun-rain text-2xl mb-1"></i>
                <span class="text-xs">天氣</span>
            </button>
            
            <button class="bottom-nav-button" data-target="wishlist-tab" onclick="switchMainNav('wishlist-tab'); renderWishlist();">
                <i class="fa-solid fa-heart text-2xl mb-1"></i>
                <span class="text-xs">慾望清單</span>
            </button>

        </div>
    </nav>
    
    <div id="addItineraryModal" class="modal-overlay">
        <div class="modal-content">
            
            <div class="text-center mb-4">
                <div class="text-custom-primary font-bold text-lg mb-2 flex items-center justify-center">
                    <i class="fa-solid fa-circle-plus mr-2"></i> 新增行程項目
                </div>
                <h3 class="text-xl font-bold text-gray-800 border-b pb-2">新增行程細節</h3>
            </div>
            <button onclick="closeModal('addItineraryModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            
            <form id="add-itinerary-form" onsubmit="addItineraryItem(event)">
                
                <label for="new-date" class="text-sm font-semibold text-gray-700 mb-1 block">選擇日期:</label>
                <select id="new-date" class="w-full p-2 border rounded-lg mb-3 text-sm bg-white" required>
                    </select>
                
                <label for="new-time" class="text-sm font-semibold text-gray-700 mb-1 block">時間:</label>
                <div class="flex items-center mb-3">
                    <input type="text" id="new-time" placeholder="--:--" pattern="[0-2][0-9]:[0-5][0-9]" class="flex-1 p-2 border rounded-lg text-sm mr-2" required>
                    <i class="fa-solid fa-clock text-gray-500"></i>
                </div>
                
                <label for="new-title" class="text-sm font-semibold text-gray-700 mb-1 block">行程標題:</label>
                <input type="text" id="new-title" placeholder="行程標題 (如: 晚餐)" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                
                <label for="new-note" class="text-sm font-semibold text-gray-700 mb-1 block">備註/地點:</label>
                <textarea id="new-note" rows="2" placeholder="備註 (如: 阿蘇赤牛丼/飯店)" class="w-full p-2 border rounded-lg mb-4 text-sm"></textarea>
                
                <button type="submit" class="w-full bg-custom-secondary text-white p-2 rounded-lg font-bold hover:bg-[#db8f1f]">
                    確認新增
                </button>
            </form>
        </div>
    </div>
    
    <div id="editItineraryModal" class="modal-overlay">
        <div class="modal-content">
            
            <div class="text-center mb-4">
                <div class="text-custom-secondary font-bold text-lg mb-2 flex items-center justify-center">
                    <i class="fa-solid fa-pen-to-square mr-2"></i> 修改行程項目
                </div>
                <h3 class="text-xl font-bold text-gray-800 border-b pb-2" id="edit-modal-date-info"></h3>
            </div>
            <button onclick="closeModal('editItineraryModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            
            <form id="edit-itinerary-form" onsubmit="saveItineraryItem(event)">
                <input type="hidden" id="edit-date-key" name="dateKey">
                <input type="hidden" id="edit-item-index" name="itemIndex">

                <label for="edit-time" class="text-sm font-semibold text-gray-700 mb-1 block">時間:</label>
                <div class="flex items-center mb-3">
                    <input type="text" id="edit-time" placeholder="--:--" pattern="[0-2][0-9]:[0-5][0-9]" class="flex-1 p-2 border rounded-lg text-sm mr-2" required>
                    <i class="fa-solid fa-clock text-gray-500"></i>
                </div>
                
                <label for="edit-title" class="text-sm font-semibold text-gray-700 mb-1 block">行程標題:</label>
                <input type="text" id="edit-title" placeholder="行程標題 (如: 晚餐)" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                
                <label for="edit-note" class="text-sm font-semibold text-gray-700 mb-1 block">備註/地點:</label>
                <textarea id="edit-note" rows="2" placeholder="備註 (如: 阿蘇赤牛丼/飯店)" class="w-full p-2 border rounded-lg mb-4 text-sm"></textarea>
                
                <div class="flex space-x-2">
                    <button type="button" onclick="deleteItineraryItem(document.getElementById('edit-date-key').value, parseInt(document.getElementById('edit-item-index').value))" class="flex-1 bg-red-500 text-white p-2 rounded-lg font-bold hover:bg-red-600">
                        <i class="fa-solid fa-trash-can mr-1"></i> 刪除
                    </button>
                    <button type="submit" class="flex-1 bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-[#3A7AD0]">
                        <i class="fa-solid fa-save mr-1"></i> 儲存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
// 掛到 window，給原本 JS 用
 window.db = db;
 window.fbDoc = doc;
 window.fbGetDoc = getDoc;
 window.fbSetDoc = setDoc;
 window.fbOnSnapshot = onSnapshot;
    
    <script>
        // ===================================
        // 核心數據 (行程、天氣、記帳) - 12/26 ~ 12/31 最終版
        // ===================================
        
        // **地圖連結數據 (已確認)**
        const MAP_LINKS = { 
    "Ritz Carlton Fukuoka": "https://www.google.com/maps/search/?api=1&query=The+Ritz-Carlton+Fukuoka",
    "福岡塔": "https://www.google.com/maps/search/?api=1&query=福岡???",
    "大濠公園": "https://www.google.com/maps/search/?api=1&query=Ohori+Park",
    "Nagasaki Marriott Hotel": "https://www.google.com/maps/search/?api=1&query=Nagasaki+Marriott+Hotel",
    "長崎中華街": "https://www.google.com/maps/search/?api=1&query=長崎新地中華街",
    "和平公園 / 原爆資料館": "https://www.google.com/maps/search/?api=1&query=長崎平和公園+原爆資料館",
    "稻佐山夜景": "https://www.google.com/maps/search/?api=1&query=長崎+?佐山",
    "大浦天主堂": "https://www.google.com/maps/search/?api=1&query=Oura+Church",
    "哥拉巴園": "https://www.google.com/maps/search/?api=1&query=Glover+Garden",
    "出島": "https://www.google.com/maps/search/?api=1&query=Dejima+Nagasaki",
    "眼鏡橋": "https://www.google.com/maps/search/?api=1&query=眼鏡橋",
    "KOKO Hotel Premier Kumamoto": "https://www.google.com/maps/search/?api=1&query=KOKO+HOTEL+Premier+Kumamoto",
    "熊本城": "https://www.google.com/maps/search/?api=1&query=Kumamoto+Castle",
    "城彩苑": "https://www.google.com/maps/search/?api=1&query=??馬場+城彩苑",
    "上通/下通商店街": "https://www.google.com/maps/search/?api=1&query=上通+下通+商店街+熊本",
    "水前寺成趣園": "https://www.google.com/maps/search/?api=1&query=Suizenji+Jojuen+Garden",
    "黑川溫泉": "https://www.google.com/maps/search/?api=1&query=Kurokawa+Onsen",
    "植木溫泉": "https://www.google.com/maps/search/?api=1&query=Ueki+Onsen",
    "熊本機場 (KMJ)": "https://www.google.com/maps/search/?api=1&query=Kumamoto+Airport+KMJ",
        };
        
        // **行程數據**
        // 使用 localStorage 儲存，確保新增的行程不會消失
        let ITINERARY_DATA = JSON.parse(localStorage.getItem('tripItinerary')) || {
            "12/26": {
                date: "12/26 (二) - 高雄 → 福岡",
                events: [
                    { time: "06:30", icon: "fa-plane-departure", title: "CI0132 KHH → FUK", note: "高雄出發，請提早至機場" },
                    { time: "10:15", icon: "fa-bus", title: "機場至飯店交通", 
                        note: "? **建議交通 (FUK → 博多站/Ritz)**：<br>• 地下鐵空港線：10 分鐘可到" 
                    },
                    { time: "11:00", icon: "fa-hotel", title: "The Ritz-Carlton, Fukuoka 寄放行李 " + getMapLink("Ritz Carlton Fukuoka"), note: "飯店位於天神大名區" },
                    { time: "12:30", icon: "fa-utensils", title: "午餐：博多站周邊美食", note: "可選擇牛腸鍋或明太子便當" },
                    { time: "14:30", icon: "fa-camera-retro", title: "福岡塔 / 百道海濱公園 " + getMapLink("福岡塔"), note: "從 Ritz 搭計程車約 15–20 分到海邊" },
                    { time: "17:00", icon: "fa-tree", title: "大濠公園散步 " + getMapLink("大濠公園"), note: "輕鬆行程" },
                    { time: "19:30", icon: "fa-utensils", title: "晚餐：屋台或飯店用餐", note: "屋台 (中洲/天神) 體驗夜市文化" },
                    { time: "21:30", icon: "fa-bed", title: "The Ritz-Carlton Check-in", note: "回飯店休息" },
                ],
                food_notes: [
                    "?? **博多站周邊**：牛腸鍋「??鍋????」 (午餐/晚餐皆可)",
                    "?? **晚餐/宵夜**：中洲/天神屋台：體驗獨特的日式路邊攤文化。"
                ]
            },
            "12/27": {
                date: "12/27 (三) - 福岡 → 長崎",
                events: [
                    { time: "08:00", icon: "fa-train", title: "搭乘新幹線前往長崎", 
                        note: "? **新幹線 Kamome (???)**：博多 → 長崎，約 1 小時 20–30 分 (JR Pass 啟用日)" 
                    },
                    { time: "10:30", icon: "fa-hotel", title: "Nagasaki Marriott Hotel 寄放行李 " + getMapLink("Nagasaki Marriott Hotel"), note: "飯店就在長崎站" },
                    { time: "12:00", icon: "fa-utensils", title: "長崎中華街午餐 " + getMapLink("長崎中華街"), note: "可考慮江山樓或四海樓" },
                    { time: "14:00", icon: "fa-church", title: "和平公園 / 原爆資料館 " + getMapLink("和平公園 / 原爆資料館"), note: "路面電車可抵達" },
                    { time: "17:30", icon: "fa-bell-concierge", title: "飯店 Check-in & 休息", note: "Nagasaki Marriott Hotel" },
                    { time: "19:00", icon: "fa-mountain-sun", title: "稻佐山夜景 " + getMapLink("稻佐山夜景"), note: "? **世界三大夜景**：纜車上山" },
                ],
                food_notes: [
                    "?? **長崎必吃**：四海樓（長崎?????）或江山樓（強棒麵老店）"
                ]
            },
            "12/28": {
                date: "12/28 (四) - 長崎一日遊",
                events: [
                    { time: "09:00", icon: "fa-church", title: "大浦天主堂 " + getMapLink("大浦天主堂"), note: "日本最古老木造教堂" },
                    { time: "10:30", icon: "fa-gopuram", title: "哥拉巴園 " + getMapLink("哥拉巴園"), note: "歐風庭園，從大浦天主堂步行可達" },
                    { time: "12:30", icon: "fa-utensils", title: "午餐時間", note: "長崎中華街或大浦周邊" },
                    { time: "14:30", icon: "fa-landmark", title: "出島 " + getMapLink("出島"), note: "長崎歷史人文景點" },
                    { time: "16:30", icon: "fa-bridge", title: "眼鏡橋 " + getMapLink("眼鏡橋"), note: "沿著中島川散步＋享用咖啡" },
                    { time: "19:30", icon: "fa-utensils", title: "長崎站周邊晚餐", note: "長崎強棒麵（?????）或卓袱料理" },
                    { time: "21:30", icon: "fa-bed", title: "回飯店休息", note: "Nagasaki Marriott Hotel" },
                ],
                food_notes: [
                    "?? **晚餐重點**：長崎強棒麵（?????）或卓袱料理"
                ]
            },
            "12/29": {
                date: "12/29 (五) - 長崎 → 熊本",
                events: [
                    { time: "08:30", icon: "fa-hotel", title: "退房並出發", note: "Nagasaki Marriott Hotel Check-out" },
                    { time: "09:00", icon: "fa-train-subway", title: "搭乘新幹線前往熊本", 
                        note: "? **路線**：長崎 → 武雄溫泉 → 熊本站 (總耗時約 2 小時)" 
                    },
                    { time: "11:30", icon: "fa-hotel", title: "KOKO Hotel Premier 寄放行李 " + getMapLink("KOKO Hotel Premier Kumamoto"), note: "飯店近熊本站" },
                    { time: "12:30", icon: "fa-utensils", title: "午餐時間", note: "熊本站周邊" },
                    { time: "14:30", icon: "fa-fort-awesome", title: "熊本城 " + getMapLink("熊本城"), note: "修復後值得參觀" },
                    { time: "16:30", icon: "fa-hand-holding-box", title: "城彩苑（伴手禮/美食） " + getMapLink("城彩苑"), note: "熊本城山腳下的美食/購物區" },
                    { time: "18:30", icon: "fa-shopping-bag", title: "上通/下通商店街 " + getMapLink("上通/下通商店街"), note: "適合散步與晚餐" },
                    { time: "20:00", icon: "fa-utensils", title: "晚餐：赤牛丼/熊本拉麵", note: "推薦赤牛丼（??牛）或尋找熊本拉麵名店" },
                    { time: "21:30", icon: "fa-bed", title: "KOKO Hotel Premier Check-in", note: "回飯店休息" },
                ],
                food_notes: [
                    "?? **熊本必吃**：赤牛丼（??牛）、熊本拉麵"
                ]
            },
            "12/30": {
                date: "12/30 (六) - 熊本一日遊 (溫泉方案)",
                events: [
                    { time: "09:00", icon: "fa-tree", title: "水前寺成趣園 " + getMapLink("水前寺成趣園"), note: "日式庭園" },
                    { time: "11:30", icon: "fa-utensils", title: "午餐時間", note: "熊本市區或飯店周邊" },
                    { time: "14:00", icon: "fa-hot-tub", title: "前往溫泉區", note: "? **溫泉建議**：黑川溫泉 or 植木溫泉" },
                    { time: "15:00", icon: "fa-spa", title: "享受溫泉泡湯", note: "選擇當日來回溫泉" },
                    { time: "18:30", icon: "fa-bus", title: "返回熊本市區", note: "從溫泉區返回市中心" },
                    { time: "19:30", icon: "fa-shopping-bag", title: "上通/下通逛街 + 晚餐", note: "把握最後的購物機會" },
                    { time: "21:30", icon: "fa-bed", title: "回飯店休息", note: "準備隔日回程" },
                ],
                food_notes: [
                    "?? **市區美食**：熊本拉麵（如：黑亭、天外天）、馬肉料理"
                ]
            },
            "12/31": {
                date: "12/31 (日) - 熊本/返程",
                events: [
                    { time: "08:30", icon: "fa-bus-simple", title: "搭乘利木津巴士前往機場", 
                        note: "? **建議交通 (市區 → KMJ)**：利木津巴士，約 40 分鐘。提前 1.5–2 小時抵達機場最穩妥。請準時在 08:30 搭乘。" 
                    },
                    { time: "11:55", icon: "fa-plane-departure", title: "CI0199 KMJ → KHH", note: "預計 13:40 抵達高雄" }, 
                    { time: "18:00", icon: "fa-plane-arrival", title: "跨年夜在台灣", note: "慶祝新年快樂！" },
                ],
                food_notes: []
            }
        };
        
        // **天氣數據 (tenki.jp 2024年 12月實際觀測數據)**
        const WEATHER_DATA = {
            // 福岡 (2024/12/26)
            "12/26": { city: "福岡", min: 8.7, max: 13.6, icon: "fa-cloud-sun-rain", description: "多雲轉雨，上午局部有雨", rain_chance: "20%" }, 
            // 長崎 (2024/12/27)
            "12/27": { city: "長崎", min: 7.2, max: 9.8, icon: "fa-cloud-showers-heavy", description: "多雲有雨，氣溫偏低", rain_chance: "40%" },
            // 長崎 (2024/12/28)
            "12/28": { city: "長崎", min: 5.2, max: 8.8, icon: "fa-cloud", description: "多雲，持續寒冷", rain_chance: "10%" },
            // 熊本 (2024/12/29 - 採用最近數據 2024年)
            "12/29": { city: "熊本", min: 4.7, max: 8.7, icon: "fa-cloud", description: "多雲，請加強保暖", rain_chance: "10%" },
            // 熊本 (2024/12/30)
            "12/30": { city: "熊本", min: 1.6, max: 15.1, icon: "fa-sun", description: "晴朗，早晚溫差大", rain_chance: "0%" },
            // 熊本 (2024/12/31)
            "12/31": { city: "熊本", min: 7.3, max: 13.4, icon: "fa-wind", description: "晴朗，午後西風強勁", rain_chance: "0%" },
        };
        
        // **天氣總覽數據 (配合圖片樣式)**
        const OVERVIEW_WEATHER_DATA = {
            "Fukuoka": { min: 8, max: 13, icon: "fa-cloud-sun-rain", rain: "20%" }, // 12/26
            "Nagasaki": { min: 5, max: 10, icon: "fa-sun", rain: "0%" },     // 12/27-28
            "Kumamoto": { min: 3, max: 9, icon: "fa-cloud-showers-heavy", rain: "40%" }   // 12/29-31
        };


        // ===================================
        // 輔助函式 (Helper Functions)
        // ===================================
        
        /** 依據景點名稱取得地圖連結 */
        function getMapLink(placeName) {
            const url = MAP_LINKS[placeName] || `https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(placeName)}`;
            // 更新地圖連結顏色為新的副色
            return `<a href="${url}" target="_blank" class="text-custom-secondary underline hover:text-custom-primary">(地圖 <i class="fa-solid fa-map-location-dot fa-xs"></i>)</a>`;
        }

        /** 取得日期列表 */
        function getDateKeys() {
            return Object.keys(ITINERARY_DATA).sort();
        }

        /** 取得當前作用中的日期按鈕 */
        function getActiveDateKey() {
            const activeBtn = document.querySelector('#date-buttons-container .tab-button.active');
            return activeBtn ? activeBtn.getAttribute('data-date') : getDateKeys()[0];
        }

        // ===================================
        // Modal 函式
        // ===================================
        
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // 如果是新增行程，先填入日期選項
                if (modalId === 'addItineraryModal') {
                    populateDateOptions();
                }
                modal.style.display = 'flex';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // 清空表單
                if (modalId === 'addItineraryModal') {
                    document.getElementById('add-itinerary-form').reset();
                }
                if (modalId === 'editItineraryModal') {
                    document.getElementById('edit-itinerary-form').reset();
                }
            }
        }
        
        // 點擊 Modal 外圍關閉
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal(e.target.id);
            }
        });

        function populateDateOptions() {
            const select = document.getElementById('new-date');
            select.innerHTML = '';
            const dates = getDateKeys();
            
            dates.forEach(dateKey => {
                const option = document.createElement('option');
                option.value = dateKey;
                option.textContent = ITINERARY_DATA[dateKey].date;
                select.appendChild(option);
            });

            // 預設選取當前在看的日期
            const activeDateKey = getActiveDateKey();
            if (activeDateKey) {
                 select.value = activeDateKey;
            }
        }

        // ===================================
        // 新增/修改/刪除 行程函式
        // ===================================
        
        function addItineraryItem(event) {
            event.preventDefault();
            
            const dateKey = document.getElementById('new-date').value;
            const time = document.getElementById('new-time').value.trim();
            const title = document.getElementById('new-title').value.trim();
            const note = document.getElementById('new-note').value.trim();
            
            const defaultIcon = 'fa-circle-dot'; // 新增的項目使用預設圖標
            
            if (!dateKey || !time || !title) {
                alert('請填寫完整日期、時間和標題！');
                return;
            }
            
            const newItem = {
                time: time,
                icon: defaultIcon,
                title: title,
                note: note
            };
            
            if (ITINERARY_DATA[dateKey]) {
                ITINERARY_DATA[dateKey].events.push(newItem);
                
                // 依時間排序
                ITINERARY_DATA[dateKey].events.sort((a, b) => {
                    if (a.time < b.time) return -1;
                    if (a.time > b.time) return 1;
                    return 0;
                });
                
                localStorage.setItem('tripItinerary', JSON.stringify(ITINERARY_DATA));
                
                renderItinerary(dateKey);
                
                alert(`已成功將「${title}」新增到 ${dateKey} 的行程！`);
                closeModal('addItineraryModal');
            } else {
                alert('日期不存在，請聯繫開發者處理核心行程數據！');
            }
        }
        
        /** 點擊行程項目，載入數據到修改 Modal */
        function editItineraryItem(dateKey, index) {
            const item = ITINERARY_DATA[dateKey].events[index];
            
            document.getElementById('edit-modal-date-info').textContent = ITINERARY_DATA[dateKey].date;
            document.getElementById('edit-date-key').value = dateKey;
            document.getElementById('edit-item-index').value = index;
            document.getElementById('edit-time').value = item.time;
            document.getElementById('edit-title').value = item.title;
            document.getElementById('edit-note').value = item.note.replace(/<br>/g, '\n').replace(/<a.*?<\/a>/, '').trim(); // 移除地圖連結 HTML 和換行符號

            openModal('editItineraryModal');
        }

        /** 儲存修改後的行程項目 */
        function saveItineraryItem(event) {
            event.preventDefault();
            
            const dateKey = document.getElementById('edit-date-key').value;
            const index = parseInt(document.getElementById('edit-item-index').value);
            const newTime = document.getElementById('edit-time').value.trim();
            const newTitle = document.getElementById('edit-title').value.trim();
            const newNote = document.getElementById('edit-note').value.trim();
            
            if (!newTime || !newTitle) {
                alert('時間和標題不能為空！');
                return;
            }

            if (ITINERARY_DATA[dateKey] && ITINERARY_DATA[dateKey].events[index]) {
                const item = ITINERARY_DATA[dateKey].events[index];
                
                // 檢查 note 裡是否有地圖連結，如果有就保留
                let noteToSave = newNote.replace(/\n/g, '<br>');
                const mapLinkRegex = /<a.*?<\/a>/;
                const existingMapLinkMatch = item.note.match(mapLinkRegex);

                if (existingMapLinkMatch) {
                     // 確保地圖連結總是附加在備註的後面
                     const mapLink = existingMapLinkMatch[0];
                     if (!noteToSave.includes(mapLink)) {
                         noteToSave = `${noteToSave} ${mapLink}`;
                     }
                }

                // 更新數據
                item.time = newTime;
                item.title = newTitle;
                item.note = noteToSave;
                // item.icon 不做修改
                
                // 依時間重新排序
                ITINERARY_DATA[dateKey].events.sort((a, b) => {
                    if (a.time < b.time) return -1;
                    if (a.time > b.time) return 1;
                    return 0;
                });
                
                localStorage.setItem('tripItinerary', JSON.stringify(ITINERARY_DATA));

                // 重新渲染並關閉
                renderItinerary(dateKey);
                alert(`已成功更新行程：${newTitle}！`);
                closeModal('editItineraryModal');
            } else {
                alert('行程數據無效！');
            }
        }
        
        /** 刪除行程項目 */
        function deleteItineraryItem(dateKey, index) {
            if (confirm(`確定要刪除「${ITINERARY_DATA[dateKey].events[index].title}」這個行程嗎？`)) {
                if (ITINERARY_DATA[dateKey] && ITINERARY_DATA[dateKey].events.length > index) {
                    ITINERARY_DATA[dateKey].events.splice(index, 1);
                    localStorage.setItem('tripItinerary', JSON.stringify(ITINERARY_DATA));
                    
                    renderItinerary(dateKey);
                    alert('行程已刪除。');
                    closeModal('editItineraryModal');
                }
            }
        }


        /** 渲染日期按鈕 */
        function renderDateButtons() {
            const container = document.getElementById('date-buttons-container');
            container.innerHTML = '';
            const dates = getDateKeys();
            
            dates.forEach(dateKey => {
                const button = document.createElement('button');
                // 沿用新的顏色和樣式
                button.className = 'tab-button px-3 py-1 text-sm font-semibold rounded-full transition duration-200';
                button.textContent = dateKey;
                button.setAttribute('data-date', dateKey);
                button.onclick = () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderItinerary(dateKey);
                };
                container.appendChild(button);
            });

            // 預設點擊第一個日期
            if (dates.length > 0) {
                const firstButton = container.querySelector(`[data-date="${dates[0]}"]`);
                if (firstButton) {
                    firstButton.classList.add('active');
                    renderItinerary(dates[0]);
                }
            }
        }
        
        /** 渲染行程內容 */
        function renderItinerary(dateKey) {
            const container = document.getElementById('itinerary-container');
            const data = ITINERARY_DATA[dateKey];

            if (!data) {
                container.innerHTML = `<p class="text-center text-gray-500">查無 ${dateKey} 的行程。</p>`;
                return;
            }

            let html = `
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 text-custom-primary">
                    <i class="fa-solid fa-calendar-day mr-2"></i> ${data.date}
                </h2>
                <div class="timeline-container space-y-4">
            `;

            data.events.forEach((event, index) => {
                const noteContent = event.note ? `<p class="text-sm text-gray-600 mt-1" style="hyphens: auto; word-break: break-word;">${event.note}</p>` : '';
                
                // **核心修改：新增 onclick 事件**
                html += `
                    <div class="timeline-item relative pb-4" onclick="editItineraryItem('${dateKey}', ${index})">
                        <div class="absolute -left-3 top-0 w-6 h-6 bg-white border-2 border-custom-primary rounded-full flex items-center justify-center">
                            <i class="fa-solid ${event.icon} text-custom-primary text-xs"></i>
                        </div>
                        <div class="ml-4">
                            <p class="font-bold text-custom-secondary">${event.time}</p>
                            <h3 class="font-semibold text-gray-800">${event.title}</h3>
                            ${noteContent}
                        </div>
                    </div>
                `;
            });

            html += `</div>
                <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-custom-secondary rounded-lg shadow-inner">
                    <h3 class="text-lg font-bold text-custom-secondary mb-2"><i class="fa-solid fa-cookie-bite mr-1"></i> 美食備註：</h3>
            `;
            
            if (data.food_notes && data.food_notes.length > 0) {
                data.food_notes.forEach(note => {
                    html += `<p class="text-sm text-gray-700 mb-1">${note}</p>`;
                });
            } else {
                 html += `<p class="text-sm text-gray-700">本日無特別美食備註。</p>`;
            }

            html += `</div>`;

            container.innerHTML = html;
        }

        // ===================================
        // 天氣頁籤函式 (WEATHER Tab Functions)
        // ===================================

        // 渲染總覽天氣卡片
        function renderOverviewWeather() {
            const data = OVERVIEW_WEATHER_DATA;
            
            // 福岡
            document.getElementById('weather-icon-fukuoka').className = `fa-solid ${data.Fukuoka.icon} text-3xl text-custom-primary mb-1`;
            document.getElementById('weather-temp-fukuoka').textContent = `${data.Fukuoka.min}°C / ${data.Fukuoka.max}°C`;
            document.getElementById('weather-rain-fukuoka').textContent = `降雨率: ${data.Fukuoka.rain}`;
            
            // 長崎
            document.getElementById('weather-icon-nagasaki').className = `fa-solid ${data.Nagasaki.icon} text-3xl text-custom-secondary mb-1`;
            document.getElementById('weather-temp-nagasaki').textContent = `${data.Nagasaki.min}°C / ${data.Nagasaki.max}°C`;
            document.getElementById('weather-rain-nagasaki').textContent = `降雨率: ${data.Nagasaki.rain}`;
            
            // 熊本
            document.getElementById('weather-icon-kumamoto').className = `fa-solid ${data.Kumamoto.icon} text-3xl text-custom-primary mb-1`;
            document.getElementById('weather-temp-kumamoto').textContent = `${data.Kumamoto.min}°C / ${data.Kumamoto.max}°C`;
            document.getElementById('weather-rain-kumamoto').textContent = `降雨率: ${data.Kumamoto.rain}`;
        }


        // 渲染每日詳細天氣 (在「天氣」頁籤中)
        function renderWeather() {
            const container = document.getElementById('weather-content');
            container.innerHTML = '';
            
            const dates = getDateKeys();
            
            dates.forEach(dateKey => {
                const data = WEATHER_DATA[dateKey];
                if (data) {
                    const minTemp = data.min.toFixed(1);
                    const maxTemp = data.max.toFixed(1);
                    
                    container.innerHTML += `
                        <div class="flex items-center justify-between p-3 border-b last:border-b-0">
                            <div class="flex-1">
                                <p class="text-md font-bold text-gray-800">${dateKey} - ${data.city}</p>
                                <p class="text-sm text-gray-600">${data.description} (降雨率: ${data.rain_chance})</p>
                            </div>
                            <div class="text-right flex items-center">
                                <i class="fa-solid ${data.icon} text-4xl text-custom-primary mr-3"></i>
                                <div>
                                    <p class="text-xl font-bold text-gray-900">${maxTemp}°C / ${minTemp}°C</p>
                                    <p class="text-xs text-gray-500">高溫 / 低溫</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // ===================================
        // 記帳頁籤函式 (Expense Tracking Functions - 簡化版)
        // ===================================
        
        let EXPENSES = [];
        const EXCHANGE_RATE = 4.8; // 假設的 TWD/JPY 匯率
        const BUDGET = 50000; // 總預算
        
        function getTwdEquivalent(amount, currency) {
            if (currency === 'JPY') {
                return Math.round(amount / EXCHANGE_RATE);
            }
            return amount;
        }
        
        function selectCurrency(currency) {
            document.querySelectorAll('.active-currency').forEach(btn => btn.classList.remove('active-currency'));
            document.querySelector(`[data-currency="${currency}"]`).classList.add('active-currency');
            document.getElementById('expense-currency').value = currency;
        }

        function selectPayer(payer) {
            document.querySelectorAll('.active-payer').forEach(btn => btn.classList.remove('active-payer'));
            document.querySelector(`[data-payer="${payer}"]`).classList.add('active-payer');
            document.getElementById('expense-payer').value = payer;
        }
        
        function selectCategory(category) {
            document.querySelectorAll('.active-category').forEach(btn => btn.classList.remove('active-category'));
            document.querySelector(`[data-category="${category}"]`).classList.add('active-category');
            document.getElementById('expense-category').value = category;
        }
        
        function selectPayment(payment) {
            document.querySelectorAll('.active-payment').forEach(btn => btn.classList.remove('active-payment'));
            document.querySelector(`[data-payment="${payment}"]`).classList.add('active-payment');
            document.getElementById('expense-payment').value = payment;
        }
        
        function addExpense() {
            const date = document.getElementById('expense-date').value || new Date().toISOString().slice(0, 10);
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const currency = document.getElementById('expense-currency').value;
            const payer = document.getElementById('expense-payer').value;
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value.trim();
            const payment = document.getElementById('expense-payment').value;

            if (isNaN(amount) || amount <= 0 || !category) {
                alert('請輸入有效金額和類別！');
                return;
            }

            const newExpense = {
                id: Date.now(),
                date: date,
                amount: amount,
                currency: currency,
                payer: payer,
                category: category,
                description: description || '無說明',
                payment: payment,
                twd: getTwdEquivalent(amount, currency)
            };
- localStorage.setItem('tripExpenses', JSON.stringify(EXPENSES));
+ saveToFirebase();
            EXPENSES.unshift(newExpense); // 新增到清單最前面
            localStorage.setItem('tripExpenses', JSON.stringify(EXPENSES));

            // 重設表單
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-description').value = '';
            
            renderExpenseTracking();
        }

        function deleteExpense(id) {
            EXPENSES = EXPENSES.filter(e => e.id !== id);
            localStorage.setItem('tripExpenses', JSON.stringify(EXPENSES));
            renderExpenseTracking();
        }

        let currentFilterCategory = 'All';

        function setFilterCategory(category) {
            currentFilterCategory = category;
            document.querySelectorAll('.active-filter').forEach(btn => btn.classList.remove('active-filter'));
            const targetBtn = document.querySelector(`[data-filter="${category}"]`);
            if (targetBtn) {
                 targetBtn.classList.add('active-filter');
            }
           
            renderExpenseList();
        }
        
        function renderExpenseList() {
            const listContainer = document.getElementById('expense-list');
            const filteredExpenses = EXPENSES.filter(e => currentFilterCategory === 'All' || e.category === currentFilterCategory);
            
            if (filteredExpenses.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 text-sm">
                    ${currentFilterCategory === 'All' ? '尚無支出紀錄' : `在 ${currentFilterCategory} 類別下無紀錄`}
                </p>`;
                return;
            }

            listContainer.innerHTML = filteredExpenses.map(e => `
                <div class="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm">
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-400">${e.date} / ${e.payment}</p>
                        <p class="font-semibold text-gray-800 truncate">${e.description || e.category}</p>
                        <p class="text-xs font-medium text-custom-secondary mt-1">
                            ${e.category} | ${e.payer} 支付
                        </p>
                    </div>
                    <div class="text-right ml-3 flex items-center">
                        <div class="mr-2">
                            <p class="text-lg font-bold text-gray-900">${e.amount.toLocaleString()} ${e.currency}</p>
                            <p class="text-xs text-gray-500">約 NT$ ${e.twd.toLocaleString()}</p>
                        </div>
                        <button onclick="deleteExpense(${e.id})" class="text-red-400 hover:text-red-600 transition duration-150 ml-2">
                            <i class="fa-solid fa-trash-can text-sm"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderExpenseTracking() {
            // 1. 渲染匯率
            document.getElementById('exchange-rate-display').textContent = `1 JPY ? ${EXCHANGE_RATE.toFixed(2)} TWD`;
            
            // 2. 計算總結
            let totalSpentTWD = 0;
            let joshPaidTWD = 0;
            let candicePaidTWD = 0;
            
            EXPENSES.forEach(e => {
                totalSpentTWD += e.twd;
                if (e.payer === 'Josh') {
                    joshPaidTWD += e.twd;
                } else if (e.payer === 'Candice') {
                    candicePaidTWD += e.twd;
                }
            });

            const remainingBudget = BUDGET - totalSpentTWD;
            const sharedTotal = totalSpentTWD;
            const halfShared = Math.round(sharedTotal / 2);
            
            let settlementResult = '';
            const joshDiff = joshPaidTWD - halfShared;
            const candiceDiff = candicePaidTWD - halfShared;

            if (Math.abs(joshDiff) < 1) {
                settlementResult = '雙方付費平均，無需結算。';
            } else if (joshDiff > 0) {
                settlementResult = `Candice 需支付給 Josh $${Math.abs(joshDiff).toLocaleString()} TWD。`;
            } else {
                settlementResult = `Josh 需支付給 Candice $${Math.abs(candiceDiff).toLocaleString()} TWD。`;
            }
            
            // 3. 更新 UI
            document.getElementById('total-budget').textContent = BUDGET.toLocaleString();
            document.getElementById('total-spent').textContent = totalSpentTWD.toLocaleString();
            document.getElementById('remaining-budget').textContent = remainingBudget.toLocaleString();
            document.getElementById('josh-paid').textContent = joshPaidTWD.toLocaleString();
            document.getElementById('candice-paid').textContent = candicePaidTWD.toLocaleString();
            document.getElementById('settlement-result').textContent = settlementResult;

            // 4. 渲染篩選按鈕 (確保所有類別都有按鈕)
            const allCategories = ['Food', 'Transport', 'Accommodation', 'Shopping', 'Other'];
            const filterContainer = document.getElementById('category-filter-buttons');
            filterContainer.innerHTML = `
                <button type="button" class="block-select-btn px-2 py-1 text-xs active-filter" data-filter="All" onclick="setFilterCategory('All')">
                    <i class="fa-solid fa-list-ul mr-1"></i> 全部
                </button>
            `;
            allCategories.forEach(category => {
                const icon = {
                    'Food': 'fa-utensils',
                    'Transport': 'fa-train-subway',
                    'Accommodation': 'fa-hotel',
                    'Shopping': 'fa-bag-shopping',
                    'Other': 'fa-ellipsis'
                }[category];
                const button = document.createElement('button');
                button.className = `block-select-btn px-2 py-1 text-xs`;
                button.setAttribute('data-filter', category);
                button.onclick = () => setFilterCategory(category);
                button.innerHTML = `<i class="fa-solid ${icon} mr-1"></i> ${category}`;
                filterContainer.appendChild(button);
            });
            // 確保篩選器狀態正確
            setFilterCategory(currentFilterCategory); 

            // 5. 渲染支出列表
            renderExpenseList();
        }


        // ===================================
        // 慾望清單頁籤函式 (Wishlist Tab Functions)
        // ===================================

        let WISHLIST = JSON.parse(localStorage.getItem('tripWishlist')) || [];
        
        function addWishlistItem(event) {
            event.preventDefault();
            const name = document.getElementById('wishlist-name').value.trim();
            const category = document.getElementById('wishlist-category').value;
            const price = parseFloat(document.getElementById('wishlist-price').value);

            if (!name || isNaN(price) || price <= 0 || !category) {
                alert('請填寫完整且有效的項目名稱、分類和價格！');
                return;
            }

            const newItem = {
                id: Date.now(),
                name: name,
                category: category,
                price: price, // JPY
                purchased: false
            };

            WISHLIST.unshift(newItem); 
            localStorage.setItem('tripWishlist', JSON.stringify(WISHLIST));

            // 重設表單
            document.getElementById('wishlist-form').reset();
            
            renderWishlist();
        }

        function togglePurchaseStatus(id) {
            const item = WISHLIST.find(i => i.id === id);
            if (item) {
                item.purchased = !item.purchased;
                localStorage.setItem('tripWishlist', JSON.stringify(WISHLIST));
                renderWishlist();
            }
        }

        function deleteWishlistItem(id) {
            WISHLIST = WISHLIST.filter(i => i.id !== id);
            localStorage.setItem('tripWishlist', JSON.stringify(WISHLIST));
            renderWishlist();
        }

        function renderWishlist() {
            const listContainer = document.getElementById('wishlist-list');
            
            if (WISHLIST.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 text-sm">尚無待購項目</p>`;
                return;
            }

            // 將未購買的放在前面
            const sortedList = [...WISHLIST].sort((a, b) => (a.purchased === b.purchased) ? 0 : a.purchased ? 1 : -1);

            listContainer.innerHTML = sortedList.map(item => {
                const statusText = item.purchased ? '已購買' : '待購買';
                const statusClass = item.purchased ? 'purchased' : 'pending';
                const twdEquivalent = getTwdEquivalent(item.price, 'JPY');
                
                return `
                    <div class="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-800">${item.name}</p>
                            <p class="text-xs text-gray-500 mt-1">${item.category}</p>
                        </div>
                        <div class="text-right ml-3 flex items-center">
                            <div class="mr-3">
                                <p class="text-md font-bold text-gray-900">${item.price.toLocaleString()} JPY</p>
                                <p class="text-xs text-gray-500">約 NT$ ${twdEquivalent.toLocaleString()}</p>
                            </div>
                            <button onclick="togglePurchaseStatus(${item.id})" class="wishlist-status-btn ${statusClass} mr-2">
                                <i class="fa-solid fa-${item.purchased ? 'check' : 'hourglass-half'} mr-1"></i> ${statusText}
                            </button>
                            <button onclick="deleteWishlistItem(${item.id})" class="text-red-400 hover:text-red-600 transition duration-150">
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ===================================
        // 主要導航函式 (Main Navigation)
        // ===================================
        function switchMainNav(targetId) {
            // 隱藏所有內容區塊
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // 顯示目標內容區塊
            document.getElementById(targetId).classList.remove('hidden');

            // 更新底部導航按鈕的 active 狀態
            document.querySelectorAll('.bottom-nav-button').forEach(btn => {
                if (btn.getAttribute('data-target') === targetId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }


        // ===================================
        // 初始化
        // ===================================
        document.addEventListener('DOMContentLoaded', () => {
            renderDateButtons();
            renderOverviewWeather(); // 渲染總覽天氣卡片
            
            // 初始化記帳和慾望清單 (如果使用者切換到這兩個頁籤才會完全渲染)
            renderExpenseTracking(); 
            renderWishlist(); 
            
            // 確保頁面初始顯示行程頁籤
            switchMainNav('itinerary-tab');
        });
    </script>
</body>
</html>