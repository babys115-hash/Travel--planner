<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>My Travel History</title>
        <link rel="icon" type="image/png" href="./luggage.png">
        <link rel="apple-touch-icon" href="./luggage.png">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <script src="https://cdn.tailwindcss.com"></script>
        <style type="text/tailwindcss">
            :root {
                --custom-primary: #FF8BA7;
                --custom-secondary: #4ECDC4;
                --custom-danger: #FF6B6B;
                --custom-bg: #FFFDF9;
                --custom-text: #595959;
            }

            body {
                font-family: 'Zen Maru Gothic', sans-serif !important;
                color: var(--custom-text);
                background-color: var(--custom-bg);
            }

            .bg-gray-50 {
                background-color: var(--custom-bg) !important;
            }

            .bg-white {
                background-color: #ffffff;
            }

            .bg-custom-primary {
                background-color: var(--custom-primary);
            }

            .text-custom-primary {
                color: var(--custom-primary);
            }

            .bg-custom-secondary {
                background-color: var(--custom-secondary);
            }

            .text-custom-secondary {
                color: var(--custom-secondary);
            }

            .rounded-lg {
                border-radius: 16px !important;
            }

            .rounded-xl {
                border-radius: 20px !important;
            }

            .tab-button {
                padding: 10px 16px;
                margin-right: 8px;
                border-radius: 24px;
                cursor: pointer;
                text-align: center;
                transition: all 0.3s;
                min-width: 85px;
                border: 2px solid #F0F0F0;
                color: #9CA3AF;
                background: white;
                font-weight: bold;
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .tab-button.active {
                background-color: var(--custom-primary);
                color: white;
                border-color: var(--custom-primary);
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 139, 167, 0.3);
            }

            .main-nav-btn {
                @apply flex-1 py-4 text-center transition duration-200 text-gray-500 border-b-4 border-transparent; }

            .main-nav-btn.active {
                color: var(--custom-primary);
                border-color: var(--custom-primary);
                font-weight: 800;
            }

            input, select, textarea {
                border: 2px solid #F3F4F6 !important;
                transition: all 0.2s;
                outline: none;
                @apply rounded-2xl bg-gray-50 text-gray-700 font-bold; }

            input:focus, select:focus, textarea:focus {
                border-color: var(--custom-primary) !important;
                background-color: white;
            }

            .block-select-btn {
                @apply px-4 py-2 border-2 rounded-full text-sm font-bold transition-all duration-200 mr-2 mb-2 bg-white flex-shrink-0 cursor-pointer text-gray-400 border-gray-100; }

            .active-filter, .active-category, .active-payment, .active-payer {
                background-color: #FF7596 !important;
                border-color: #FF7596 !important;
                color: white !important;
                box-shadow: 0 4px 6px rgba(255, 117, 150, 0.2);
            }

            /* Updated Split Buttons */
            .split-type-btn {
                @apply flex-1 py-2 rounded-xl text-sm font-bold transition-all border-2 border-transparent; }

            .split-type-btn.active {
                @apply bg-[#FF8BA7] text-white shadow-md; }

            .split-type-btn.inactive {
                @apply bg-white text-gray-400 border-gray-100; }

            /* Updated Beneficiary Buttons */
            .beneficiary-btn {
                @apply px-4 py-2 rounded-full text-sm font-bold border-2 transition-all mr-2 mb-2 flex-1 text-center justify-center; }

            .beneficiary-btn.active {
                @apply bg-[#4ECDC4] border-[#4ECDC4] text-white shadow-sm; transform: scale(1.05);
            }

            .beneficiary-btn.inactive {
                @apply bg-white border-gray-200 text-gray-400; }

            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }

            .timeline-container::before {
                content: '';
                position: absolute;
                top: 20px;
                bottom: 20px;
                left: 23px;
                width: 2px;
                background-image: linear-gradient(to bottom, #FFE5EA 50%, transparent 50%);
                background-size: 2px 10px;
                z-index: 0;
            }

            .filter-card-active {
                @apply ring-2 ring-offset-1 transform scale-105; }

            .filter-card-active.blue {
                @apply ring-blue-400 bg-blue-50; }

            .filter-card-active.green {
                @apply ring-green-400 bg-green-50; }

            .filter-card-active.purple {
                @apply ring-purple-400 bg-purple-50; }
        </style>
        <script type="module">
            import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
            import {getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc, writeBatch, getDocs, where} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
            import {getStorage, ref, uploadBytes, getDownloadURL} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

            const firebaseConfig = {
                apiKey: "AIzaSyBRjYjvwvCNTRHdI8vH8n3GPabzSnSDbvI",
                authDomain: "jp-b0e03.firebaseapp.com",
                projectId: "jp-b0e03",
                storageBucket: "jp-b0e03.firebasestorage.app",
                messagingSenderId: "689610031212",
                appId: "1:689610031212:web:f63f2efe61d4ad562bd849"
            };
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const storage = getStorage(app);

            window.TRIP_LIST = [];
            window.CURRENT_TRIP_ID = '';
            window.ITINERARY_DATA = [];
            window.EXPENSES_DATA = [];
            window.WISHLIST_DATA = [];
            window.PACKING_DATA = [];
            window.SPOTS_DATA = [];
            window.TRIP_PARTICIPANTS = ['Josh', 'Candice'];
            window.CURRENT_CURRENCY = 'JPY';
            window.EXCHANGE_RATE = 0.215;

            let ACTIVE_DATE = ''
              , ACTIVE_PAYER = 'Josh'
              , ACTIVE_CATEGORY = 'Food'
              , ACTIVE_PAYMENT = 'Cash'
              , ACTIVE_SPLIT_TYPE = 'shared'
              , ACTIVE_BENEFICIARIES = [];
            let PAYER_FILTER = 'All'
              , PAYMENT_FILTER = 'All'
              , CATEGORY_FILTER = 'All';
            let EDIT_PAYER = ''
              , EDIT_CATEGORY = ''
              , EDIT_PAYMENT = ''
              , EDIT_SPLIT_TYPE = 'shared'
              , EDIT_BENEFICIARIES = [];

            window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
            window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
            window.addDocWithTripId = async (c, d) => await addDoc(collection(db, c), {
                ...d,
                tripId: window.CURRENT_TRIP_ID
            });
            window.updateDoc = updateDoc;
            window.doc = doc;
            window.db = db;
            window.openImagePreview = (url) => {
                if (url) {
                    document.getElementById('preview-full-image').src = url;
                    document.getElementById('imagePreviewModal').classList.remove('hidden');
                }
            }
            ;
            window.closeImagePreview = () => {
                document.getElementById('imagePreviewModal').classList.add('hidden');
                document.getElementById('preview-full-image').src = '';
            }
            ;
            window.previewImage = (input, imgId, containerId) => {
                if (input.files && input.files[0]) {
                    const r = new FileReader();
                    r.onload = (e) => {
                        document.getElementById(imgId).src = e.target.result;
                        document.getElementById(containerId).classList.remove('hidden');
                    }
                    ;
                    r.readAsDataURL(input.files[0]);
                }
            }
            ;

            document.addEventListener('DOMContentLoaded', () => {
                window.initTripList();
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                // Initialize currency UI based on default selection
                window.saveTripCurrency(); 
            }
            );

            // --- Currency Management ---
            window.saveTripCurrency = () => {
                const sel = document.getElementById('currency-selector');
                window.CURRENT_CURRENCY = sel.value;
                window.updateCurrencyUI();
                updateLiveExchangeRate();
            };

            window.updateCurrencyUI = () => {
                const cur = window.CURRENT_CURRENCY;

                // 1. Update Add Expense Form
                const addContainer = document.getElementById('add-currency-container');
                if (addContainer) {
                    const btns = addContainer.querySelectorAll('button');
                    btns.forEach(b => {
                        // We assume TWD is the home currency and shouldn't change
                        if (b.textContent.trim() !== 'TWD') {
                            b.innerText = cur;
                            b.setAttribute('data-currency', cur);
                            // Update the click handler to select the new currency
                            b.onclick = () => window.selectCurrency(cur);
                            
                            // If the hidden input is currently set to a non-TWD value (old foreign), update it
                            const hiddenInput = document.getElementById('expense-currency');
                            if (hiddenInput.value !== 'TWD') {
                                window.selectCurrency(cur);
                            }
                        }
                    });
                }

                // 2. Update Edit Expense Form
                const editContainer = document.getElementById('edit-currency-container');
                if (editContainer) {
                    const btns = editContainer.querySelectorAll('button');
                    btns.forEach(b => {
                        if (b.textContent.trim() !== 'TWD') {
                            b.innerText = cur;
                            b.setAttribute('data-currency', cur);
                            b.onclick = () => window.selectCurrency(cur, 'edit-');
                        }
                    });
                }

                // 3. Update Overview Simple Converter
                const calcLabel = document.getElementById('calc-currency-label');
                if (calcLabel) {
                    calcLabel.innerText = cur;
                }
                
                // Clear calculator inputs to avoid confusion
                document.getElementById('calc-jpy').value = '';
                document.getElementById('calc-twd').value = '0';
            };

            async function updateLiveExchangeRate() {
                try {
                    const res = await fetch(`https://open.er-api.com/v6/latest/${window.CURRENT_CURRENCY}`);
                    const data = await res.json();
                    if (data.result === 'success') {
                        window.EXCHANGE_RATE = data.rates.TWD;
                        // Update Rate Displays
                        document.getElementById('exchange-rate-display').innerText = ': ' + window.EXCHANGE_RATE.toFixed(4);
                        document.getElementById('calc-rate-display').innerText = window.EXCHANGE_RATE.toFixed(4);
                        
                        // Recalculate calculator if it has value
                        if(document.getElementById('calc-jpy').value) {
                            window.calculateTwd();
                        }
                        // Refresh dashboard to apply new rate to foreign expenses
                        window.renderExpenseDashboard();
                    }
                } catch (e) {
                    console.error("Exchange rate fetch failed", e);
                }
            }

            // --- Trip Management ---
            window.initTripList = () => {
                onSnapshot(query(collection(db, "trips_meta"), orderBy("startDate", "desc")), (snap) => {
                    window.TRIP_LIST = snap.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    if (!window.TRIP_LIST.find(t => t.id === 'trip_legacy_default')) {
                        setDoc(doc(db, "trips_meta", "trip_legacy_default"), {
                            name: 'Á¶èÂ≤°Èï∑Â¥éÁÜäÊú¨ 2025',
                            startDate: '2025-12-25',
                            days: 6,
                            color: 'pink'
                        }, {
                            merge: true
                        });
                    }
                    window.renderTripList();
                }
                );
            }
            ;
            window.renderTripList = () => {
                document.getElementById('trip-list-container').innerHTML = window.TRIP_LIST.map(t => `<div onclick="window.enterTrip('${t.id}')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-4 cursor-pointer hover:shadow-md transition relative group"><div class="flex items-center"><div class="w-14 h-14 rounded-full bg-${t.color === 'blue' ? 'blue' : 'pink'}-100 text-${t.color === 'blue' ? 'blue' : 'pink'}-500 flex items-center justify-center text-2xl mr-4"><i class="fa-solid ${t.color === 'blue' ? 'fa-earth-asia' : 'fa-suitcase'}"></i></div><div class="flex-1"><h3 class="font-bold text-lg text-gray-700 mb-1">${t.name}</h3><p class="text-xs text-gray-400 font-bold">${t.startDate} ¬∑ ${t.days} Days</p></div><div class="flex gap-2" onclick="event.stopPropagation()"><button onclick="window.deleteTrip('${t.id}')" class="text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-trash-can"></i></button></div></div></div>`).join('');
            }
            ;
            window.enterTrip = (id) => {
                window.CURRENT_TRIP_ID = id;
                const trip = window.TRIP_LIST.find(t => t.id === id);
                window.CURRENT_TRIP_NAME = trip ? trip.name : 'My Trip';
                document.getElementById('trip-list-view').classList.add('hidden');
                document.getElementById('trip-dashboard-view').classList.remove('hidden');
                document.getElementById('trip-title-display').innerText = window.CURRENT_TRIP_NAME;
                document.getElementById('trip-name-input').value = window.CURRENT_TRIP_NAME;
                if (id === 'trip_legacy_default') {
                    document.getElementById('legacy-import-container').classList.remove('hidden');
                } else {
                    document.getElementById('legacy-import-container').classList.add('hidden');
                }
                window.ITINERARY_DATA = [];
                window.EXPENSES_DATA = [];
                window.startDataSync();
            }
            ;
            window.exitTrip = () => {
                window.location.reload();
            }
            ;
            window.calculateTripDays = () => {
                const start = new Date(document.getElementById('new-trip-start').value);
                const end = new Date(document.getElementById('new-trip-end').value);
                if (start && end && end >= start) {
                    const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    document.getElementById('new-trip-days').value = diff;
                }
            }
            ;
            window.createNewTrip = async (e) => {
                e.preventDefault();
                const name = document.getElementById('new-trip-name').value;
                const start = document.getElementById('new-trip-start').value;
                const days = parseInt(document.getElementById('new-trip-days').value);
                const ref = await addDoc(collection(db, "trips_meta"), {
                    name,
                    startDate: start,
                    days,
                    color: 'blue',
                    createdAt: serverTimestamp()
                });
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const startDate = new Date(start);
                for (let i = 0; i < days; i++) {
                    const d = new Date(startDate);
                    d.setDate(startDate.getDate() + i);
                    const dateId = d.toISOString().split('T')[0];
                    await setDoc(doc(db, "itineraries", dateId), {
                        tripId: ref.id,
                        date: dateId,
                        day_of_week: dayNames[d.getDay()],
                        city: `Day ${i + 1}`
                    });
                }
                await setDoc(doc(db, "trips_settings", ref.id), {
                    totalBudget: 0,
                    participants: ['Josh', 'Candice'],
                    tripName: name
                });
                window.closeModal('createTripModal');
                window.enterTrip(ref.id);
            }
            ;
            window.deleteTrip = async (id) => {
                if (confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§ÊóÖÁ®ã? (Ë≥áÊñôÂ∞áÁÑ°Ê≥ïÂæ©Âéü)')) {
                    await deleteDoc(doc(db, "trips_meta", id));
                }
            }
            ;

            // --- Data Sync ---
            window.startDataSync = () => {
                const isLegacy = window.CURRENT_TRIP_ID === 'trip_legacy_default';
                const filterFn = d => isLegacy ? (!d.tripId || d.tripId === 'trip_legacy_default') : d.tripId === window.CURRENT_TRIP_ID;

                // Sync Metadata
                onSnapshot(doc(db, "trips_meta", window.CURRENT_TRIP_ID), (docSnap) => {
                    if (docSnap.exists()) {
                        const meta = docSnap.data();
                        document.getElementById('overview-duration-display').innerText = meta.days || 0;
                        window.renderTripSummaryBlock(meta.startDate, meta.days);
                    } else if (isLegacy) {
                        document.getElementById('overview-duration-display').innerText = 6;
                        window.renderTripSummaryBlock('2025-12-25', 6);
                    }
                }
                );

                onSnapshot(query(collection(db, "expenses"), orderBy("date", "desc")), (snap) => {
                    window.EXPENSES_DATA = snap.docs.map(d => ({
                        id: d.id,
                        ...d.data()
                    })).filter(filterFn);
                    window.renderExpenseDashboard();
                }
                );

                onSnapshot(collection(db, "itineraries"), (snap) => {
                    const rawDocs = snap.docs.map(d => ({
                        id: d.id,
                        ...d.data()
                    })).filter(filterFn);
                    const dateMap = {};
                    rawDocs.forEach(d => {
                        if (!d.date)
                            return;
                        if (!dateMap[d.date]) {
                            dateMap[d.date] = {
                                ...d,
                                activities: []
                            };
                        }
                        if (d.activities && Array.isArray(d.activities)) {
                            dateMap[d.date].activities = [...dateMap[d.date].activities, ...d.activities];
                        }
                        if (d.city && d.city !== 'Day X')
                            dateMap[d.date].city = d.city;
                        if (d.id === d.date)
                            dateMap[d.date].id = d.id;
                        else if (!dateMap[d.date].id)
                            dateMap[d.date].id = d.id;
                    }
                    );
                    window.ITINERARY_DATA = Object.values(dateMap).sort( (a, b) => a.date.localeCompare(b.date));
                    window.ITINERARY_DATA.forEach(d => {
                        if (d.activities)
                            d.activities.sort( (a, b) => a.time.localeCompare(b.time));
                    }
                    );
                    if (window.ITINERARY_DATA.length > 0 && (!ACTIVE_DATE || !window.ITINERARY_DATA.find(d => d.id === ACTIVE_DATE))) {
                        ACTIVE_DATE = window.ITINERARY_DATA[0].id;
                    }
                    window.generateDateTabs();
                    window.renderItinerary();
                    window.populateItineraryModalDates();
                }
                );

                onSnapshot(collection(db, "wishlists"), (snap) => {
                    window.WISHLIST_DATA = snap.docs.map(d => ({
                        id: d.id,
                        ...d.data()
                    })).filter(filterFn);
                    window.renderWishlist();
                }
                );
                onSnapshot(collection(db, "packinglist"), (snap) => {
                    window.PACKING_DATA = snap.docs.map(d => ({
                        id: d.id,
                        ...d.data()
                    })).filter(filterFn);
                    window.renderPackingList();
                }
                );
                onSnapshot(collection(db, "spots"), (snap) => {
                    window.SPOTS_DATA = snap.docs.map(d => ({
                        id: d.id,
                        ...d.data()
                    })).filter(filterFn);
                    window.renderSpots();
                }
                );

                const settingsRef = isLegacy ? doc(db, "trips", "currentTrip") : doc(db, "trips_settings", window.CURRENT_TRIP_ID);
                onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        window.TOTAL_BUDGET = data.totalBudget || 0;
                        if (data.participants)
                            window.TRIP_PARTICIPANTS = data.participants;
                        window.renderExpensePayerButtons();
                        window.renderBeneficiaryButtons();
                        window.renderExpenseDashboard();
                        window.renderParticipantsList();
                    }
                }
                );
            }
            ;

            window.bindLegacyData = async () => {
                if (!confirm("Á¢∫ÂÆöË¶ÅÂ∞áÊâÄÊúâÊú™ÂàÜÈ°ûÁöÑËàäË≥áÊñôÁ∂ÅÂÆöÂà∞Ê≠§ÊóÖÁ®ãÂóéÔºü"))
                    return;
                const btn = document.getElementById('bind-data-btn');
                btn.innerText = "ËôïÁêÜ‰∏≠...";
                btn.disabled = true;
                const batch = writeBatch(db);
                let count = 0;
                const processCollection = (data, colName) => {
                    data.forEach(item => {
                        if (!item.tripId) {
                            const ref = doc(db, colName, item.id);
                            batch.update(ref, {
                                tripId: window.CURRENT_TRIP_ID
                            });
                            count++;
                        }
                    }
                    );
                }
                ;
                processCollection(window.EXPENSES_DATA, 'expenses');
                processCollection(window.ITINERARY_DATA, 'itineraries');
                processCollection(window.WISHLIST_DATA, 'wishlists');
                processCollection(window.PACKING_DATA, 'packinglist');
                processCollection(window.SPOTS_DATA, 'spots');
                if (count > 0) {
                    await batch.commit();
                    alert(`ÊàêÂäüÁ∂ÅÂÆö ${count} Á≠ÜË≥áÊñôÔºÅ`);
                } else {
                    alert("Ê≤íÊúâÁôºÁèæÊú™Á∂ÅÂÆöÁöÑËàäË≥áÊñô„ÄÇ");
                }
                btn.innerText = "üîß ÂåØÂÖ•/Á∂ÅÂÆöËàäË≥áÊñô";
                btn.disabled = false;
            }
            ;
            
            window.switchMainNav = (tid) => {
                document.querySelectorAll('.main-tab-content').forEach(e => e.classList.add('hidden'));
                document.querySelectorAll('.main-nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(tid).classList.remove('hidden');
                document.querySelector(`[data-target="${tid}"]`).classList.add('active');
            }
            ;
            window.switchExpenseView = (v) => {
                document.getElementById('add-expense-container').classList.toggle('hidden', v !== 'add');
                document.getElementById('expense-details-container').classList.toggle('hidden', v !== 'details');
                document.getElementById('tab-add-expense-btn').className = v === 'add' ? 'flex-1 py-3 rounded-2xl text-sm font-bold bg-[#FF8BA7] text-white shadow-md transition-all' : 'flex-1 py-3 rounded-2xl text-sm font-bold bg-white text-gray-400 transition-all hover:bg-gray-50';
                document.getElementById('tab-view-details-btn').className = v === 'details' ? 'flex-1 py-3 rounded-2xl text-sm font-bold bg-[#FF8BA7] text-white shadow-md transition-all' : 'flex-1 py-3 rounded-2xl text-sm font-bold bg-white text-gray-400 transition-all hover:bg-gray-50';
                if (v === 'add') {
                    ACTIVE_BENEFICIARIES = [...window.TRIP_PARTICIPANTS];
                    window.renderBeneficiaryButtons();
                }
            }
            ;

            window.selectCurrency = (c, prefix='') => {
                const id = prefix ? prefix + 'expense-currency' : 'expense-currency';
                const container = prefix ? document.getElementById('edit-currency-container') : document.getElementById('add-currency-container');
                container.querySelectorAll('button').forEach(b => {
                    b.classList.replace('bg-[#FF7596]', 'text-gray-400');
                    b.classList.remove('text-white');
                }
                );
                const btn = container.querySelector(`[data-currency="${c}"]`);
                if(btn) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('bg-[#FF7596]', 'text-white');
                    document.getElementById(id).value = c;
                }
            }
            ;
            window.selectPayer = (p, isEdit=false) => {
                if (isEdit) {
                    EDIT_PAYER = p;
                    window.renderEditExpensePayerButtons();
                    document.getElementById('edit-expense-payer').value = p;
                } else {
                    ACTIVE_PAYER = p;
                    window.renderExpensePayerButtons();
                    document.getElementById('expense-payer').value = p;
                }
            }
            ;
            window.selectCategory = (c, isEdit=false) => {
                if (isEdit) {
                    EDIT_CATEGORY = c;
                    document.querySelectorAll('.edit-category-btn').forEach(b => b.classList.remove('active-category'));
                    document.querySelector(`[data-edit-category="${c}"]`).classList.add('active-category');
                } else {
                    ACTIVE_CATEGORY = c;
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active-category'));
                    document.querySelector(`[data-category="${c}"]`).classList.add('active-category');
                }
            }
            ;
            window.selectPayment = (p, isEdit=false) => {
                if (isEdit) {
                    EDIT_PAYMENT = p;
                    document.querySelectorAll('.edit-payment-btn').forEach(b => b.classList.remove('active-payment'));
                    document.querySelector(`[data-edit-payment="${p}"]`).classList.add('active-payment');
                } else {
                    ACTIVE_PAYMENT = p;
                    document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('active-payment'));
                    document.querySelector(`[data-payment="${p}"]`).classList.add('active-payment');
                }
            }
            ;

            // ‚òÖ‚òÖ‚òÖ UPDATED SPLIT LOGIC ‚òÖ‚òÖ‚òÖ
            window.selectSplitType = (t, isEdit=false) => {
                if (isEdit) {
                    EDIT_SPLIT_TYPE = t;
                    document.getElementById('edit-btn-split-shared').className = t === 'shared' ? 'split-type-btn active' : 'split-type-btn inactive';
                    document.getElementById('edit-btn-split-personal').className = t === 'personal' ? 'split-type-btn active' : 'split-type-btn inactive';
                    // Personal -> Clear to allow single select, Shared -> All
                    EDIT_BENEFICIARIES = t === 'shared' ? [...window.TRIP_PARTICIPANTS] : [];
                    window.renderEditBeneficiaryButtons();
                } else {
                    ACTIVE_SPLIT_TYPE = t;
                    document.getElementById('btn-split-shared').className = t === 'shared' ? 'split-type-btn active' : 'split-type-btn inactive';
                    document.getElementById('btn-split-personal').className = t === 'personal' ? 'split-type-btn active' : 'split-type-btn inactive';
                    ACTIVE_BENEFICIARIES = t === 'shared' ? [...window.TRIP_PARTICIPANTS] : [];
                    window.renderBeneficiaryButtons();
                }
            }
            ;

            window.toggleBeneficiary = (p, isEdit=false) => {
                if (isEdit) {
                    if (EDIT_SPLIT_TYPE === 'personal') {
                        // Radio Button Logic
                        EDIT_BENEFICIARIES = [p];
                    } else {
                        // Checkbox Logic
                        if (EDIT_BENEFICIARIES.includes(p))
                            EDIT_BENEFICIARIES = EDIT_BENEFICIARIES.filter(x => x !== p);
                        else
                            EDIT_BENEFICIARIES.push(p);
                    }
                    window.renderEditBeneficiaryButtons();
                } else {
                    if (ACTIVE_SPLIT_TYPE === 'personal') {
                        // Radio Button Logic
                        ACTIVE_BENEFICIARIES = [p];
                    } else {
                        // Checkbox Logic
                        if (ACTIVE_BENEFICIARIES.includes(p))
                            ACTIVE_BENEFICIARIES = ACTIVE_BENEFICIARIES.filter(x => x !== p);
                        else
                            ACTIVE_BENEFICIARIES.push(p);
                    }
                    window.renderBeneficiaryButtons();
                }
            }
            ;

            window.renderBeneficiaryButtons = () => {
                const container = document.getElementById('beneficiaries-container');
                container.innerHTML = window.TRIP_PARTICIPANTS.map(p => {
                    const isActive = ACTIVE_BENEFICIARIES.includes(p);
                    return `<button type="button" onclick="window.toggleBeneficiary('${p}')" class="beneficiary-btn flex-1 ${isActive ? 'active' : 'inactive'}">${isActive ? '<i class="fa-solid fa-check mr-1"></i>' : ''}${p}</button>`;
                }
                ).join('');
            }
            ;

            window.renderEditBeneficiaryButtons = () => {
                const container = document.getElementById('edit-beneficiaries-container');
                container.innerHTML = window.TRIP_PARTICIPANTS.map(p => {
                    const isActive = EDIT_BENEFICIARIES.includes(p);
                    return `<button type="button" onclick="window.toggleBeneficiary('${p}', true)" class="beneficiary-btn flex-1 ${isActive ? 'active' : 'inactive'}">${isActive ? '<i class="fa-solid fa-check mr-1"></i>' : ''}${p}</button>`;
                }
                ).join('');
            }
            ;

            window.renderExpensePayerButtons = () => {
                document.getElementById('expense-payer-select').innerHTML = window.TRIP_PARTICIPANTS.map(p => `<button type="button" class="payer-btn flex-1 block-select-btn ${p === ACTIVE_PAYER ? 'active-payer' : ''}" data-payer="${p}" onclick="window.selectPayer('${p}')">${p}</button>`).join('');
            }
            ;
            window.renderEditExpensePayerButtons = () => {
                document.getElementById('edit-expense-payer-select').innerHTML = window.TRIP_PARTICIPANTS.map(p => `<button type="button" class="edit-payer-btn flex-1 block-select-btn ${p === EDIT_PAYER ? 'active-payer' : ''}" onclick="window.selectPayer('${p}', true)">${p}</button>`).join('');
            }
            ;
            window.addExpense = async () => {
                const date = document.getElementById('expense-date').value
                  , amount = parseFloat(document.getElementById('expense-amount').value)
                  , desc = document.getElementById('expense-description').value
                  , currency = document.getElementById('expense-currency').value;
                const fileIn = document.getElementById('expense-camera-input');
                if (!date || !amount || !desc)
                    return alert('Ë´ãÂ°´ÂØ´ÂÆåÊï¥');
                let imgUrl = '';
                if (fileIn.files[0]) {
                    const snap = await uploadBytes(ref(storage, `expenses/${Date.now()}_${fileIn.files[0].name}`), fileIn.files[0]);
                    imgUrl = await getDownloadURL(snap.ref);
                }
                await window.addDocWithTripId('expenses', {
                    date,
                    amount,
                    description: desc,
                    currency,
                    payer: ACTIVE_PAYER,
                    category: ACTIVE_CATEGORY,
                    payment: ACTIVE_PAYMENT,
                    splitType: ACTIVE_SPLIT_TYPE,
                    beneficiaries: ACTIVE_BENEFICIARIES,
                    imageUrl: imgUrl,
                    timestamp: serverTimestamp()
                });
                alert('Ë®òÂ∏≥ÊàêÂäü');
                document.getElementById('expense-description').value = '';
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-preview-container').classList.add('hidden');
            }
            ;
            window.togglePayerFilter = (p) => {
                PAYER_FILTER = (PAYER_FILTER === p) ? 'All' : p;
                window.renderExpenseDashboard();
            }
            ;
            window.togglePaymentFilter = (p) => {
                PAYMENT_FILTER = (PAYMENT_FILTER === p) ? 'All' : p;
                window.renderExpenseDashboard();
            }
            ;
            window.toggleCategoryFilter = (c) => {
                CATEGORY_FILTER = (CATEGORY_FILTER === c) ? 'All' : c;
                window.renderExpenseDashboard();
            }
            ;
            window.enableBudgetEdit = () => {
                document.getElementById('budget-display-area').classList.add('hidden');
                document.getElementById('budget-edit-area').classList.remove('hidden');
                document.getElementById('budget-edit-input').value = window.TOTAL_BUDGET;
            }
            ;
            window.saveBudget = async () => {
                const val = parseFloat(document.getElementById('budget-edit-input').value);
                if (!isNaN(val)) {
                    const ref = window.CURRENT_TRIP_ID === 'trip_legacy_default' ? doc(db, "trips", "currentTrip") : doc(db, "trips_settings", window.CURRENT_TRIP_ID);
                    await setDoc(ref, {
                        totalBudget: val
                    }, {
                        merge: true
                    });
                }
                document.getElementById('budget-display-area').classList.remove('hidden');
                document.getElementById('budget-edit-area').classList.add('hidden');
            }
            ;
            window.renderExpenseDashboard = () => {
                let total = 0
                  , cash = 0
                  , card = 0;
                let payerTotals = {};
                window.TRIP_PARTICIPANTS.forEach(p => payerTotals[p] = 0);
                window.EXPENSES_DATA.forEach(e => {
                    const v = e.currency !== 'TWD' ? e.amount * window.EXCHANGE_RATE : e.amount;
                    total += v;
                    if (e.payer && payerTotals[e.payer] !== undefined)
                        payerTotals[e.payer] += v;
                    if (e.payment === 'Cash')
                        cash += v;
                    else
                        card += v;
                }
                );
                document.getElementById('total-budget-display').innerText = (window.TOTAL_BUDGET || 0).toLocaleString();
                document.getElementById('total-spent').innerText = Math.round(total).toLocaleString();
                document.getElementById('overview-budget-display').innerText = window.TOTAL_BUDGET.toLocaleString();
                const colors = ['text-blue-500', 'text-pink-500', 'text-orange-500'];
                document.getElementById('payer-cards-container').innerHTML = window.TRIP_PARTICIPANTS.map( (p, i) => `<div onclick="window.togglePayerFilter('${p}')" class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 cursor-pointer transition ${PAYER_FILTER === p ? 'filter-card-active blue' : 'hover:bg-gray-50'}"><p class="text-xs font-bold mb-1 ${colors[i % 3]} flex justify-between">${p} ‰ªò ${PAYER_FILTER === p ? '<i class="fa-solid fa-check"></i>' : ''}</p><p class="text-xl font-bold text-gray-700">$ ${Math.round(payerTotals[p]).toLocaleString()}</p></div>`).join('');
                const cashActive = PAYMENT_FILTER === 'Cash' ? 'filter-card-active green' : 'hover:bg-gray-50';
                const cardActive = PAYMENT_FILTER === 'Card' ? 'filter-card-active purple' : 'hover:bg-gray-50';
                document.getElementById('payment-cards-container').innerHTML = `<div onclick="window.togglePaymentFilter('Cash')" class="bg-white p-4 rounded-3xl shadow-sm border border-green-100 cursor-pointer transition ${cashActive}"><p class="text-xs font-bold text-green-500 mb-1 flex justify-between">ÁèæÈáëÊîØ‰ªò ${PAYMENT_FILTER === 'Cash' ? '<i class="fa-solid fa-check"></i>' : ''}</p><p class="text-xl font-bold text-gray-700">$ ${Math.round(cash).toLocaleString()}</p></div><div onclick="window.togglePaymentFilter('Card')" class="bg-white p-4 rounded-3xl shadow-sm border border-purple-100 cursor-pointer transition ${cardActive}"><p class="text-xs font-bold text-purple-500 mb-1 flex justify-between">Âà∑Âç°/PayPay ${PAYMENT_FILTER === 'Card' ? '<i class="fa-solid fa-check"></i>' : ''}</p><p class="text-xl font-bold text-gray-700">$ ${Math.round(card).toLocaleString()}</p></div>`;
                let balance = {};
                window.TRIP_PARTICIPANTS.forEach(p => balance[p] = 0);
                window.EXPENSES_DATA.forEach(e => {
                    const val = e.currency !== 'TWD' ? e.amount * window.EXCHANGE_RATE : e.amount;
                    balance[e.payer] += val;
                    const bens = e.beneficiaries && e.beneficiaries.length > 0 ? e.beneficiaries : window.TRIP_PARTICIPANTS;
                    const split = val / bens.length;
                    bens.forEach(b => {
                        if (balance[b] !== undefined)
                            balance[b] -= split;
                    }
                    );
                }
                );
                let maxDebtor = null
                  , maxDebt = 0;
                Object.keys(balance).forEach(p => {
                    if (balance[p] < 0 && Math.abs(balance[p]) > maxDebt) {
                        maxDebtor = p;
                        maxDebt = Math.abs(balance[p]);
                    }
                }
                );
                document.getElementById('settlement-result').innerHTML = maxDebtor ? `<span class="text-[#FF8BA7]">${maxDebtor}</span> ÈúÄÂÜç‰ªòÂá∫ <span class="text-[#FF8BA7]">$${Math.round(maxDebt).toLocaleString()}</span>` : "ÁõÆÂâçÂ∑≤ÁµêÊ∏Ö";
                window.renderExpenseList();
            }
            ;
            window.renderExpenseList = () => {
                const cats = ['All', ...new Set(window.EXPENSES_DATA.map(e => e.category))];
                document.getElementById('category-filter-container').innerHTML = cats.map(c => `<button onclick="window.toggleCategoryFilter('${c}')" class="block-select-btn px-3 py-1 text-xs rounded-full ${CATEGORY_FILTER === c ? 'active-filter' : ''}">${c === 'All' ? 'ÂÖ®ÈÉ®' : c}</button>`).join('');
                const filteredData = window.EXPENSES_DATA.filter(e => {
                    const matchPayer = PAYER_FILTER === 'All' || e.payer === PAYER_FILTER;
                    const matchPayment = PAYMENT_FILTER === 'All' || (PAYMENT_FILTER === 'Cash' ? e.payment === 'Cash' : e.payment !== 'Cash');
                    const matchCategory = CATEGORY_FILTER === 'All' || e.category === CATEGORY_FILTER;
                    return matchPayer && matchPayment && matchCategory;
                }
                );
                const iconMap = {
                    Food: 'fa-utensils',
                    Transport: 'fa-train',
                    Accommodation: 'fa-bed',
                    Shopping: 'fa-bag-shopping',
                    Ticket: 'fa-ticket',
                    Purchasing: 'fa-cart-plus'
                };
                document.getElementById('expense-list').innerHTML = filteredData.map(e => {
                    const twd = e.currency !== 'TWD' ? Math.round(e.amount * window.EXCHANGE_RATE) : e.amount;
                    const imgHtml = e.imageUrl ? `<img src="${e.imageUrl}" class="w-10 h-10 rounded-lg object-cover mr-3 border border-gray-100" onclick="event.stopPropagation(); window.openImagePreview(this.src)">` : `<div class="w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center mr-3 text-custom-primary"><i class="fa-solid ${iconMap[e.category] || 'fa-shapes'}"></i></div>`;
                    return `<div onclick="window.openEditExpenseModal('${e.id}')" class="p-4 mb-3 bg-white rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer hover:shadow-md transition"><div class="flex items-center">${imgHtml}<div><p class="font-bold text-gray-700 text-sm">${e.description}</p><p class="text-xs text-gray-400">${e.date} ¬∑ ${e.payer} ¬∑ ${e.category}</p></div></div><div class="text-right"><p class="font-bold text-[#FF6B6B]">${e.currency} ${e.amount.toLocaleString()}</p><p class="text-[10px] text-gray-400">‚âà ${twd.toLocaleString()}</p></div></div>`;
                }
                ).join('');
            }
            ;
            window.openEditExpenseModal = (id) => {
                const e = window.EXPENSES_DATA.find(x => x.id === id);
                document.getElementById('edit-expense-id').value = id;
                document.getElementById('edit-expense-date').value = e.date || '';
                document.getElementById('edit-expense-amount').value = e.amount;
                document.getElementById('edit-expense-desc').value = e.description;
                document.getElementById('edit-expense-old-image').value = e.imageUrl || '';
                window.selectCurrency(e.currency || 'JPY', 'edit-');
                EDIT_PAYER = e.payer || window.TRIP_PARTICIPANTS[0];
                window.selectPayer(EDIT_PAYER, true);
                EDIT_SPLIT_TYPE = e.splitType || 'shared';
                EDIT_BENEFICIARIES = e.beneficiaries || [...window.TRIP_PARTICIPANTS];
                window.selectSplitType(EDIT_SPLIT_TYPE, true);
                EDIT_CATEGORY = e.category || 'Food';
                window.selectCategory(EDIT_CATEGORY, true);
                EDIT_PAYMENT = e.payment || 'Cash';
                window.selectPayment(EDIT_PAYMENT, true);
                const img = document.getElementById('edit-expense-preview');
                if (e.imageUrl) {
                    img.src = e.imageUrl;
                    img.parentElement.classList.remove('hidden');
                } else {
                    img.parentElement.classList.add('hidden');
                }
                window.openModal('editExpenseModal');
            }
            ;
            window.saveExpenseUpdate = async () => {
                const id = document.getElementById('edit-expense-id').value;
                const fileIn = document.getElementById('edit-expense-file');
                let imgUrl = document.getElementById('edit-expense-old-image').value;
                if (fileIn.files[0]) {
                    const snap = await uploadBytes(ref(storage, `expenses/updated_${Date.now()}_${fileIn.files[0].name}`), fileIn.files[0]);
                    imgUrl = await getDownloadURL(snap.ref);
                }
                await updateDoc(doc(db, "expenses", id), {
                    date: document.getElementById('edit-expense-date').value,
                    amount: parseFloat(document.getElementById('edit-expense-amount').value),
                    description: document.getElementById('edit-expense-description').value,
                    currency: document.getElementById('edit-expense-currency').value,
                    payer: EDIT_PAYER,
                    category: EDIT_CATEGORY,
                    payment: EDIT_PAYMENT,
                    splitType: EDIT_SPLIT_TYPE,
                    beneficiaries: EDIT_BENEFICIARIES,
                    imageUrl: imgUrl
                });
                window.closeModal('editExpenseModal');
            }
            ;
            window.deleteExpense = async () => {
                const id = document.getElementById('edit-expense-id').value;
                if (confirm('Âà™Èô§?')) {
                    await deleteDoc(doc(db, "expenses", id));
                    window.closeModal('editExpenseModal');
                }
            }
            ;
            window.removeEditExpensePhoto = () => {
                document.getElementById('edit-expense-old-image').value = '';
                document.getElementById('edit-expense-preview-container').classList.add('hidden');
            }
            ;

            window.saveTripName = async () => {
                await setDoc(doc(db, "trips_settings", window.CURRENT_TRIP_ID), {
                    tripName: document.getElementById('trip-name-input').value
                }, {
                    merge: true
                });
            }
            ;
            window.updateTripNamePreview = () => {
                document.getElementById('summary-trip-name').innerText = document.getElementById('trip-name-input').value || 'Êú™ÂëΩÂêçÊóÖÁ®ã';
            }
            ;

            window.renderTripSummaryBlock = (startDate, days) => {
                let dateStr = 'Â∞öÊú™ÂÆâÊéíË°åÁ®ã';
                let endDate = '';
                if (startDate && days) {
                    const start = new Date(startDate);
                    const end = new Date(start);
                    end.setDate(start.getDate() + (parseInt(days) - 1));
                    endDate = end.toISOString().split('T')[0];
                    dateStr = `${startDate} ~ ${endDate}`;
                }
                document.getElementById('trip-summary-block').innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-xs text-pink-400 font-bold mb-1 flex items-center">
                            <i class="fa-regular fa-calendar-days mr-2"></i> ${dateStr}
                            <button onclick="window.openEditTripDateModal('${startDate}', '${endDate}')" class="ml-2 text-gray-400 hover:text-custom-primary"><i class="fa-solid fa-pen"></i></button>
                        </p>
                        <h3 id="summary-trip-name" class="text-2xl font-bold text-gray-700 tracking-wide">${window.CURRENT_TRIP_NAME}</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-pink-100 flex items-center justify-center text-pink-400 text-xl shadow-sm"><i class="fa-solid fa-plane"></i></div>
                </div>`;
            }
            ;

            window.openEditTripDateModal = (start, end) => {
                if (start)
                    document.getElementById('edit-trip-start').value = start;
                if (end)
                    document.getElementById('edit-trip-end').value = end;
                window.calculateEditTripDays();
                window.openModal('editTripDateModal');
            }
            ;

            window.calculateEditTripDays = () => {
                const start = new Date(document.getElementById('edit-trip-start').value);
                const end = new Date(document.getElementById('edit-trip-end').value);
                if (start && end && end >= start) {
                    const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    document.getElementById('edit-trip-days').value = diff;
                }
            }
            ;

            window.saveTripDates = async () => {
                const startStr = document.getElementById('edit-trip-start').value;
                const days = parseInt(document.getElementById('edit-trip-days').value);
                if (!startStr || !days)
                    return alert("Ë´ãËº∏ÂÖ•ÂÆåÊï¥Êó•Êúü");

                if (!confirm(`Âç≥Â∞áÊõ¥Êñ∞ÊóÖÁ®ãÊó•ÊúüÔºö${startStr} Ëµ∑ÔºåÂÖ± ${days} Â§©„ÄÇ\n(ÈÄôÂ∞áÊ∏ÖÈô§‰∏¶ÈáçÊñ∞Âª∫Á´ãË°åÁ®ãË°®Êó•ÊúüÊ†ºÂ≠ê)`))
                    return;

                const btn = document.getElementById('save-trip-date-btn');
                btn.innerText = "Êõ¥Êñ∞‰∏≠...";
                btn.disabled = true;

                try {
                    // 1. Delete Old Dates
                    const oldDocs = await getDocs(query(collection(db, "itineraries"), where("tripId", "==", window.CURRENT_TRIP_ID)));
                    const deleteBatch = writeBatch(db);
                    oldDocs.forEach(doc => deleteBatch.delete(doc.ref));
                    await deleteBatch.commit();

                    // 2. Update Meta (even for legacy)
                    const metaRef = doc(db, "trips_meta", window.CURRENT_TRIP_ID);
                    await setDoc(metaRef, {
                        startDate: startStr,
                        days: days
                    }, {
                        merge: true
                    });

                    // 3. Generate New Dates
                    const startDate = new Date(startStr);
                    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    const createBatch = writeBatch(db);

                    for (let i = 0; i < days; i++) {
                        const d = new Date(startDate);
                        d.setDate(startDate.getDate() + i);
                        const dateId = d.toISOString().split('T')[0];
                        const docId = `${window.CURRENT_TRIP_ID}_${dateId}`;
                        const ref = doc(db, "itineraries", docId);
                        createBatch.set(ref, {
                            tripId: window.CURRENT_TRIP_ID,
                            date: dateId,
                            day_of_week: dayNames[d.getDay()],
                            city: `Day ${i + 1}`
                        });
                    }
                    await createBatch.commit();

                    alert("Êó•ÊúüÂ∑≤Êõ¥Êñ∞ÔºÅ");
                    window.closeModal('editTripDateModal');
                    window.enterTrip(window.CURRENT_TRIP_ID);

                } catch (e) {
                    console.error(e);
                    alert("Êõ¥Êñ∞Â§±Êïó: " + e.message);
                } finally {
                    btn.innerText = "Á¢∫Ë™ç‰øÆÊîπ";
                    btn.disabled = false;
                }
            }
            ;

            window.addParticipant = async () => {
                const name = document.getElementById('new-participant-name').value;
                if (!name)
                    return;
                const ref = window.CURRENT_TRIP_ID === 'trip_legacy_default' ? doc(db, "trips", "currentTrip") : doc(db, "trips_settings", window.CURRENT_TRIP_ID);
                await setDoc(ref, {
                    participants: [...window.TRIP_PARTICIPANTS, name]
                }, {
                    merge: true
                });
                document.getElementById('new-participant-name').value = '';
            }
            ;
            window.removeParticipant = async (name) => {
                if (confirm(`ÁßªÈô§ ${name}?`)) {
                    const ref = window.CURRENT_TRIP_ID === 'trip_legacy_default' ? doc(db, "trips", "currentTrip") : doc(db, "trips_settings", window.CURRENT_TRIP_ID);
                    await setDoc(ref, {
                        participants: window.TRIP_PARTICIPANTS.filter(p => p !== name)
                    }, {
                        merge: true
                    });
                }
            }
            ;
            window.renderParticipantsList = () => {
                document.getElementById('participants-list').innerHTML = window.TRIP_PARTICIPANTS.map(p => `<span class="inline-flex items-center bg-blue-50 text-blue-500 px-3 py-1 rounded-full text-sm font-bold mr-2 mb-2 border border-blue-100">${p} <button onclick="window.removeParticipant('${p}')" class="ml-2 text-blue-300 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button></span>`).join('');
            }
            ;
            window.calculateTwd = () => {
                const jpy = parseFloat(document.getElementById('calc-jpy').value) || 0;
                document.getElementById('calc-twd').value = Math.round(jpy * window.EXCHANGE_RATE);
            }
            ;
            window.addSpot = async () => {
                const name = document.getElementById('new-spot-name').value;
                const fileIn = document.getElementById('spot-camera-input');
                if (!name)
                    return alert('Ë´ãËº∏ÂÖ•ÊôØÈªûÂêçÁ®±');
                let imgUrl = '';
                if (fileIn.files[0]) {
                    const snap = await uploadBytes(ref(storage, `spots/${Date.now()}_${fileIn.files[0].name}`), fileIn.files[0]);
                    imgUrl = await getDownloadURL(snap.ref);
                }
                await addDocWithTripId('spots', {
                    name,
                    description: document.getElementById('new-spot-desc').value,
                    link: document.getElementById('new-spot-link').value,
                    imageUrl: imgUrl
                });
                document.getElementById('new-spot-name').value = '';
                document.getElementById('new-spot-desc').value = '';
                document.getElementById('new-spot-link').value = '';
                document.getElementById('spot-preview-container').classList.add('hidden');
            }
            ;
            window.renderSpots = () => {
                document.getElementById('spots-list').innerHTML = window.SPOTS_DATA.map(s => {
                    const img = s.imageUrl ? `<img src="${s.imageUrl}" class="w-full h-32 object-cover rounded-xl mb-3 border border-gray-100 cursor-pointer" onclick="window.openImagePreview(this.src)">` : '';
                    const link = s.link ? `<a href="${s.link}" target="_blank" class="text-xs text-pink-400 hover:underline mt-2 inline-block"><i class="fa-solid fa-map-location-dot mr-1"></i> ÈñãÂïüÂú∞Âúñ</a>` : '';
                    return `<div class="bg-white p-4 rounded-2xl border border-gray-100 mb-4 shadow-sm relative">${img}<div><h3 class="font-bold text-gray-700 text-lg">${s.name}</h3><p class="text-sm text-gray-500 mt-1">${s.description || ''}</p>${link}</div><div class="absolute top-4 right-4 flex gap-2"><button onclick="window.openEditSpotModal('${s.id}')" class="bg-white/80 p-2 rounded-full text-gray-400 hover:text-blue-400"><i class="fa-solid fa-pen"></i></button><button onclick="window.deleteDoc('spots','${s.id}')" class="bg-white/80 p-2 rounded-full text-gray-400 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button></div></div>`;
                }
                ).join('');
            }
            ;
            window.openEditSpotModal = (id) => {
                const s = window.SPOTS_DATA.find(x => x.id === id);
                document.getElementById('edit-spot-id').value = id;
                document.getElementById('edit-spot-name').value = s.name;
                document.getElementById('edit-spot-desc').value = s.description || '';
                document.getElementById('edit-spot-link').value = s.link || '';
                document.getElementById('edit-spot-old-image').value = s.imageUrl || '';
                if (s.imageUrl) {
                    document.getElementById('edit-spot-preview').src = s.imageUrl;
                    document.getElementById('edit-spot-preview-container').classList.remove('hidden');
                }
                window.openModal('editSpotModal');
            }
            ;
            window.saveSpotUpdate = async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-spot-id').value;
                const fileIn = document.getElementById('edit-spot-file');
                let imgUrl = document.getElementById('edit-spot-old-image').value;
                if (fileIn.files[0]) {
                    const snap = await uploadBytes(ref(storage, `spots/updated_${Date.now()}_${fileIn.files[0].name}`), fileIn.files[0]);
                    imgUrl = await getDownloadURL(snap.ref);
                }
                await updateDoc(doc(db, "spots", id), {
                    name: document.getElementById('edit-spot-name').value,
                    description: document.getElementById('edit-spot-desc').value,
                    link: document.getElementById('edit-spot-link').value,
                    imageUrl: imgUrl
                });
                window.closeModal('editSpotModal');
            }
            ;
            window.removeEditSpotPhoto = () => {
                document.getElementById('edit-spot-old-image').value = '';
                document.getElementById('edit-spot-preview-container').classList.add('hidden');
            }
            ;
            window.switchItineraryDate = (id) => {
                ACTIVE_DATE = id;
                window.generateDateTabs();
                window.renderItinerary();
            }
            ;
            window.generateDateTabs = () => {
                document.getElementById('date-buttons-container').innerHTML = window.ITINERARY_DATA.map( (d, i) => `<button onclick="window.switchItineraryDate('${d.id}')" class="tab-button ${d.id === ACTIVE_DATE ? 'active' : ''}"><span class="text-xs opacity-80 mb-1">Day ${i + 1}</span><span class="text-sm font-bold">${d.date.substring(5)} (${d.day_of_week || 'Day'})</span></button>`).join('');
            }
            ;
            window.renderItinerary = () => {
                const d = window.ITINERARY_DATA.find(x => x.id === ACTIVE_DATE);
                const container = document.getElementById('itinerary-container');
                if (!d)
                    return container.innerHTML = '<div class="text-center text-gray-400 py-10">Â∞öÁÑ°Ë°åÁ®ã</div>';

                const headerHtml = `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-pink-100 mb-6 flex justify-between items-center cursor-pointer hover:bg-gray-50" onclick="window.openEditDailyTitleModal()">
                    <h2 class="text-lg font-bold text-gray-700">${d.city || 'Ë®≠ÂÆö‰ªäÊó•Ê®ôÈ°å'} <i class="fa-solid fa-pen text-xs text-gray-300 ml-2"></i></h2>
                    <span class="bg-pink-50 text-custom-primary px-3 py-1 rounded-full text-xs font-bold">${d.date}</span>
                </div>`;

                const activitiesHtml = (d.activities || []).map( (a, i) => {
                    const t = a.title.toLowerCase();
                    let iconClass = 'fa-location-dot';
                    // Default
                    if (t.includes('ÂêÉ') || t.includes('È§ê') || t.includes('È£ü') || t.includes('È£Ø') || t.includes('È∫µ') || t.includes('È£≤') || t.includes('Âñù') || t.includes('ÈÖí') || t.includes('Âíñ') || t.includes('Ëå∂') || t.includes('Áîú') || t.includes('Ëõã') || t.includes('Ááí') || t.includes('Èçã')) {
                        iconClass = 'fa-utensils';
                    } else if (t.includes('Ëªä') || t.includes('Èêµ') || t.includes('Á´ô') || t.includes('jr') || t.includes('Â∑¥Â£´')) {
                        iconClass = 'fa-train-subway';
                    } else if (t.includes('ÂÆø') || t.includes('‰Ωè') || t.includes('È£ØÂ∫ó') || t.includes('check')) {
                        iconClass = 'fa-bed';
                    } else if (t.includes('Ë≤∑') || t.includes('Ë≥º') || t.includes('outlet') || t.includes('ÁôæË≤®')) {
                        iconClass = 'fa-bag-shopping';
                    } else if (t.includes('Ê©ü') || t.includes('È£õ') || t.includes('Ëà™')) {
                        iconClass = 'fa-plane';
                    }

                    const mapLinkHtml = a.link ? `<a href="${a.link}" target="_blank" onclick="event.stopPropagation()" class="text-[#4ECDC4] text-sm ml-2 font-bold hover:underline">(Âú∞Âúñ üó∫Ô∏è)</a>` : '';
                    const noteHtml = a.location ? `<p class="text-xs text-gray-400 mt-1 pl-6">${a.location}</p>` : '';

                    return `
                <div class="flex items-start mb-6 group relative" onclick="window.openEditItineraryModal('${d.id}', ${i})">
                    <div class="w-14 pt-3 text-right mr-4 text-xs font-bold text-gray-400 font-mono">${a.time}</div>
                    <div class="absolute left-[69px] top-4 w-3 h-3 bg-[#FF8BA7] rounded-full ring-4 ring-[#FFFDF9] z-20"></div>
                    <div class="flex-1 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 relative z-10 hover:shadow-md transition cursor-pointer">
                        <div class="flex items-start">
                            <div class="mt-1 mr-2 text-[#FF8BA7]"><i class="fa-solid ${iconClass}"></i></div>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-700 text-base leading-tight">${a.title} ${mapLinkHtml}</h3>
                                ${noteHtml}
                            </div>
                        </div>
                    </div>
                </div>`;
                }
                ).join('');

                container.innerHTML = headerHtml + `<div class="timeline-container relative pl-2">${activitiesHtml}</div>`;
            }
            ;

            window.populateItineraryModalDates = () => {
                document.getElementById('new-itinerary-date').innerHTML = window.ITINERARY_DATA.map(d => `<option value="${d.id}">${d.date} (${d.day_of_week})</option>`).join('');
            }
            ;
            window.openAddItineraryModal = () => {
                window.populateItineraryModalDates();
                if (ACTIVE_DATE) {
                    document.getElementById('new-itinerary-date').value = ACTIVE_DATE;
                }
                window.openModal('addItineraryModal');
            }
            ;

            window.addItineraryItem = async (e) => {
                e.preventDefault();
                const dId = document.getElementById('new-itinerary-date').value;
                const d = window.ITINERARY_DATA.find(x => x.id === dId);
                const act = {
                    time: document.getElementById('new-itinerary-time').value,
                    title: document.getElementById('new-itinerary-title').value,
                    link: document.getElementById('new-itinerary-link').value,
                    location: document.getElementById('new-itinerary-note').value
                };
                await updateDoc(doc(db, "itineraries", dId), {
                    activities: [...(d.activities || []), act].sort( (a, b) => a.time.localeCompare(b.time))
                });
                window.closeModal('addItineraryModal');
                e.target.reset();
            }
            ;

            window.openEditItineraryModal = (dId, idx) => {
                const d = window.ITINERARY_DATA.find(x => x.id === dId);
                const act = d.activities[idx];

                // Populate date dropdown
                const select = document.getElementById('edit-itinerary-date-select');
                select.innerHTML = window.ITINERARY_DATA.map(d => `<option value="${d.id}">${d.date} (${d.day_of_week})</option>`).join('');
                select.value = dId;

                document.getElementById('edit-itinerary-id').value = dId;
                // Old Date ID
                document.getElementById('edit-itinerary-idx').value = idx;
                document.getElementById('edit-itinerary-time').value = act.time;
                document.getElementById('edit-itinerary-title').value = act.title;
                document.getElementById('edit-itinerary-link').value = act.link || '';
                document.getElementById('edit-itinerary-note').value = act.location || '';

                window.openModal('editItineraryModal');
            }
            ;

            window.saveItineraryItem = async (e) => {
                e.preventDefault();
                const oldDateId = document.getElementById('edit-itinerary-id').value;
                const newDateId = document.getElementById('edit-itinerary-date-select').value;
                const idx = parseInt(document.getElementById('edit-itinerary-idx').value);

                const oldDoc = window.ITINERARY_DATA.find(x => x.id === oldDateId);
                const act = oldDoc.activities[idx];

                // Update activity object
                const updatedAct = {
                    ...act,
                    time: document.getElementById('edit-itinerary-time').value,
                    title: document.getElementById('edit-itinerary-title').value,
                    link: document.getElementById('edit-itinerary-link').value,
                    location: document.getElementById('edit-itinerary-note').value
                };

                if (oldDateId === newDateId) {
                    // Same day update
                    let acts = [...oldDoc.activities];
                    acts[idx] = updatedAct;
                    acts.sort( (a, b) => a.time.localeCompare(b.time));
                    await updateDoc(doc(db, "itineraries", oldDateId), {
                        activities: acts
                    });
                } else {
                    // Move to different day
                    // 1. Remove from old
                    const newOldActs = oldDoc.activities.filter( (_, i) => i !== idx);
                    await updateDoc(doc(db, "itineraries", oldDateId), {
                        activities: newOldActs
                    });

                    // 2. Add to new
                    const newDoc = window.ITINERARY_DATA.find(x => x.id === newDateId);
                    const newActs = [...(newDoc.activities || []), updatedAct].sort( (a, b) => a.time.localeCompare(b.time));
                    await updateDoc(doc(db, "itineraries", newDateId), {
                        activities: newActs
                    });
                }
                window.closeModal('editItineraryModal');
            }
            ;

            window.deleteItineraryItem = async () => {
                const dId = document.getElementById('edit-itinerary-id').value
                  , idx = document.getElementById('edit-itinerary-idx').value
                  , d = window.ITINERARY_DATA.find(x => x.id === dId);
                if (confirm('Á¢∫ÂÆöÂà™Èô§?')) {
                    await updateDoc(doc(db, "itineraries", dId), {
                        activities: d.activities.filter( (_, i) => i != idx)
                    });
                    window.closeModal('editItineraryModal');
                }
            }
            ;
            window.openEditDailyTitleModal = () => {
                const d = window.ITINERARY_DATA.find(x => x.id === ACTIVE_DATE);
                document.getElementById('edit-daily-title-input').value = d.city || '';
                window.openModal('editDailyTitleModal');
            }
            ;
            window.saveDailyTitle = async () => {
                const val = document.getElementById('edit-daily-title-input').value;
                await updateDoc(doc(db, "itineraries", ACTIVE_DATE), {
                    city: val
                });
                window.closeModal('editDailyTitleModal');
            }
            ;
            window.addWishlistItem = async (e) => {
                e.preventDefault();
                const name = document.getElementById('wishlist-name').value
                  , price = parseFloat(document.getElementById('wishlist-price').value)
                  , qty = parseInt(document.getElementById('wishlist-qty').value) || 1
                  , fileIn = document.getElementById('item-camera-input');
                if (!name)
                    return;
                let imgUrl = '';
                if (fileIn.files[0]) {
                    const snap = await uploadBytes(ref(storage, `wishlist/${Date.now()}_${fileIn.files[0].name}`), fileIn.files[0]);
                    imgUrl = await getDownloadURL(snap.ref);
                }
                await window.addDocWithTripId('wishlists', {
                    name,
                    price,
                    quantity: qty,
                    category: document.getElementById('wishlist-cat').value,
                    imageUrl: imgUrl,
                    status: 'pending'
                });
                e.target.reset();
                document.getElementById('item-preview-container').classList.add('hidden');
            }
            ;
            window.renderWishlist = () => {
                document.getElementById('wishlist-list').innerHTML = window.WISHLIST_DATA.map(i => `<div onclick="window.openEditWishlistModal('${i.id}')" class="p-4 mb-3 bg-white rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer hover:shadow-md transition"><div><p class="font-bold text-gray-700 text-lg">${i.name} <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full ml-2">x${i.quantity || 1}</span></p><p class="text-xs text-custom-primary mt-1">${i.category}</p></div><div class="flex items-center gap-3"><div class="text-right"><p class="font-bold text-gray-700 text-lg">¬•${(i.price).toLocaleString()}</p>${i.imageUrl ? `<span onclick="event.stopPropagation(); window.openImagePreview('${i.imageUrl}')" class="text-xs text-blue-400 cursor-pointer underline">Êü•ÁúãÁÖßÁâá</span>` : ''}</div></div></div>`).join('');
            }
            ;
            window.openEditWishlistModal = (id) => {
                const item = window.WISHLIST_DATA.find(i => i.id === id);
                document.getElementById('edit-wishlist-id').value = id;
                document.getElementById('edit-wishlist-name').value = item.name;
                document.getElementById('edit-wishlist-price').value = item.price;
                document.getElementById('edit-wishlist-qty').value = item.quantity;
                document.getElementById('edit-wishlist-category').value = item.category;
                document.getElementById('edit-wishlist-old-image').value = item.imageUrl || '';
                if (item.imageUrl) {
                    document.getElementById('edit-wishlist-preview').src = item.imageUrl;
                    document.getElementById('edit-wishlist-preview-container').classList.remove('hidden');
                } else {
                    document.getElementById('edit-wishlist-preview-container').classList.add('hidden');
                }
                window.openModal('editWishlistModal');
            }
            ;
            window.saveWishlistUpdate = async () => {
                const id = document.getElementById('edit-wishlist-id').value;
                const fileIn = document.getElementById('edit-wishlist-file');
                let imgUrl = document.getElementById('edit-wishlist-old-image').value;
                if (fileIn.files[0]) {
                    const snap = await uploadBytes(ref(storage, `wishlist/updated_${Date.now()}_${fileIn.files[0].name}`), fileIn.files[0]);
                    imgUrl = await getDownloadURL(snap.ref);
                }
                await updateDoc(doc(db, "wishlists", id), {
                    name: document.getElementById('edit-wishlist-name').value,
                    price: parseFloat(document.getElementById('edit-wishlist-price').value),
                    quantity: parseInt(document.getElementById('edit-wishlist-qty').value),
                    category: document.getElementById('edit-wishlist-category').value,
                    imageUrl: imgUrl
                });
                window.closeModal('editWishlistModal');
            }
            ;
            window.deleteWishlistItem = async (id) => {
                if (confirm('Âà™Èô§?')) {
                    await deleteDoc(doc(db, "wishlists", document.getElementById('edit-wishlist-id').value));
                    window.closeModal('editWishlistModal');
                }
            }
            ;
            window.removeEditWishlistPhoto = () => {
                document.getElementById('edit-wishlist-old-image').value = '';
                document.getElementById('edit-wishlist-preview-container').classList.add('hidden');
            }
            ;
            window.addPackingItem = async (e) => {
                e.preventDefault();
                const name = document.getElementById('packing-name').value;
                if (!name)
                    return;
                await window.addDocWithTripId('packinglist', {
                    name,
                    category: document.getElementById('packing-cat').value,
                    packed: false
                });
                e.target.reset();
            }
            ;
            window.renderPackingList = () => {
                document.getElementById('packing-list').innerHTML = window.PACKING_DATA.map(i => `<div class="p-4 mb-2 bg-white rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center ${i.packed ? 'opacity-50' : ''}"><div class="flex items-center cursor-pointer flex-1" onclick="window.updateDoc(window.doc(window.db, 'packinglist', '${i.id}'), {packed: !${i.packed}})"><i class="fa-solid ${i.packed ? 'fa-circle-check text-[#4ECDC4]' : 'fa-circle text-gray-200'} text-xl mr-3"></i><div><p class="font-bold text-gray-700 ${i.packed ? 'line-through' : ''}">${i.name}</p><p class="text-xs text-gray-400">${i.category}</p></div></div><button onclick="window.deleteDoc('packinglist', '${i.id}')" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button></div>`).join('');
            }
            ;
            window.deleteDoc = async (c, id) => {
                if (confirm('Âà™Èô§?'))
                    await deleteDoc(doc(db, c, id));
            }
            ;
            window.generateTripDates = async () => {
                const startStr = document.getElementById('trip-start-date').value;
                const days = parseInt(document.getElementById('trip-days').value);
                if (!startStr || !days)
                    return;
                const startDate = new Date(startStr);
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                for (let i = 0; i < days; i++) {
                    const d = new Date(startDate);
                    d.setDate(startDate.getDate() + i);
                    const dateId = d.toISOString().split('T')[0];
                    await setDoc(doc(db, "itineraries", dateId), {
                        date: dateId,
                        day_of_week: dayNames[d.getDay()],
                        tripId: window.CURRENT_TRIP_ID
                    }, {
                        merge: true
                    });
                }
                alert('Ë°åÁ®ãÊó•ÊúüÂ∑≤ÁîüÊàê');
            }
            ;
        </script>
    </head>
    <body class="bg-gray-50 font-sans">
        <div id="imagePreviewModal" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="window.closeImagePreview()">
            <img id="preview-full-image" src="" class="max-w-full max-h-[85vh] rounded-2xl shadow-2xl object-contain">
        </div>
        <!-- 1. LIST VIEW -->
        <div id="trip-list-view" class="max-w-xl mx-auto bg-white min-h-screen shadow-2xl overflow-hidden rounded-none sm:rounded-3xl border border-gray-100 relative p-6">
            <header class="flex justify-between items-center mb-8 mt-4">
                <h1 class="text-2xl font-bold text-gray-800 tracking-wide flex items-center">
                    <i class="fa-solid fa-map-location-dot text-custom-primary mr-3 text-3xl"></i>
                    My History
                </h1>
            </header>
            <div id="trip-list-container"></div>
            <div onclick="window.openModal('createTripModal')" class="w-full py-4 mt-6 bg-gray-50 border-2 border-dashed border-gray-200 rounded-2xl text-gray-400 font-bold hover:border-custom-primary hover:text-custom-primary transition-all flex items-center justify-center cursor-pointer">
                <i class="fa-solid fa-plus mr-2"></i>
                Âª∫Á´ãÊñ∞ÊóÖÁ®ã
            </div>
        </div>
        <!-- 2. DASHBOARD -->
        <div id="trip-dashboard-view" class="max-w-xl mx-auto bg-white min-h-screen shadow-2xl overflow-hidden rounded-none sm:rounded-3xl border border-gray-100 relative hidden">
            <header class="p-4 bg-white sticky top-0 z-20 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center overflow-hidden">
                    <button onclick="window.exitTrip()" class="mr-3 text-gray-400 hover:text-custom-primary flex-shrink-0">
                        <i class="fa-solid fa-chevron-left text-xl"></i>
                    </button>
                    <h1 id="trip-title-display" class="text-xl font-bold text-gray-700 tracking-wide truncate">Trip Name</h1>
                </div>
                <!-- Currency Widget -->
                <div class="flex items-center bg-gray-50 px-2 py-1 rounded-lg text-xs flex-shrink-0 ml-2">
                    <select id="currency-selector" onchange="window.saveTripCurrency()" class="bg-transparent font-bold text-custom-secondary border-none outline-none mr-1 appearance-none cursor-pointer">
                        <option value="JPY">JPY</option>
                        <option value="KRW">KRW</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="THB">THB</option>
                    </select>
                    <span id="exchange-rate-display" class="font-bold text-gray-600 ml-1">...</span>
                </div>
            </header>
            <nav class="flex border-b border-gray-100 text-sm sticky top-[60px] bg-white z-20">
                <button class="main-nav-btn" data-target="overview-tab" onclick="window.switchMainNav('overview-tab')">Á∏ΩË¶Ω</button>
                <button class="main-nav-btn active" data-target="itinerary-tab" onclick="window.switchMainNav('itinerary-tab')">Ë°åÁ®ã</button>
                <button class="main-nav-btn" data-target="expense-tab" onclick="window.switchMainNav('expense-tab')">Ë®òÂ∏≥</button>
                <button class="main-nav-btn" data-target="wishlist-tab" onclick="window.switchMainNav('wishlist-tab')">Ê∏ÖÂñÆ</button>
                <button class="main-nav-btn" data-target="packing-tab" onclick="window.switchMainNav('packing-tab')">ÊâìÂåÖ</button>
            </nav>
            <main class="bg-[#FFFDF9] pb-20 min-h-screen">
                <!-- Expense -->
                <div id="expense-tab" class="main-tab-content hidden p-4">
                    <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-4">
                        <button id="tab-add-expense-btn" onclick="window.switchExpenseView('add')" class="flex-1 py-3 rounded-2xl text-sm font-bold bg-[#FF8BA7] text-white shadow-md transition-all">
                            <i class="fa-solid fa-pen mr-1"></i>
                            Ë®ò‰∏ÄÁ≠Ü
                        </button>
                        <button id="tab-view-details-btn" onclick="window.switchExpenseView('details')" class="flex-1 py-3 rounded-2xl text-sm font-bold bg-white text-gray-400 transition-all hover:bg-gray-50">
                            <i class="fa-solid fa-list mr-1"></i>
                            Êü•ÊòéÁ¥∞
                        </button>
                    </div>
                    <div id="add-expense-container">
                        <div class="bg-white p-6 rounded-[30px] shadow-sm border border-pink-50">
                            <form onsubmit="event.preventDefault(); window.addExpense();">
                                <div class="mb-4">
                                    <label class="text-sm font-bold text-gray-400 block mb-1">Êó•Êúü</label>
                                    <div class="relative">
                                        <input type="date" id="expense-date" class="w-full p-3 pl-4 bg-gray-50 rounded-2xl font-bold text-gray-700">
                                        <i class="fa-regular fa-calendar absolute right-4 top-3.5 text-gray-400 pointer-events-none"></i>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="text-sm font-bold text-gray-400 block mb-1">ÈáëÈ°ç & Âπ£Âà•</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="expense-amount" placeholder="0" class="flex-1 p-3 bg-gray-50 rounded-2xl text-xl font-bold text-gray-700">
                                        <div id="add-currency-container" class="flex bg-gray-100 rounded-2xl p-1 items-center">
                                            <button type="button" data-currency="TWD" onclick="window.selectCurrency('TWD')" class="currency-toggle px-4 py-2 rounded-xl text-sm font-bold text-gray-400 transition-all">TWD</button>
                                            <button type="button" data-currency="JPY" onclick="window.selectCurrency('JPY')" class="currency-toggle px-4 py-2 rounded-xl text-sm font-bold bg-[#FF7596] text-white shadow-md transition-all">JPY</button>
                                            <input type="hidden" id="expense-currency" value="JPY">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="text-sm font-bold text-gray-400 block mb-1">Áî®ÈÄî</label>
                                    <input type="text" id="expense-description" placeholder="‰æãÂ¶Ç: ‰∏ÄËò≠ÊãâÈ∫µ" class="w-full p-3 bg-gray-50 rounded-2xl font-bold text-gray-700">
                                </div>
                                <div class="mb-4">
                                    <label class="text-sm font-bold text-gray-400 block mb-2">Ë™∞‰ªòÈå¢?</label>
                                    <div id="expense-payer-select" class="flex gap-2 bg-gray-50 p-2 rounded-2xl"></div>
                                    <input type="hidden" id="expense-payer" value="Josh">
                                </div>
                                <div class="mb-4">
                                    <label class="text-sm font-bold text-gray-400 block mb-2">ÂàÜÂ∏≥ÊñπÂºè</label>
                                    <div class="border-2 border-dashed border-gray-200 rounded-3xl p-4 bg-gray-50">
                                        <div class="flex gap-2 mb-3">
                                            <button type="button" id="btn-split-shared" onclick="window.selectSplitType('shared')" class="split-type-btn active">
                                                <i class="fa-solid fa-users mr-1"></i>
                                                ÂÖ±ÂêåÂàÜÊìî
                                            </button>
                                            <button type="button" id="btn-split-personal" onclick="window.selectSplitType('personal')" class="split-type-btn inactive">
                                                <i class="fa-solid fa-user mr-1"></i>
                                                ÂÄã‰∫∫Áç®‰∫´
                                            </button>
                                        </div>
                                        <div id="beneficiaries-container" class="flex flex-wrap"></div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="text-sm font-bold text-gray-400 block mb-2">È°ûÂà•</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button type="button" data-category="Food" onclick="window.selectCategory('Food')" class="category-btn block-select-btn active-category">È§êÈ£≤</button>
                                        <button type="button" data-category="Transport" onclick="window.selectCategory('Transport')" class="category-btn block-select-btn">‰∫§ÈÄö</button>
                                        <button type="button" data-category="Accommodation" onclick="window.selectCategory('Accommodation')" class="category-btn block-select-btn">‰ΩèÂÆø</button>
                                        <button type="button" data-category="Shopping" onclick="window.selectCategory('Shopping')" class="category-btn block-select-btn">Ë≥ºÁâ©</button>
                                        <button type="button" data-category="Ticket" onclick="window.selectCategory('Ticket')" class="category-btn block-select-btn">ÈñÄÁ•®</button>
                                        <button type="button" data-category="Purchasing" onclick="window.selectCategory('Purchasing')" class="category-btn block-select-btn">‰ª£Ë≥º</button>
                                    </div>
                                </div>
                                <div class="mb-6">
                                    <button type="button" onclick="document.getElementById('expense-camera-input').click()" class="w-full p-3 mb-2 text-sm font-bold text-pink-500 bg-pink-50 rounded-xl border border-pink-100 flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-camera"></i>
                                        ÊãçÁÖß (ÈÅ∏Â°´)
                                    </button>
                                    <input type="file" id="expense-camera-input" accept="image/*" class="hidden" onchange="window.previewImage(this, 'expense-preview-img', 'expense-preview-container')">
                                    <div id="expense-preview-container" class="hidden mb-2 text-center">
                                        <img id="expense-preview-img" class="h-40 rounded-xl mx-auto border-2 border-pink-100 object-cover">
                                    </div>
                                </div>
                                <button type="submit" class="w-full py-4 rounded-2xl bg-[#FF8BA7] text-white font-bold text-lg shadow-lg hover:bg-[#ff7596] transition-all">Á¢∫Ë™çÁ¥ÄÈåÑ</button>
                            </form>
                        </div>
                    </div>
                    <div id="expense-details-container" class="hidden">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                    <p class="text-xs text-gray-400 font-bold mb-1">Á∏ΩÈ†êÁÆó</p>
                                    <div id="budget-display-area" class="flex items-center gap-2">
                                        <p class="text-2xl font-bold text-gray-800 tracking-wide">
                                            $ <span id="total-budget-display">0</span>
                                        </p>
                                        <button onclick="window.enableBudgetEdit()" class="text-gray-300 hover:text-custom-primary">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                    </div>
                                    <div id="budget-edit-area" class="hidden flex items-center gap-2 mt-1">
                                        <input type="number" id="budget-edit-input" class="w-full p-1 border-b border-pink-200 text-lg font-bold outline-none">
                                        <button onclick="window.saveBudget()" class="text-custom-secondary">
                                            <i class="fa-solid fa-check"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                    <p class="text-xs text-gray-400 font-bold mb-1">Â∑≤ÊîØÂá∫ (TWD)</p>
                                    <p class="text-2xl font-bold text-gray-800 tracking-wide">
                                        $ <span id="total-spent">0</span>
                                    </p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4" id="payer-cards-container"></div>
                            <div class="grid grid-cols-2 gap-4" id="payment-cards-container"></div>
                            <div class="bg-white p-5 rounded-3xl shadow-md border-2 border-pink-50 text-center">
                                <p class="text-xs font-bold text-gray-400 mb-2">ÁµêÁÆóÂª∫Ë≠∞</p>
                                <p id="settlement-result" class="text-lg font-bold text-gray-700">Ë®àÁÆó‰∏≠...</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <div class="mb-2">
                                <span class="text-xs font-bold text-gray-400 ml-1">Ê∂àË≤ªÈ°ûÂà•</span>
                            </div>
                            <div id="category-filter-container" class="flex flex-wrap gap-2 mb-4 overflow-x-auto no-scrollbar"></div>
                            <div id="expense-list" class="space-y-3 pb-24"></div>
                        </div>
                    </div>
                </div>
                <!-- Itinerary -->
                <div id="itinerary-tab" class="main-tab-content p-4">
                    <div class="bg-white p-4 rounded-3xl shadow-sm border-2 border-pink-100 mb-4 flex items-center justify-between bg-pink-50/50 cursor-pointer" onclick="window.open('https://tenki.jp/', '_blank')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center text-pink-400 text-xl">
                                <i class="fa-solid fa-cloud-sun"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-700">Ë°åÁ®ãÂ§©Ê∞£ (tenki.jp)</h3>
                                <p class="text-xs text-gray-400 font-bold">
                                    ÈªûÊìäÊü•ÁúãË©≥Á¥∞È†êÂ†± <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-2 rounded-3xl shadow-sm border border-pink-50 mb-6 sticky top-[70px] z-10">
                        <div id="date-buttons-container" class="flex overflow-x-auto no-scrollbar p-1 gap-2"></div>
                    </div>
                    <div id="itinerary-container"></div>
                    <button onclick="window.openAddItineraryModal()" class="fixed right-6 bottom-24 w-14 h-14 rounded-full bg-[#FF8BA7] text-white shadow-xl flex items-center justify-center text-2xl hover:scale-110 transition z-20">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                <!-- Wishlist -->
                <div id="wishlist-tab" class="main-tab-content hidden p-4">
                    <div class="bg-white p-6 rounded-[30px] shadow-lg border border-pink-100 mb-6">
                        <h3 class="flex items-center mb-4 text-xl font-bold text-gray-700">
                            <i class="fa-solid fa-cart-shopping text-[#FF8BA7] mr-2"></i>
                            Êñ∞Â¢ûÊÖæÊúõ
                        </h3>
                        <form onsubmit="window.addWishlistItem(event)">
                            <input type="text" id="wishlist-name" placeholder="ÂïÜÂìÅÂêçÁ®±" class="w-full p-4 mb-3 border-0 bg-gray-50 rounded-2xl font-bold" required>
                            <div class="flex gap-2 mb-3">
                                <input type="number" id="wishlist-price" placeholder="ÂÉπÊ†º (JPY)" class="flex-1 p-4 border-0 bg-gray-50 rounded-2xl font-bold" required>
                                <input type="number" id="wishlist-qty" value="1" class="w-20 p-4 border-0 bg-gray-50 rounded-2xl font-bold text-center">
                            </div>
                            <div class="relative mb-3">
                                <select id="wishlist-cat" class="w-full p-4 border-0 bg-gray-50 rounded-2xl font-bold appearance-none">
                                    <option value="‰º¥ÊâãÁ¶Æ">üéÅ ‰º¥ÊâãÁ¶Æ</option>
                                    <option value="Ëó•Â¶ù">üíä Ëó•Â¶ù</option>
                                    <option value="ÊúçÈ£æ">üëï ÊúçÈ£æ</option>
                                    <option value="ÈõªÂô®">‚ö° ÈõªÂô®</option>
                                    <option value="ÂÖ∂‰ªñ">‚ú® ÂÖ∂‰ªñ</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-4 top-5 text-gray-400 pointer-events-none"></i>
                            </div>
                            <div class="mb-4">
                                <button type="button" onclick="document.getElementById('item-camera-input').click()" class="w-full p-3 mb-2 text-sm font-bold text-pink-500 bg-pink-50 rounded-xl border border-pink-100 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-camera"></i>
                                    ÊãçÁÖß (ÈÅ∏Â°´)
                                </button>
                                <input type="file" id="item-camera-input" accept="image/*" class="hidden" onchange="window.previewImage(this, 'item-preview-img', 'item-preview-container')">
                                <div id="item-preview-container" class="hidden mb-2 text-center">
                                    <img id="item-preview-img" class="h-40 rounded-xl mx-auto border-2 border-pink-100 object-cover">
                                </div>
                            </div>
                            <button type="submit" class="w-full py-4 font-bold text-white bg-[#FF8BA7] rounded-2xl shadow-md hover:bg-[#ff7596] transition-all">Êñ∞Â¢ûÊ∏ÖÂñÆÈ†ÖÁõÆ</button>
                        </form>
                    </div>
                    <div id="wishlist-list" class="space-y-3"></div>
                </div>
                <!-- Packing -->
                <div id="packing-tab" class="main-tab-content hidden p-4">
                    <div class="bg-white p-6 rounded-[30px] shadow-sm border border-blue-50 mb-6">
                        <h3 class="flex items-center mb-4 text-xl font-bold text-gray-700">
                            <i class="fa-solid fa-shirt text-[#4ECDC4] mr-2"></i>
                            Êñ∞Â¢ûË°åÊùé
                        </h3>
                        <form onsubmit="window.addPackingItem(event)">
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="packing-name" placeholder="Ë≠∑ÁÖß" class="flex-[2] p-4 border-0 bg-gray-50 rounded-2xl font-bold" required>
                                <div class="flex-1 relative">
                                    <select id="packing-cat" class="w-full h-full p-4 border-0 bg-gray-50 rounded-2xl font-bold appearance-none pl-3">
                                        <option value="Ë≠â‰ª∂">ü™™ Ë≠â‰ª∂</option>
                                        <option value="Ë°£Áâ©">üëï Ë°£Áâ©</option>
                                        <option value="ÈõªÂ≠ê">üì± ÈõªÂ≠ê</option>
                                        <option value="Ëó•ÂìÅ">üíä Ëó•ÂìÅ</option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down absolute right-3 top-5 text-gray-400 pointer-events-none text-xs"></i>
                                </div>
                            </div>
                            <button type="submit" class="w-full py-4 font-bold text-white bg-[#4ECDC4] rounded-2xl shadow-md hover:opacity-90 transition-all">Âä†ÂÖ•Ë°åÊùéÁÆ±</button>
                        </form>
                    </div>
                    <div id="packing-list" class="space-y-2"></div>
                </div>
                <!-- Overview -->
                <div id="overview-tab" class="main-tab-content hidden p-4">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-orange-100 mb-6 relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-orange-50 rounded-full opacity-50 pointer-events-none"></div>
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center relative z-10">
                            <i class="fa-solid fa-map-location text-orange-400 text-xl mr-2"></i>
                            ÊóÖÁ®ãË≥áË®ä
                        </h3>
                        <div class="mb-4 relative z-10">
                            <label class="text-xs text-gray-400 block mb-1 font-bold ml-1">ÊóÖÁ®ãÂêçÁ®± (ÈªûÊìäÁ∑®ËºØ)</label>
                            <input type="text" id="trip-name-input" class="w-full p-4 bg-orange-50 border-2 border-transparent rounded-2xl font-bold text-gray-700 text-lg focus:bg-white focus:border-orange-200 outline-none transition-all" oninput="window.updateTripNamePreview()" onchange="window.saveTripName()">
                        </div>
                        <div id="trip-summary-block" class="bg-white border-l-4 border-orange-400 p-5 rounded-r-2xl shadow-sm relative z-10 mt-2"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="p-6 text-center border border-yellow-100 bg-yellow-50 rounded-3xl shadow-sm">
                            <p class="mb-1 text-xs font-bold text-yellow-700 uppercase">Duration</p>
                            <p class="text-2xl font-bold font-mono">
                                <span id="overview-duration-display">0</span>
                                Days
                            </p>
                        </div>
                        <div class="p-6 text-center border border-green-100 bg-green-50 rounded-3xl shadow-sm">
                            <p class="mb-1 text-xs font-bold text-green-700 uppercase">Budget</p>
                            <p class="text-2xl font-bold font-mono">
                                $<span id="overview-budget-display">0</span>
                            </p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-blue-100 mb-6 relative">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center">
                            <i class="fa-solid fa-user-group text-blue-400 text-xl mr-2"></i>
                            ÊóÖ‰º¥Ë®≠ÂÆö
                        </h3>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="new-participant-name" placeholder="Ëº∏ÂÖ•ÂêçÂ≠ó..." class="flex-1 p-3 bg-blue-50 border-0 rounded-xl font-bold outline-none">
                            <button onclick="window.addParticipant()" class="w-12 bg-blue-400 text-white font-bold rounded-xl shadow-md">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <div id="participants-list"></div>
                    </div>
                    <div class="p-6 mb-6 bg-white border border-green-100 shadow-sm rounded-3xl">
                        <h3 class="flex items-center mb-4 text-lg font-bold text-gray-700">
                            <i class="mr-2 fa-solid fa-calculator text-custom-secondary"></i>
                            Á∞°ÊòìÊèõÁÆó
                        </h3>
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <label class="block mb-1 text-xs text-gray-400" id="calc-currency-label">JPY</label>
                                <input type="number" id="calc-jpy" class="w-full p-3 text-lg font-bold border-2 border-gray-100 bg-gray-50 rounded-xl" placeholder="0" oninput="window.calculateTwd()">
                            </div>
                            <i class="mt-4 text-gray-300 fa-solid fa-arrow-right"></i>
                            <div class="flex-1">
                                <label class="block mb-1 text-xs text-gray-400">Âè∞Âπ£ (TWD)</label>
                                <input type="text" id="calc-twd" class="w-full h-[54px] p-3 text-lg font-bold border-2 border-green-100 bg-green-50 text-custom-secondary rounded-xl" readonly value="0">
                            </div>
                        </div>
                        <p class="mt-2 text-xs text-right text-gray-400">
                            ÂåØÁéá: <span id="calc-rate-display" class="font-bold text-custom-danger">0.215</span>
                        </p>
                    </div>
                    <div class="p-6 mb-6 bg-white border border-pink-100 shadow-sm rounded-3xl">
                        <h3 class="flex items-center mb-4 text-lg font-bold text-gray-700">
                            <i class="mr-2 fa-solid fa-location-dot text-custom-primary"></i>
                            ÊÉ≥ÂéªÂú∞ÈªûÊ∏ÖÂñÆ
                        </h3>
                        <div class="space-y-3">
                            <input type="text" id="new-spot-name" placeholder="ÊôØÈªûÂêçÁ®± (ÂøÖÂ°´)" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                            <input type="text" id="new-spot-desc" placeholder="Á∞°ÂñÆÈôÑË®ª (ÈÅ∏Â°´)" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                            <input type="text" id="new-spot-link" placeholder="Google Map ÈÄ£Áµê" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                            <button type="button" onclick="document.getElementById('spot-camera-input').click()" class="flex items-center justify-center w-full gap-2 p-3 font-bold text-gray-500 transition bg-gray-100 rounded-xl hover:bg-gray-200">
                                <i class="fa-solid fa-camera"></i>
                                ÈªûÊàëÊãçÁÖßÊàñÈÅ∏ÁÖßÁâá
                            </button>
                            <input type="file" id="spot-camera-input" accept="image/*" class="hidden" onchange="window.previewImage(this, 'spot-preview-img', 'spot-preview-container')">
                            <div id="spot-preview-container" class="hidden mb-2 text-center">
                                <img id="spot-preview-img" class="h-40 mx-auto object-cover border-2 border-pink-100 rounded-xl">
                            </div>
                            <button onclick="window.addSpot()" class="w-full p-3 font-bold text-white bg-[#FF8BA7] rounded-xl shadow-md active:scale-95">Êñ∞Â¢ûÊôØÈªû</button>
                        </div>
                    </div>
                    <div id="spots-list" class="space-y-4"></div>
                    <!-- Data Binding Button (Only for Legacy Trip) -->
                    <div id="legacy-import-container" class="mt-8 text-center hidden">
                        <button id="bind-data-btn" onclick="window.bindLegacyData()" class="px-6 py-3 bg-gray-100 text-gray-500 font-bold rounded-2xl hover:bg-gray-200 transition text-sm">
                            <i class="fa-solid fa-wrench mr-2"></i>
                            ÂåØÂÖ•/Á∂ÅÂÆöËàäË≥áÊñô
                    
                        </button>
                        <p class="text-[10px] text-gray-400 mt-2">Â∞áÊâÄÊúâÊú™ÂàÜÈ°ûÁöÑË≥áÊñôÊ≠∏Ê™îËá≥Ê≠§ÊóÖÁ®ã</p>
                    </div>
                </div>
            </main>
        </div>
        <!-- Modals -->
        <div id="createTripModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('createTripModal')">
            <div class="w-full max-w-sm p-6 bg-white shadow-2xl rounded-3xl" onclick="event.stopPropagation()">
                <h3 class="flex items-center justify-between mb-6 text-xl font-bold text-gray-700">
                    Âª∫Á´ãÊñ∞ÊóÖÁ®ã
                    <button onclick="window.closeModal('createTripModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 bg-gray-100 rounded-full">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <form onsubmit="window.createNewTrip(event)">
                    <label class="block mb-1 text-sm font-bold text-gray-500">ÊóÖÁ®ãÂêçÁ®±</label>
                    <input type="text" id="new-trip-name" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl" placeholder="‰æãÂ¶Ç: Ê≤ñÁπ©‰∫îÊó•" required>
                    <div class="flex gap-2 mb-3">
                        <div class="flex-1">
                            <label class="block mb-1 text-sm font-bold text-gray-500">ÈñãÂßãÊó•Êúü</label>
                            <input type="date" id="new-trip-start" class="w-full p-3 border-0 bg-gray-50 rounded-xl" required onchange="window.calculateTripDays()">
                        </div>
                        <div class="flex-1">
                            <label class="block mb-1 text-sm font-bold text-gray-500">ÁµêÊùüÊó•Êúü</label>
                            <input type="date" id="new-trip-end" class="w-full p-3 border-0 bg-gray-50 rounded-xl" required onchange="window.calculateTripDays()">
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block mb-1 text-sm font-bold text-gray-500">È†êË®àÂ§©Êï∏</label>
                        <input type="number" id="new-trip-days" class="w-full p-3 border-0 bg-gray-50 rounded-xl text-center font-bold text-custom-primary" readonly>
                    </div>
                    <button type="submit" class="w-full p-3 font-bold text-white shadow-lg bg-custom-primary rounded-2xl">Âª∫Á´ãÊóÖÁ®ã</button>
                </form>
            </div>
        </div>
        <!-- Edit Trip Dates -->
        <div id="editTripDateModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editTripDateModal')">
            <div class="w-full max-w-sm p-6 bg-white shadow-2xl rounded-3xl" onclick="event.stopPropagation()">
                <h3 class="flex items-center justify-between mb-6 text-xl font-bold text-gray-700">
                    Ë™øÊï¥ÊóÖÁ®ãÊó•Êúü
                    <button onclick="window.closeModal('editTripDateModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 bg-gray-100 rounded-full">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <div class="flex gap-2 mb-3">
                    <div class="flex-1">
                        <label class="block mb-1 text-sm font-bold text-gray-500">ÈñãÂßãÊó•Êúü</label>
                        <input type="date" id="edit-trip-start" class="w-full p-3 border-0 bg-gray-50 rounded-xl" onchange="window.calculateEditTripDays()">
                    </div>
                    <div class="flex-1">
                        <label class="block mb-1 text-sm font-bold text-gray-500">ÁµêÊùüÊó•Êúü</label>
                        <input type="date" id="edit-trip-end" class="w-full p-3 border-0 bg-gray-50 rounded-xl" onchange="window.calculateEditTripDays()">
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block mb-1 text-sm font-bold text-gray-500">Â§©Êï∏</label>
                    <input type="number" id="edit-trip-days" class="w-full p-3 border-0 bg-gray-50 rounded-xl text-center font-bold text-custom-primary" readonly>
                </div>
                <button onclick="window.saveTripDates()" id="save-trip-date-btn" class="w-full p-3 font-bold text-white shadow-lg bg-custom-secondary rounded-2xl">Á¢∫Ë™ç‰øÆÊîπ</button>
            </div>
        </div>
        <!-- Edit Expense -->
        <div id="editExpenseModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editExpenseModal')">
            <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[85vh]" onclick="event.stopPropagation()">
                <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">
                    Á∑®ËºØË®òÂ∏≥
                    <button onclick="window.closeModal('editExpenseModal')" class="bg-gray-100 w-8 h-8 rounded-full text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <input type="hidden" id="edit-expense-id">
                <input type="hidden" id="edit-expense-old-image">
                <div class="mb-4">
                    <label class="block mb-1 text-sm font-bold text-gray-500">Êó•Êúü</label>
                    <input type="date" id="edit-expense-date" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl font-bold">
                </div>
                <div class="mb-4">
                    <label class="block mb-1 text-sm font-bold text-gray-500">ÈáëÈ°ç</label>
                    <div class="flex gap-2">
                        <input type="number" id="edit-expense-amount" class="flex-1 p-3 border-0 bg-gray-50 rounded-xl font-bold text-xl">
                        <div id="edit-currency-container" class="flex bg-gray-100 rounded-xl p-1 items-center">
                            <button type="button" data-currency="TWD" onclick="window.selectCurrency('TWD', 'edit-')" class="px-3 py-2 rounded-lg text-sm font-bold text-gray-400">TWD</button>
                            <button type="button" data-currency="JPY" onclick="window.selectCurrency('JPY', 'edit-')" class="px-3 py-2 rounded-lg text-sm font-bold bg-[#FF7596] text-white">JPY</button>
                            <input type="hidden" id="edit-expense-currency">
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-1 text-sm font-bold text-gray-500">Áî®ÈÄî</label>
                    <input type="text" id="edit-expense-desc" class="w-full p-3 mb-4 border-0 bg-gray-50 rounded-xl">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 text-sm font-bold text-gray-500">‰ªòÊ¨æ‰∫∫</label>
                    <div id="edit-expense-payer-select" class="flex gap-2 overflow-x-auto no-scrollbar"></div>
                    <input type="hidden" id="edit-expense-payer">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 text-sm font-bold text-gray-500">ÂàÜÂ∏≥ÊñπÂºè</label>
                    <div class="border-2 border-dashed border-gray-200 rounded-3xl p-4 bg-gray-50">
                        <div class="flex gap-2 mb-3">
                            <button type="button" id="edit-btn-split-shared" onclick="window.selectSplitType('shared', true)" class="split-type-btn active">
                                <i class="fa-solid fa-users mr-1"></i>
                                ÂÖ±ÂêåÂàÜÊìî
                            </button>
                            <button type="button" id="edit-btn-split-personal" onclick="window.selectSplitType('personal', true)" class="split-type-btn inactive">
                                <i class="fa-solid fa-user mr-1"></i>
                                ÂÄã‰∫∫Áç®‰∫´
                            </button>
                        </div>
                        <div id="edit-beneficiaries-container" class="flex flex-wrap"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 text-sm font-bold">È°ûÂà•</label>
                    <div id="edit-expense-category-select" class="grid grid-cols-3 gap-2 mb-6">
                        <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-edit-category="Food" onclick="window.selectEditCategory('Food', true)" class="edit-category-btn block-select-btn">È§êÈ£≤</button>
                        <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-edit-category="Transport" onclick="window.selectEditCategory('Transport', true)" class="edit-category-btn block-select-btn">‰∫§ÈÄö</button>
                        <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-edit-category="Accommodation" onclick="window.selectEditCategory('Accommodation', true)" class="edit-category-btn block-select-btn">‰ΩèÂÆø</button>
                        <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-edit-category="Shopping" onclick="window.selectEditCategory('Shopping', true)" class="edit-category-btn block-select-btn">Ë≥ºÁâ©</button>
                        <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-edit-category="Ticket" onclick="window.selectEditCategory('Ticket', true)" class="edit-category-btn block-select-btn">ÈñÄÁ•®</button>
                        <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-edit-category="Other" onclick="window.selectEditCategory('Other', true)" class="edit-category-btn block-select-btn">ÂÖ∂‰ªñ</button>
                        <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-edit-category="Purchasing" onclick="window.selectEditCategory('Purchasing', true)" class="edit-category-btn block-select-btn">‰ª£Ë≥º</button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 text-sm font-bold text-gray-500">ÊîØ‰ªòÊñπÂºè</label>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" data-edit-payment="Cash" onclick="window.selectPayment('Cash', true)" class="edit-payment-btn block-select-btn">ÁèæÈáë</button>
                        <button type="button" data-edit-payment="Card" onclick="window.selectPayment('Card', true)" class="edit-payment-btn block-select-btn">Âà∑Âç°</button>
                        <button type="button" data-edit-payment="Paypay" onclick="window.selectPayment('Paypay', true)" class="edit-payment-btn block-select-btn">PayPay</button>
                    </div>
                </div>
                <div id="edit-expense-preview-container" class="relative hidden mb-3 text-center">
                    <img id="edit-expense-preview" src="" class="object-cover w-full h-40 border-2 border-pink-100 rounded-xl mb-2">
                    <button type="button" onclick="window.removeEditExpensePhoto()" class="text-red-500 text-sm font-bold hover:underline">üóëÔ∏è ÁßªÈô§ÁÖßÁâá</button>
                </div>
                <button type="button" onclick="document.getElementById('edit-expense-file').click()" class="flex items-center justify-center w-full gap-2 p-2 mb-6 text-sm font-bold text-pink-500 transition border border-pink-100 bg-pink-50 rounded-xl hover:bg-pink-100">
                    <i class="fa-solid fa-camera"></i>
                    Êõ¥ÊèõÁÖßÁâá
                </button>
                <input type="file" id="edit-expense-file" accept="image/*" class="hidden" onchange="window.previewEditExpenseImage(this)">
                <div class="flex gap-3">
                    <button onclick="window.deleteExpense()" class="flex-1 p-3 font-bold text-red-400 border-2 border-red-100 rounded-2xl">Âà™Èô§</button>
                    <button onclick="window.saveExpenseUpdate()" class="flex-[2] p-3 font-bold text-white bg-custom-primary rounded-2xl shadow-lg">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>
        <!-- Edit Wishlist -->
        <div id="editWishlistModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editWishlistModal')">
            <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[85vh]" onclick="event.stopPropagation()">
                <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">
                    Á∑®ËºØÁâ©ÂìÅ
                    <button onclick="window.closeModal('editWishlistModal')" class="bg-gray-100 w-8 h-8 rounded-full text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <input type="hidden" id="edit-wishlist-id">
                <input type="hidden" id="edit-wishlist-old-image">
                <label class="block mb-1 text-sm font-bold text-gray-500">ÂêçÁ®±</label>
                <input type="text" id="edit-wishlist-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>
                <div class="flex gap-2 mb-3">
                    <div class="flex-1">
                        <label class="block mb-1 text-sm font-bold text-gray-500">ÂÉπÊ†º</label>
                        <input type="number" id="edit-wishlist-price" class="w-full p-3 font-bold border-0 bg-gray-50 rounded-xl" required>
                    </div>
                    <div class="w-20">
                        <label class="block mb-1 text-sm font-bold text-gray-500">Êï∏Èáè</label>
                        <input type="number" id="edit-wishlist-qty" class="w-full p-3 border-0 bg-gray-50 rounded-xl text-center" min="1">
                    </div>
                </div>
                <div class="relative mb-3">
                    <select id="edit-wishlist-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl">
                        <option value="‰º¥ÊâãÁ¶Æ">üéÅ ‰º¥ÊâãÁ¶Æ</option>
                        <option value="Ëó•Â¶ù">üíä Ëó•Â¶ù</option>
                        <option value="ÊúçÈ£æ">üëï ÊúçÈ£æ</option>
                        <option value="ÈõªÂô®">‚ö° ÈõªÂô®</option>
                        <option value="ÂÖ∂‰ªñ">‚ú® ÂÖ∂‰ªñ</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-4 top-5 text-gray-400 pointer-events-none"></i>
                </div>
                <div id="edit-wishlist-preview-container" class="relative hidden mb-3 text-center">
                    <img id="edit-wishlist-preview" src="" class="object-cover w-full h-40 border border-gray-200 rounded-xl mb-2">
                    <button type="button" onclick="window.removeEditWishlistPhoto()" class="text-red-500 text-sm font-bold hover:underline">üóëÔ∏è ÁßªÈô§ÁÖßÁâá</button>
                </div>
                <button type="button" onclick="document.getElementById('edit-wishlist-file').click()" class="flex items-center justify-center w-full gap-2 p-2 mb-6 text-sm font-bold text-pink-500 transition border border-pink-100 bg-pink-50 rounded-xl hover:bg-pink-100">
                    <i class="fa-solid fa-camera"></i>
                    Êõ¥ÊèõÁÖßÁâá
                </button>
                <input type="file" id="edit-wishlist-file" accept="image/*" class="hidden" onchange="window.previewEditWishlistImage(this)">
                <div class="flex gap-3">
                    <button onclick="window.deleteWishlistItem()" class="flex-1 p-3 font-bold text-red-400 border-2 border-red-100 rounded-2xl">Âà™Èô§</button>
                    <button onclick="window.saveWishlistUpdate()" class="flex-[2] p-3 font-bold text-white bg-custom-primary rounded-2xl shadow-lg">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>
        <!-- Add Itinerary -->
        <div id="addItineraryModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('addItineraryModal')">
            <div class="w-full max-w-sm p-6 bg-white shadow-2xl rounded-3xl max-h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
                <h3 class="flex items-center justify-between mb-6 text-xl font-bold text-gray-700">
                    Êñ∞Â¢ûË°åÁ®ã
                    <button onclick="window.closeModal('addItineraryModal')" class="bg-gray-100 w-8 h-8 rounded-full text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <form onsubmit="window.addItineraryItem(event)">
                    <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">Âì™‰∏ÄÂ§©?</label>
                    <div class="relative mb-3">
                        <select id="new-itinerary-date" class="w-full p-3 font-bold border-0 appearance-none bg-gray-50 rounded-xl text-gray-700" required></select>
                        <i class="absolute pointer-events-none fa-solid fa-chevron-down right-4 top-4 text-gray-400"></i>
                    </div>
                    <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">ÂπæÈªû?</label>
                    <input type="time" id="new-itinerary-time" class="w-full p-3 mb-3 text-lg font-bold text-center border-0 bg-gray-50 rounded-xl text-gray-700" required>
                    <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">ÂÅö‰ªÄÈ∫º?</label>
                    <input type="text" id="new-itinerary-title" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl text-gray-700" required>
                    <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">Âú∞ÂúñÈÄ£Áµê</label>
                    <input type="text" id="new-itinerary-link" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl text-gray-700">
                    <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">ÂÇôË®ª</label>
                    <textarea id="new-itinerary-note" rows="3" class="w-full p-3 mb-6 border-0 bg-gray-50 rounded-xl text-gray-700"></textarea>
                    <button type="submit" class="w-full p-3 font-bold text-white shadow-lg bg-custom-primary rounded-2xl hover:bg-custom-primary-dark">ÂÆåÊàê</button>
                </form>
            </div>
        </div>
        <div id="editItineraryModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="window.closeModal('editItineraryModal')">
            <div class="w-full max-w-sm p-6 bg-white shadow-2xl rounded-3xl max-h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
                <h3 class="flex items-center justify-between mb-2 text-xl font-bold text-gray-700">
                    Á∑®ËºØË°åÁ®ã
                    <button onclick="window.closeModal('editItineraryModal')" class="bg-gray-100 w-8 h-8 rounded-full text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <!-- Date Selection Dropdown -->
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">Âì™‰∏ÄÂ§©?</label>
                <div class="relative mb-3">
                    <select id="edit-itinerary-date-select" class="w-full p-3 font-bold border-0 appearance-none bg-gray-50 rounded-xl text-gray-700" required></select>
                    <i class="absolute pointer-events-none fa-solid fa-chevron-down right-4 top-4 text-gray-400"></i>
                </div>
                <form onsubmit="window.saveItineraryItem(event)">
                    <input type="hidden" id="edit-itinerary-id">
                    <input type="hidden" id="edit-itinerary-idx">
                    <div class="relative mb-3">
                        <input type="time" id="edit-itinerary-time" class="w-full p-4 pl-12 bg-white border-2 border-gray-100 rounded-2xl font-bold text-gray-700 shadow-sm" required>
                        <i class="fa-regular fa-clock absolute left-4 top-5 text-gray-400"></i>
                    </div>
                    <input type="text" id="edit-itinerary-title" placeholder="Ë°åÁ®ãÊ®ôÈ°å" class="w-full p-4 mb-3 bg-white border-2 border-gray-100 rounded-2xl font-bold text-gray-700 shadow-sm" required>
                    <input type="text" id="edit-itinerary-link" placeholder="Âú∞ÂúñÈÄ£Áµê" class="w-full p-4 mb-3 bg-white border-2 border-gray-100 rounded-2xl text-sm font-bold text-gray-700 shadow-sm">
                    <textarea id="edit-itinerary-note" rows="3" placeholder="ÂÇôË®ª‰∫ãÈ†Ö" class="w-full p-4 mb-6 bg-white border-2 border-gray-100 rounded-2xl text-sm font-bold text-gray-700 shadow-sm resize-none"></textarea>
                    <div class="flex gap-3">
                        <button type="button" onclick="window.deleteItineraryItem()" class="flex-1 py-3 bg-white border-2 border-red-100 text-red-400 font-bold rounded-2xl hover:bg-red-50 transition">Âà™Èô§</button>
                        <button type="submit" class="flex-[2] py-3 bg-[#FF8BA7] text-white font-bold rounded-2xl shadow-lg hover:bg-[#ff7596] transition">ÂÑ≤Â≠ò</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="editDailyTitleModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editDailyTitleModal')">
            <div class="w-full max-w-sm p-6 bg-white shadow-2xl rounded-3xl" onclick="event.stopPropagation()">
                <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">Á∑®ËºØÁï∂Êó•Ê®ôÈ°å</h3>
                <input type="text" id="edit-daily-title-input" class="w-full p-4 mb-4 border-2 border-gray-100 bg-gray-50 rounded-2xl font-bold text-gray-700" placeholder="‰æãÂ¶Ç: È´òÈõÑ -> Á¶èÂ≤°">
                <button onclick="window.saveDailyTitle()" class="w-full p-3 font-bold text-white shadow-lg bg-custom-primary rounded-2xl">ÂÑ≤Â≠ò</button>
            </div>
        </div>
        <div id="editSpotModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editSpotModal')">
            <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
                <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">
                    Á∑®ËºØÊôØÈªû
                    <button onclick="window.closeModal('editSpotModal')" class="bg-gray-100 w-8 h-8 rounded-full text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <form onsubmit="window.saveSpotUpdate(event)">
                    <input type="hidden" id="edit-spot-id">
                    <input type="hidden" id="edit-spot-old-image">
                    <input type="text" id="edit-spot-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>
                    <textarea id="edit-spot-desc" rows="2" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl"></textarea>
                    <input type="text" id="edit-spot-link" class="w-full p-3 mb-4 text-sm border-0 bg-gray-50 rounded-xl">
                    <div id="edit-spot-preview-container" class="relative hidden mb-3 text-center">
                        <img id="edit-spot-preview" src="" class="object-cover w-full h-40 border border-gray-200 rounded-xl mb-2">
                        <button type="button" onclick="window.removeEditSpotPhoto()" class="text-red-500 text-sm font-bold hover:underline">üóëÔ∏è ÁßªÈô§ÁÖßÁâá</button>
                    </div>
                    <button type="button" onclick="document.getElementById('edit-spot-file').click()" class="flex items-center justify-center w-full gap-2 p-2 mb-2 text-sm font-bold text-pink-500 transition border border-pink-100 bg-pink-50 rounded-xl hover:bg-pink-100">
                        <i class="fa-solid fa-camera"></i>
                        Êõ¥ÊèõÁÖßÁâá
                    </button>
                    <input type="file" id="edit-spot-file" accept="image/*" class="hidden" onchange="window.previewEditImage(this, 'edit-spot-preview', 'edit-spot-preview-container')">
                    <button type="submit" class="w-full p-3 mt-4 font-bold text-white shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">ÂÑ≤Â≠ò‰øÆÊîπ</button>
                </form>
            </div>
        </div>
        <div id="editPackingModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editPackingModal')">
            <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
                <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">
                    Á∑®ËºØË°åÊùéÈ†ÖÁõÆ
                    <button onclick="window.closeModal('editPackingModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 transition bg-gray-100 rounded-full hover:bg-gray-200">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <form onsubmit="window.savePackingUpdate(event)">
                    <input type="hidden" id="edit-packing-id">
                    <label class="block mb-1 text-sm font-bold text-gray-500">Áâ©ÂìÅÂêçÁ®±</label>
                    <input type="text" id="edit-packing-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>
                    <label class="block mb-1 text-sm font-bold text-gray-500">ÂàÜÈ°û</label>
                    <div class="relative mb-3">
                        <select id="edit-packing-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl">
                            <option value="Ë≠â‰ª∂">ü™™ Ë≠â‰ª∂</option>
                            <option value="Ë°£Áâ©">üëï Ë°£Áâ©</option>
                            <option value="ÈõªÂ≠ê">üì± 3C</option>
                            <option value="Ëó•ÂìÅ">üíä Ëó•ÂìÅ</option>
                            <option value="Áõ•Ê¥ó">üöø Áõ•Ê¥ó</option>
                            <option value="ÂÖ∂‰ªñ">üß© ÂÖ∂‰ªñ</option>
                        </select>
                        <i class="absolute top-4 right-4 text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i>
                    </div>
                    <button type="submit" id="save-packing-btn" class="w-full p-3 mt-4 font-bold text-white transition shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">ÂÑ≤Â≠ò‰øÆÊîπ</button>
                </form>
            </div>
        </div>
    </body>
</html>