<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦å²¡ç†Šæœ¬è¡Œç¨‹åŠ©æ‰‹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script type="module">
        /* =========================
          Firebase åˆå§‹åŒ– (ä½¿ç”¨ ES Modules)
        ========================= */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import {
            getFirestore,
            collection,
            doc,
            setDoc, // ç”¨æ–¼è¦†å¯«æ•´å€‹æ–‡ä»¶ (ä¾‹å¦‚æ–°å¢è¡Œç¨‹å¤©æ•¸æ™‚)
            addDoc, // ç”¨æ–¼æ–°å¢æ–‡ä»¶ (ä¾‹å¦‚è¨˜å¸³å’Œæ…¾æœ›æ¸…å–®)
            updateDoc, // ç”¨æ–¼æ›´æ–°ç¾æœ‰æ–‡ä»¶ (ä¾‹å¦‚ä¿®æ”¹è¡Œç¨‹å…§å®¹)
            deleteDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        
        // ğŸš¨ è«‹ç¢ºèªé€™æ˜¯æ‚¨çš„çœŸå¯¦é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBRjYjvwvCNTRHdI8vH8n3GPabzSnSDbvI",
            authDomain: "jp-b0e03.firebaseapp.com",
            projectId: "jp-b0e03",
            storageBucket: "jp-b0e03.firebasestorage.app", // å»ºè­°åŠ å…¥
            messagingSenderId: "689610031212", // å»ºè­°åŠ å…¥
            appId: "1:689610031212:web:f63f2efe61d4ad562bd849", // å»ºè­°åŠ å…¥
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /* =========================
          å…¨åŸŸè®Šæ•¸èˆ‡è³‡æ–™ç‹€æ…‹
        ========================= */
        let ITINERARY_DATA = []; // è¡Œç¨‹æ•¸æ“š (ç”¨æ–¼æ¸²æŸ“)
        let EXPENSES_DATA = []; // è¨˜å¸³æ•¸æ“š
        let WISHLIST_DATA = []; // æ…¾æœ›æ¸…å–®æ•¸æ“š
        let ACTIVE_DATE = ''; // ç•¶å‰é¸ä¸­çš„æ—¥æœŸ (è¡Œç¨‹é ç±¤)
        let ACTIVE_CURRENCY = 'TWD';
        let ACTIVE_PAYER = 'Josh';
        let ACTIVE_CATEGORY = 'Food';
        let ACTIVE_PAYMENT = 'Cash';
        let EXPENSE_FILTER = 'All';
        
        // åŒ¯ç‡èˆ‡é ç®— (éœæ…‹è³‡æ–™æˆ–æœªä¾†å¯å¾ Firestore è¼‰å…¥)
        const EXCHANGE_RATE_JPY_TWD = 0.215; 
        const TOTAL_BUDGET_TWD = 50000;
        
        /* =========================
          æ•¸æ“šåŒæ­¥æ ¸å¿ƒ (onSnapshot)
        ========================= */
        function startDataSync() {
            // 1. è¡Œç¨‹æ•¸æ“š (Itineraries) - æŒ‰æ—¥æœŸæ’åº
            const itineraryQuery = query(collection(db, "itineraries"), orderBy("date", "asc"));
            onSnapshot(itineraryQuery, (snapshot) => {
                ITINERARY_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // ç¢ºä¿ activities æ˜¯ä¸€å€‹é™£åˆ—ï¼Œä¸¦æŒ‰æ™‚é–“æ’åº
                    activities: Array.isArray(doc.data().activities) ? 
                                doc.data().activities.sort((a, b) => a.time.localeCompare(b.time)) : []
                }));

                if (ITINERARY_DATA.length > 0) {
                    if (!ACTIVE_DATE) {
                        ACTIVE_DATE = ITINERARY_DATA[0].id; // ä½¿ç”¨ id ä½œç‚ºæ—¥æœŸéµ
                    }
                    window.generateDateTabs();
                    window.renderItinerary();
                    window.populateItineraryModalDates();
                } else {
                    document.getElementById('itinerary-container').innerHTML = '<p class="text-center text-gray-500 mt-8">è«‹åœ¨ Firebase Console ä¸­æ–°å¢è¡Œç¨‹æ•¸æ“šã€‚</p>';
                }
            }, (error) => {
                console.error("Error listening to itineraries: ", error);
            });
            
            // 2. è¨˜å¸³æ•¸æ“š (Expenses) - æŒ‰æ—¥æœŸæ’åº
            const expenseQuery = query(collection(db, "expenses"), orderBy("date", "desc"), orderBy("timestamp", "desc"));
            onSnapshot(expenseQuery, (snapshot) => {
                EXPENSES_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                window.renderExpenseTracking(); // æ•¸æ“šæ›´æ–°æ™‚é‡æ–°æ¸²æŸ“è¨˜å¸³é 
            }, (error) => {
                console.error("Error listening to expenses: ", error);
            });
            
            // 3. æ…¾æœ›æ¸…å–® (Wishlist) - æŒ‰è³¼è²·ç‹€æ…‹å’Œæ™‚é–“æ’åº
            const wishlistQuery = query(collection(db, "wishlists"), orderBy("purchased", "asc"), orderBy("timestamp", "desc"));
            onSnapshot(wishlistQuery, (snapshot) => {
                WISHLIST_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // åªæœ‰åœ¨ wishlist é ç±¤è¢«é¸ä¸­æ™‚æ‰å¼·åˆ¶æ¸²æŸ“ï¼Œé¿å…ä¸å¿…è¦çš„é–‹éŠ·
                if (document.getElementById('wishlist-tab').classList.contains('hidden') === false) {
                     window.renderWishlist(); 
                }
            }, (error) => {
                console.error("Error listening to wishlists: ", error);
            });
            
            // æ¸²æŸ“åŒ¯ç‡ (éœæ…‹)
            document.getElementById('exchange-rate-display').textContent = EXCHANGE_RATE_JPY_TWD.toFixed(4);
        }

        /* ===================================================
          è¡Œç¨‹ (ITINERARY) ç›¸é—œå‡½å¼
        =================================================== */

        // æ¸²æŸ“æ—¥æœŸæŒ‰éˆ•
        window.generateDateTabs = function() {
            const tabContainer = document.getElementById('date-buttons-container');
            if (!tabContainer) return;
            tabContainer.innerHTML = ''; 

            ITINERARY_DATA.forEach((day, index) => {
                const isActive = day.id === ACTIVE_DATE;
                const button = document.createElement('button');
                
                // ç¢ºä¿ä½¿ç”¨ HTML ä¸­å®šç¾©çš„ CSS class
                button.className = `tab-button ${isActive ? 'active' : ''}`;
                button.innerHTML = `
                    <div class="font-bold">Day ${index + 1}</div>
                    <div class="text-xs">${day.date.substring(5)} (${day.day_of_week})</div>
                `;
                
                button.onclick = () => {
                    window.setActiveDate(day.id);
                };
                
                tabContainer.appendChild(button);
            });
        }
        
        // åˆ‡æ›ç•¶å‰é¸ä¸­æ—¥æœŸ
        window.setActiveDate = function(dateId) {
            ACTIVE_DATE = dateId;
            window.generateDateTabs(); 
            window.renderItinerary();  
        }

        // æ¸²æŸ“è¡Œç¨‹å…§å®¹
        window.renderItinerary = function() {
            const contentContainer = document.getElementById('itinerary-container'); 
            if (!contentContainer) return;
            contentContainer.innerHTML = ''; 

            const currentDay = ITINERARY_DATA.find(day => day.id === ACTIVE_DATE);

            if (!currentDay || !currentDay.activities || currentDay.activities.length === 0) {
                contentContainer.innerHTML = `
                    <h2 class="text-xl font-bold p-4 bg-gray-100 border-b border-gray-200">${currentDay ? currentDay.city : 'ç„¡è³‡æ–™'} - ${currentDay ? currentDay.date : 'ç„¡è³‡æ–™'}</h2>
                    <p class="text-center text-gray-500 mt-8">æœ¬æ—¥ç„¡è¡Œç¨‹ï¼Œé»æ“Šå³ä¸‹è§’æ–°å¢ã€‚</p>`;
                return;
            }
            
            let html = `
                <h2 class="text-xl font-bold p-4 bg-gray-100 border-b border-gray-200">${currentDay.city} - ${currentDay.date}</h2>
                <div class="timeline-container p-4">
            `;

            currentDay.activities.forEach((activity, index) => {
                const clickHandler = `window.openEditModal('${currentDay.id}', ${index})`;
                
                html += `
                    <div class="flex items-start mb-6" onclick="${clickHandler}">
                        <div class="w-1/4 text-sm font-semibold text-gray-600 pt-1">${activity.time}</div>
                        <div class="w-3/4">
                            <div class="timeline-item relative">
                                <span class="absolute -left-[1.3rem] top-1 h-3 w-3 rounded-full bg-custom-primary border-2 border-white"></span>
                                <div class="font-bold text-gray-800">${activity.title}</div>
                                <div class="text-sm text-gray-500">${activity.location || ''}</div>
                                ${activity.notes ? `<div class="text-xs text-gray-700 mt-1 italic">${activity.notes}</div>` : ''}
                                ${activity.link ? `<a href="${activity.link}" target="_blank" class="text-xs font-semibold mt-1 inline-block" onclick="event.stopPropagation();"><i class="fas fa-map-marker-alt"></i> å°èˆª</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            contentContainer.innerHTML = html;
        }
        
        // å¡«å……æ–°å¢è¡Œç¨‹ Modal ä¸­çš„æ—¥æœŸé¸é …
        window.populateItineraryModalDates = function() {
            const select = document.getElementById('new-date');
            if (!select) return;
            select.innerHTML = ''; 
            
            ITINERARY_DATA.forEach(day => {
                const option = document.createElement('option');
                option.value = day.id;
                option.textContent = `${day.date.substring(5)} (${day.day_of_week}) - ${day.city}`;
                if (day.id === ACTIVE_DATE) {
                    option.selected = true; 
                }
                select.appendChild(option);
            });
        }
        
        // æ–°å¢è¡Œç¨‹é …ç›® (Add)
        window.addItineraryItem = async function(event) {
            event.preventDefault();
            const dateId = document.getElementById('new-date').value;
            const time = document.getElementById('new-time').value;
            const title = document.getElementById('new-title').value;
            const note = document.getElementById('new-note').value;
            
            if (!dateId || !time || !title) return;

            const newActivity = {
                time: time,
                title: title,
                location: note, // å‡è¨­å‚™è¨»/åœ°é»
                notes: '', 
                link: ''
            };

            try {
                const dayDocRef = doc(db, 'itineraries', dateId);
                const currentDay = ITINERARY_DATA.find(d => d.id === dateId);
                
                if (currentDay) {
                     // è¤‡è£½ä¸¦åŠ å…¥æ–°æ´»å‹•
                    const updatedActivities = [...(currentDay.activities || []), newActivity];

                    // æ ¹æ“šæ™‚é–“æ’åº (å¯é¸ï¼Œä½†å¼·çƒˆå»ºè­°)
                    updatedActivities.sort((a, b) => a.time.localeCompare(b.time));
                    
                    await updateDoc(dayDocRef, {
                        activities: updatedActivities
                    });
                } else {
                    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯ä»¥é¸æ“‡å‰µå»ºä¸€å€‹æ–°çš„æ—¥æœŸæ–‡ä»¶ (é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œå‡è¨­æ–‡ä»¶å·²å­˜åœ¨)
                    alert('æ‰¾ä¸åˆ°å°æ‡‰æ—¥æœŸæ–‡ä»¶ï¼Œè«‹å…ˆåœ¨ Firestore æ–°å¢æ–‡ä»¶ã€‚');
                    return;
                }


                window.closeModal('addItineraryModal');
                document.getElementById('add-itinerary-form').reset(); 
                alert('è¡Œç¨‹æ–°å¢æˆåŠŸï¼');

            } catch (e) {
                console.error("Error adding itinerary item: ", e);
                alert('æ–°å¢è¡Œç¨‹å¤±æ•—ã€‚');
            }
        }

        // é–‹å•Ÿç·¨è¼¯ Modal
        window.openEditModal = function(dateId, index) {
            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay || !currentDay.activities || !currentDay.activities[index]) return;

            const activity = currentDay.activities[index];
            const dayIndex = ITINERARY_DATA.indexOf(currentDay);

            document.getElementById('edit-modal-date-info').textContent = `${currentDay.city} - ${currentDay.date} (Day ${dayIndex + 1})`;
            
            document.getElementById('edit-date-key').value = dateId;
            document.getElementById('edit-item-index').value = index;
            document.getElementById('edit-time').value = activity.time || '';
            document.getElementById('edit-title').value = activity.title || '';
            document.getElementById('edit-note').value = activity.location || activity.notes || ''; 

            window.openModal('editItineraryModal');
        }

        // å„²å­˜ä¿®æ”¹ (Update)
        window.saveItineraryItem = async function(event) {
            event.preventDefault();
            const dateId = document.getElementById('edit-date-key').value;
            const index = parseInt(document.getElementById('edit-item-index').value);
            const time = document.getElementById('edit-time').value;
            const title = document.getElementById('edit-title').value;
            const note = document.getElementById('edit-note').value;

            if (!dateId || index === undefined || !time || !title) return;

            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay) return;

            const updatedActivities = [...currentDay.activities];
            
            updatedActivities[index] = {
                ...updatedActivities[index], 
                time: time,
                title: title,
                location: note, 
                notes: '',
            };
            
            updatedActivities.sort((a, b) => a.time.localeCompare(b.time));

            try {
                await updateDoc(doc(db, 'itineraries', dateId), {
                    activities: updatedActivities
                });
                window.closeModal('editItineraryModal');
                alert('è¡Œç¨‹ä¿®æ”¹æˆåŠŸï¼');
            } catch (e) {
                console.error("Error updating document: ", e);
                alert('è¡Œç¨‹ä¿®æ”¹å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤è¡Œç¨‹é …ç›® (Delete)
        window.deleteItineraryItem = async function(dateId, index) {
            if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹é …ç›®å—ï¼Ÿ')) return;

            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay) return;

            const updatedActivities = currentDay.activities.filter((_, i) => i !== index);

            try {
                await updateDoc(doc(db, 'itineraries', dateId), {
                    activities: updatedActivities
                });
                window.closeModal('editItineraryModal');
                alert('è¡Œç¨‹åˆªé™¤æˆåŠŸï¼');
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert('è¡Œç¨‹åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        /* ===================================================
          è¨˜å¸³ (EXPENSE) ç›¸é—œå‡½å¼
        =================================================== */
/* ===================================================
  è¨˜å¸³ (EXPENSE) ç›¸é—œå‡½å¼
=================================================== */
// æ”¾åœ¨æ‚¨çš„ç¨‹å¼ç¢¼é ‚éƒ¨
let EXPENSESf_DATA = []; // â­ï¸ é€™è£¡æ˜¯é‡è¤‡å®šç¾©ï¼Œæœƒè¦†è“‹æ‰ Firebase è³¦å€¼çš„ EXPENSES_DATA

        // é¸æ“‡å¹£åˆ¥
        window.selectCurrency = function(currency) {
            ACTIVE_CURRENCY = currency;
            document.querySelectorAll('#currency-select .block-select-btn').forEach(btn => {
                btn.classList.remove('active-currency');
                if (btn.getAttribute('data-currency') === currency) {
                    btn.classList.add('active-currency');
                }
            });
            document.getElementById('expense-currency').value = currency;
        }

        // é¸æ“‡ä»˜æ¬¾äºº
        window.selectPayer = function(payer) {
            ACTIVE_PAYER = payer;
            document.querySelectorAll('#payer-select .block-select-btn').forEach(btn => {
                btn.classList.remove('active-payer');
                if (btn.getAttribute('data-payer') === payer) {
                    btn.classList.add('active-payer');
                }
            });
            document.getElementById('expense-payer').value = payer;
        }
        
        // é¸æ“‡é¡åˆ¥ (æ–°å¢æ”¯å‡º)
        window.selectCategory = function(category) {
            ACTIVE_CATEGORY = category;
            document.querySelectorAll('#category-select .block-select-btn').forEach(btn => {
                btn.classList.remove('active-category');
                if (btn.getAttribute('data-category') === category) {
                    btn.classList.add('active-category');
                }
            });
            document.getElementById('expense-category').value = category;
        }
        
        // é¸æ“‡æ”¯ä»˜æ–¹å¼
        window.selectPayment = function(payment) {
            ACTIVE_PAYMENT = payment;
            document.querySelectorAll('#payment-select .block-select-btn').forEach(btn => {
                btn.classList.remove('active-payment');
                if (btn.getAttribute('data-payment') === payment) {
                    btn.classList.add('active-payment');
                }
            });
            document.getElementById('expense-payment').value = payment;
        }

        // é¸æ“‡é¡åˆ¥ (ç¯©é¸æ¸…å–®)
        window.filterExpenses = function(category) {
            EXPENSE_FILTER = category;
            window.renderExpenseTracking(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }

        // æ–°å¢æ”¯å‡º (Add Expense)
        window.addExpense = async function() {
            const date = document.getElementById('expense-date').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const description = document.getElementById('expense-description').value;

            if (!date || isNaN(amount) || amount <= 0 || !description) {
                alert('è«‹æª¢æŸ¥æ—¥æœŸã€é‡‘é¡å’Œç”¨é€”æ˜¯å¦æ­£ç¢ºå¡«å¯«ï¼');
                return;
            }

            const newExpense = {
                date: date,
                amount: amount,
                currency: ACTIVE_CURRENCY,
                payer: ACTIVE_PAYER,
                category: ACTIVE_CATEGORY,
                payment: ACTIVE_PAYMENT,
                description: description,
                timestamp: serverTimestamp() // ä½¿ç”¨ Firestore æœå‹™å™¨æ™‚é–“æˆ³
            };

            try {
                await addDoc(collection(db, "expenses"), newExpense);
                alert('æ”¯å‡ºç´€éŒ„æ–°å¢æˆåŠŸï¼');
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-description').value = '';
            } catch (e) {
                console.error("Error adding expense: ", e);
                alert('æ–°å¢æ”¯å‡ºç´€éŒ„å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤æ”¯å‡º
        window.deleteExpense = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "expenses", id));
                alert('æ”¯å‡ºç´€éŒ„å·²åˆªé™¤ã€‚');
            } catch (e) {
                console.error("Error deleting expense: ", e);
                alert('åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        // è¨ˆç®—ä¸¦æ›´æ–°çµç®—æ‘˜è¦
        window.updateSettlementSummary = function() {
            let joshPaidTWD = 0;
            let candicePaidTWD = 0;
            
            EXPENSES_DATA.forEach(expense => {
                let amountTWD = expense.amount;
                if (expense.currency === 'JPY') {
                    amountTWD = expense.amount * EXCHANGE_RATE_JPY_TWD;
                }
                
                if (expense.payer === 'Josh') {
                    joshPaidTWD += amountTWD;
                } else if (expense.payer === 'Candice') {
                    candicePaidTWD += amountTWD;
                }
            });

            // ç¸½æ”¯å‡ºèˆ‡é ç®—
            const totalSpentTWD = joshPaidTWD + candicePaidTWD;
            const remainingBudget = TOTAL_BUDGET_TWD - totalSpentTWD;

            document.getElementById('total-budget').textContent = TOTAL_BUDGET_TWD.toLocaleString();
            document.getElementById('total-spent').textContent = Math.round(totalSpentTWD).toLocaleString();
            document.getElementById('remaining-budget').textContent = Math.round(remainingBudget).toLocaleString();
            
            // çµç®—çµæœ
            document.getElementById('josh-paid').textContent = Math.round(joshPaidTWD).toLocaleString();
            document.getElementById('candice-paid').textContent = Math.round(candicePaidTWD).toLocaleString();

            const diff = joshPaidTWD - candicePaidTWD;
            const halfDiff = Math.abs(diff) / 2;
            const settlementElement = document.getElementById('settlement-result');

            if (Math.abs(diff) < 1) { // å¿½ç•¥å¾®å°å·®ç•°
                settlementElement.textContent = "ç„¡éœ€çµç®—ã€‚";
                settlementElement.classList.remove('text-red-600', 'text-green-600');
                settlementElement.classList.add('text-gray-900');
            } else if (diff > 0) {
                settlementElement.textContent = `Candice éœ€æ”¯ä»˜ Josh $ ${Math.round(halfDiff).toLocaleString()} TWD`;
                settlementElement.classList.add('text-red-600');
            } else {
                settlementElement.textContent = `Josh éœ€æ”¯ä»˜ Candice $ ${Math.round(halfDiff).toLocaleString()} TWD`;
                settlementElement.classList.add('text-green-600');
            }
        }
        
        // æ¸²æŸ“è¨˜å¸³æ¸…å–®
        window.renderExpenseTracking = function() {
            const expenseList = document.getElementById('expense-list');
            const categories = [...new Set(EXPENSES_DATA.map(e => e.category)), 'All']; // æ‰¾å‡ºæ‰€æœ‰é¡åˆ¥
            
            // æ¸²æŸ“ç¯©é¸æŒ‰éˆ•
            const filterContainer = document.getElementById('category-filter-buttons');
            filterContainer.innerHTML = '';
            categories.forEach(cat => {
                const isActive = cat === EXPENSE_FILTER;
                 filterContainer.innerHTML += `
                    <button type="button" class="block-select-btn px-2 py-1 text-xs ${isActive ? 'active-filter' : ''}" onclick="window.filterExpenses('${cat}')">
                        ${cat}
                    </button>
                `;
            });
            
            // ç¯©é¸æ•¸æ“š
            const filteredExpenses = EXPENSES_DATA.filter(e => EXPENSE_FILTER === 'All' || e.category === EXPENSE_FILTER);

            // æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨
            if (filteredExpenses.length === 0) {
                expenseList.innerHTML = '<p class="text-center text-gray-500 text-sm">å°šç„¡ç¬¦åˆç¯©é¸æ¢ä»¶çš„æ”¯å‡ºç´€éŒ„</p>';
            } else {
                expenseList.innerHTML = filteredExpenses.map(expense => {
                    const amountTWD = expense.currency === 'JPY' 
                        ? (expense.amount * EXCHANGE_RATE_JPY_TWD).toFixed(0) 
                        : expense.amount.toFixed(0);
                        
                    const iconMap = {
                        Food: 'fa-utensils',
                        Transport: 'fa-train-subway',
                        Accommodation: 'fa-hotel',
                        Shopping: 'fa-bag-shopping',
                        Other: 'fa-ellipsis'
                    };
                    const categoryIcon = iconMap[expense.category] || 'fa-ellipsis';
                    
                    return `
                        <div class="p-3 border-b border-gray-100 flex justify-between items-center hover:bg-gray-50 transition duration-150">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-custom-secondary/20 flex items-center justify-center mr-3 text-custom-secondary">
                                    <i class="fa-solid ${categoryIcon}"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">${expense.description}</p>
                                    <p class="text-xs text-gray-500">${expense.date} (${expense.payer} / ${expense.payment})</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-red-600">${expense.currency} ${expense.amount.toLocaleString()}</p>
                                <p class="text-xs text-gray-600">ç´„ $ ${amountTWD.toLocaleString()} TWD</p>
                                <button onclick="window.deleteExpense('${expense.id}')" class="text-red-400 hover:text-red-600 text-xs mt-1">
                                    <i class="fa-solid fa-trash-can"></i> åˆªé™¤
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            window.updateSettlementSummary();
        }
<div id="add-expense-container">
    <h3>æ—…è²»è¨˜å¸³ä¸­å¿ƒ</h3>
    </div>

<div id="expense-details-container" class="hidden">
    
    <div class="mb-4">
        <div class="flex items-center text-sm font-semibold text-gray-700 mb-2">
            ä¾é¡åˆ¥ç¯©é¸æ¸…å–®ï¼š
        </div>
        <div id="category-filter-buttons" class="flex flex-wrap gap-2">
        </div>
    </div>
    
    <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">æ”¯å‡ºæ˜ç´°</h3>
    <div id="expense-list" class="divide-y divide-gray-100">
    </div>

</div>
        /* ===================================================
          æ…¾æœ›æ¸…å–® (WISHLIST) ç›¸é—œå‡½å¼
        =================================================== */
        
        // æ–°å¢æ…¾æœ›æ¸…å–®é …ç›® (Add)
        window.addWishlistItem = async function(event) {
            event.preventDefault();
            const name = document.getElementById('wishlist-name').value;
            const price = parseFloat(document.getElementById('wishlist-price').value);
            const category = document.getElementById('wishlist-category').value;
            
            if (!name || isNaN(price) || price <= 0 || !category) {
                alert('è«‹å¡«å¯«å®Œæ•´é …ç›®åç¨±ã€åƒ¹æ ¼å’Œåˆ†é¡ï¼');
                return;
            }

            const newItem = {
                name: name,
                price: price,
                category: category,
                purchased: false, // é è¨­ç‚ºæœªè³¼è²·
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "wishlists"), newItem);
                alert('æ…¾æœ›æ¸…å–®æ–°å¢æˆåŠŸï¼');
                document.getElementById('wishlist-form').reset();
            } catch (e) {
                console.error("Error adding wishlist item: ", e);
                alert('æ–°å¢æ…¾æœ›æ¸…å–®å¤±æ•—ã€‚');
            }
        }
        
        // åˆ‡æ›è³¼è²·ç‹€æ…‹ (Update)
        window.toggleWishlistStatus = async function(id, currentStatus) {
            try {
                const docRef = doc(db, "wishlists", id);
                await updateDoc(docRef, {
                    purchased: !currentStatus
                });
            } catch (e) {
                console.error("Error updating wishlist status: ", e);
                alert('æ›´æ–°ç‹€æ…‹å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤æ…¾æœ›æ¸…å–®é …ç›®
        window.deleteWishlistItem = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ…¾æœ›æ¸…å–®å—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "wishlists", id));
            } catch (e) {
                console.error("Error deleting wishlist item: ", e);
                alert('åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        // æ¸²æŸ“æ…¾æœ›æ¸…å–®
        window.renderWishlist = function() {
            const wishlistList = document.getElementById('wishlist-list');
            if (!wishlistList) return;
            
            if (WISHLIST_DATA.length === 0) {
                wishlistList.innerHTML = '<p class="text-center text-gray-500 text-sm">å°šç„¡å¾…è³¼é …ç›®</p>';
                return;
            }

            wishlistList.innerHTML = WISHLIST_DATA.map(item => {
                const statusClass = item.purchased ? 'purchased' : 'pending';
                const statusText = item.purchased ? 'âœ… å·²è³¼' : 'âŒ æœªè³¼';
                
                return `
                    <div class="p-3 border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.category}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-custom-primary">Â¥ ${item.price.toLocaleString()}</p>
                            <div class="flex items-center mt-1 space-x-2">
                                <button class="wishlist-status-btn ${statusClass}" 
                                        onclick="window.toggleWishlistStatus('${item.id}', ${item.purchased})">
                                    ${statusText}
                                </button>
                                <button onclick="window.deleteWishlistItem('${item.id}')" class="text-red-400 hover:text-red-600 text-xs">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        /* ===================================================
          é€šç”¨å‡½å¼ (Modal, Navigation, Initialization)
        =================================================== */

        // é–‹å•Ÿ Modal
        window.openModal = function(id) {
            document.getElementById(id).style.display = 'flex';
        }

        // é—œé–‰ Modal
        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        // æ¸²æŸ“ç¸½è¦½å¤©æ°£ (ä¿æŒéœæ…‹ï¼Œå› ç‚ºå¤©æ°£æŸ¥è©¢å¯èƒ½éœ€è¦é¡å¤–çš„ API key)
        window.renderOverviewWeather = function() {
            // é€™å€‹å‡½å¼ä¿æŒéœæ…‹æ¸²æŸ“ï¼Œå¯ä»¥è®“ç”¨æˆ¶è‡ªè¡Œå¡«å……æ¯æ—¥å¤©æ°£
        }
        
        // æ¸²æŸ“æ¯æ—¥å¤©æ°£ (ç›®å‰ç‚ºç©ºï¼Œå¯è‡ªè¡Œå¯¦ä½œ)
        window.renderWeather = function() {
            const weatherContent = document.getElementById('weather-content');
            weatherContent.innerHTML = '<p class="text-center text-gray-500 mt-8">æ¯æ—¥è©³ç´°å¤©æ°£åŠŸèƒ½å¾…å¯¦ä½œ (éœ€ä¸²æ¥ç¬¬ä¸‰æ–¹å¤©æ°£ API)ã€‚</p>';
        }

        // ä¸»è¦å°èˆªå‡½å¼
        window.switchMainNav = function(targetId) {
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            document.getElementById(targetId).classList.remove('hidden');

            document.querySelectorAll('.bottom-nav-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-target') === targetId) {
                    btn.classList.add('active');
                }
            });
            
            // è™•ç†åˆæ¬¡åˆ‡æ›æ™‚çš„æ¸²æŸ“
            if (targetId === 'expense-tab') {
                window.renderExpenseTracking();
            } else if (targetId === 'wishlist-tab') {
                window.renderWishlist();
            } else if (targetId === 'weather-tab') {
                window.renderWeather();
            }
        }


        // ç¶²é è¼‰å…¥å®Œæˆå¾Œå•Ÿå‹•
        document.addEventListener('DOMContentLoaded', () => {
            // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºæ–°å¢æ”¯å‡ºçš„é è¨­æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            const expenseDateInput = document.getElementById('expense-date');
            if (expenseDateInput) {
                 expenseDateInput.value = today;
            }
            
            window.renderOverviewWeather(); // æ¸²æŸ“éœæ…‹å¤©æ°£ç¸½è¦½
            window.switchMainNav('itinerary-tab'); // ç¢ºä¿åˆå§‹é¡¯ç¤ºè¡Œç¨‹é ç±¤
            startDataSync(); // å•Ÿå‹• Firebase æ•¸æ“šåŒæ­¥
        });
        
    </script>

    <script src="https://cdn.tailwindcss.com"></script> 

    <style>
        /* è‡ªè¨‚é¡è‰²ä¸»é¡Œ (æ¸…æ–°/ç¾ä»£æ„Ÿé…è‰²) */
        .bg-custom-primary { background-color: #4A90E2; } /* ä¸»è‰²ï¼šæ·±å¤©ç©ºè— */
        .text-custom-primary { color: #4A90E2; }
        .bg-custom-secondary { background-color: #F5A623; } /* å‰¯è‰²ï¼šæš–é‡‘æ©˜ */
        .text-custom-secondary { color: #F5A623; }
        
        /* è¡Œç¨‹é ç±¤çš„æ—¥æœŸæŒ‰éˆ•æ¨£å¼ */
        .tab-button {
    /* ç¢ºä¿æŒ‰éˆ•ä¸æœƒå› ç‚º Flex è€Œæ”¾å¤§ */
    flex-shrink: 0; 
    /* èª¿æ•´ padding å’Œå­—é«”å¤§å° */
    padding: 0.3rem 0.6rem; 
    font-size: 0.8rem; /* æ•´é«”å­—é«”ç¸®å° */
    line-height: 1.2;
    text-align: center;
    border-radius: 0.5rem;
    cursor: pointer;
    background-color: #f7f7f7;
    transition: background-color 0.2s, color 0.2s;
    border: 1px solid #e0e0e0;
}

/* Day 1 å’Œæ—¥æœŸçš„å­—é«”å¤§å°ä¹Ÿåœ¨ generateDateTabs å‡½å¼ä¸­æ§åˆ¶ */
/* <div class="font-bold">Day ${index + 1}</div>  <-- ä¿æŒé€™å€‹å¤§å°
    <div class="text-xs">${day.date.substring(5)} (${day.day_of_week})</div> <-- ä¿æŒé€™å€‹å¤§å°
*/
        /* è¡Œç¨‹æ™‚é–“è»¸æ¨£å¼ */
        .timeline-item {
            border-left: 2px solid #4A90E2; /* ä½¿ç”¨æ–°çš„ä¸»è‰² */
            padding-left: 1rem;
            cursor: pointer; /* **æ–°å¢ï¼šè®“ä½¿ç”¨è€…çŸ¥é“å¯ä»¥é»æ“Š** */
            transition: background-color 0.2s;
        }
        .timeline-item:hover {
            background-color: #f0f8ff; /* é»æ“Šæ™‚æœ‰æ·ºè‰²æç¤º */
        }
        .timeline-container > div:last-child .timeline-item {
            border-left: none; /* ç§»é™¤æœ€å¾Œä¸€å€‹é …ç›®çš„å·¦é‚Šç·š */
        }
        .timeline-item a {
            color: #F5A623; /* ä½¿ç”¨æ–°çš„å‰¯è‰² */
            text-decoration: underline;
        }
        
        /* åº•éƒ¨å°èˆªæ¬„æ¨£å¼ */
        .bottom-nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0;
            cursor: pointer;
            transition: color 0.2s ease;
            color: #4b5563; 
        }
        .bottom-nav-button.active {
            color: #4A90E2; /* ä½¿ç”¨æ–°çš„ä¸»è‰² */
        }
        
        /* ç¢ºä¿åº•éƒ¨å…§å®¹ä¸æœƒè¢«å›ºå®šå°èˆªæ¬„é®æ“‹ */
        body {
            padding-bottom: 70px; 
        }

        /* è¨˜å¸³é é¢çš„å€å¡Šé»é¸æŒ‰éˆ•æ¨£å¼ */
        .block-select-btn {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap; 
        }
        /* å¹£åˆ¥ã€é¡åˆ¥ã€ç¯©é¸ ä½¿ç”¨å‰¯è‰² (æš–é‡‘æ©˜) */
        .block-select-btn.active-currency,
        .block-select-btn.active-category,
        .block-select-btn.active-filter {
            background-color: #F5A623;
            color: white;
            border-color: #F5A623;
        }
        /* ä»˜æ¬¾äººã€æ”¯ä»˜æ–¹å¼ ä½¿ç”¨ä¸»è‰² (å¤©ç©ºè—) */
        .block-select-btn.active-payer,
        .block-select-btn.active-payment {
            background-color: #4A90E2;
            color: white;
            border-color: #4A90E2;
        }
        
        /* æ…¾æœ›æ¸…å–®çš„å·²è³¼/æœªè³¼æŒ‰éˆ•æ¨£å¼ */
        .wishlist-status-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .wishlist-status-btn.pending {
            background-color: #fca5a5; /* æ·ºç´… */
            color: #7f1d1d; /* æ·±ç´…æ–‡å­— */
        }
        .wishlist-status-btn.purchased {
            background-color: #a7f3d0; /* æ·ºç¶  */
            color: #065f46; /* æ·±ç¶ æ–‡å­— */
        }

        /* Modal æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* é è¨­éš±è— */
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* è¡Œç¨‹æ—¥æœŸæŒ‰éˆ•çš„å®¹å™¨æ¨£å¼ (é…åˆåœ–ç‰‡) */
        #itinerary-overview-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        #itinerary-overview-buttons .tab-button {
            border-radius: 9999px; /* åœ“è§’è† å›Šå½¢ */
            background-color: #E8F3FF; /* æ·ºè—ç™½èƒŒæ™¯ */
            color: #4A90E2; /* è—è‰²æ–‡å­— */
            padding: 0.4rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            border-bottom: none !important; /* ç§»é™¤åŸæœ¬çš„åº•ç·š */
        }
        #itinerary-overview-buttons .tab-button.active {
            background-color: #4A90E2; /* ä¸»è‰² */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-custom-primary text-white shadow-md p-4 sticky top-0 z-20">
        <h1 class="text-2xl font-bold text-center">Josh&CandiceåŒ—ä¹å·è–èª•è·¨å¹´ä¹‹æ—… (12/26 - 12/31)</h1>
    </header>

    <div id="main-content" class="p-4 max-w-md mx-auto">
        
        <div id="itinerary-tab" class="main-tab-content">
            
            <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-cloud-sun text-custom-primary mr-2"></i> è¡Œç¨‹å¤©æ°£ç¸½è¦½ (tenki.jp)
                </h2>

                <div class="flex justify-around items-stretch mb-4 space-x-2">
                    <div class="flex-1 text-center p-3 border rounded-lg bg-gray-50 shadow-sm">
                        <p class="text-sm font-semibold text-gray-700 mb-1">ç¦å²¡ (26æ—¥)</p>
                        <i id="weather-icon-fukuoka" class="fa-solid fa-cloud-sun-rain text-3xl text-custom-primary mb-1"></i>
                        <p id="weather-temp-fukuoka" class="text-lg font-bold text-gray-800">8Â°C / 13Â°C</p>
                        <p id="weather-rain-fukuoka" class="text-xs text-red-500 mt-1">é™é›¨ç‡: 20%</p>
                    </div>

                    <div class="flex-1 text-center p-3 border rounded-lg bg-gray-50 shadow-sm">
                        <p class="text-sm font-semibold text-gray-700 mb-1">é•·å´ (27-28æ—¥)</p>
                        <i id="weather-icon-nagasaki" class="fa-solid fa-sun text-3xl text-custom-secondary mb-1"></i> 
                        <p id="weather-temp-nagasaki" class="text-lg font-bold text-gray-800">5Â°C / 10Â°C</p>
                        <p id="weather-rain-nagasaki" class="text-xs text-gray-500 mt-1">é™é›¨ç‡: 0%</p>
                    </div>

                    <div class="flex-1 text-center p-3 border rounded-lg bg-gray-50 shadow-sm">
                        <p class="text-sm font-semibold text-gray-700 mb-1">ç†Šæœ¬ (29-31æ—¥)</p>
                        <i id="weather-icon-kumamoto" class="fa-solid fa-cloud-showers-heavy text-3xl text-custom-primary mb-1"></i>
                        <p id="weather-temp-kumamoto" class="text-lg font-bold text-gray-800">3Â°C / 9Â°C</p>
                        <p id="weather-rain-kumamoto" class="text-xs text-red-500 mt-1">é™é›¨ç‡: 40%</p>
                    </div>
                </div>

                <a href="https://www.tenki.jp/" target="_blank" class="w-full block text-center bg-gray-200 text-gray-700 p-2 rounded-lg font-semibold hover:bg-gray-300 transition duration-200">
                    é»æ“ŠæŸ¥çœ‹ tenki.jp è©³ç´°é å ±
                </a>
            </div>
            
            <div id="itinerary-overview-buttons" class="bg-white p-4 rounded-lg shadow-md sticky top-[72px] z-10">
                <h3 class="font-bold text-gray-800 mb-2">ğŸ“… è¡Œç¨‹ç¸½è¦½</h3>
                <div id="date-buttons-container" class="p-2 flex gap-1 overflow-x-auto whitespace-nowrap border-b border-gray-200">
    </div>
            </div>

            <div id="itinerary-container" class="bg-white p-4 rounded-lg shadow-md mt-4 min-h-[300px]">
                <p class="text-center text-gray-500">æ­£åœ¨è¼‰å…¥è¡Œç¨‹æ•¸æ“š...</p>
            </div>
            
            <button onclick="window.openModal('addItineraryModal')" class="fixed right-4 bottom-20 bg-custom-primary text-white p-4 rounded-full shadow-lg hover:bg-[#3A7AD0] transition z-20">
                <i class="fa-solid fa-circle-plus text-2xl"></i>
            </button>
            
            <div class="mt-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                <h3 class="text-lg font-bold text-custom-secondary mb-2">ğŸ’¡ å‚™è¨»ï¼š</h3>
                <p class="text-sm text-gray-600">è¡Œç¨‹é»æ“Šå¾Œå³å¯é€²è¡Œä¿®æ”¹æˆ–åˆªé™¤ã€‚é£¯åº—åç¨±å·²åŠ ä¸Š <a href="#" onclick="return false;" class="text-custom-secondary underline">Google Maps é€£çµ</a>ã€‚</p>
            </div>
        </div>
        

        <div id="expense-tab" class="main-tab-content hidden">
            <div id="expense-tracking-container" class="bg-white p-4 rounded-lg shadow-md mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-calculator text-[#F5A623] mr-2"></i> ğŸ’¸ æ—…è²»è¨˜å¸³ä¸­å¿ƒ
                </h3>
        
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm font-semibold text-blue-700">å³æ™‚åŒ¯ç‡ (JPY/TWD)ï¼š<span id="exchange-rate-display">--</span></p>
                </div>
        
                <div class="p-4 bg-gray-50 rounded-lg mb-4 shadow-inner">
                    <h4 class="font-semibold mb-3 text-custom-primary">æ–°å¢æ”¯å‡º</h4>
                    
                    <input type="date" id="expense-date" class="w-full p-2 border rounded-lg mb-3 text-sm">
                    
                    <input type="number" id="expense-amount" placeholder="é‡‘é¡" class="w-full p-2 border rounded-lg mb-3 text-sm" min="0">
                    
                    <h5 class="text-sm font-semibold mb-2">ä»˜æ¬¾å¹£åˆ¥:</h5>
                    <div id="currency-select" class="flex space-x-2 mb-3">
                        <button type="button" class="block-select-btn flex-1 active-currency" data-currency="TWD" onclick="window.selectCurrency('TWD')">
                            <i class="fa-solid fa-money-bill-wave mr-1"></i> å°å¹£ (TWD)
                        </button>
                        <button type="button" class="block-select-btn flex-1" data-currency="JPY" onclick="window.selectCurrency('JPY')">
                            <i class="fa-solid fa-yen-sign mr-1"></i> æ—¥åœ“ (JPY)
                        </button>
                        <input type="hidden" id="expense-currency" value="TWD">
                    </div>
                    
                    <h5 class="text-sm font-semibold mb-2">ä»˜æ¬¾äºº:</h5>
                    <div id="payer-select" class="flex space-x-2 mb-3">
                        <button type="button" class="block-select-btn flex-1 active-payer" data-payer="Josh" onclick="window.selectPayer('Josh')">
                            <i class="fa-solid fa-person-military-pointing mr-1"></i> Josh
                        </button>
                        <button type="button" class="block-select-btn flex-1" data-payer="Candice" onclick="window.selectPayer('Candice')">
                            <i class="fa-solid fa-person-dress mr-1"></i> Candice
                        </button>
                        <input type="hidden" id="expense-payer" value="Josh">
                    </div>

                    <h5 class="text-sm font-semibold mb-2">æ”¯å‡ºé¡åˆ¥:</h5>
                    <div id="category-select" class="flex flex-wrap gap-2 mb-3">
                        <button type="button" class="block-select-btn px-2 py-1 text-xs active-category" data-category="Food" onclick="window.selectCategory('Food')">
                            <i class="fa-solid fa-utensils mr-1"></i> é¤é£²
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Transport" onclick="window.selectCategory('Transport')">
                            <i class="fa-solid fa-train-subway mr-1"></i> äº¤é€š
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Accommodation" onclick="window.selectCategory('Accommodation')">
                            <i class="fa-solid fa-hotel mr-1"></i> ä½å®¿
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Shopping" onclick="window.selectCategory('Shopping')">
                            <i class="fa-solid fa-bag-shopping mr-1"></i> è³¼ç‰©
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-category="Other" onclick="window.selectCategory('Other')">
                            <i class="fa-solid fa-ellipsis mr-1"></i> å…¶ä»–
                        </button>
                        <input type="hidden" id="expense-category" value="Food"> 
                    </div>
                    
                    <h5 class="text-sm font-semibold mb-2">æ”¯ä»˜æ–¹å¼:</h5>
                    <div id="payment-select" class="flex flex-wrap gap-2 mb-3">
                        <button type="button" class="block-select-btn px-2 py-1 text-xs active-payment" data-payment="Cash" onclick="window.selectPayment('Cash')">
                            <i class="fa-solid fa-money-bill-1-wave mr-1"></i> ç¾é‡‘
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-payment="CreditCard" onclick="window.selectPayment('CreditCard')">
                            <i class="fa-solid fa-credit-card mr-1"></i> ä¿¡ç”¨å¡
                        </button>
                        <button type="button" class="block-select-btn px-2 py-1 text-xs" data-payment="PayPay" onclick="window.selectPayment('PayPay')">
                            <i class="fa-solid fa-mobile-screen mr-1"></i> PayPay
                        </button>
                        <input type="hidden" id="expense-payment" value="Cash"> 
                    </div>

                    <input type="text" id="expense-description" placeholder="ç”¨é€”/èªªæ˜" class="w-full p-2 border rounded-lg mb-3 text-sm">
                    
                    <button onclick="window.addExpense()" class="w-full bg-custom-secondary text-white p-2 rounded-lg font-bold hover:bg-[#db8f1f]">
                        <i class="fa-solid fa-circle-plus mr-1"></i> ç¢ºèªæ–°å¢
                    </button>
                </div>
        
                <div id="expense-summary" class="mb-4 p-4 bg-custom-primary text-white rounded-lg shadow-md">
                    <h4 class="font-semibold mb-2">ç¸½æ”¯å‡ºæ¦‚æ³</h4>
                    <p class="text-sm">ç¸½é ç®— (TWD): $ <span id="total-budget">50,000</span></p>
                    <p class="text-sm">ç´¯ç©ç¸½æ”¯å‡º (TWD): $ <span id="total-spent">0</span></p>
                    <p class="text-lg font-bold mt-2">å‰©é¤˜é ç®—: $ <span id="remaining-budget">50,000</span></p>
                </div>
                
                <div id="settlement-summary" class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg shadow-md">
                    <h4 class="font-semibold mb-2 text-gray-800 flex items-center"><i class="fa-solid fa-handshake-angle mr-2 text-yellow-600"></i> åˆ†æ”¤çµç®—æ¦‚æ³ (TWD)</h4>
                    <p class="text-sm text-gray-700">Josh å·²æ”¯ä»˜: $ <span id="josh-paid">0</span></p>
                    <p class="text-sm text-gray-700 mb-2">Candice å·²æ”¯ä»˜: $ <span id="candice-paid">0</span></p>
                    <p class="text-md font-bold text-gray-900 border-t pt-2 mt-2">
                        <span id="settlement-result">ç„¡éœ€çµç®—ã€‚</span>
                    </p>
                </div>

                <div class="mb-4">
                    <h4 class="font-semibold mb-2 text-gray-700 flex items-center"><i class="fa-solid fa-filter mr-2"></i> ä¾é¡åˆ¥ç¯©é¸æ¸…å–®:</h4>
                    <div id="category-filter-buttons" class="flex flex-wrap gap-2 text-sm">
                        </div>
                </div>
        
                <h4 class="font-semibold mb-3 text-gray-700 border-b pb-2">æ”¯å‡ºæ˜ç´°</h4>
                <div id="expense-list" class="space-y-2">
                    <p class="text-center text-gray-500 text-sm">å°šç„¡æ”¯å‡ºç´€éŒ„</p>
                </div>
            </div>
        </div>

        <div id="weather-tab" class="main-tab-content hidden">
            <div id="weather-container" class="bg-white p-4 rounded-lg shadow-md mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-temperature-three-quarters text-[#4A90E2] mr-2"></i> â„ï¸ æ¯æ—¥å¤©æ°£é å ± (tenki.jp æ­·å²æ•¸æ“š)
                </h3>
                <div id="weather-content" class="space-y-4">
                    <p class="text-center text-gray-500">æ­£åœ¨è¼‰å…¥å¤©æ°£è³‡è¨Š...</p>
                </div>
            </div>
        </div>
        
        <div id="wishlist-tab" class="main-tab-content hidden">
             <div class="bg-white p-4 rounded-lg shadow-md mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-heart text-[#F5A623] mr-2"></i> âœ¨ æ…¾æœ›æ¸…å–®
                </h3>
                
                <div class="p-4 bg-gray-50 rounded-lg mb-4 shadow-inner">
                    <h4 class="font-semibold mb-3 text-custom-primary">æ–°å¢è³¼è²·ç›®æ¨™</h4>
                    <form id="wishlist-form" onsubmit="window.addWishlistItem(event)">
                        
                        <label for="wishlist-category" class="text-sm font-semibold text-gray-700 mb-1 block">é …ç›®åˆ†é¡:</label>
                        <select id="wishlist-category" name="wishlist-category" class="w-full p-2 border rounded-lg mb-3 text-sm bg-white" required>
                            <option value="" disabled selected>-- è«‹é¸æ“‡åˆ†é¡ --</option>
                            <option value="3C">3C</option>
                            <option value="Beauty">ç¾å¦</option>
                            <option value="Daily">æ—¥ç”¨å“</option>
                            <option value="Toy">ç©å…·</option>
                            <option value="Clothes">è¡£ç‰©</option>
                            <option value="Souvenir">ä¼´æ‰‹ç¦®/é£Ÿç‰©</option>
                            <option value="Other">å…¶ä»–</option>
                        </select>
                        
                        <label for="wishlist-name" class="text-sm font-semibold text-gray-700 mb-1 block">é …ç›®åç¨±/æè¿°:</label>
                        <input type="text" id="wishlist-name" name="wishlist-name" placeholder="ä¾‹å¦‚ï¼šDyson å¹é¢¨æ©Ÿ" class="w-full p-2 border rounded-lg mb-3 text-sm" required>

                        <label for="wishlist-price" class="text-sm font-semibold text-gray-700 mb-1 block">é è¨ˆåƒ¹æ ¼ (JPY):</label>
                        <input type="number" id="wishlist-price" name="wishlist-price" placeholder="è«‹è¼¸å…¥é è¨ˆåƒ¹æ ¼ (æ—¥åœ“)" min="0" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                        
                        <button type="submit" class="w-full bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-[#3A7AD0]">
                            <i class="fa-solid fa-cart-plus mr-1"></i> åŠ å…¥æ¸…å–®
                        </button>
                    </form>
                </div>
                
                <h4 class="font-semibold mb-3 text-gray-700 border-b pb-2">å¾…è³¼æ¸…å–®</h4>
                <div id="wishlist-list" class="space-y-3">
                    <p class="text-center text-gray-500 text-sm">å°šç„¡å¾…è³¼é …ç›®</p>
                </div>

             </div>
        </div>
        
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl z-30">
        <div class="flex justify-around max-w-md mx-auto">
            
            <button class="bottom-nav-button active" data-target="itinerary-tab" onclick="window.switchMainNav('itinerary-tab')">
                <i class="fa-solid fa-map-location-dot text-2xl mb-1"></i>
                <span class="text-xs">è¡Œç¨‹</span>
            </button>

            <button class="bottom-nav-button" data-target="expense-tab" onclick="window.switchMainNav('expense-tab')">
                <i class="fa-solid fa-calculator text-2xl mb-1"></i>
                <span class="text-xs">è¨˜å¸³</span>
            </button>
            
            <button class="bottom-nav-button" data-target="weather-tab" onclick="window.switchMainNav('weather-tab')">
                <i class="fa-solid fa-cloud-sun-rain text-2xl mb-1"></i>
                <span class="text-xs">å¤©æ°£</span>
            </button>
            
            <button class="bottom-nav-button" data-target="wishlist-tab" onclick="window.switchMainNav('wishlist-tab')">
                <i class="fa-solid fa-heart text-2xl mb-1"></i>
                <span class="text-xs">æ…¾æœ›æ¸…å–®</span>
            </button>

        </div>
    </nav>
    
    <div id="addItineraryModal" class="modal-overlay">
        <div class="modal-content">
            
            <div class="text-center mb-4">
                <div class="text-custom-primary font-bold text-lg mb-2 flex items-center justify-center">
                    <i class="fa-solid fa-circle-plus mr-2"></i> æ–°å¢è¡Œç¨‹é …ç›®
                </div>
                <h3 class="text-xl font-bold text-gray-800 border-b pb-2">æ–°å¢è¡Œç¨‹ç´°ç¯€</h3>
            </div>
            <button onclick="window.closeModal('addItineraryModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            
            <form id="add-itinerary-form" onsubmit="window.addItineraryItem(event)">
                
                <label for="new-date" class="text-sm font-semibold text-gray-700 mb-1 block">é¸æ“‡æ—¥æœŸ:</label>
                <select id="new-date" class="w-full p-2 border rounded-lg mb-3 text-sm bg-white" required>
                    </select>
                
                <label for="new-time" class="text-sm font-semibold text-gray-700 mb-1 block">æ™‚é–“:</label>
                <div class="flex items-center mb-3">
                    <input type="text" id="new-time" placeholder="--:--" pattern="[0-2][0-9]:[0-5][0-9]" class="flex-1 p-2 border rounded-lg text-sm mr-2" required>
                    <i class="fa-solid fa-clock text-gray-500"></i>
                </div>
                
                <label for="new-title" class="text-sm font-semibold text-gray-700 mb-1 block">è¡Œç¨‹æ¨™é¡Œ:</label>
                <input type="text" id="new-title" placeholder="è¡Œç¨‹æ¨™é¡Œ (å¦‚: æ™šé¤)" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                
                <label for="new-note" class="text-sm font-semibold text-gray-700 mb-1 block">å‚™è¨»/åœ°é»:</label>
                <textarea id="new-note" rows="2" placeholder="å‚™è¨» (å¦‚: é˜¿è˜‡èµ¤ç‰›ä¸¼/é£¯åº—)" class="w-full p-2 border rounded-lg mb-4 text-sm"></textarea>
                
                <button type="submit" class="w-full bg-custom-secondary text-white p-2 rounded-lg font-bold hover:bg-[#db8f1f]">
                    ç¢ºèªæ–°å¢
                </button>
            </form>
        </div>
    </div>
    
    <div id="editItineraryModal" class="modal-overlay">
        <div class="modal-content">
            
            <div class="text-center mb-4">
                <div class="text-custom-secondary font-bold text-lg mb-2 flex items-center justify-center">
                    <i class="fa-solid fa-pen-to-square mr-2"></i> ä¿®æ”¹è¡Œç¨‹é …ç›®
                </div>
                <h3 class="text-xl font-bold text-gray-800 border-b pb-2" id="edit-modal-date-info"></h3>
            </div>
            <button onclick="window.closeModal('editItineraryModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            
            <form id="edit-itinerary-form" onsubmit="window.saveItineraryItem(event)">
                <input type="hidden" id="edit-date-key" name="dateKey">
                <input type="hidden" id="edit-item-index" name="itemIndex">

                <label for="edit-time" class="text-sm font-semibold text-gray-700 mb-1 block">æ™‚é–“:</label>
                <div class="flex items-center mb-3">
                    <input type="text" id="edit-time" placeholder="--:--" pattern="[0-2][0-9]:[0-5][0-9]" class="flex-1 p-2 border rounded-lg text-sm mr-2" required>
                    <i class="fa-solid fa-clock text-gray-500"></i>
                </div>
                
                <label for="edit-title" class="text-sm font-semibold text-gray-700 mb-1 block">è¡Œç¨‹æ¨™é¡Œ:</label>
                <input type="text" id="edit-title" placeholder="è¡Œç¨‹æ¨™é¡Œ (å¦‚: æ™šé¤)" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                
                <label for="edit-note" class="text-sm font-semibold text-gray-700 mb-1 block">å‚™è¨»/åœ°é»:</label>
                <textarea id="edit-note" rows="2" placeholder="å‚™è¨» (å¦‚: é˜¿è˜‡èµ¤ç‰›ä¸¼/é£¯åº—)" class="w-full p-2 border rounded-lg mb-4 text-sm"></textarea>
                
                <div class="flex space-x-2">
                    <button type="button" onclick="window.deleteItineraryItem(document.getElementById('edit-date-key').value, parseInt(document.getElementById('edit-item-index').value))" class="flex-1 bg-red-500 text-white p-2 rounded-lg font-bold hover:bg-red-600">
                        <i class="fa-solid fa-trash-can mr-1"></i> åˆªé™¤
                    </button>
                    <button type="submit" class="flex-1 bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-[#3A7AD0]">
                        <i class="fa-solid fa-save mr-1"></i> å„²å­˜ä¿®æ”¹
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>