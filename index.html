<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦å²¡ç†Šæœ¬è¡Œç¨‹åŠ©æ‰‹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script type="module">
        /* =========================
          Firebase åˆå§‹åŒ– (ä½¿ç”¨ ES Modules)
        ========================= */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import {
            getFirestore,
            collection,
            doc,
            setDoc, // ç”¨æ–¼è¦†å¯«æ•´å€‹æ–‡ä»¶ (ä¾‹å¦‚æ–°å¢è¡Œç¨‹å¤©æ•¸æ™‚)
            addDoc, // ç”¨æ–¼æ–°å¢æ–‡ä»¶ (ä¾‹å¦‚è¨˜å¸³å’Œæ…¾æœ›æ¸…å–®)
            updateDoc, // ç”¨æ–¼æ›´æ–°ç¾æœ‰æ–‡ä»¶ (ä¾‹å¦‚ä¿®æ”¹è¡Œç¨‹å…§å®¹)
            deleteDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        
        // ğŸš¨ è«‹ç¢ºèªé€™æ˜¯æ‚¨çš„çœŸå¯¦é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBRjYjvwvCNTRHdI8vH8n3GPabzSnSDbvI",
            authDomain: "jp-b0e03.firebaseapp.com",
            projectId: "jp-b0e03",
            storageBucket: "jp-b0e03.firebasestorage.app", // å»ºè­°åŠ å…¥
            messagingSenderId: "689610031212", // å»ºè­°åŠ å…¥
            appId: "1:689610031212:web:f63f2efe61d4ad562bd849", // å»ºè­°åŠ å…¥
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /* =========================
          å…¨åŸŸè®Šæ•¸èˆ‡è³‡æ–™ç‹€æ…‹
        ========================= */
        let ITINERARY_DATA = []; // è¡Œç¨‹æ•¸æ“š (ç”¨æ–¼æ¸²æŸ“)
        let EXPENSES_DATA = []; // è¨˜å¸³æ•¸æ“š
        let WISHLIST_DATA = []; // æ…¾æœ›æ¸…å–®æ•¸æ“š
        let ACTIVE_DATE = ''; // ç•¶å‰é¸ä¸­çš„æ—¥æœŸ (è¡Œç¨‹é ç±¤)
        let ACTIVE_CURRENCY = 'TWD';
        let ACTIVE_PAYER = 'Josh';
        let ACTIVE_CATEGORY = 'Food';
        let ACTIVE_PAYMENT = 'Cash';
        let EXPENSE_FILTER = 'All';
        
        // åŒ¯ç‡èˆ‡é ç®— (éœæ…‹è³‡æ–™æˆ–æœªä¾†å¯å¾ Firestore è¼‰å…¥)
        const EXCHANGE_RATE_JPY_TWD = 0.215; 
        const TOTAL_BUDGET_TWD = 50000;
        
        /* =========================
          æ•¸æ“šåŒæ­¥æ ¸å¿ƒ (onSnapshot)
        ========================= */
        function startDataSync() {
            // 1. è¡Œç¨‹æ•¸æ“š (Itineraries) - æŒ‰æ—¥æœŸæ’åº
            const itineraryQuery = query(collection(db, "itineraries"), orderBy("date", "asc"));
            onSnapshot(itineraryQuery, (snapshot) => {
                ITINERARY_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // ç¢ºä¿ activities æ˜¯ä¸€å€‹é™£åˆ—ï¼Œä¸¦æŒ‰æ™‚é–“æ’åº
                    activities: Array.isArray(doc.data().activities) ? 
                                doc.data().activities.sort((a, b) => a.time.localeCompare(b.time)) : []
                }));

                if (ITINERARY_DATA.length > 0) {
                    if (!ACTIVE_DATE) {
                        ACTIVE_DATE = ITINERARY_DATA[0].id; // ä½¿ç”¨ id ä½œç‚ºæ—¥æœŸéµ
                    }
                    window.generateDateTabs();
                    window.renderItinerary();
                    window.populateItineraryModalDates();
                } else {
                    document.getElementById('itinerary-container').innerHTML = '<p class="text-center text-gray-500 mt-8">è«‹åœ¨ Firebase Console ä¸­æ–°å¢è¡Œç¨‹æ•¸æ“šã€‚</p>';
                }
            }, (error) => {
                console.error("Error listening to itineraries: ", error);
            });
            
            // 2. è¨˜å¸³æ•¸æ“š (Expenses) - æŒ‰æ—¥æœŸæ’åº
            const expenseQuery = query(collection(db, "expenses"), orderBy("date", "desc"), orderBy("timestamp", "desc"));
            onSnapshot(expenseQuery, (snapshot) => {
                EXPENSES_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                window.renderExpenseTracking(); // æ•¸æ“šæ›´æ–°æ™‚é‡æ–°æ¸²æŸ“è¨˜å¸³é 
            }, (error) => {
                console.error("Error listening to expenses: ", error);
            });
            
            // 3. æ…¾æœ›æ¸…å–® (Wishlist) - æŒ‰è³¼è²·ç‹€æ…‹å’Œæ™‚é–“æ’åº
            const wishlistQuery = query(collection(db, "wishlists"), orderBy("purchased", "asc"), orderBy("timestamp", "desc"));
            onSnapshot(wishlistQuery, (snapshot) => {
                WISHLIST_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // åªæœ‰åœ¨ wishlist é ç±¤è¢«é¸ä¸­æ™‚æ‰å¼·åˆ¶æ¸²æŸ“ï¼Œé¿å…ä¸å¿…è¦çš„é–‹éŠ·
                if (document.getElementById('wishlist-tab').classList.contains('hidden') === false) {
                     window.renderWishlist(); 
                }
            }, (error) => {
                console.error("Error listening to wishlists: ", error);
            });
            
            // æ¸²æŸ“åŒ¯ç‡ (éœæ…‹)
            document.getElementById('exchange-rate-display').textContent = EXCHANGE_RATE_JPY_TWD.toFixed(4);
        }

        /* ===================================================
          è¡Œç¨‹ (ITINERARY) ç›¸é—œå‡½å¼
        =================================================== */

        // æ¸²æŸ“æ—¥æœŸæŒ‰éˆ•
        window.generateDateTabs = function() {
            const tabContainer = document.getElementById('date-buttons-container');
            if (!tabContainer) return;
            tabContainer.innerHTML = ''; 

            ITINERARY_DATA.forEach((day, index) => {
                const isActive = day.id === ACTIVE_DATE;
                const button = document.createElement('button');
                
                // ç¢ºä¿ä½¿ç”¨ HTML ä¸­å®šç¾©çš„ CSS class
                button.className = `tab-button ${isActive ? 'active' : ''}`;
                button.innerHTML = `
                    <div class="font-bold">Day ${index + 1}</div>
                    <div class="text-xs">${day.date.substring(5)} (${day.day_of_week})</div>
                `;
                
                button.onclick = () => {
                    window.setActiveDate(day.id);
                };
                
                tabContainer.appendChild(button);
            });
        }
        
        // åˆ‡æ›ç•¶å‰é¸ä¸­æ—¥æœŸ
        window.setActiveDate = function(dateId) {
            ACTIVE_DATE = dateId;
            window.generateDateTabs(); 
            window.renderItinerary();  
        }

        // æ¸²æŸ“è¡Œç¨‹å…§å®¹
        window.renderItinerary = function() {
            const contentContainer = document.getElementById('itinerary-container'); 
            if (!contentContainer) return;
            contentContainer.innerHTML = ''; 

            const currentDay = ITINERARY_DATA.find(day => day.id === ACTIVE_DATE);

            if (!currentDay || !currentDay.activities || currentDay.activities.length === 0) {
                contentContainer.innerHTML = `
                    <h2 class="text-xl font-bold p-4 bg-gray-100 border-b border-gray-200">${currentDay ? currentDay.city : 'ç„¡è³‡æ–™'} - ${currentDay ? currentDay.date : 'ç„¡è³‡æ–™'}</h2>
                    <p class="text-center text-gray-500 mt-8">æœ¬æ—¥ç„¡è¡Œç¨‹ï¼Œé»æ“Šå³ä¸‹è§’æ–°å¢ã€‚</p>`;
                return;
            }
            
            let html = `
                <h2 class="text-xl font-bold p-4 bg-gray-100 border-b border-gray-200">${currentDay.city} - ${currentDay.date}</h2>
                <div class="timeline-container p-4">
            `;

            currentDay.activities.forEach((activity, index) => {
                const clickHandler = `window.openEditModal('${currentDay.id}', ${index})`;
                
                html += `
                    <div class="flex items-start mb-6" onclick="${clickHandler}">
                        <div class="w-1/4 text-sm font-semibold text-gray-600 pt-1">${activity.time}</div>
                        <div class="w-3/4">
                            <div class="timeline-item relative">
                                <span class="absolute -left-[1.3rem] top-1 h-3 w-3 rounded-full bg-custom-primary border-2 border-white"></span>
                                <div class="font-bold text-gray-800">${activity.title}</div>
                                <div class="text-sm text-gray-500">${activity.location || ''}</div>
                                ${activity.notes ? `<div class="text-xs text-gray-700 mt-1 italic">${activity.notes}</div>` : ''}
                                ${activity.link ? `<a href="${activity.link}" target="_blank" class="text-xs font-semibold mt-1 inline-block" onclick="event.stopPropagation();"><i class="fas fa-map-marker-alt"></i> å°èˆª</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            contentContainer.innerHTML = html;
        }
        
        // å¡«å……æ–°å¢è¡Œç¨‹ Modal ä¸­çš„æ—¥æœŸé¸é …
        window.populateItineraryModalDates = function() {
            const select = document.getElementById('new-date');
            if (!select) return;
            select.innerHTML = ''; 
            
            ITINERARY_DATA.forEach(day => {
                const option = document.createElement('option');
                option.value = day.id;
                option.textContent = `${day.date.substring(5)} (${day.day_of_week}) - ${day.city}`;
                if (day.id === ACTIVE_DATE) {
                    option.selected = true; 
                }
                select.appendChild(option);
            });
        }
        
        // æ–°å¢è¡Œç¨‹é …ç›® (Add)
        window.addItineraryItem = async function(event) {
            event.preventDefault();
            const dateId = document.getElementById('new-date').value;
            const time = document.getElementById('new-time').value;
            const title = document.getElementById('new-title').value;
            const note = document.getElementById('new-note').value;
            
            if (!dateId || !time || !title) return;

            const newActivity = {
                time: time,
                title: title,
                location: note, // å‡è¨­å‚™è¨»/åœ°é»
                notes: '', 
                link: ''
            };

            try {
                const dayDocRef = doc(db, 'itineraries', dateId);
                const currentDay = ITINERARY_DATA.find(d => d.id === dateId);
                
                if (currentDay) {
                     // è¤‡è£½ä¸¦åŠ å…¥æ–°æ´»å‹•
                    const updatedActivities = [...(currentDay.activities || []), newActivity];

                    // æ ¹æ“šæ™‚é–“æ’åº (å¯é¸ï¼Œä½†å¼·çƒˆå»ºè­°)
                    updatedActivities.sort((a, b) => a.time.localeCompare(b.time));
                    
                    await updateDoc(dayDocRef, {
                        activities: updatedActivities
                    });
                } else {
                    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯ä»¥é¸æ“‡å‰µå»ºä¸€å€‹æ–°çš„æ—¥æœŸæ–‡ä»¶ (é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œå‡è¨­æ–‡ä»¶å·²å­˜åœ¨)
                    alert('æ‰¾ä¸åˆ°å°æ‡‰æ—¥æœŸæ–‡ä»¶ï¼Œè«‹å…ˆåœ¨ Firestore æ–°å¢æ–‡ä»¶ã€‚');
                    return;
                }


                window.closeModal('addItineraryModal');
                document.getElementById('add-itinerary-form').reset(); 
                alert('è¡Œç¨‹æ–°å¢æˆåŠŸï¼');

            } catch (e) {
                console.error("Error adding itinerary item: ", e);
                alert('æ–°å¢è¡Œç¨‹å¤±æ•—ã€‚');
            }
        }

        // é–‹å•Ÿç·¨è¼¯ Modal
        window.openEditModal = function(dateId, index) {
            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay || !currentDay.activities || !currentDay.activities[index]) return;

            const activity = currentDay.activities[index];
            const dayIndex = ITINERARY_DATA.indexOf(currentDay);

            document.getElementById('edit-modal-date-info').textContent = `${currentDay.city} - ${currentDay.date} (Day ${dayIndex + 1})`;
            
            document.getElementById('edit-date-key').value = dateId;
            document.getElementById('edit-item-index').value = index;
            document.getElementById('edit-time').value = activity.time || '';
            document.getElementById('edit-title').value = activity.title || '';
            document.getElementById('edit-note').value = activity.location || activity.notes || ''; 

            window.openModal('editItineraryModal');
        }

        // å„²å­˜ä¿®æ”¹ (Update)
        window.saveItineraryItem = async function(event) {
            event.preventDefault();
            const dateId = document.getElementById('edit-date-key').value;
            const index = parseInt(document.getElementById('edit-item-index').value);
            const time = document.getElementById('edit-time').value;
            const title = document.getElementById('edit-title').value;
            const note = document.getElementById('edit-note').value;

            if (!dateId || index === undefined || !time || !title) return;

            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay) return;

            const updatedActivities = [...currentDay.activities];
            
            updatedActivities[index] = {
                ...updatedActivities[index], 
                time: time,
                title: title,
                location: note, 
                notes: '',
            };
            
            updatedActivities.sort((a, b) => a.time.localeCompare(b.time));

            try {
                await updateDoc(doc(db, 'itineraries', dateId), {
                    activities: updatedActivities
                });
                window.closeModal('editItineraryModal');
                alert('è¡Œç¨‹ä¿®æ”¹æˆåŠŸï¼');
            } catch (e) {
                console.error("Error updating document: ", e);
                alert('è¡Œç¨‹ä¿®æ”¹å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤è¡Œç¨‹é …ç›® (Delete)
        window.deleteItineraryItem = async function(dateId, index) {
            if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹é …ç›®å—ï¼Ÿ')) return;

            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay) return;

            const updatedActivities = currentDay.activities.filter((_, i) => i !== index);

            try {
                await updateDoc(doc(db, 'itineraries', dateId), {
                    activities: updatedActivities
                });
                window.closeModal('editItineraryModal');
                alert('è¡Œç¨‹åˆªé™¤æˆåŠŸï¼');
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert('è¡Œç¨‹åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        /* ===================================================
          è¨˜å¸³ (EXPENSE) ç›¸é—œå‡½å¼
        =================================================== */
/* ===================================================
  è¨˜å¸³ (EXPENSE) ç›¸é—œå‡½å¼
=================================================== */
// æ”¾åœ¨æ‚¨çš„ç¨‹å¼ç¢¼é ‚éƒ¨
let EXPENSESf_DATA = []; // â­ï¸ é€™è£¡æ˜¯é‡è¤‡å®šç¾©ï¼Œæœƒè¦†è“‹æ‰ Firebase è³¦å€¼çš„ EXPENSES_DATA

        // é¸æ“‡å¹£åˆ¥
        window.selectCurrency = function(currency) {
            ACTIVE_CURRENCY = currency;
            document.querySelectorAll('#currency-select .block-select-btn').forEach(btn => {
                btn.classList.remove('active-currency');
                if (btn.getAttribute('data-currency') === currency) {
                    btn.classList.add('active-currency');
                }
            });
            document.getElementById('expense-currency').value = currency;
        }

        // é¸æ“‡ä»˜æ¬¾äºº
        window.selectPayer = function(payer) {
            ACTIVE_PAYER = payer;
            document.querySelectorAll('#payer-select .block-select-btn').forEach(btn => {
                btn.classList.remove('active-payer');
                if (btn.getAttribute('data-payer') === payer) {
                    btn.classList.add('active-payer');
                }
            });
            document.getElementById('expense-payer').value = payer;
        }
        
        // é¸æ“‡é¡åˆ¥ (æ–°å¢æ”¯å‡º)
        window.selectCategory = function(category) {
            ACTIVE_CATEGORY = category;
            document.querySelectorAll('#category-select .block-select-btn').forEach(btn => {
                btn.classList.remove('active-category');
                if (btn.getAttribute('data-category') === category) {
                    btn.classList.add('active-category');
                }
            });
            document.getElementById('expense-category').value = category;
        }
        
        // é¸æ“‡æ”¯ä»˜æ–¹å¼
        window.selectPayment = function(payment) {
            ACTIVE_PAYMENT = payment;
            document.querySelectorAll('#payment-select .block-select-btn').forEach(btn => {
                btn.classList.remove('active-payment');
                if (btn.getAttribute('data-payment') === payment) {
                    btn.classList.add('active-payment');
                }
            });
            document.getElementById('expense-payment').value = payment;
        }

        // é¸æ“‡é¡åˆ¥ (ç¯©é¸æ¸…å–®)
        window.filterExpenses = function(category) {
            EXPENSE_FILTER = category;
            window.renderExpenseTracking(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }

        // æ–°å¢æ”¯å‡º (Add Expense)
        window.addExpense = async function() {
            const date = document.getElementById('expense-date').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const description = document.getElementById('expense-description').value;

            if (!date || isNaN(amount) || amount <= 0 || !description) {
                alert('è«‹æª¢æŸ¥æ—¥æœŸã€é‡‘é¡å’Œç”¨é€”æ˜¯å¦æ­£ç¢ºå¡«å¯«ï¼');
                return;
            }

            const newExpense = {
                date: date,
                amount: amount,
                currency: ACTIVE_CURRENCY,
                payer: ACTIVE_PAYER,
                category: ACTIVE_CATEGORY,
                payment: ACTIVE_PAYMENT,
                description: description,
                timestamp: serverTimestamp() // ä½¿ç”¨ Firestore æœå‹™å™¨æ™‚é–“æˆ³
            };

            try {
                await addDoc(collection(db, "expenses"), newExpense);
                alert('æ”¯å‡ºç´€éŒ„æ–°å¢æˆåŠŸï¼');
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-description').value = '';
            } catch (e) {
                console.error("Error adding expense: ", e);
                alert('æ–°å¢æ”¯å‡ºç´€éŒ„å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤æ”¯å‡º
        window.deleteExpense = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "expenses", id));
                alert('æ”¯å‡ºç´€éŒ„å·²åˆªé™¤ã€‚');
            } catch (e) {
                console.error("Error deleting expense: ", e);
                alert('åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        // è¨ˆç®—ä¸¦æ›´æ–°çµç®—æ‘˜è¦
        window.updateSettlementSummary = function() {
            let joshPaidTWD = 0;
            let candicePaidTWD = 0;
            
            EXPENSES_DATA.forEach(expense => {
                let amountTWD = expense.amount;
                if (expense.currency === 'JPY') {
                    amountTWD = expense.amount * EXCHANGE_RATE_JPY_TWD;
                }
                
                if (expense.payer === 'Josh') {
                    joshPaidTWD += amountTWD;
                } else if (expense.payer === 'Candice') {
                    candicePaidTWD += amountTWD;
                }
            });

            // ç¸½æ”¯å‡ºèˆ‡é ç®—
            const totalSpentTWD = joshPaidTWD + candicePaidTWD;
            const remainingBudget = TOTAL_BUDGET_TWD - totalSpentTWD;

            document.getElementById('total-budget').textContent = TOTAL_BUDGET_TWD.toLocaleString();
            document.getElementById('total-spent').textContent = Math.round(totalSpentTWD).toLocaleString();
            document.getElementById('remaining-budget').textContent = Math.round(remainingBudget).toLocaleString();
            
            // çµç®—çµæœ
            document.getElementById('josh-paid').textContent = Math.round(joshPaidTWD).toLocaleString();
            document.getElementById('candice-paid').textContent = Math.round(candicePaidTWD).toLocaleString();

            const diff = joshPaidTWD - candicePaidTWD;
            const halfDiff = Math.abs(diff) / 2;
            const settlementElement = document.getElementById('settlement-result');

            if (Math.abs(diff) < 1) { // å¿½ç•¥å¾®å°å·®ç•°
                settlementElement.textContent = "ç„¡éœ€çµç®—ã€‚";
                settlementElement.classList.remove('text-red-600', 'text-green-600');
                settlementElement.classList.add('text-gray-900');
            } else if (diff > 0) {
                settlementElement.textContent = `Candice éœ€æ”¯ä»˜ Josh $ ${Math.round(halfDiff).toLocaleString()} TWD`;
                settlementElement.classList.add('text-red-600');
            } else {
                settlementElement.textContent = `Josh éœ€æ”¯ä»˜ Candice $ ${Math.round(halfDiff).toLocaleString()} TWD`;
                settlementElement.classList.add('text-green-600');
            }
        }
        
        // æ¸²æŸ“è¨˜å¸³æ¸…å–®
        window.renderExpenseTracking = function() {
            const expenseList = document.getElementById('expense-list');
            const categories = [...new Set(EXPENSES_DATA.map(e => e.category)), 'All']; // æ‰¾å‡ºæ‰€æœ‰é¡åˆ¥
            
            // æ¸²æŸ“ç¯©é¸æŒ‰éˆ•
            const filterContainer = document.getElementById('category-filter-buttons');
            filterContainer.innerHTML = '';
            categories.forEach(cat => {
                const isActive = cat === EXPENSE_FILTER;
                 filterContainer.innerHTML += `
                    <button type="button" class="block-select-btn px-2 py-1 text-xs ${isActive ? 'active-filter' : ''}" onclick="window.filterExpenses('${cat}')">
                        ${cat}
                    </button>
                `;
            });
            
            // ç¯©é¸æ•¸æ“š
            const filteredExpenses = EXPENSES_DATA.filter(e => EXPENSE_FILTER === 'All' || e.category === EXPENSE_FILTER);

            // æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨
            if (filteredExpenses.length === 0) {
                expenseList.innerHTML = '<p class="text-center text-gray-500 text-sm">å°šç„¡ç¬¦åˆç¯©é¸æ¢ä»¶çš„æ”¯å‡ºç´€éŒ„</p>';
            } else {
                expenseList.innerHTML = filteredExpenses.map(expense => {
                    const amountTWD = expense.currency === 'JPY' 
                        ? (expense.amount * EXCHANGE_RATE_JPY_TWD).toFixed(0) 
                        : expense.amount.toFixed(0);
                        
                    const iconMap = {
                        Food: 'fa-utensils',
                        Transport: 'fa-train-subway',
                        Accommodation: 'fa-hotel',
                        Shopping: 'fa-bag-shopping',
                        Other: 'fa-ellipsis'
                    };
                    const categoryIcon = iconMap[expense.category] || 'fa-ellipsis';
                    
                    return `
                        <div class="p-3 border-b border-gray-100 flex justify-between items-center hover:bg-gray-50 transition duration-150">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-custom-secondary/20 flex items-center justify-center mr-3 text-custom-secondary">
                                    <i class="fa-solid ${categoryIcon}"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">${expense.description}</p>
                                    <p class="text-xs text-gray-500">${expense.date} (${expense.payer} / ${expense.payment})</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-red-600">${expense.currency} ${expense.amount.toLocaleString()}</p>
                                <p class="text-xs text-gray-600">ç´„ $ ${amountTWD.toLocaleString()} TWD</p>
                                <button onclick="window.deleteExpense('${expense.id}')" class="text-red-400 hover:text-red-600 text-xs mt-1">
                                    <i class="fa-solid fa-trash-can"></i> åˆªé™¤
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            window.updateSettlementSummary();
        }

        /* ===================================================
          æ…¾æœ›æ¸…å–® (WISHLIST) ç›¸é—œå‡½å¼
        =================================================== */
        
        // æ–°å¢æ…¾æœ›æ¸…å–®é …ç›® (Add)
        window.addWishlistItem = async function(event) {
            event.preventDefault();
            const name = document.getElementById('wishlist-name').value;
            const price = parseFloat(document.getElementById('wishlist-price').value);
            const category = document.getElementById('wishlist-category').value;
            
            if (!name || isNaN(price) || price <= 0 || !category) {
                alert('è«‹å¡«å¯«å®Œæ•´é …ç›®åç¨±ã€åƒ¹æ ¼å’Œåˆ†é¡ï¼');
                return;
            }

            const newItem = {
                name: name,
                price: price,
                category: category,
                purchased: false, // é è¨­ç‚ºæœªè³¼è²·
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "wishlists"), newItem);
                alert('æ…¾æœ›æ¸…å–®æ–°å¢æˆåŠŸï¼');
                document.getElementById('wishlist-form').reset();
            } catch (e) {
                console.error("Error adding wishlist item: ", e);
                alert('æ–°å¢æ…¾æœ›æ¸…å–®å¤±æ•—ã€‚');
            }
        }
        
        // åˆ‡æ›è³¼è²·ç‹€æ…‹ (Update)
        window.toggleWishlistStatus = async function(id, currentStatus) {
            try {
                const docRef = doc(db, "wishlists", id);
                await updateDoc(docRef, {
                    purchased: !currentStatus
                });
            } catch (e) {
                console.error("Error updating wishlist status: ", e);
                alert('æ›´æ–°ç‹€æ…‹å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤æ…¾æœ›æ¸…å–®é …ç›®
        window.deleteWishlistItem = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ…¾æœ›æ¸…å–®å—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "wishlists", id));
            } catch (e) {
                console.error("Error deleting wishlist item: ", e);
                alert('åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        // æ¸²æŸ“æ…¾æœ›æ¸…å–®
        window.renderWishlist = function() {
            const wishlistList = document.getElementById('wishlist-list');
            if (!wishlistList) return;
            if (WISHLIST_DATA.length === 0) {
                wishlistList.innerHTML = '<p class="text-center text-gray-500 text-sm">å°šç„¡å¾…è³¼é …ç›®</p>';
                return;
            }
            wishlistList.innerHTML = WISHLIST_DATA.map(item => {
                const statusClass = item.purchased ? 'purchased' : 'pending';
                const statusText = item.purchased ? 'âœ… å·²è³¼' : 'âŒ æœªè³¼';
                return `
                    <div class="p-3 border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.category}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-custom-primary">Â¥ ${item.price.toLocaleString()}</p>
                            <div class="flex items-center mt-1 space-x-2">
                                <button class="wishlist-status-btn ${statusClass}" onclick="window.toggleWishlistStatus('${item.id}', ${item.purchased})">
                                    ${statusText}
                                </button>
                                <button onclick="window.deleteWishlistItem('${item.id}')" class="text-red-400 hover:text-red-600 text-xs">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /* ===================================================
          é€šç”¨å‡½å¼ (Modal, Navigation, Initialization)
        =================================================== */
        // é–‹å•Ÿ Modal
        window.openModal = function(id) {
            document.getElementById(id).style.display = 'flex';
        }

        // é—œé–‰ Modal
        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        }

        // æ¸²æŸ“ç¸½è¦½å¤©æ°£ (ä¿æŒéœæ…‹ï¼Œå› ç‚ºå¤©æ°£æŸ¥è©¢å¯èƒ½éœ€è¦é¡å¤–çš„ API key)
        window.renderOverviewWeather = function() {
            // é€™å€‹å‡½å¼ä¿æŒéœæ…‹æ¸²æŸ“ï¼Œå¯ä»¥è®“ç”¨æˆ¶è‡ªè¡Œå¡«å……æ¯æ—¥å¤©æ°£
        }

        // æ¸²æŸ“æ¯æ—¥å¤©æ°£ (ç›®å‰ç‚ºç©ºï¼Œå¯è‡ªè¡Œå¯¦ä½œ)
        window.renderWeather = function() {
            const weatherContent = document.getElementById('weather-content');
            weatherContent.innerHTML = '<p class="text-center text-gray-500 mt-8">æ¯æ—¥è©³ç´°å¤©æ°£åŠŸèƒ½å¾…å¯¦ä½œ (éœ€ä¸²æ¥ç¬¬ä¸‰æ–¹å¤©æ°£ API)ã€‚</p>';
        }

        // ä¸»è¦å°èˆªå‡½å¼
        window.switchMainNav = function(targetId) {
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(targetId).classList.remove('hidden');
            document.querySelectorAll('.bottom-nav-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-target') === targetId) {
                    btn.classList.add('active');
                }
            });
            // è™•ç†åˆæ¬¡åˆ‡æ›æ™‚çš„æ¸²æŸ“
            if (targetId === 'expense-tab') {
                window.renderExpenseTracking();
            } else if (targetId === 'wishlist-tab') {
                window.renderWishlist();
            } else if (targetId === 'weather-tab') {
                window.renderWeather();
            }
        }

        // ç¶²é è¼‰å…¥å®Œæˆå¾Œå•Ÿå‹•
        document.addEventListener('DOMContentLoaded', () => {
            // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºæ–°å¢æ”¯å‡ºçš„é è¨­æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            const expenseDateInput = document.getElementById('expense-date');
            if (expenseDateInput) {
                expenseDateInput.value = today;
            }
            window.renderOverviewWeather(); // æ¸²æŸ“éœæ…‹å¤©æ°£ç¸½è¦½
            window.switchMainNav('itinerary-tab'); // ç¢ºä¿åˆå§‹é¡¯ç¤ºè¡Œç¨‹é ç±¤
            startDataSync(); // å•Ÿå‹• Firebase æ•¸æ“šåŒæ­¥
        });
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªè¨‚é¡è‰²ä¸»é¡Œ (æº«æš–/å…¸é›…é…è‰²) */
        .bg-custom-primary { background-color: #008080; } /* ä¸»è‰²ï¼šæ¾çŸ³ç¶ /å¢¨ç¶  */
        .text-custom-primary { color: #008080; }
        .bg-custom-secondary { background-color: #D65A31; } /* å‰¯è‰²ï¼šæŸ”å’Œç£šç´…/çŠç‘šç´… */
        .text-custom-secondary { color: #D65A31; }

        /* è¡Œç¨‹é ç±¤çš„æ—¥æœŸæŒ‰éˆ•æ¨£å¼ */
        .tab-button {
            /* ç¢ºä¿æŒ‰éˆ•ä¸æœƒå› ç‚º Flex è€Œæ”¾å¤§ */
            flex-shrink: 0; 
            /* èª¿æ•´ padding å’Œå­—é«”å¤§å° */
            padding: 0.3rem 0.6rem; 
            font-size: 0.8rem; /* æ•´é«”å­—é«”ç¸®å° */
            line-height: 1.2;
            text-align: center;
            border-radius: 0.5rem;
            cursor: pointer;
            background-color: #FFF8E8; /* æ›¿æ›ç‚ºæ¥µæ·ºç±³è‰² */
            transition: background-color 0.2s, color 0.2s;
            border: none; /* ç§»é™¤é‚Šæ¡† */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* æ–°å¢æŸ”å’Œé™°å½±å–ä»£é‚Šæ¡† */
        }
        /* Day 1 å’Œæ—¥æœŸçš„å­—é«”å¤§å°ä¹Ÿåœ¨ generateDateTabs å‡½å¼ä¸­æ§åˆ¶ */
        /* <div class="font-bold">Day ${index + 1}</div> <-- ä¿æŒé€™å€‹å¤§å°
        <div class="text-xs">${day.date.substring(5)} (${day.day_of_week})</div> <-- ä¿æŒé€™å€‹å¤§å° */

        /* è¡Œç¨‹æ™‚é–“è»¸æ¨£å¼ */
        .timeline-item {
            border-left: 2px solid #008080; /* ä½¿ç”¨æ–°çš„ä¸»è‰² (æ¾çŸ³ç¶ ) */
            padding-left: 1rem;
            cursor: pointer; /* **æ–°å¢ï¼šè®“ä½¿ç”¨è€…çŸ¥é“å¯ä»¥é»æ“Š** */
            transition: background-color 0.2s;
        }
        .timeline-item:hover {
            background-color: #FFFBF0; /* æ›¿æ›ç‚ºæ¥µæ·ºå¥¶æ²¹ç™½ */
        }
        .timeline-container > div:last-child .timeline-item {
            border-left: none; /* ç§»é™¤æœ€å¾Œä¸€å€‹é …ç›®çš„å·¦é‚Šç·š */
        }
        .timeline-item a {
            color: #D65A31; /* ä½¿ç”¨æ–°çš„å‰¯è‰² (ç£šç´…) */
            text-decoration: underline;
        }

        /* åº•éƒ¨å°èˆªæ¬„æ¨£å¼ */
        .bottom-nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0;
            cursor: pointer;
            transition: color 0.2s ease;
            color: #4b5563;
        }
        .bottom-nav-button.active {
            color: #008080; /* ä½¿ç”¨æ–°çš„ä¸»è‰² (æ¾çŸ³ç¶ ) */
        }
        /* ç¢ºä¿åº•éƒ¨å…§å®¹ä¸æœƒè¢«å›ºå®šå°èˆªæ¬„é®æ“‹ */
        body { padding-bottom: 70px; }

        /* è¨˜å¸³é é¢çš„å€å¡Šé»é¸æŒ‰éˆ•æ¨£å¼ */
        .block-select-btn {
            padding: 0.5rem;
            text-align: center;
            border: none; /* ç§»é™¤é‚Šæ¡† */
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            background-color: #F5F5F5; /* è¼•å¾®èƒŒæ™¯è‰² */
            color: #4B5563; /* é è¨­æ–‡å­—é¡è‰² */
            box-shadow: 0 1px 2px rgba(0,0,0,0.02); /* æŸ”å’Œé è¨­é™°å½± */
        }
        /* å¹£åˆ¥ã€é¡åˆ¥ã€ç¯©é¸ ä½¿ç”¨å‰¯è‰² (æŸ”å’Œç£šç´…) */
        .block-select-btn.active-currency,
        .block-select-btn.active-category,
        .block-select-btn.active-filter {
            background-color: #D65A31; /* æ–°å‰¯è‰² */
            color: white;
            box-shadow: 0 2px 5px rgba(214, 90, 49, 0.4); /* çªå‡ºé™°å½±å–ä»£é‚Šæ¡† */
        }
        /* ä»˜æ¬¾äººã€æ”¯ä»˜æ–¹å¼ ä½¿ç”¨ä¸»è‰² (æ¾çŸ³ç¶ ) */
        .block-select-btn.active-payer,
        .block-select-btn.active-payment {
            background-color: #008080; /* æ–°ä¸»è‰² */
            color: white;
            box-shadow: 0 2px 5px rgba(0, 128, 128, 0.4); /* çªå‡ºé™°å½±å–ä»£é‚Šæ¡† */
        }

        /* æ…¾æœ›æ¸…å–®çš„å·²è³¼/æœªè³¼æŒ‰éˆ•æ¨£å¼ */
        .wishlist-status-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .wishlist-status-btn.pending {
            background-color: #fca5...
        }
    </style>
</head>
<body class="bg-gray-100 font-serif"> <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg">

        <div id="itinerary-tab" class="main-tab-content p-4">
            <header class="flex justify-between items-center mb-4 sticky top-0 bg-white pt-4 pb-2 z-10 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-custom-primary">ğŸ‡¯ğŸ‡µ ç¦å²¡ & ç†Šæœ¬</h1>
                <button onclick="window.openModal('addItineraryModal')" class="bg-custom-primary text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-[#006666] transition">
                    <i class="fa-solid fa-plus mr-1"></i> æ–°å¢è¡Œç¨‹
                </button>
            </header>

            <section id="weather-overview" class="mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
                <h2 class="text-lg font-bold text-gray-700 mb-3"><i class="fa-solid fa-cloud-sun text-custom-secondary mr-2"></i>å¤©æ°£æ¦‚æ³</h2>
                <div class="flex justify-between text-center text-sm">
                    <div class="w-1/5">
                        <p class="font-semibold">Day 1</p>
                        <i class="fa-solid fa-sun text-custom-primary text-xl"></i>
                        <p>18Â°C/10Â°C</p>
                    </div>
                    <div class="w-1/5">
                        <p class="font-semibold">Day 2</p>
                        <i class="fa-solid fa-cloud-showers-heavy text-blue-400 text-xl"></i>
                        <p>15Â°C/8Â°C</p>
                    </div>
                    <div class="w-1/5">
                        <p class="font-semibold">Day 3</p>
                        <i class="fa-solid fa-cloud text-gray-500 text-xl"></i>
                        <p>16Â°C/9Â°C</p>
                    </div>
                    <div class="w-1/5">
                        <p class="font-semibold">Day 4</p>
                        <i class="fa-solid fa-wind text-custom-primary text-xl"></i>
                        <p>17Â°C/11Â°C</p>
                    </div>
                    <div class="w-1/5">
                        <p class="font-semibold">Day 5</p>
                        <i class="fa-solid fa-umbrella text-custom-secondary text-xl"></i>
                        <p>14Â°C/7Â°C</p>
                    </div>
                </div>
            </section>

            <div id="itinerary-overview-buttons" class="flex space-x-2 overflow-x-auto pb-4 sticky top-[70px] bg-white z-10 border-b border-gray-200">
                </div>
            
            <section id="itinerary-container" class="mt-4">
                </section>
            
            <section class="mt-8 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400 shadow-sm">
                <h3 class="text-lg font-bold text-gray-700 mb-2">é‡è¦å‚™è¨»</h3>
                <ul class="list-disc pl-5 text-gray-600 text-sm space-y-1">
                    <li>è«‹è¨˜å¾—å¸¶è­·ç…§å’Œé›»å­æ©Ÿç¥¨ã€‚</li>
                    <li>JR Pass å¿…é ˆåœ¨Day 2é–‹å§‹å•Ÿç”¨ã€‚</li>
                    <li>é£¯åº—å…¥ä½æ™‚é–“çš†ç‚ºä¸‹åˆ 3 é»ã€‚</li>
                </ul>
            </section>

            <div class="fixed bottom-20 right-6 z-20">
                <button onclick="window.openModal('addItineraryModal')" class="bg-custom-primary text-white p-4 rounded-full shadow-lg hover:bg-[#006666] transition z-20"> <i class="fa-solid fa-calendar-plus text-2xl"></i>
                </button>
            </div>
        </div>

        <div id="expense-tab" class="main-tab-content p-4 hidden">
            <header class="mb-4">
                <h1 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-file-invoice text-[#D65A31] mr-2"></i>è¨˜å¸³è¿½è¹¤</h1> </header>

            <section class="mb-6 p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
                <h2 class="text-lg font-bold text-gray-700 mb-3"><i class="fa-solid fa-chart-line text-custom-primary mr-2"></i>é ç®—èˆ‡çµç®—</h2>
                <div class="grid grid-cols-3 gap-2 text-center text-sm mb-3">
                    <div>
                        <p class="text-gray-500">ç¸½é ç®— (TWD)</p>
                        <p id="total-budget" class="font-bold text-lg text-custom-primary">50,000</p>
                    </div>
                    <div>
                        <p class="text-gray-500">ç¸½èŠ±è²» (TWD)</p>
                        <p id="total-spent" class="font-bold text-lg text-red-600">--</p>
                    </div>
                    <div>
                        <p class="text-gray-500">å‰©é¤˜é ç®—</p>
                        <p id="remaining-budget" class="font-bold text-lg text-green-600">--</p>
                    </div>
                </div>
                
                <hr class="my-3 border-gray-200">
                
                <h3 class="font-bold text-md mb-2">å€‹äººç¸½ä»˜é‡‘é¡:</h3>
                <div class="flex justify-between text-sm mb-2">
                    <p class="text-gray-600">Josh å·²ä»˜:</p>
                    <p id="josh-paid" class="font-bold text-gray-800">-- TWD</p>
                </div>
                <div class="flex justify-between text-sm mb-3">
                    <p class="text-gray-600">Candice å·²ä»˜:</p>
                    <p id="candice-paid" class="font-bold text-gray-800">-- TWD</p>
                </div>
                
                <div class="mb-4 p-3 bg-teal-50 border border-teal-200 rounded-lg"> <p class="text-sm font-semibold text-teal-700">å³æ™‚åŒ¯ç‡ (JPY/TWD)ï¼š<span id="exchange-rate-display">--</span></p>
                </div>
                
                <p id="settlement-result" class="text-center font-bold text-lg text-gray-900"></p>
                
                <button onclick="window.openModal('addExpenseModal')" class="w-full bg-custom-secondary text-white p-2 rounded-lg font-bold hover:bg-[#A64726] mt-3"> <i class="fa-solid fa-circle-plus mr-1"></i> æ–°å¢æ”¯å‡º
                </button>
            </section>
            
            <section class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-700">æ”¯å‡ºåˆ—è¡¨</h2>
                    <div id="category-filter-buttons" class="flex space-x-2">
                        </div>
                </div>
                
                <div id="expense-list" class="border rounded-lg bg-white divide-y divide-gray-100 shadow-sm">
                    </div>
            </section>
        </div>

        <div id="wishlist-tab" class="main-tab-content p-4 hidden">
             <header class="mb-4">
                <h1 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-tags text-[#D65A31] mr-2"></i>æ…¾æœ›æ¸…å–®</h1> </header>
            
            <section class="mb-6">
                <button onclick="window.openModal('addWishlistModal')" class="w-full bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-[#006666] mb-4"> <i class="fa-solid fa-gift mr-1"></i> æ–°å¢å¾…è³¼é …ç›®
                </button>
                
                <h2 class="text-lg font-bold text-gray-700 mb-3">å¾…è³¼ & å·²è³¼é …ç›®</h2>

                <div id="wishlist-list" class="border rounded-lg bg-white divide-y divide-gray-100 shadow-sm">
                    </div>
            </section>
        </div>

        <div id="weather-tab" class="main-tab-content p-4 hidden">
             <header class="mb-4">
                <h1 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-umbrella text-custom-primary mr-2"></i>å¤©æ°£é å ±</h1>
            </header>
            
            <section id="weather-content" class="text-center">
                <div class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <p class="text-gray-500">æ¯æ—¥è©³ç´°å¤©æ°£åŠŸèƒ½å¾…å¯¦ä½œ</p>
                    <p class="text-xs text-gray-400 mt-2">è«‹æ–¼ `renderWeather` å‡½å¼ä¸­ä¸²æ¥å¤©æ°£ API</p>
                </div>
            </section>
        </div>

    </div>
    
    <footer class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 shadow-md z-30">
        <nav class="flex justify-around">
            <div class="bottom-nav-button active" data-target="itinerary-tab" onclick="window.switchMainNav('itinerary-tab')">
                <i class="fa-solid fa-route text-xl"></i>
                <span class="text-xs mt-1">è¡Œç¨‹</span>
            </div>
            <div class="bottom-nav-button" data-target="expense-tab" onclick="window.switchMainNav('expense-tab')">
                <i class="fa-solid fa-wallet text-xl"></i>
                <span class="text-xs mt-1">è¨˜å¸³</span>
            </div>
            <div class="bottom-nav-button" data-target="wishlist-tab" onclick="window.switchMainNav('wishlist-tab')">
                <i class="fa-solid fa-cart-shopping text-xl"></i>
                <span class="text-xs mt-1">å¾…è³¼</span>
            </div>
            <div class="bottom-nav-button" data-target="weather-tab" onclick="window.switchMainNav('weather-tab')">
                <i class="fa-solid fa-cloud text-xl"></i>
                <span class="text-xs mt-1">å¤©æ°£</span>
            </div>
        </nav>
    </footer>

    <div id="addItineraryModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-sm shadow-xl">
            <h2 class="text-2xl font-bold text-custom-primary mb-4 text-center">æ–°å¢è¡Œç¨‹é …ç›®</h2>
            <form id="add-itinerary-form" onsubmit="window.addItineraryItem(event)">
                <label for="new-date" class="text-sm font-semibold text-gray-700 mb-1 block">æ—¥æœŸ:</label>
                <select id="new-date" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg mb-3 text-sm" required>
                    </select>

                <label for="new-time" class="text-sm font-semibold text-gray-700 mb-1 block">æ™‚é–“:</label>
                <div class="flex items-center mb-3">
                    <input type="text" id="new-time" placeholder="--:--" pattern="[0-2][0-9]:[0-5][0-9]" class="flex-1 p-2 border border-gray-200 shadow-inner rounded-lg text-sm mr-2" required>
                    <i class="fa-solid fa-clock text-gray-500"></i>
                </div>
                
                <label for="new-title" class="text-sm font-semibold text-gray-700 mb-1 block">è¡Œç¨‹æ¨™é¡Œ:</label>
                <input type="text" id="new-title" placeholder="è¡Œç¨‹æ¨™é¡Œ (å¦‚: æ™šé¤)" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg mb-3 text-sm" required>
                
                <label for="new-note" class="text-sm font-semibold text-gray-700 mb-1 block">å‚™è¨»/åœ°é»:</label>
                <textarea id="new-note" rows="2" placeholder="å‚™è¨» (å¦‚: é˜¿è˜‡èµ¤ç‰›ä¸¼/é£¯åº—)" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg mb-4 text-sm"></textarea>
                
                <div class="flex space-x-2">
                    <button type="button" onclick="window.closeModal('addItineraryModal')" class="flex-1 bg-gray-200 text-gray-700 p-2 rounded-lg font-bold hover:bg-gray-300">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 bg-custom-secondary text-white p-2 rounded-lg font-bold hover:bg-[#A64726]">å„²å­˜</button> </div>
            </form>
        </div>
    </div>

    <div id="editItineraryModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-sm shadow-xl">
            <h2 class="text-2xl font-bold text-custom-secondary mb-2 text-center">ç·¨è¼¯è¡Œç¨‹é …ç›®</h2>
            <p id="edit-modal-date-info" class="text-sm text-gray-500 mb-4 text-center"></p>
            <form id="edit-itinerary-form" onsubmit="window.saveItineraryItem(event)">
                <input type="hidden" id="edit-date-key">
                <input type="hidden" id="edit-item-index">

                <label for="edit-time" class="text-sm font-semibold text-gray-700 mb-1 block">æ™‚é–“:</label>
                <div class="flex items-center mb-3">
                    <input type="text" id="edit-time" placeholder="--:--" pattern="[0-2][0-9]:[0-5][0-9]" class="flex-1 p-2 border border-gray-200 shadow-inner rounded-lg text-sm mr-2" required>
                    <i class="fa-solid fa-clock text-gray-500"></i>
                </div>
                
                <label for="edit-title" class="text-sm font-semibold text-gray-700 mb-1 block">è¡Œç¨‹æ¨™é¡Œ:</label>
                <input type="text" id="edit-title" placeholder="è¡Œç¨‹æ¨™é¡Œ (å¦‚: æ™šé¤)" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg mb-3 text-sm" required>
                
                <label for="edit-note" class="text-sm font-semibold text-gray-700 mb-1 block">å‚™è¨»/åœ°é»:</label>
                <textarea id="edit-note" rows="2" placeholder="å‚™è¨» (å¦‚: é˜¿è˜‡èµ¤ç‰›ä¸¼/é£¯åº—)" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg mb-4 text-sm"></textarea>
                
                <div class="flex space-x-2">
                    <button type="button" onclick="window.deleteItineraryItem(document.getElementById('edit-date-key').value, parseInt(document.getElementById('edit-item-index').value))" class="flex-1 bg-red-500 text-white p-2 rounded-lg font-bold hover:bg-red-600">
                        <i class="fa-solid fa-trash-can mr-1"></i> åˆªé™¤
                    </button>
                    <button type="submit" class="flex-1 bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-[#006666]">å„²å­˜ä¿®æ”¹</button> </div>
            </form>
        </div>
    </div>

    <div id="addExpenseModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-sm shadow-xl">
            <h2 class="text-2xl font-bold text-custom-secondary mb-4 text-center">æ–°å¢æ”¯å‡ºç´€éŒ„</h2>
            
            <div class="mb-4 space-y-3">
                 <label class="text-sm font-semibold text-gray-700 mb-1 block">å¹£åˆ¥:</label>
                <div id="currency-select" class="flex space-x-2" role="group">
                    <button type="button" class="block-select-btn flex-1 active-currency" data-currency="TWD" onclick="window.selectCurrency('TWD')">TWD (å°å¹£)</button>
                    <button type="button" class="block-select-btn flex-1" data-currency="JPY" onclick="window.selectCurrency('JPY')">JPY (æ—¥åœ“)</button>
                </div>
                
                 <label class="text-sm font-semibold text-gray-700 mb-1 block">ä»˜æ¬¾äºº:</label>
                <div id="payer-select" class="flex space-x-2" role="group">
                    <button type="button" class="block-select-btn flex-1 active-payer" data-payer="Josh" onclick="window.selectPayer('Josh')">Josh</button>
                    <button type="button" class="block-select-btn flex-1" data-payer="Candice" onclick="window.selectPayer('Candice')">Candice</button>
                </div>

                <label class="text-sm font-semibold text-gray-700 mb-1 block">é¡åˆ¥:</label>
                <div id="category-select" class="flex flex-wrap gap-2" role="group">
                    <button type="button" class="block-select-btn active-category" data-category="Food" onclick="window.selectCategory('Food')">é¤é£²</button>
                    <button type="button" class="block-select-btn" data-category="Shopping" onclick="window.selectCategory('Shopping')">è³¼ç‰©</button>
                    <button type="button" class="block-select-btn" data-category="Transport" onclick="window.selectCategory('Transport')">äº¤é€š</button>
                    <button type="button" class="block-select-btn" data-category="Accommodation" onclick="window.selectCategory('Accommodation')">ä½å®¿</button>
                    <button type="button" class="block-select-btn" data-category="Other" onclick="window.selectCategory('Other')">å…¶ä»–</button>
                </div>
                
                <label class="text-sm font-semibold text-gray-700 mb-1 block">æ”¯ä»˜æ–¹å¼:</label>
                <div id="payment-select" class="flex flex-wrap gap-2" role="group">
                    <button type="button" class="block-select-btn active-payment" data-payment="Cash" onclick="window.selectPayment('Cash')">ç¾é‡‘</button>
                    <button type="button" class="block-select-btn" data-payment="Card" onclick="window.selectPayment('Card')">ä¿¡ç”¨å¡</button>
                    <button type="button" class="block-select-btn" data-payment="Mobile" onclick="window.selectPayment('Mobile')">è¡Œå‹•æ”¯ä»˜</button>
                </div>
            </div>

            <div class="space-y-3">
                <label for="expense-date" class="text-sm font-semibold text-gray-700 mb-1 block">æ—¥æœŸ:</label>
                <input type="date" id="expense-date" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg text-sm" required>

                <label for="expense-amount" class="text-sm font-semibold text-gray-700 mb-1 block">é‡‘é¡:</label>
                <input type="number" id="expense-amount" placeholder="0" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg text-sm" required min="1">
                
                <label for="expense-description" class="text-sm font-semibold text-gray-700 mb-1 block">ç”¨é€”/èªªæ˜:</label>
                <input type="text" id="expense-description" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ - ä¸€è˜­æ‹‰éºµ" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg mb-4 text-sm" required>
            </div>
            
            <input type="hidden" id="expense-currency" value="TWD">
            <input type="hidden" id="expense-payer" value="Josh">
            <input type="hidden" id="expense-category" value="Food">
            <input type="hidden" id="expense-payment" value="Cash">
            
            <div class="flex space-x-2 mt-4">
                <button type="button" onclick="window.closeModal('addExpenseModal')" class="flex-1 bg-gray-200 text-gray-700 p-2 rounded-lg font-bold hover:bg-gray-300">å–æ¶ˆ</button>
                <button type="button" onclick="window.addExpense()" class="flex-1 bg-custom-secondary text-white p-2 rounded-lg font-bold hover:bg-[#A64726]">å„²å­˜ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <div id="addWishlistModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-sm shadow-xl">
            <h2 class="text-2xl font-bold text-custom-primary mb-4 text-center">æ–°å¢å¾…è³¼é …ç›®</h2>
            <form id="wishlist-form" onsubmit="window.addWishlistItem(event)">
                <label for="wishlist-name" class="text-sm font-semibold text-gray-700 mb-1 block">é …ç›®åç¨±:</label>
                <input type="text" id="wishlist-name" placeholder="ä¾‹å¦‚ï¼šé™å®šç‰ˆæ¨¡å‹" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg mb-3 text-sm" required>
                
                <label for="wishlist-price" class="text-sm font-semibold text-gray-700 mb-1 block">é ä¼°åƒ¹æ ¼ (JPY):</label>
                <input type="number" id="wishlist-price" placeholder="0" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg mb-3 text-sm" required min="1">
                
                <label for="wishlist-category" class="text-sm font-semibold text-gray-700 mb-1 block">åˆ†é¡:</label>
                <select id="wishlist-category" class="w-full p-2 border border-gray-200 shadow-inner rounded-lg mb-4 text-sm" required>
                    <option value="Shopping">è³¼ç‰©</option>
                    <option value="Food">é¤é£²</option>
                    <option value="Souvenir">ç´€å¿µå“</option>
                    <option value="Other">å…¶ä»–</option>
                </select>
                
                <div class="flex space-x-2">
                    <button type="button" onclick="window.closeModal('addWishlistModal')" class="flex-1 bg-gray-200 text-gray-700 p-2 rounded-lg font-bold hover:bg-gray-300">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-[#006666]">æ–°å¢</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>