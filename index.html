<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦å²¡ç†Šæœ¬è¡Œç¨‹åŠ©æ‰‹</title>
    <!-- å¼•å…¥å¯æ„›çš„åœ“é«”å­—å‹ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
   <style type="text/tailwindcss" >
        /* è‡ªå®šç¾©é¡è‰² - å¯æ„›æ´»æ½‘ç‰ˆ */
        :root {
            --custom-primary: #FF8BA7; /* Sweet Pink */
            --custom-secondary: #4ECDC4; /* Lively Mint */
            --custom-danger: #FF6B6B; /* Soft Coral */
            --custom-bg: #FFFDF9; /* Creamy White */
            --custom-text: #595959; /* Softer Dark Gray */
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif !important;
            color: var(--custom-text);
            background-color: var(--custom-bg);
        }

        /* è¦†è“‹ Tailwind çš„é è¨­èƒŒæ™¯ */
        .bg-gray-50 { background-color: var(--custom-bg) !important; }
        .bg-white { background-color: #ffffff; }

        .bg-custom-primary { background-color: var(--custom-primary); }
        .text-custom-primary { color: var(--custom-primary); }
        .bg-custom-secondary { background-color: var(--custom-secondary); }
        .text-custom-secondary { color: var(--custom-secondary); }
        .border-custom-primary { border-color: var(--custom-primary); }
        
        /* å¢åŠ æŒ‰éˆ•äº’å‹•æ•ˆæœ */
        .hover\:bg-custom-primary-dark:hover { 
            background-color: #FF7596; 
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(255, 139, 167, 0.3);
        }
        .hover\:text-custom-primary-dark:hover { color: #FF7596; }

        /* è®“æ‰€æœ‰åœ“è§’æ›´åœ“æ½¤ */
        .rounded-lg { border-radius: 16px !important; }
        .rounded-xl { border-radius: 20px !important; }

        /* é€šç”¨æŒ‰éˆ•æ¨£å¼ - è®Šå¾—æ›´åƒç³–æœ */
        .tab-button {
            padding: 8px 16px;
            margin-right: 8px;
            border-radius: 20px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 80px;
            font-size: 0.9rem;
            border: 2px solid #F0F0F0;
            color: #7D7D7D;
            background: white;
            font-weight: bold;
        }
        .tab-button:hover {
            border-color: #FFD1DC;
            color: #FF8BA7;
        }
        .tab-button.active {
            background-color: var(--custom-primary);
            color: white;
            border-color: var(--custom-primary);
            box-shadow: 0 4px 10px rgba(255, 139, 167, 0.4);
            transform: scale(1.05);
        }

        /* ä¸»å°èˆªæŒ‰éˆ•æ¨£å¼ */
        .main-nav-btn {
            @apply flex-1 py-4 text-center transition duration-200 text-gray-500 border-b-4 border-transparent;
        }
        .main-nav-btn i {
            font-size: 1.2rem;
            margin-bottom: 2px;
            display: inline-block;
        }
        .main-nav-btn.active {
            color: var(--custom-primary);
            border-color: var(--custom-primary);
            font-weight: 800;
        }
        
      /* 1. åŸºç¤æ¨£å¼ï¼šåœ“åœ“çš„æ¡† + é–’ç½®æ™‚ç°è‰²æ¡† */
.block-select-btn {
    /* ä½¿ç”¨ rounded-full é”æˆè† å›Šç‹€åœ“è§’ */
    @apply px-4 py-1 border-2 rounded-full text-sm font-bold transition-all duration-200 mr-2 mb-2 bg-white;
    
    /* é–’ç½®æ™‚çš„é¡è‰²è¨­å®š */
    border-color: #D1D5DB !important; /* æ·ºç°è‰²æ¡† */
    color: #6B7280;                   /* ç°è‰²æ–‡å­— */
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* 2. é–’ç½®æ™‚æ»‘é¼ æ‡¸åœæ•ˆæœ (å¾®ç²‰ç´…æç¤º) */
.block-select-btn:hover:not([class*="active-"]) {
    border-color: #FF748D;
    background-color: #FFF1F2; /* æ·¡æ·¡çš„ç²‰ç´…åº• */
    color: #FF748D;
}

/* 3. é¸å–ç‹€æ…‹ï¼šç²‰ç´…è‰²å¡«æ»¿ + ç²‰ç´…è‰²å¤–æ¡† */
.active-currency, .active-payer, .active-category, .active-payment, .active-filter {
    background-color: #FF7596!important; /* ç²‰ç´…å¡«æ»¿ */
    border-color: #FF748D !important;     /* ç²‰ç´…å¤–æ¡† */
    color: white !important;              /* æ–‡å­—è½‰ç™½ */
    @apply shadow-md;
    transform: scale(1.05);               /* è¼•å¾®æ”¾å¤§æ„Ÿ */
}

        /* è¡Œç¨‹æ™‚é–“ç·šé€£æ¥ç·š - æ”¹æˆè™›ç·šæ›´å¯æ„› */
        .timeline-container {
            position: relative;
        }
        .timeline-container::before {
            content: '';
            position: absolute;
            top: 60px;
            bottom: 30px;
            left: 1.5rem;
            width: 3px;
            background-image: linear-gradient(to bottom, #FFE5EA 50%, transparent 50%);
            background-size: 3px 15px;
            background-repeat: repeat-y;
            background-color: transparent;
            z-index: 0;
        }
        .timeline-item {
            padding-left: 1.5rem;
            min-height: 20px;
            cursor: pointer;
        }
        
        /* æ™‚é–“é»é» */
        .timeline-dot {
            box-shadow: 0 0 0 3px #FFF0F3;
        }

        /* æ…¾æœ›æ¸…å–®ç‹€æ…‹ */
        .wishlist-status-btn {
            @apply px-3 py-1 rounded-full text-xs font-bold shadow-sm;
        }
        .wishlist-status-btn.purchased {
            @apply bg-custom-secondary text-white;
        }
        .wishlist-status-btn.pending {
            @apply bg-orange-100 text-orange-600;
        }

        /* æ‰“åŒ…æ¸…å–®ç‹€æ…‹ (æ–°å¢) */
        .packing-status-btn {
            @apply px-2 py-1 rounded-full text-xs font-bold transition duration-150;
        }
        .packing-status-btn.packed {
            @apply bg-custom-secondary text-white shadow-sm;
        }
        .packing-status-btn.not-packed {
            @apply bg-pink-50 text-pink-400 hover:bg-pink-100;
        }
        
        /* è¼¸å…¥æ¡†æ¨£å¼å„ªåŒ– */
        input, select, textarea {
            border: 2px solid #F3F4F6 !important;
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--custom-primary) !important;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 139, 167, 0.1);
        }
    </style>
    
    <script type="module">
        /* =========================
          Firebase åˆå§‹åŒ– (ä½¿ç”¨ ES Modules)
        ========================= */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import {
            getFirestore,
            collection,
            doc,
            setDoc, // ç”¨æ–¼è¦†å¯«æ•´å€‹æ–‡ä»¶ (ä¾‹å¦‚æ–°å¢è¡Œç¨‹å¤©æ•¸æ™‚)
            addDoc, // ç”¨æ–¼æ–°å¢æ–‡ä»¶ (ä¾‹å¦‚è¨˜å¸³å’Œæ…¾æœ›æ¸…å–®)
            updateDoc, // ç”¨æ–¼æ›´æ–°ç¾æœ‰æ–‡ä»¶ (ä¾‹å¦‚ä¿®æ”¹è¡Œç¨‹å…§å®¹)
            deleteDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        
        // ğŸš¨ è«‹ç¢ºèªé€™æ˜¯æ‚¨çš„çœŸå¯¦é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBRjYjvwvCNTRHdI8vH8n3GPabzSnSDbvI",
            authDomain: "jp-b0e03.firebaseapp.com",
            projectId: "jp-b0e03",
            storageBucket: "jp-b0e03.firebasestorage.app", // å»ºè­°åŠ å…¥
            messagingSenderId: "689610031212", // å»ºè­°åŠ å…¥
            appId: "1:689610031212:web:f63f2efe61d4ad562bd849", // å»ºè­°åŠ å…¥
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
/* ===================================================
  é ç®—ç·¨è¼¯èˆ‡å„²å­˜åŠŸèƒ½
=================================================== */

// 1. å•Ÿå‹•ç·¨è¼¯æ¨¡å¼
window.enableBudgetEdit = function() {
    const display = document.getElementById('budget-display');
    const form = document.getElementById('budget-edit-form');
    const budgetValue = document.getElementById('total-budget').innerText.replace(/,/g, ''); // ç§»é™¤åƒä½åˆ†éš”ç¬¦
    
    // éš±è—é¡¯ç¤ºå€å¡Šï¼Œé¡¯ç¤ºç·¨è¼¯è¡¨å–®
    display.classList.add('hidden');
    form.classList.remove('hidden');
    
    // å°‡ç•¶å‰å€¼è³¦äºˆ input ä¸¦èšç„¦
    const input = document.getElementById('budget-input');
    input.value = budgetValue;
    input.focus();
};

// 2. å–æ¶ˆç·¨è¼¯
window.cancelBudgetEdit = function() {
    document.getElementById('budget-display').classList.remove('hidden');
    document.getElementById('budget-edit-form').classList.add('hidden');
};

// 3. å„²å­˜é ç®—ä¸¦æ›´æ–° Firebase (å‡è¨­ trip info å„²å­˜åœ¨ trips é›†åˆçš„ 'currentTrip' æ–‡ä»¶ä¸­)
window.saveBudget = async function() {
    const newBudgetString = document.getElementById('budget-input').value;
    const newBudget = parseFloat(newBudgetString);

    if (isNaN(newBudget) || newBudget < 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é ç®—é‡‘é¡ã€‚");
        return;
    }

    try {
        // å‡è¨­æ‚¨çš„ trip info å„²å­˜åœ¨ä¸€å€‹å›ºå®šçš„æ–‡ä»¶ ID ä¸‹
        const tripDocRef = doc(db, "trips", "currentTrip"); 
        
        // æ›´æ–° Firebase
        await updateDoc(tripDocRef, {
            totalBudget: newBudget 
        });

        // æ›´æ–°æˆåŠŸå¾Œï¼Œåˆ·æ–°é¡¯ç¤ºå’Œç‹€æ…‹
        document.getElementById('total-budget').innerText = newBudget.toLocaleString(); // æ ¼å¼åŒ–é¡¯ç¤º
        window.cancelBudgetEdit();
        
        // å‡è¨­æ‚¨æœ‰ä¸€å€‹å‡½å¼ä¾†æ¸²æŸ“è¨˜å¸³æ¦‚æ³ï¼Œéœ€è¦é‡æ–°èª¿ç”¨
        // window.renderExpenseSummary(); 

    } catch (error) {
        console.error("æ›´æ–°é ç®—å¤±æ•—: ", error);
        alert("æ›´æ–°é ç®—å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
    }
};

// âš ï¸ æ³¨æ„ï¼šæ‚¨é‚„éœ€è¦ç¢ºä¿æ‚¨çš„æ•¸æ“šåŒæ­¥å‡½å¼ (startDataSync) åœ¨ç²å– trip info æ™‚ï¼Œ
// èƒ½å¤ å°‡ totalBudget æ¸²æŸ“åˆ° <span id="total-budget"> è£¡ã€‚
        /* =========================
          å…¨åŸŸè®Šæ•¸èˆ‡è³‡æ–™ç‹€æ…‹
        ========================= */
        let ITINERARY_DATA = []; // è¡Œç¨‹æ•¸æ“š (ç”¨æ–¼æ¸²æŸ“)
        let EXPENSES_DATA = []; // è¨˜å¸³æ•¸æ“š
        let WISHLIST_DATA = []; // æ…¾æœ›æ¸…å–®æ•¸æ“š
        let PACKING_DATA = []; // â­ï¸ æ–°å¢ï¼šæ‰“åŒ…æ¸…å–®æ•¸æ“š
        let ACTIVE_DATE = ''; // ç•¶å‰é¸ä¸­çš„æ—¥æœŸ (è¡Œç¨‹é ç±¤)
        let ACTIVE_CURRENCY = 'TWD';
        let ACTIVE_PAYER = 'Josh';
        let ACTIVE_CATEGORY = 'Food';
        let ACTIVE_PAYMENT = 'Cash';
        let EXPENSE_FILTER = 'All';
        
        // åŒ¯ç‡èˆ‡é ç®— (éœæ…‹è³‡æ–™æˆ–æœªä¾†å¯å¾ Firestore è¼‰å…¥)
        const EXCHANGE_RATE_JPY_TWD = 0.215; 
        const TOTAL_BUDGET_TWD = 50000;
        
        // é¡åˆ¥åœ–æ¨™æ˜ å°„
        const ICON_MAP = {
            Food: 'fa-utensils',
            Transport: 'fa-train-subway',
            Accommodation: 'fa-hotel',
            Shopping: 'fa-bag-shopping',
            Other: 'fa-ellipsis',
            // æ–°å¢æ›´å¤šé¡åˆ¥ä»¥æ”¯æ´è¨˜å¸³ç·¨è¼¯
            Ticket: 'fa-ticket', 
            Souvenir: 'fa-gift'
        };

        /* =========================
          æ•¸æ“šåŒæ­¥æ ¸å¿ƒ (onSnapshot)
        ========================= */
        function startDataSync() {
            // 1. è¡Œç¨‹æ•¸æ“š (Itineraries) - æŒ‰æ—¥æœŸæ’åº
            const itineraryQuery = query(collection(db, "itineraries"), orderBy("date", "asc"));
            onSnapshot(itineraryQuery, (snapshot) => {
                ITINERARY_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // ç¢ºä¿ activities æ˜¯ä¸€å€‹é™£åˆ—ï¼Œä¸¦æŒ‰æ™‚é–“æ’åº
                    activities: Array.isArray(doc.data().activities) ? 
                                doc.data().activities.sort((a, b) => a.time.localeCompare(b.time)) : []
                }));

                if (ITINERARY_DATA.length > 0) {
                    if (!ACTIVE_DATE) {
                        ACTIVE_DATE = ITINERARY_DATA[0].id; // ä½¿ç”¨ id ä½œç‚ºæ—¥æœŸéµ
                    }
                    window.generateDateTabs();
                    window.renderItinerary();
                    window.populateItineraryModalDates();
                } else {
                    document.getElementById('itinerary-container').innerHTML = '<p class="text-center text-gray-500 mt-8">è«‹åœ¨ Firebase Console ä¸­æ–°å¢è¡Œç¨‹æ•¸æ“šã€‚</p>';
                }
            }, (error) => {
                console.error("Error listening to itineraries: ", error);
            });
            
            // 2. è¨˜å¸³æ•¸æ“š (Expenses) - æŒ‰æ—¥æœŸæ’åº
            const expenseQuery = query(collection(db, "expenses"), orderBy("date", "desc"), orderBy("timestamp", "desc"));
            onSnapshot(expenseQuery, (snapshot) => {
                EXPENSES_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                window.renderExpenseTracking(); // æ•¸æ“šæ›´æ–°æ™‚é‡æ–°æ¸²æŸ“è¨˜å¸³é 
            }, (error) => {
                console.error("Error listening to expenses: ", error);
            });
// â­ï¸ 2. ç²å–ä¸¦ç›£è½æ—…è¡Œè³‡è¨Š/é ç®— (Trip Info / Budget)
    const tripDocRef = doc(db, "trips", "currentTrip");
    onSnapshot(tripDocRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            const budget = data.totalBudget || 0; // å¦‚æœ totalBudget ä¸å­˜åœ¨ï¼Œé è¨­ç‚º 0
            
            // å°‡å¾ Firebase è®€å–åˆ°çš„æœ€æ–°é ç®—æ¸²æŸ“åˆ° HTML å…ƒç´ 
            document.getElementById('total-budget').innerText = budget.toLocaleString();

            // å­˜å„²é ç®—åˆ°å…¨åŸŸè®Šæ•¸ (å¦‚æœéœ€è¦è¨ˆç®—æ”¯å‡ºç™¾åˆ†æ¯”)
            window.TOTAL_BUDGET = budget;
            
            // é‡æ–°æ¸²æŸ“æ”¯å‡ºæ¦‚æ³ï¼Œä»¥ä¾¿æ›´æ–°é ç®—ç™¾åˆ†æ¯”
            window.renderExpenseTracking(); 
        } else {
            console.warn("Trip info document 'currentTrip' not found. Budget set to 0.");
            document.getElementById('total-budget').innerText = "0";
            window.TOTAL_BUDGET = 0;
        }
    }, (error) => {
        console.error("Error listening to trip info: ", error);
    });
            
            // 3. æ…¾æœ›æ¸…å–® (Wishlist) - æŒ‰è³¼è²·ç‹€æ…‹å’Œæ™‚é–“æ’åº
            const wishlistQuery = query(collection(db, "wishlists"), orderBy("purchased", "asc"), orderBy("timestamp", "desc"));
            onSnapshot(wishlistQuery, (snapshot) => {
                WISHLIST_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // åªæœ‰åœ¨ wishlist é ç±¤è¢«é¸ä¸­æ™‚æ‰å¼·åˆ¶æ¸²æŸ“ï¼Œé¿å…ä¸å¿…è¦çš„é–‹éŠ·
                if (document.getElementById('wishlist-tab').classList.contains('hidden') === false) {
                     window.renderWishlist(); 
                }
            }, (error) => {
                console.error("Error listening to wishlists: ", error);
            });

            // 4. â­ï¸ æ–°å¢ï¼šæ‰“åŒ…æ¸…å–® (PackingList) - æŒ‰æ‰“åŒ…ç‹€æ…‹å’Œæ™‚é–“æ’åº
            const packingQuery = query(collection(db, "packinglist"), orderBy("packed", "asc"), orderBy("timestamp", "desc"));
            onSnapshot(packingQuery, (snapshot) => {
                PACKING_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                if (document.getElementById('packing-tab') && document.getElementById('packing-tab').classList.contains('hidden') === false) {
                    window.renderPackingList();
                }
            }, (error) => {
                console.error("Error listening to packinglist: ", error);
            });
            
            // æ¸²æŸ“åŒ¯ç‡ (éœæ…‹)
            document.getElementById('exchange-rate-display').textContent = EXCHANGE_RATE_JPY_TWD.toFixed(4);
        }

        /* ===================================================
          è¡Œç¨‹ (ITINERARY) ç›¸é—œå‡½å¼
        =================================================== */

        // æ¸²æŸ“æ—¥æœŸæŒ‰éˆ•
        window.generateDateTabs = function() {
            const tabContainer = document.getElementById('date-buttons-container');
            if (!tabContainer) return;
            tabContainer.innerHTML = ''; 

            ITINERARY_DATA.forEach((day, index) => {
                const isActive = day.id === ACTIVE_DATE;
                const button = document.createElement('button');
                
                // ç¢ºä¿ä½¿ç”¨ HTML ä¸­å®šç¾©çš„ CSS class
                button.className = `tab-button ${isActive ? 'active' : ''}`;
                button.innerHTML = `
                    <div class="font-bold">Day ${index + 1}</div>
                    <div class="text-xs font-normal">${day.date.substring(5)} (${day.day_of_week})</div>
                `;
                
                button.onclick = () => {
                    window.setActiveDate(day.id);
                };
                
                tabContainer.appendChild(button);
            });
        }
        
        // åˆ‡æ›ç•¶å‰é¸ä¸­æ—¥æœŸ
        window.setActiveDate = function(dateId) {
            ACTIVE_DATE = dateId;
            window.generateDateTabs(); 
            window.renderItinerary();  
        }

        // æ¸²æŸ“è¡Œç¨‹å…§å®¹
        window.renderItinerary = function() {
            const contentContainer = document.getElementById('itinerary-container'); 
            if (!contentContainer) return;
            contentContainer.innerHTML = ''; 

            const currentDay = ITINERARY_DATA.find(day => day.id === ACTIVE_DATE);

            if (!currentDay || !currentDay.activities || currentDay.activities.length === 0) {
                contentContainer.innerHTML = `
                    <div class="m-4 p-6 bg-white rounded-xl shadow-sm text-center border border-pink-100">
                        <h2 class="text-xl font-bold text-gray-700 mb-2">${currentDay ? currentDay.city : 'ç„¡è³‡æ–™'}</h2>
                        <div class="text-custom-primary text-sm mb-4">${currentDay ? currentDay.date : 'ç„¡è³‡æ–™'}</div>
                        <p class="text-gray-400 mt-4 text-sm">
                            <i class="fa-regular fa-face-smile mb-2 text-2xl block"></i>
                            æœ¬æ—¥å°šç„¡è¡Œç¨‹ï¼Œé»æ“Šå³ä¸‹è§’ã€Œ+ã€æ–°å¢ã€‚
                        </p>
                    </div>`;
                return;
            }
            
            let html = `
                <div class="mx-4 mt-4 p-4 bg-white rounded-xl shadow-sm border border-pink-100 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-gray-700"><i class="fa-solid fa-location-dot text-custom-secondary mr-2"></i>${currentDay.city}</h2>
                    <span class="text-sm font-bold bg-pink-50 text-custom-primary px-3 py-1 rounded-full">${currentDay.date}</span>
                </div>
                <div class="timeline-container p-4">
                `;

            currentDay.activities.forEach((activity, index) => {
                const clickHandler = `window.openEditModal('${currentDay.id}', ${index})`;
                
                // â­ï¸ æ–°å¢ï¼šæ ¹æ“šæ´»å‹•é¡å‹çµ¦äºˆä¸åŒåœ–æ¨™ (å¯æ ¹æ“š title é—œéµå­—æ“´å……)
                const activityIcon = activity.title.includes('é¤') ? 'fa-utensils' : 
                                     activity.title.includes('é£¯åº—') || activity.title.includes('ä½å®¿') ? 'fa-bed' : 
                                     activity.title.includes('æ©Ÿ') ? 'fa-plane' : 
                                     'fa-location-dot';

                
                html += `
                    <div class="flex items-start mb-6 group" onclick="${clickHandler}">
                        <div class="w-1/4 text-sm font-bold text-gray-400 pt-1 text-center font-mono bg-gray-50 rounded-lg mr-3 py-1 self-start">${activity.time}</div>
                        <div class="flex-1 bg-white p-3 rounded-xl shadow-sm border border-gray-100 group-hover:border-pink-200 transition-colors relative z-10">
                            <div class="timeline-item relative !pl-0">
                                <span class="absolute -left-[2.1rem] top-2 h-4 w-4 rounded-full bg-custom-primary border-4 border-white timeline-dot z-20"></span>
                                <div class="font-bold text-gray-700 flex items-center mb-1">
                                    <i class="fa-solid ${activityIcon} text-custom-primary mr-2 text-sm bg-pink-50 w-6 h-6 rounded-full flex items-center justify-center"></i>
                                    <span>${activity.title}</span>
                                </div>
                                <div class="text-sm text-gray-500 ml-8 mb-1">${activity.location || ''}</div>
                                ${activity.notes ? `<div class="text-xs text-gray-500 mt-1 ml-8 bg-gray-50 p-2 rounded-lg"><i class="fa-regular fa-comment-dots mr-1"></i>${activity.notes}</div>` : ''}
                                ${activity.link ? `<a href="${activity.link}" target="_blank" class="text-xs font-bold text-custom-secondary mt-2 ml-8 inline-block hover:underline" onclick="event.stopPropagation();"><i class="fas fa-map-marker-alt mr-1"></i>å°èˆª</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            contentContainer.innerHTML = html;
        }
        
        // å¡«å……æ–°å¢è¡Œç¨‹ Modal ä¸­çš„æ—¥æœŸé¸é …
        window.populateItineraryModalDates = function() {
            const select = document.getElementById('new-date');
            if (!select) return;
            select.innerHTML = ''; 
            
            ITINERARY_DATA.forEach(day => {
                const option = document.createElement('option');
                option.value = day.id;
                option.textContent = `${day.date.substring(5)} (${day.day_of_week}) - ${day.city}`;
                if (day.id === ACTIVE_DATE) {
                    option.selected = true; 
                }
                select.appendChild(option);
            });
        }
        
        // æ–°å¢è¡Œç¨‹é …ç›® (Add)
        window.addItineraryItem = async function(event) {
            event.preventDefault();
            const dateId = document.getElementById('new-date').value;
            const time = document.getElementById('new-time').value;
            const title = document.getElementById('new-title').value;
            const note = document.getElementById('new-note').value;
            
            if (!dateId || !time || !title) return;

            const newActivity = {
                time: time,
                title: title,
                location: note, // å‡è¨­å‚™è¨»/åœ°é»
                notes: '', 
                link: ''
            };

            try {
                const dayDocRef = doc(db, 'itineraries', dateId);
                const currentDay = ITINERARY_DATA.find(d => d.id === dateId);
                
                if (currentDay) {
                     // è¤‡è£½ä¸¦åŠ å…¥æ–°æ´»å‹•
                    const updatedActivities = [...(currentDay.activities || []), newActivity];

                    // æ ¹æ“šæ™‚é–“æ’åº (å¯é¸ï¼Œä½†å¼·çƒˆå»ºè­°)
                    updatedActivities.sort((a, b) => a.time.localeCompare(b.time));
                    
                    await updateDoc(dayDocRef, {
                        activities: updatedActivities
                    });
                } else {
                    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯ä»¥é¸æ“‡å‰µå»ºä¸€å€‹æ–°çš„æ—¥æœŸæ–‡ä»¶ (é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œå‡è¨­æ–‡ä»¶å·²å­˜åœ¨)
                    alert('æ‰¾ä¸åˆ°å°æ‡‰æ—¥æœŸæ–‡ä»¶ï¼Œè«‹å…ˆåœ¨ Firestore æ–°å¢æ–‡ä»¶ã€‚');
                    return;
                }


                window.closeModal('addItineraryModal');
                document.getElementById('add-itinerary-form').reset(); 
                alert('è¡Œç¨‹æ–°å¢æˆåŠŸï¼');

            } catch (e) {
                console.error("Error adding itinerary item: ", e);
                alert('æ–°å¢è¡Œç¨‹å¤±æ•—ã€‚');
            }
        }

        // é–‹å•Ÿç·¨è¼¯ Modal
        window.openEditModal = function(dateId, index) {
            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay || !currentDay.activities || !currentDay.activities[index]) return;

            const activity = currentDay.activities[index];
            const dayIndex = ITINERARY_DATA.indexOf(currentDay);

            document.getElementById('edit-modal-date-info').textContent = `${currentDay.city} - ${currentDay.date} (Day ${dayIndex + 1})`;
            
            document.getElementById('edit-date-key').value = dateId;
            document.getElementById('edit-item-index').value = index;
            document.getElementById('edit-time').value = activity.time || '';
            document.getElementById('edit-title').value = activity.title || '';
            document.getElementById('edit-note').value = activity.location || activity.notes || ''; 

            window.openModal('editItineraryModal');
        }

        // å„²å­˜ä¿®æ”¹ (Update)
        window.saveItineraryItem = async function(event) {
            event.preventDefault();
            const dateId = document.getElementById('edit-date-key').value;
            const index = parseInt(document.getElementById('edit-item-index').value);
            const time = document.getElementById('edit-time').value;
            const title = document.getElementById('edit-title').value;
            const note = document.getElementById('edit-note').value;

            if (!dateId || index === undefined || !time || !title) return;

            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay) return;

            const updatedActivities = [...currentDay.activities];
            
            updatedActivities[index] = {
                ...updatedActivities[index], 
                time: time,
                title: title,
                location: note, 
                notes: '',
            };
            
            updatedActivities.sort((a, b) => a.time.localeCompare(b.time));

            try {
                await updateDoc(doc(db, 'itineraries', dateId), {
                    activities: updatedActivities
                });
                window.closeModal('editItineraryModal');
                alert('è¡Œç¨‹ä¿®æ”¹æˆåŠŸï¼');
            } catch (e) {
                console.error("Error updating document: ", e);
                alert('è¡Œç¨‹ä¿®æ”¹å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤è¡Œç¨‹é …ç›® (Delete)
        window.deleteItineraryItem = async function(dateId, index) {
            if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹é …ç›®å—ï¼Ÿ')) return;

            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay) return;

            const updatedActivities = currentDay.activities.filter((_, i) => i !== index);

            try {
                await updateDoc(doc(db, 'itineraries', dateId), {
                    activities: updatedActivities
                });
                window.closeModal('editItineraryModal');
                alert('è¡Œç¨‹åˆªé™¤æˆåŠŸï¼');
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert('è¡Œç¨‹åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        /* ===================================================
          è¨˜å¸³ (EXPENSE) ç›¸é—œå‡½å¼ (æ–°å¢ç·¨è¼¯åŠŸèƒ½)
        =================================================== */
        
        // â­ï¸ æ–°å¢ï¼šåˆ‡æ›è¨˜å¸³/æ˜ç´°é ç±¤
        window.switchExpenseView = function(view) {
            const addContainer = document.getElementById('add-expense-container');
            const detailsContainer = document.getElementById('expense-details-container');
            const addBtn = document.getElementById('tab-add-expense-btn');
            const detailsBtn = document.getElementById('tab-view-details-btn');

            // ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å­˜åœ¨
            if (!addContainer || !detailsContainer || !addBtn || !detailsBtn) return; 

            // é‡è¨­æŒ‰éˆ•æ¨£å¼
            addBtn.classList.remove('active-expense-tab-btn', 'bg-custom-primary', 'text-white', 'shadow-md');
            detailsBtn.classList.remove('active-expense-tab-btn', 'bg-custom-primary', 'text-white', 'shadow-md');
            addBtn.classList.add('bg-white', 'text-gray-500');
            detailsBtn.classList.add('bg-white', 'text-gray-500');
            
            // ç¢ºä¿ inactive æŒ‰éˆ•æœ‰ hover æ•ˆæœ
            addBtn.classList.remove('hover:bg-[#FF7596]');
            detailsBtn.classList.remove('hover:bg-[#FF7596]');
            addBtn.classList.add('hover:bg-pink-50');
            detailsBtn.classList.add('hover:bg-pink-50');


            if (view === 'add') {
                // é¡¯ç¤ºæ–°å¢è¡¨å–®ï¼Œéš±è—æ˜ç´°
                addContainer.classList.remove('hidden');
                detailsContainer.classList.add('hidden');
                
                // è¨­å®šæŒ‰éˆ•æ¨£å¼
                addBtn.classList.add('active-expense-tab-btn', 'bg-custom-primary', 'text-white', 'shadow-md');
                addBtn.classList.remove('bg-white', 'text-gray-500', 'hover:bg-pink-50');
                addBtn.classList.add('hover:bg-[#FF7596]');

            } else if (view === 'details') {
                // é¡¯ç¤ºæ˜ç´°ï¼Œéš±è—æ–°å¢è¡¨å–®
                addContainer.classList.add('hidden');
                detailsContainer.classList.remove('hidden');
                
                // è¨­å®šæŒ‰éˆ•æ¨£å¼
                detailsBtn.classList.add('active-expense-tab-btn', 'bg-custom-primary', 'text-white', 'shadow-md');
                detailsBtn.classList.remove('bg-white', 'text-gray-500', 'hover:bg-pink-50');
                detailsBtn.classList.add('hover:bg-[#FF7596]');
                
                // å‘¼å«æ¸²æŸ“å‡½å¼
                window.renderExpenseTracking(); 
            }
        }


        // é¸æ“‡å¹£åˆ¥ (é€šç”¨å‡½å¼ï¼Œç”¨æ–¼æ–°å¢å’Œç·¨è¼¯)
        window.selectCurrency = function(currency, prefix = 'expense') {
            const currencyId = `${prefix}-currency`;
            const containerId = `${prefix}-currency-select`;
            
            ACTIVE_CURRENCY = currency;

            document.querySelectorAll(`#${containerId} .block-select-btn`).forEach(btn => {
                btn.classList.remove('active-currency');
                if (btn.getAttribute('data-currency') === currency) {
                    btn.classList.add('active-currency');
                }
            });
            document.getElementById(currencyId).value = currency;
        }

        // é¸æ“‡ä»˜æ¬¾äºº (é€šç”¨å‡½å¼ï¼Œç”¨æ–¼æ–°å¢å’Œç·¨è¼¯)
        window.selectPayer = function(payer, prefix = 'expense') {
            const payerId = `${prefix}-payer`;
            const containerId = `${prefix}-payer-select`;
            
            ACTIVE_PAYER = payer;

            document.querySelectorAll(`#${containerId} .block-select-btn`).forEach(btn => {
                btn.classList.remove('active-payer');
                if (btn.getAttribute('data-payer') === payer) {
                    btn.classList.add('active-payer');
                }
            });
            document.getElementById(payerId).value = payer;
        }
        
        // é¸æ“‡é¡åˆ¥ (é€šç”¨å‡½å¼ï¼Œç”¨æ–¼æ–°å¢å’Œç·¨è¼¯)
        window.selectCategory = function(category, prefix = 'expense') {
            const categoryId = `${prefix}-category`;
            const containerId = `${prefix}-category-select`;
            
            ACTIVE_CATEGORY = category;

            document.querySelectorAll(`#${containerId} .block-select-btn`).forEach(btn => {
                btn.classList.remove('active-category');
                if (btn.getAttribute('data-category') === category) {
                    btn.classList.add('active-category');
                }
            });
            document.getElementById(categoryId).value = category;
        }
        
        // é¸æ“‡æ”¯ä»˜æ–¹å¼ (é€šç”¨å‡½å¼ï¼Œç”¨æ–¼æ–°å¢å’Œç·¨è¼¯)
        window.selectPayment = function(payment, prefix = 'expense') {
            const paymentId = `${prefix}-payment`;
            const containerId = `${prefix}-payment-select`;
            
            ACTIVE_PAYMENT = payment;

            document.querySelectorAll(`#${containerId} .block-select-btn`).forEach(btn => {
                btn.classList.remove('active-payment');
                if (btn.getAttribute('data-payment') === payment) {
                    btn.classList.add('active-payment');
                }
            });
            document.getElementById(paymentId).value = payment;
        }

        // é¸æ“‡é¡åˆ¥ (ç¯©é¸æ¸…å–®)
        window.filterExpenses = function(category) {
            EXPENSE_FILTER = category;
            window.renderExpenseTracking(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }

        // æ–°å¢æ”¯å‡º (Add Expense)
        window.addExpense = async function() {
            const date = document.getElementById('expense-date').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const description = document.getElementById('expense-description').value;

            if (!date || isNaN(amount) || amount <= 0 || !description) {
                alert('è«‹æª¢æŸ¥æ—¥æœŸã€é‡‘é¡å’Œç”¨é€”æ˜¯å¦æ­£ç¢ºå¡«å¯«ï¼');
                return;
            }

            const newExpense = {
                date: date,
                amount: amount,
                currency: ACTIVE_CURRENCY,
                payer: ACTIVE_PAYER,
                category: ACTIVE_CATEGORY,
                payment: ACTIVE_PAYMENT,
                description: description,
                timestamp: serverTimestamp() // ä½¿ç”¨ Firestore æœå‹™å™¨æ™‚é–“æˆ³
            };

            try {
                await addDoc(collection(db, "expenses"), newExpense);
                alert('æ”¯å‡ºç´€éŒ„æ–°å¢æˆåŠŸï¼');
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-description').value = '';
                // ä¸é‡è¨­æ—¥æœŸï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥
            } catch (e) {
                console.error("Error adding expense: ", e);
                alert('æ–°å¢æ”¯å‡ºç´€éŒ„å¤±æ•—ã€‚');
            }
        }

        // â­ï¸ æ–°å¢ï¼šé–‹å•Ÿç·¨è¼¯æ”¯å‡º Modal
        window.openEditExpenseModal = function(expenseId) {
            const expense = EXPENSES_DATA.find(e => e.id === expenseId);
            if (!expense) return;

            document.getElementById('edit-expense-id').value = expense.id;
            document.getElementById('edit-expense-date').value = expense.date || '';
            document.getElementById('edit-expense-amount').value = expense.amount || '';
            document.getElementById('edit-expense-description').value = expense.description || '';
            
            // é‡æ–°è¨­å®šé¸æ“‡å™¨ç‹€æ…‹ (å‚³å…¥ 'edit-expense' ä½œç‚º prefix)
            window.selectCurrency(expense.currency, 'edit-expense');
            window.selectPayer(expense.payer, 'edit-expense');
            window.selectCategory(expense.category, 'edit-expense');
            window.selectPayment(expense.payment, 'edit-expense');

            window.openModal('editExpenseModal');
        }

        // â­ï¸ æ–°å¢ï¼šå„²å­˜ç·¨è¼¯å¾Œçš„æ”¯å‡º (Update Expense)
        window.saveExpenseUpdate = async function(event) {
            event.preventDefault();
            const id = document.getElementById('edit-expense-id').value;
            const date = document.getElementById('edit-expense-date').value;
            const amount = parseFloat(document.getElementById('edit-expense-amount').value);
            const description = document.getElementById('edit-expense-description').value;
            const currency = document.getElementById('edit-expense-currency').value;
            const payer = document.getElementById('edit-expense-payer').value;
            const category = document.getElementById('edit-expense-category').value;
            const payment = document.getElementById('edit-expense-payment').value;


            if (!id || !date || isNaN(amount) || amount <= 0 || !description) {
                alert('è«‹æª¢æŸ¥æ‰€æœ‰æ¬„ä½æ˜¯å¦æ­£ç¢ºå¡«å¯«ï¼');
                return;
            }

            const updatedExpense = {
                date: date,
                amount: amount,
                currency: currency,
                payer: payer,
                category: category,
                payment: payment,
                description: description,
            };

            try {
                const docRef = doc(db, "expenses", id);
                await updateDoc(docRef, updatedExpense);
                alert('æ”¯å‡ºç´€éŒ„ä¿®æ”¹æˆåŠŸï¼');
                window.closeModal('editExpenseModal');
            } catch (e) {
                console.error("Error updating expense: ", e);
                alert('ä¿®æ”¹æ”¯å‡ºç´€éŒ„å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤æ”¯å‡º
        window.deleteExpense = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "expenses", id));
                alert('æ”¯å‡ºç´€éŒ„å·²åˆªé™¤ã€‚');
            } catch (e) {
                console.error("Error deleting expense: ", e);
                alert('åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        // è¨ˆç®—ä¸¦æ›´æ–°çµç®—æ‘˜è¦
        window.updateSettlementSummary = function() {
            let joshPaidTWD = 0;
            let candicePaidTWD = 0;
            
            EXPENSES_DATA.forEach(expense => {
                let amountTWD = expense.amount;
                if (expense.currency === 'JPY') {
                    amountTWD = expense.amount * EXCHANGE_RATE_JPY_TWD;
                }
                
                if (expense.payer === 'Josh') {
                    joshPaidTWD += amountTWD;
                } else if (expense.payer === 'Candice') {
                    candicePaidTWD += amountTWD;
                }
            });

            // ç¸½æ”¯å‡ºèˆ‡é ç®—
            const totalSpentTWD = joshPaidTWD + candicePaidTWD;
            const remainingBudget = TOTAL_BUDGET_TWD - totalSpentTWD;

            // ç¢ºä¿å…ƒç´ å­˜åœ¨
            const totalBudgetEl = document.getElementById('total-budget');
            const totalSpentEl = document.getElementById('total-spent');
            const remainingBudgetEl = document.getElementById('remaining-budget');
            const joshPaidEl = document.getElementById('josh-paid');
            const candicePaidEl = document.getElementById('candice-paid');
            const settlementElement = document.getElementById('settlement-result');

            if (totalBudgetEl) totalBudgetEl.textContent = TOTAL_BUDGET_TWD.toLocaleString();
            if (totalSpentEl) totalSpentEl.textContent = Math.round(totalSpentTWD).toLocaleString();
            if (remainingBudgetEl) remainingBudgetEl.textContent = Math.round(remainingBudget).toLocaleString();
            
            // çµç®—çµæœ
            if (joshPaidEl) joshPaidEl.textContent = Math.round(joshPaidTWD).toLocaleString();
            if (candicePaidEl) candicePaidEl.textContent = Math.round(candicePaidTWD).toLocaleString();

            if (settlementElement) {
                const diff = joshPaidTWD - candicePaidTWD;
                const halfDiff = Math.abs(diff) / 2;
                
                settlementElement.classList.remove('text-red-600', 'text-green-600', 'text-gray-900', 'text-custom-secondary', 'text-custom-danger');

                if (Math.abs(diff) < 1) { // å¿½ç•¥å¾®å°å·®ç•°
                    settlementElement.textContent = "ç„¡éœ€çµç®— (å¹³è¡¡)";
                    settlementElement.classList.add('text-gray-400');
                } else if (diff > 0) {
                    settlementElement.textContent = `Candice éœ€æ”¯ä»˜ Josh $ ${Math.round(halfDiff).toLocaleString()} TWD`;
                    settlementElement.classList.add('text-custom-danger'); // ç´…è‰²
                } else {
                    settlementElement.textContent = `Josh éœ€æ”¯ä»˜ Candice $ ${Math.round(halfDiff).toLocaleString()} TWD`;
                    settlementElement.classList.add('text-custom-secondary'); // ç¶ è‰²/è—ç¶ è‰²
                }
            }
        }
        
        // æ¸²æŸ“è¨˜å¸³æ¸…å–®
        window.renderExpenseTracking = function() {
            const expenseList = document.getElementById('expense-list');
            const filterContainer = document.getElementById('category-filter-buttons');
            
            // å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœå…ƒç´ ä¸å­˜åœ¨å‰‡ç›´æ¥é€€å‡º
            if (!expenseList || !filterContainer) return;

            const categories = [...new Set(EXPENSES_DATA.map(e => e.category)), 'All']; // æ‰¾å‡ºæ‰€æœ‰é¡åˆ¥
            
            // æ¸²æŸ“ç¯©é¸æŒ‰éˆ•
            filterContainer.innerHTML = '';
            categories.forEach(cat => {
                const isActive = cat === EXPENSE_FILTER;
                 filterContainer.innerHTML += `
                    <button type="button" class="block-select-btn px-3 py-1 text-xs rounded-full ${isActive ? 'active-filter' : ''}" onclick="window.filterExpenses('${cat}')">
                        ${cat}
                    </button>
                `;
            });
            
            // ç¯©é¸æ•¸æ“š
            const filteredExpenses = EXPENSES_DATA.filter(e => EXPENSE_FILTER === 'All' || e.category === EXPENSE_FILTER);

            // æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨
            if (filteredExpenses.length === 0) {
                expenseList.innerHTML = '<p class="text-center text-gray-400 text-sm py-8"><i class="fa-solid fa-cookie-bite text-2xl mb-2 block text-gray-200"></i>å°šç„¡ç¬¦åˆç¯©é¸æ¢ä»¶çš„æ”¯å‡ºç´€éŒ„</p>';
            } else {
                expenseList.innerHTML = filteredExpenses.map(expense => {
                    const amountTWD = expense.currency === 'JPY' 
                        ? (expense.amount * EXCHANGE_RATE_JPY_TWD).toFixed(0) 
                        : expense.amount.toFixed(0);
                        
                    const categoryIcon = ICON_MAP[expense.category] || 'fa-ellipsis';
                    
                    return `
                        <div class="p-3 mb-2 bg-white rounded-xl shadow-sm border border-gray-100 flex justify-between items-center hover:bg-pink-50 transition duration-150 group">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center mr-3 text-custom-primary">
                                    <i class="fa-solid ${categoryIcon}"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-700">${expense.description}</p>
                                    <p class="text-xs text-gray-400 font-mono">${expense.date} Â· <span class="bg-gray-100 px-1 rounded text-gray-500">${expense.payer}</span></p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-custom-danger">${expense.currency} ${expense.amount.toLocaleString()}</p>
                                <p class="text-xs text-gray-400">ç´„ $ ${amountTWD.toLocaleString()} TWD</p>
                                <div class="flex justify-end space-x-2 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="window.openEditExpenseModal('${expense.id}')" class="text-custom-primary hover:text-custom-primary-dark text-xs bg-white px-2 py-0.5 rounded-md shadow-sm border border-pink-100">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button onclick="window.deleteExpense('${expense.id}')" class="text-red-400 hover:text-red-600 text-xs bg-white px-2 py-0.5 rounded-md shadow-sm border border-red-100">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            window.updateSettlementSummary();
        }

        /* ===================================================
          æ…¾æœ›æ¸…å–® (WISHLIST) ç›¸é—œå‡½å¼
        =================================================== */
        
        // æ–°å¢æ…¾æœ›æ¸…å–®é …ç›® (Add)
        window.addWishlistItem = async function(event) {
            event.preventDefault();
            const name = document.getElementById('wishlist-name').value;
            const price = parseFloat(document.getElementById('wishlist-price').value);
            const category = document.getElementById('wishlist-category').value;
            
            if (!name || isNaN(price) || price <= 0 || !category) {
                alert('è«‹å¡«å¯«å®Œæ•´é …ç›®åç¨±ã€åƒ¹æ ¼å’Œåˆ†é¡ï¼');
                return;
            }

            const newItem = {
                name: name,
                price: price,
                category: category,
                purchased: false, // é è¨­ç‚ºæœªè³¼è²·
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "wishlists"), newItem);
                alert('æ…¾æœ›æ¸…å–®æ–°å¢æˆåŠŸï¼');
                document.getElementById('wishlist-form').reset();
            } catch (e) {
                console.error("Error adding wishlist item: ", e);
                alert('æ–°å¢æ…¾æœ›æ¸…å–®å¤±æ•—ã€‚');
            }
        }
        
        // åˆ‡æ›è³¼è²·ç‹€æ…‹ (Update)
        window.toggleWishlistStatus = async function(id, currentStatus) {
            try {
                const docRef = doc(db, "wishlists", id);
                await updateDoc(docRef, {
                    purchased: !currentStatus
                });
            } catch (e) {
                console.error("Error updating wishlist status: ", e);
                alert('æ›´æ–°ç‹€æ…‹å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤æ…¾æœ›æ¸…å–®é …ç›®
        window.deleteWishlistItem = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ…¾æœ›æ¸…å–®å—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "wishlists", id));
            } catch (e) {
                console.error("Error deleting wishlist item: ", e);
                alert('åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        // æ¸²æŸ“æ…¾æœ›æ¸…å–®
        window.renderWishlist = function() {
            const wishlistList = document.getElementById('wishlist-list');
            if (!wishlistList) return;
            
            if (WISHLIST_DATA.length === 0) {
                wishlistList.innerHTML = '<p class="text-center text-gray-400 text-sm py-8"><i class="fa-solid fa-gift text-2xl mb-2 block text-gray-200"></i>å°šç„¡å¾…è³¼é …ç›®</p>';
                return;
            }

            wishlistList.innerHTML = WISHLIST_DATA.map(item => {
                const statusClass = item.purchased ? 'purchased' : 'pending';
                const statusText = item.purchased ? 'å·²å…¥æ‰‹' : 'æƒ³è²·!';
                const bgClass = item.purchased ? 'bg-gray-50 opacity-75' : 'bg-white';
                
                return `
                    <div class="p-3 mb-2 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center ${bgClass} transition hover:shadow-md">
                        <div>
                            <p class="font-bold text-gray-700 text-lg">${item.name}</p>
                            <p class="text-sm text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full inline-block mt-1">${item.category}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-custom-primary text-lg">Â¥ ${item.price.toLocaleString()}</p>
                            <div class="flex items-center justify-end mt-2 space-x-2">
                                <button class="wishlist-status-btn ${statusClass}" 
                                        onclick="window.toggleWishlistStatus('${item.id}', ${item.purchased})">
                                    <i class="fa-solid ${item.purchased ? 'fa-check' : 'fa-heart'} mr-1"></i>${statusText}
                                </button>
                                <button onclick="window.deleteWishlistItem('${item.id}')" class="text-gray-400 hover:text-red-500 w-8 h-8 rounded-full hover:bg-red-50 transition">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /* ===================================================
          â­ï¸ æ–°å¢ï¼šæ‰“åŒ…è¡Œæ (PACKING LIST) ç›¸é—œå‡½å¼
        =================================================== */
        
        // â­ï¸ æ–°å¢ï¼šæ¸²æŸ“æ‰“åŒ…æ¸…å–®
        window.renderPackingList = function() {
            const packingListContainer = document.getElementById('packing-list-container');
            if (!packingListContainer) return;

            if (PACKING_DATA.length === 0) {
                packingListContainer.innerHTML = '<p class="text-center text-gray-400 text-sm mt-6"><i class="fa-solid fa-suitcase text-2xl mb-2 block text-gray-200"></i>æ‚¨çš„è¡Œææ¸…å–®æ˜¯ç©ºçš„ï¼</p>';
                return;
            }

            packingListContainer.innerHTML = PACKING_DATA.map(item => {
                const isPacked = item.packed;
                const statusClass = isPacked ? 'packed' : 'not-packed';
                const statusIcon = isPacked ? 'fa-check-circle' : 'fa-circle';
                const itemClass = isPacked ? 'line-through text-gray-400 italic' : 'text-gray-700 font-bold';
                const bgClass = isPacked ? 'bg-gray-50' : 'bg-white';
                
                return `
                    <div class="p-3 mb-2 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center ${bgClass} hover:bg-pink-50 transition duration-150">
                        <div class="flex items-center flex-1 min-w-0 cursor-pointer" onclick="window.togglePackingStatus('${item.id}', ${item.packed})">
                            <button class="packing-status-btn mr-3 text-lg">
                                <i class="fa-solid ${statusIcon} ${isPacked ? 'text-custom-secondary' : 'text-gray-300'}"></i>
                            </button>
                            <div class="min-w-0">
                                <p class="${itemClass} truncate text-lg">${item.name}</p>
                                <p class="text-xs text-gray-400">${item.category}</p>
                            </div>
                        </div>
                        <div class="text-right ml-4">
                            <button onclick="window.deletePackingItem('${item.id}')" class="text-gray-300 hover:text-red-400 text-sm p-2">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // â­ï¸ æ–°å¢ï¼šæ–°å¢æ‰“åŒ…é …ç›® (Add Packing Item)
        window.addPackingItem = async function(event) {
            event.preventDefault();
            const name = document.getElementById('packing-name').value;
            const category = document.getElementById('packing-category').value;
            
            if (!name || !category) {
                alert('è«‹å¡«å¯«é …ç›®åç¨±å’Œé¡åˆ¥ï¼');
                return;
            }

            const newItem = {
                name: name,
                category: category,
                packed: false, // é è¨­ç‚ºæœªæ‰“åŒ…
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "packinglist"), newItem);
                alert('æ‰“åŒ…æ¸…å–®æ–°å¢æˆåŠŸï¼');
                document.getElementById('packing-form').reset();
            } catch (e) {
                console.error("Error adding packing item: ", e);
                alert('æ–°å¢æ‰“åŒ…æ¸…å–®å¤±æ•—ã€‚');
            }
        }

        // â­ï¸ æ–°å¢ï¼šåˆ‡æ›æ‰“åŒ…ç‹€æ…‹ (Update Packing Status)
        window.togglePackingStatus = async function(id, currentStatus) {
            try {
                const docRef = doc(db, "packinglist", id);
                await updateDoc(docRef, {
                    packed: !currentStatus
                });
            } catch (e) {
                console.error("Error updating packing status: ", e);
                alert('æ›´æ–°ç‹€æ…‹å¤±æ•—ã€‚');
            }
        }

        // â­ï¸ æ–°å¢ï¼šåˆªé™¤æ‰“åŒ…æ¸…å–®é …ç›®
        window.deletePackingItem = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ‰“åŒ…æ¸…å–®é …ç›®å—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "packinglist", id));
            } catch (e) {
                console.error("Error deleting packing item: ", e);
                alert('åˆªé™¤å¤±æ•—ã€‚');
            }
        }
        
        /* ===================================================
          é€šç”¨å‡½å¼ (Modal, Navigation, Initialization)
        =================================================== */

        // é–‹å•Ÿ Modal
        window.openModal = function(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        // é—œé–‰ Modal
        window.closeModal = function(id) {
             const modal = document.getElementById(id);
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
        
        // æ¸²æŸ“ç¸½è¦½å¤©æ°£ (ä¿æŒéœæ…‹ï¼Œå› ç‚ºå¤©æ°£æŸ¥è©¢å¯èƒ½éœ€è¦é¡å¤–çš„ API key)
        window.renderOverviewWeather = function() {
            // é€™å€‹å‡½å¼ä¿æŒéœæ…‹æ¸²æŸ“ï¼Œå¯ä»¥è®“ç”¨æˆ¶è‡ªè¡Œå¡«å……æ¯æ—¥å¤©æ°£
        }
        
        // æ¸²æŸ“æ¯æ—¥å¤©æ°£ (ç›®å‰ç‚ºç©ºï¼Œå¯è‡ªè¡Œå¯¦ä½œ)
        window.renderWeather = function() {
            const weatherContent = document.getElementById('weather-content');
            weatherContent.innerHTML = '<p class="text-center text-gray-400 mt-8"><i class="fa-solid fa-cloud-moon text-4xl mb-2 block"></i>æ¯æ—¥è©³ç´°å¤©æ°£åŠŸèƒ½å¾…å¯¦ä½œ (éœ€ä¸²æ¥ç¬¬ä¸‰æ–¹å¤©æ°£ API)ã€‚</p>';
        }

        // ä¸»è¦å°èˆªå‡½å¼
        window.switchMainNav = function(targetId) {
            // éš±è—æ‰€æœ‰å…§å®¹å€
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
            document.querySelectorAll('.main-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // é¡¯ç¤ºç›®æ¨™å…§å®¹å€
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                targetContent.classList.remove('hidden');
                
                // ç‰¹æ®Šè™•ç†ï¼šç•¶åˆ‡æ›åˆ°ç‰¹å®šé ç±¤æ™‚å‘¼å«æ¸²æŸ“å‡½å¼
                if (targetId === 'expense-tab') {
                    // ç¢ºä¿ Expense Tab å§‹çµ‚é¡¯ç¤ºæ˜ç´°
                    window.switchExpenseView('details'); 
                } else if (targetId === 'wishlist-tab') {
                    window.renderWishlist();
                } else if (targetId === 'packing-tab') { // â­ï¸ æ–°å¢ï¼šè™•ç†æ‰“åŒ…æ¸…å–®æ¸²æŸ“
                    window.renderPackingList();
                }
            }

            // è¨­ç½®ç›®æ¨™æŒ‰éˆ•çš„ active ç‹€æ…‹
            const targetButton = document.querySelector(`.main-nav-btn[data-target="${targetId}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // é è¨­é¸æ“‡ç¬¬ä¸€å€‹ tab
            window.switchMainNav('itinerary-tab');
            // åˆå§‹åŒ–è¨˜å¸³é¸æ“‡å™¨
            window.selectCurrency(ACTIVE_CURRENCY);
            window.selectPayer(ACTIVE_PAYER);
            window.selectCategory(ACTIVE_CATEGORY);
            window.selectPayment(ACTIVE_PAYMENT);

            // åˆå§‹åŒ–æ•¸æ“šåŒæ­¥
            startDataSync();
        });

    </script>
</head>
<body class="bg-gray-50 font-sans">

    <div class="max-w-xl mx-auto bg-white min-h-screen shadow-2xl overflow-hidden rounded-none sm:rounded-3xl sm:my-8 border border-gray-100">

        <header class="p-4 bg-white border-b border-gray-100 sticky top-0 z-10 shadow-sm">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-700 flex items-center tracking-wide">
                    <i class="fa-solid fa-plane-departure text-custom-primary mr-2 transform -rotate-12"></i> ç¦å²¡ç†Šæœ¬ä¹‹æ—…
                </h1>
                <div class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-lg">
                    åŒ¯ç‡: <span id="exchange-rate-display" class="font-bold text-custom-secondary text-base">0.2150</span>
                </div>
            </div>
        </header>

        <nav id="main-nav" class="flex justify-around border-b border-gray-100 text-sm sticky top-[72px] bg-white/95 backdrop-blur-sm z-10 shadow-sm">
            <button class="main-nav-btn active" data-target="itinerary-tab" onclick="window.switchMainNav('itinerary-tab')">
                <i class="fa-solid fa-map-location-dot"></i><br>è¡Œç¨‹
            </button>
            <button class="main-nav-btn" data-target="expense-tab" onclick="window.switchMainNav('expense-tab')">
                <i class="fa-solid fa-wallet"></i><br>è¨˜å¸³
            </button>
            <button class="main-nav-btn" data-target="wishlist-tab" onclick="window.switchMainNav('wishlist-tab')">
                <i class="fa-solid fa-gift"></i><br>æ¸…å–®
            </button>
            <button class="main-nav-btn" data-target="packing-tab" onclick="window.switchMainNav('packing-tab')">
                <i class="fa-solid fa-suitcase"></i><br>æ‰“åŒ…
            </button>
            <button class="main-nav-btn" data-target="overview-tab" onclick="window.switchMainNav('overview-tab')">
                <i class="fa-solid fa-star"></i><br>ç¸½è¦½
            </button>
        </nav>
<!-- 1. è¡Œç¨‹å¤©æ°£ç¸½è¦½å€å¡Š (æ•´åˆè‡ªä½¿ç”¨è€…æä¾›) -->
            <div class="bg-white p-2 rounded-3xl shadow-lg mb-6 border-2 border-pink-100">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-cloud-sun-rain text-custom-primary mr-2"></i> è¡Œç¨‹å¤©æ°£ç¸½è¦½ (tenki.jp)
                </h2>

                <div class="flex justify-around items-stretch mb-4 space-x-2 flex-wrap sm:flex-nowrap">
                    <!-- ç¦å²¡ -->
                    <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm mb-3 sm:mb-0">
                        <p class="text-sm font-semibold text-gray-700 mb-1">ç¦å²¡ (26æ—¥)</p>
                        <i id="weather-icon-fukuoka" class="fa-solid fa-cloud-sun-rain text-3xl text-custom-primary mb-1"></i>
                        <p id="weather-temp-fukuoka" class="text-lg font-bold text-gray-800">8Â°C / 13Â°C</p>
                        <p id="weather-rain-fukuoka" class="text-xs text-red-500 mt-1">é™é›¨ç‡: 20%</p>
                    </div>

                    <!-- é•·å´ -->
                    <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm mb-3 sm:mb-0">
                        <p class="text-sm font-semibold text-gray-700 mb-1">é•·å´ (27-28æ—¥)</p>
                        <i id="weather-icon-nagasaki" class="fa-solid fa-sun text-3xl text-orange-400 mb-1"></i>Â 
                        <p id="weather-temp-nagasaki" class="text-lg font-bold text-gray-800">5Â°C / 10Â°C</p>
                        <p id="weather-rain-nagasaki" class="text-xs text-gray-500 mt-1">é™é›¨ç‡: 0%</p>
                    </div>

                    <!-- ç†Šæœ¬ -->
                    <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm">
                        <p class="text-sm font-semibold text-gray-700 mb-1">ç†Šæœ¬ (29-31æ—¥)</p>
                        <i id="weather-icon-kumamoto" class="fa-solid fa-cloud-showers-heavy text-3xl text-custom-secondary mb-1"></i>
                        <p id="weather-temp-kumamoto" class="text-lg font-bold text-gray-800">3Â°C / 9Â°C</p>
                        <p id="weather-rain-kumamoto" class="text-xs text-red-500 mt-1">é™é›¨ç‡: 40%</p>
                    </div>
                </div>

                <a href="https://www.tenki.jp/" target="_blank" class="w-full block text-center bg-gray-100 text-gray-700 p-3 rounded-2xl font-semibold hover:bg-gray-200 transition duration-200 text-sm">
                    <i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> é»æ“ŠæŸ¥çœ‹ tenki.jp è©³ç´°é å ±
                </a>
            </div>
        <main id="app-content" class="pb-24 bg-[#FFFDF9]">

            <div id="itinerary-tab" class="main-tab-content">
                <div id="date-buttons-container" class="flex p-4 overflow-x-auto whitespace-nowrap border-b border-gray-100 bg-white no-scrollbar">
                    </div>
                <div id="itinerary-container">
                    </div>

                <button onclick="window.openModal('addItineraryModal')" class="fixed right-6 bottom-6 w-14 h-14 rounded-full bg-custom-primary text-white shadow-xl flex items-center justify-center text-2xl hover:bg-custom-primary-dark z-20 transition transform hover:scale-110">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div id="expense-tab" class="main-tab-content hidden p-4">
                <div class="flex mb-4 p-1.5 bg-gray-100 rounded-2xl">
                    <button id="tab-add-expense-btn" class="flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-gray-500 shadow-sm transition-all" onclick="window.switchExpenseView('add')">
                        <i class="fa-solid fa-pen mr-1"></i> è¨˜ä¸€ç­†
                    </button>
                    <button id="tab-view-details-btn" class="flex-1 py-2.5 rounded-xl text-sm font-bold text-gray-500 hover:bg-white/50 transition-all" onclick="window.switchExpenseView('details')">
                        <i class="fa-solid fa-list mr-1"></i> æŸ¥æ˜ç´°
                    </button>
                </div>

                <div id="add-expense-container" class="hidden bg-white p-5 rounded-3xl shadow-sm border border-pink-100">
                    <form onsubmit="event.preventDefault(); window.addExpense();">
                        <label for="expense-date" class="text-sm font-bold text-gray-500 block mb-1 ml-1">æ—¥æœŸ</label>
                        <input type="date" id="expense-date" value="2024-05-18" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-4 text-gray-700 font-bold" required>

                        <label for="expense-amount" class="text-sm font-bold text-gray-500 block mb-1 ml-1">é‡‘é¡</label>
                        <div class="flex mb-4">
                            <input type="number" step="0.01" id="expense-amount" placeholder="0" class="flex-1 p-3 bg-gray-50 border-0 rounded-xl text-xl font-bold text-gray-700" required>
                            <div id="expense-currency-select" class="flex ml-2 items-center">
                                <button type="button" class="block-select-btn px-3 py-2 text-sm active-currency rounded-xl" data-currency="TWD" onclick="window.selectCurrency('TWD')">TWD</button>
                                <button type="button" class="block-select-btn px-3 py-2 text-sm rounded-xl" data-currency="JPY" onclick="window.selectCurrency('JPY')">JPY</button>
                            </div>
                            <input type="hidden" id="expense-currency" value="TWD">
                        </div>

                        <label for="expense-description" class="text-sm font-bold text-gray-500 block mb-1 ml-1">ç”¨é€”/èªªæ˜</label>
                        <input type="text" id="expense-description" placeholder="ä¾‹å¦‚: ä¸€è˜­æ‹‰éºµ" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-4 text-gray-700" required>

                        <label class="text-sm font-bold text-gray-500 block mb-2 ml-1">èª°ä»˜éŒ¢?</label>
                        <div id="expense-payer-select" class="flex mb-4">
                            <button type="button" class="block-select-btn flex-1" data-payer="Josh" onclick="window.selectPayer('Josh')"><i class="fa-solid fa-user mr-1"></i> Josh</button>
                            <button type="button" class="block-select-btn flex-1" data-payer="Candice" onclick="window.selectPayer('Candice')"><i class="fa-solid fa-user mr-1"></i> Candice</button>
                            <input type="hidden" id="expense-payer" value="Josh">
                        </div>
                        
                        <label class="text-sm font-bold text-gray-500 block mb-2 ml-1">é¡åˆ¥</label>
                        <div id="expense-category-select" class="grid grid-cols-3 gap-2 mb-4">
                            <button type="button" class="block-select-btn w-full !mr-0" data-category="Food" onclick="window.selectCategory('Food')"><i class="fa-solid fa-utensils mr-1"></i>é¤é£²</button>
                            <button type="button" class="block-select-btn w-full !mr-0" data-category="Transport" onclick="window.selectCategory('Transport')"><i class="fa-solid fa-train mr-1"></i>äº¤é€š</button>
                            <button type="button" class="block-select-btn w-full !mr-0" data-category="Accommodation" onclick="window.selectCategory('Accommodation')"><i class="fa-solid fa-bed mr-1"></i>ä½å®¿</button>
                            <button type="button" class="block-select-btn w-full !mr-0" data-category="Shopping" onclick="window.selectCategory('Shopping')"><i class="fa-solid fa-bag-shopping mr-1"></i>è³¼ç‰©</button>
                            <button type="button" class="block-select-btn w-full !mr-0" data-category="Ticket" onclick="window.selectCategory('Ticket')"><i class="fa-solid fa-ticket mr-1"></i>é–€ç¥¨</button>
                            <button type="button" class="block-select-btn w-full !mr-0" data-category="Other" onclick="window.selectCategory('Other')"><i class="fa-solid fa-shapes mr-1"></i>å…¶ä»–</button>
                            <input type="hidden" id="expense-category" value="Food">
                        </div>

                        <label class="text-sm font-bold text-gray-500 block mb-2 ml-1">æ”¯ä»˜æ–¹å¼</label>
                        <div id="expense-payment-select" class="flex mb-6">
                            <button type="button" class="block-select-btn flex-1" data-payment="Cash" onclick="window.selectPayment('Cash')"><i class="fa-solid fa-money-bill mr-1"></i> ç¾é‡‘</button>
                            <button type="button" class="block-select-btn flex-1" data-payment="Card" onclick="window.selectPayment('Card')"><i class="fa-regular fa-credit-card mr-1"></i> ä¿¡ç”¨å¡</button>
                            <input type="hidden" id="expense-payment" value="Cash">
                        </div>

                        <button type="submit" class="w-full bg-custom-secondary text-white p-4 rounded-2xl font-bold shadow-lg shadow-teal-100 hover:shadow-teal-200 transition transform hover:-translate-y-1">
                            <i class="fa-solid fa-check mr-2"></i> ç¢ºèªç´€éŒ„
                        </button>
                    </form>
                </div>

                <div id="expense-details-container" class="">
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-5 rounded-3xl mb-6 border border-blue-100 shadow-inner">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                            <span class="bg-white p-1.5 rounded-lg shadow-sm mr-2 text-custom-primary"><i class="fa-solid fa-calculator"></i></span> 
                            çµç®—å°å¹«æ‰‹
                        </h3>
                        <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                            <div class="p-3 bg-white/80 rounded-2xl shadow-sm">
                                <div id="budget-display-container">
    <p class="text-gray-400 text-xs mb-1">é ç®—ç¸½é¡ (TWD)</p>
    
    <p id="budget-display" class="font-bold text-gray-700 text-lg flex items-center cursor-pointer" onclick="window.enableBudgetEdit()">
        $ <span id="total-budget">50,000</span> <i class="fa-solid fa-pen-to-square ml-2 text-custom-primary text-sm"></i>
    </p>

    <div id="budget-edit-form" class="hidden flex items-center space-x-2">
        <span class="font-bold text-gray-700 text-lg">$</span>
        <input type="number" id="budget-input" value="50000" class="w-24 border-b border-gray-400 focus:outline-none focus:border-custom-primary text-gray-700 text-lg font-bold p-1">
        <button onclick="window.saveBudget()" class="text-white bg-custom-primary p-1 rounded-md text-sm hover:bg-custom-primary/90">
            <i class="fa-solid fa-check"></i>
        </button>
        <button onclick="window.cancelBudgetEdit()" class="text-gray-500 p-1 rounded-md text-sm hover:text-gray-700">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>
</div>
                            </div>
                            <div class="p-3 bg-white/80 rounded-2xl shadow-sm">
                                <p class="text-gray-400 text-xs mb-1">å·²èŠ±ç¸½é¡ (TWD)</p>
                                <p class="font-bold text-custom-danger text-lg">$ <span id="total-spent">0</span></p>
                            </div>
                            <div class="p-3 bg-white/80 rounded-2xl shadow-sm">
                                <p class="text-gray-400 text-xs mb-1">Josh æ”¯ä»˜</p>
                                <p class="font-bold text-gray-700">$ <span id="josh-paid">0</span></p>
                            </div>
                            <div class="p-3 bg-white/80 rounded-2xl shadow-sm">
                                <p class="text-gray-400 text-xs mb-1">Candice æ”¯ä»˜</p>
                                <p class="font-bold text-gray-700">$ <span id="candice-paid">0</span></p>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-blue-100/50 text-center bg-white/50 rounded-xl p-2">
                            <p class="text-gray-400 text-xs mb-1">æ‡‰ä»˜çµç®—çµæœ</p>
                            <p id="settlement-result" class="text-lg font-bold text-gray-700">è¨ˆç®—ä¸­...</p>
                        </div>
                    </div>

                    <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center px-1">
                        <i class="fa-solid fa-receipt mr-2 text-custom-secondary"></i> æ”¯å‡ºæ˜ç´°
                    </h3>
                    
                    <div id="category-filter-buttons" class="flex flex-wrap gap-2 mb-4 pb-2 px-1 overflow-x-auto no-scrollbar">
                        </div>
                    
                    <div id="expense-list" class="space-y-3">
                        </div>
                </div>
            </div>

            <div id="wishlist-tab" class="main-tab-content hidden p-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-pink-100 mb-6">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2 text-custom-primary"></i> è¨±é¡˜æ± 
                    </h3>
                    
                    <form id="wishlist-form" onsubmit="window.addWishlistItem(event)">
                        <label for="wishlist-name" class="text-sm font-bold text-gray-500 block mb-1 ml-1">æƒ³è¦ä»€éº¼?</label>
                        <input type="text" id="wishlist-name" placeholder="ä¾‹å¦‚: ç†Šæœ¬ç†Šé¤…ä¹¾" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-3 text-gray-700" required>
                        
                        <label for="wishlist-price" class="text-sm font-bold text-gray-500 block mb-1 ml-1">å¤§æ¦‚å¤šå°‘éŒ¢ (JPY)</label>
                        <input type="number" step="1" id="wishlist-price" placeholder="0" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-3 text-gray-700 font-bold" required>
                        
                        <label for="wishlist-category" class="text-sm font-bold text-gray-500 block mb-1 ml-1">åˆ†é¡</label>
                        <div class="relative">
                            <select id="wishlist-category" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-4 text-gray-700 appearance-none">
                                <option value="ä¼´æ‰‹ç¦®">ğŸ ä¼´æ‰‹ç¦®</option>
                                <option value="é›»å™¨">âš¡ é›»å™¨</option>
                                <option value="æœé£¾">ğŸ‘• æœé£¾</option>
                                <option value="è—¥å¦">ğŸ’Š è—¥å¦</option>
                                <option value="å…¶ä»–">âœ¨ å…¶ä»–</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-gray-400 pointer-events-none"></i>
                        </div>

                        <button type="submit" class="w-full bg-custom-primary text-white p-3 rounded-2xl font-bold shadow-lg shadow-pink-200 hover:bg-custom-primary-dark transition">
                            <i class="fa-solid fa-plus mr-1"></i> åŠ å…¥æ¸…å–®
                        </button>
                    </form>
                </div>

                <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center px-2">
                    <i class="fa-solid fa-heart mr-2 text-custom-danger"></i> è³¼ç‰©æ¸…å–®
                </h3>
                <div id="wishlist-list" class="space-y-3">
                    </div>
            </div>
            
            <div id="packing-tab" class="main-tab-content hidden p-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-blue-100 mb-6">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                        <i class="fa-solid fa-shirt mr-2 text-custom-secondary"></i> æ–°å¢è¡Œæ
                    </h3>
                    
                    <form id="packing-form" onsubmit="window.addPackingItem(event)">
                        <div class="flex gap-2 mb-3">
                            <div class="flex-1">
                                <label for="packing-name" class="text-sm font-bold text-gray-500 block mb-1 ml-1">ç‰©å“åç¨±</label>
                                <input type="text" id="packing-name" placeholder="è­·ç…§" class="w-full p-3 bg-gray-50 border-0 rounded-xl text-gray-700" required>
                            </div>
                            <div class="w-1/3 relative">
                                <label for="packing-category" class="text-sm font-bold text-gray-500 block mb-1 ml-1">åˆ†é¡</label>
                                <select id="packing-category" class="w-full p-3 bg-gray-50 border-0 rounded-xl text-gray-700 appearance-none">
                                    <option value="è­‰ä»¶">ğŸªª</option>
                                    <option value="è¡£ç‰©">ğŸ‘•</option>
                                    <option value="é›»å­">ğŸ“±</option>
                                    <option value="è—¥å“">ğŸ’Š</option>
                                    <option value="ç›¥æ´—">ğŸš¿</option>
                                    <option value="å…¶ä»–">ğŸ§©</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-3 top-[34px] text-gray-400 pointer-events-none text-xs"></i>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-custom-secondary text-white p-3 rounded-2xl font-bold shadow-lg shadow-teal-100 hover:bg-opacity-90 transition">
                            <i class="fa-solid fa-plus mr-1"></i> åŠ å…¥è¡Œæç®±
                        </button>
                    </form>
                </div>

                <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center px-2">
                    <i class="fa-solid fa-clipboard-check mr-2 text-custom-primary"></i> æª¢æŸ¥æ¸…å–®
                </h3>
                <div id="packing-list-container" class="space-y-2">
                    </div>
            </div>

            <div id="weather-tab" class="main-tab-content hidden p-4">
                <div class="bg-gradient-to-b from-blue-100 to-white p-8 rounded-3xl text-center shadow-inner mb-6">
                    <i class="fa-solid fa-sun text-6xl text-yellow-400 mb-4 drop-shadow-md"></i>
                    <h2 class="text-2xl font-bold text-gray-700 mb-2">ç¦å²¡å¥½å¤©æ°£</h2>
                    <p class="text-gray-500">æ°£æº«èˆ’é©ï¼Œé©åˆæ—…éŠï¼</p>
                </div>
                
                <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                    <i class="fa-solid fa-calendar-days mr-2 text-custom-primary"></i> æ¯æ—¥é å ±
                </h2>
                <div id="weather-content" class="space-y-3">
                    </div>
            </div>

            <div id="overview-tab" class="main-tab-content hidden p-4">
                <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                    <i class="fa-solid fa-chart-pie mr-2 text-custom-primary"></i> æ—…ç¨‹å„€è¡¨æ¿
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-6 bg-yellow-50 rounded-3xl shadow-sm border border-yellow-100 text-center">
                        <i class="fa-regular fa-calendar text-2xl text-yellow-500 mb-2 block"></i>
                        <p class="text-xs text-yellow-700 font-bold uppercase tracking-wider mb-1">Duration</p>
                        <p class="text-2xl font-bold text-yellow-900 font-mono">6 Days</p>
                    </div>
                    <div class="p-6 bg-green-50 rounded-3xl shadow-sm border border-green-100 text-center">
                        <i class="fa-solid fa-sack-dollar text-2xl text-green-500 mb-2 block"></i>
                        <p class="text-xs text-green-700 font-bold uppercase tracking-wider mb-1">Budget</p>
                        <p class="text-2xl font-bold text-green-900 font-mono">$80k</p>
                    </div>
                </div>
                
                <div class="mt-6 p-6 bg-white rounded-3xl shadow-sm border border-gray-100 text-center">
                   <p class="text-gray-400 mb-4">æ›´å¤šçµ±è¨ˆåœ–è¡¨é–‹ç™¼ä¸­...</p>
                   <i class="fa-solid fa-laptop-code text-4xl text-gray-200"></i>
                </div>
            </div>

        </main>

        <!-- Modals æ¨£å¼å„ªåŒ– -->
        <div id="addItineraryModal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="window.closeModal('addItineraryModal')">
            <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-sm transform transition-all scale-100" onclick="event.stopPropagation()">
                <h3 class="text-xl font-bold mb-6 flex justify-between items-center text-gray-700">
                    æ–°å¢è¡Œç¨‹
                    <button onclick="window.closeModal('addItineraryModal')" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 hover:bg-gray-200 flex items-center justify-center transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <form id="add-itinerary-form" onsubmit="window.addItineraryItem(event)">
                    <label class="text-sm font-bold text-gray-500 mb-1 block ml-1">å“ªä¸€å¤©?</label>
                    <div class="relative mb-3">
                        <select id="new-date" class="w-full p-3 bg-gray-50 border-0 rounded-xl text-gray-700 appearance-none font-bold" required></select>
                        <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-gray-400 pointer-events-none"></i>
                    </div>

                    <label class="text-sm font-bold text-gray-500 mb-1 block ml-1">å¹¾é»?</label>
                    <div class="flex items-center mb-3">
                        <input type="time" id="new-time" class="w-full p-3 bg-gray-50 border-0 rounded-xl text-gray-700 font-bold text-lg text-center" required>
                    </div>

                    <label class="text-sm font-bold text-gray-500 mb-1 block ml-1">åšä»€éº¼?</label>
                    <input type="text" id="new-title" placeholder="æ™šé¤: ç‡’è‚‰" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-3 text-gray-700 placeholder-gray-300" required>

                    <label class="text-sm font-bold text-gray-500 mb-1 block ml-1">å‚™è¨» / åœ°é»</label>
                    <textarea id="new-note" rows="3" placeholder="è¨˜å¾—è¨‚ä½..." class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-6 text-gray-700 placeholder-gray-300"></textarea>

                    <button type="submit" class="w-full bg-custom-primary text-white p-3 rounded-2xl font-bold shadow-lg shadow-pink-200 hover:bg-custom-primary-dark transition">
                        <i class="fa-solid fa-check mr-1"></i> å®Œæˆ
                    </button>
                </form>
            </div>
        </div>

        <div id="editItineraryModal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="window.closeModal('editItineraryModal')">
            <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-xl font-bold mb-2 flex justify-between items-center text-gray-700">
                    ç·¨è¼¯è¡Œç¨‹
                    <button onclick="window.closeModal('editItineraryModal')" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 hover:bg-gray-200 flex items-center justify-center transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <p id="edit-modal-date-info" class="text-sm text-custom-primary font-bold mb-6 bg-pink-50 inline-block px-3 py-1 rounded-lg"></p>
                <form id="edit-itinerary-form" onsubmit="window.saveItineraryItem(event)">
                    <input type="hidden" id="edit-date-key">
                    <input type="hidden" id="edit-item-index">

                    <label class="text-sm font-bold text-gray-500 mb-1 block ml-1">æ™‚é–“</label>
                    <input type="time" id="edit-time" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-3 text-gray-700 font-bold" required>

                    <label class="text-sm font-bold text-gray-500 mb-1 block ml-1">æ¨™é¡Œ</label>
                    <input type="text" id="edit-title" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-3 text-gray-700" required>

                    <label class="text-sm font-bold text-gray-500 mb-1 block ml-1">å‚™è¨»</label>
                    <textarea id="edit-note" rows="3" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-6 text-gray-700"></textarea>

                    <div class="flex space-x-3">
                        <button type="button" onclick="window.deleteItineraryItem(document.getElementById('edit-date-key').value, parseInt(document.getElementById('edit-item-index').value))" class="flex-1 bg-white text-red-400 border-2 border-red-100 p-3 rounded-2xl font-bold hover:bg-red-50 transition">
                            <i class="fa-solid fa-trash-can mr-1"></i> åˆªé™¤
                        </button>
                        <button type="submit" class="flex-[2] bg-custom-primary text-white p-3 rounded-2xl font-bold shadow-lg shadow-pink-200 hover:bg-custom-primary-dark transition">
                            <i class="fa-solid fa-check mr-1"></i> å„²å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="editExpenseModal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="window.closeModal('editExpenseModal')">
            <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-xl font-bold mb-4 flex justify-between items-center text-custom-primary">
                    <span class="flex items-center"><i class="fa-solid fa-pen-to-square mr-2"></i> ç·¨è¼¯æ”¯å‡º</span>
                    <button onclick="window.closeModal('editExpenseModal')" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 hover:bg-gray-200 flex items-center justify-center transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <form onsubmit="window.saveExpenseUpdate(event)">
                    <input type="hidden" id="edit-expense-id">
                    
                    <label class="text-sm font-bold text-gray-500 block mb-1 ml-1">æ—¥æœŸ</label>
                    <input type="date" id="edit-expense-date" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-3 text-gray-700 font-bold" required>

                    <label class="text-sm font-bold text-gray-500 block mb-1 ml-1">é‡‘é¡</label>
                    <div class="flex mb-3">
                        <input type="number" step="0.01" id="edit-expense-amount" class="flex-1 p-3 bg-gray-50 border-0 rounded-xl text-gray-700 font-bold" required>
                        <div id="edit-expense-currency-select" class="flex ml-2 items-center">
                            <button type="button" class="block-select-btn px-3 py-2 text-sm rounded-xl" data-currency="TWD" onclick="window.selectCurrency('TWD', 'edit-expense')">TWD</button>
                            <button type="button" class="block-select-btn px-3 py-2 text-sm rounded-xl" data-currency="JPY" onclick="window.selectCurrency('JPY', 'edit-expense')">JPY</button>
                        </div>
                        <input type="hidden" id="edit-expense-currency" value="TWD">
                    </div>

                    <label class="text-sm font-bold text-gray-500 block mb-1 ml-1">èªªæ˜</label>
                    <input type="text" id="edit-expense-description" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-3 text-gray-700" required>

                    <label class="text-sm font-bold text-gray-500 block mb-2 ml-1">ä»˜æ¬¾äºº</label>
                    <div id="edit-expense-payer-select" class="flex mb-3">
                        <button type="button" class="block-select-btn flex-1" data-payer="Josh" onclick="window.selectPayer('Josh', 'edit-expense')">Josh</button>
                        <button type="button" class="block-select-btn flex-1" data-payer="Candice" onclick="window.selectPayer('Candice', 'edit-expense')">Candice</button>
                        <input type="hidden" id="edit-expense-payer" value="Josh">
                    </div>
                    
                    <label class="text-sm font-bold text-gray-500 block mb-2 ml-1">é¡åˆ¥</label>
                    <div id="edit-expense-category-select" class="grid grid-cols-3 gap-2 mb-3">
                        <button type="button" class="block-select-btn w-full !mr-0" data-category="Food" onclick="window.selectCategory('Food', 'edit-expense')">é¤é£²</button>
                        <button type="button" class="block-select-btn w-full !mr-0" data-category="Transport" onclick="window.selectCategory('Transport', 'edit-expense')">äº¤é€š</button>
                        <button type="button" class="block-select-btn w-full !mr-0" data-category="Accommodation" onclick="window.selectCategory('Accommodation', 'edit-expense')">ä½å®¿</button>
                        <button type="button" class="block-select-btn w-full !mr-0" data-category="Shopping" onclick="window.selectCategory('Shopping', 'edit-expense')">è³¼ç‰©</button>
                        <button type="button" class="block-select-btn w-full !mr-0" data-category="Ticket" onclick="window.selectCategory('Ticket', 'edit-expense')">é–€ç¥¨</button>
                        <button type="button" class="block-select-btn w-full !mr-0" data-category="Other" onclick="window.selectCategory('Other', 'edit-expense')">å…¶ä»–</button>
                        <input type="hidden" id="edit-expense-category" value="Food">
                    </div>

                    <label class="text-sm font-bold text-gray-500 block mb-2 ml-1">æ–¹å¼</label>
                    <div id="edit-expense-payment-select" class="flex mb-6">
                        <button type="button" class="block-select-btn flex-1" data-payment="Cash" onclick="window.selectPayment('Cash', 'edit-expense')">ç¾é‡‘</button>
                        <button type="button" class="block-select-btn flex-1" data-payment="Card" onclick="window.selectPayment('Card', 'edit-expense')">ä¿¡ç”¨å¡</button>
                        <input type="hidden" id="edit-expense-payment" value="Cash">
                    </div>

                    <button type="submit" class="w-full bg-custom-primary text-white p-3 rounded-2xl font-bold shadow-lg shadow-pink-200 hover:bg-custom-primary-dark transition">
                        <i class="fa-solid fa-check mr-1"></i> å„²å­˜
                    </button>
                </form>
            </div>
        </div>

    </div>

</body>
</html>