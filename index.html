<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦å²¡ç†Šæœ¬è¡Œç¨‹åŠ©æ‰‹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šç¾©é¡è‰² */
        :root {
            --custom-primary: #4285F4; /* Google Blue */
            --custom-secondary: #0F9D58; /* Google Green */
            --custom-danger: #DB4437; /* Google Red */
        }

        .bg-custom-primary { background-color: var(--custom-primary); }
        .text-custom-primary { color: var(--custom-primary); }
        .bg-custom-secondary { background-color: var(--custom-secondary); }
        .text-custom-secondary { color: var(--custom-secondary); }
        .border-custom-primary { border-color: var(--custom-primary); }
        .hover\:bg-custom-primary-dark:hover { background-color: #3A7AD0; }
        .hover\:text-custom-primary-dark:hover { color: #3A7AD0; }

        /* é€šç”¨æŒ‰éˆ•æ¨£å¼ */
        .tab-button {
            padding: 8px 12px;
            margin-right: 8px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            min-width: 80px;
            font-size: 0.875rem; /* text-sm */
            border: 1px solid #E5E7EB;
            color: #4B5563; /* text-gray-700 */
        }
        .tab-button.active {
            background-color: var(--custom-primary);
            color: white;
            border-color: var(--custom-primary);
        }

        /* ä¸»å°èˆªæŒ‰éˆ•æ¨£å¼ */
        .main-nav-btn {
            @apply flex-1 py-3 text-center transition duration-200 text-gray-600 border-b-2 border-transparent;
        }
        .main-nav-btn.active {
            @apply text-custom-primary border-custom-primary font-bold;
        }
        
        /* è¨˜å¸³é¸æ“‡æŒ‰éˆ•æ¨£å¼ */
        .block-select-btn {
            @apply px-4 py-2 border rounded-lg text-sm font-semibold transition duration-150 mr-2 mb-2;
            white-space: nowrap;
        }
        .block-select-btn:not(.active-currency):not(.active-payer):not(.active-category):not(.active-payment):not(.active-filter) {
            @apply bg-white text-gray-700 hover:bg-gray-100;
        }
        .active-currency, .active-payer, .active-category, .active-payment, .active-filter {
            @apply bg-custom-primary text-white border-custom-primary;
        }

        /* è¡Œç¨‹æ™‚é–“ç·šé€£æ¥ç·š */
        .timeline-container {
            position: relative;
        }
        .timeline-container::before {
            content: '';
            position: absolute;
            top: 60px; /* èª¿æ•´èµ·é» */
            bottom: 30px; /* èª¿æ•´çµ‚é» */
            left: 1.5rem; /* è®“ç·šåœ¨ä¸­é–“ */
            width: 2px;
            background-color: #E5E7EB;
            z-index: 0;
        }
        .timeline-item {
            padding-left: 1.5rem;
            min-height: 20px;
            cursor: pointer;
        }

        /* æ…¾æœ›æ¸…å–®ç‹€æ…‹ */
        .wishlist-status-btn {
            @apply px-2 py-0.5 rounded-full text-xs font-semibold;
        }
        .wishlist-status-btn.purchased {
            @apply bg-custom-secondary text-white;
        }
        .wishlist-status-btn.pending {
            @apply bg-yellow-100 text-yellow-800;
        }

        /* æ‰“åŒ…æ¸…å–®ç‹€æ…‹ (æ–°å¢) */
        .packing-status-btn {
            @apply px-2 py-0.5 rounded-full text-xs font-semibold transition duration-150;
        }
        .packing-status-btn.packed {
            @apply bg-custom-secondary text-white;
        }
        .packing-status-btn.not-packed {
            @apply bg-red-100 text-red-700 hover:bg-red-200;
        }
    </style>
    
    <script type="module">
        /* =========================
          Firebase åˆå§‹åŒ– (ä½¿ç”¨ ES Modules)
        ========================= */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import {
            getFirestore,
            collection,
            doc,
            setDoc, // ç”¨æ–¼è¦†å¯«æ•´å€‹æ–‡ä»¶ (ä¾‹å¦‚æ–°å¢è¡Œç¨‹å¤©æ•¸æ™‚)
            addDoc, // ç”¨æ–¼æ–°å¢æ–‡ä»¶ (ä¾‹å¦‚è¨˜å¸³å’Œæ…¾æœ›æ¸…å–®)
            updateDoc, // ç”¨æ–¼æ›´æ–°ç¾æœ‰æ–‡ä»¶ (ä¾‹å¦‚ä¿®æ”¹è¡Œç¨‹å…§å®¹)
            deleteDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        
        // ğŸš¨ è«‹ç¢ºèªé€™æ˜¯æ‚¨çš„çœŸå¯¦é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBRjYjvwvCNTRHdI8vH8n3GPabzSnSDbvI",
            authDomain: "jp-b0e03.firebaseapp.com",
            projectId: "jp-b0e03",
            storageBucket: "jp-b0e03.firebasestorage.app", // å»ºè­°åŠ å…¥
            messagingSenderId: "689610031212", // å»ºè­°åŠ å…¥
            appId: "1:689610031212:web:f63f2efe61d4ad562bd849", // å»ºè­°åŠ å…¥
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /* =========================
          å…¨åŸŸè®Šæ•¸èˆ‡è³‡æ–™ç‹€æ…‹
        ========================= */
        let ITINERARY_DATA = []; // è¡Œç¨‹æ•¸æ“š (ç”¨æ–¼æ¸²æŸ“)
        let EXPENSES_DATA = []; // è¨˜å¸³æ•¸æ“š
        let WISHLIST_DATA = []; // æ…¾æœ›æ¸…å–®æ•¸æ“š
        let PACKING_DATA = []; // â­ï¸ æ–°å¢ï¼šæ‰“åŒ…æ¸…å–®æ•¸æ“š
        let ACTIVE_DATE = ''; // ç•¶å‰é¸ä¸­çš„æ—¥æœŸ (è¡Œç¨‹é ç±¤)
        let ACTIVE_CURRENCY = 'TWD';
        let ACTIVE_PAYER = 'Josh';
        let ACTIVE_CATEGORY = 'Food';
        let ACTIVE_PAYMENT = 'Cash';
        let EXPENSE_FILTER = 'All';
        
        // åŒ¯ç‡èˆ‡é ç®— (éœæ…‹è³‡æ–™æˆ–æœªä¾†å¯å¾ Firestore è¼‰å…¥)
        const EXCHANGE_RATE_JPY_TWD = 0.215; 
        const TOTAL_BUDGET_TWD = 50000;
        
        // é¡åˆ¥åœ–æ¨™æ˜ å°„
        const ICON_MAP = {
            Food: 'fa-utensils',
            Transport: 'fa-train-subway',
            Accommodation: 'fa-hotel',
            Shopping: 'fa-bag-shopping',
            Other: 'fa-ellipsis',
            // æ–°å¢æ›´å¤šé¡åˆ¥ä»¥æ”¯æ´è¨˜å¸³ç·¨è¼¯
            Ticket: 'fa-ticket', 
            Souvenir: 'fa-gift'
        };

        /* =========================
          æ•¸æ“šåŒæ­¥æ ¸å¿ƒ (onSnapshot)
        ========================= */
        function startDataSync() {
            // 1. è¡Œç¨‹æ•¸æ“š (Itineraries) - æŒ‰æ—¥æœŸæ’åº
            const itineraryQuery = query(collection(db, "itineraries"), orderBy("date", "asc"));
            onSnapshot(itineraryQuery, (snapshot) => {
                ITINERARY_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // ç¢ºä¿ activities æ˜¯ä¸€å€‹é™£åˆ—ï¼Œä¸¦æŒ‰æ™‚é–“æ’åº
                    activities: Array.isArray(doc.data().activities) ? 
                                doc.data().activities.sort((a, b) => a.time.localeCompare(b.time)) : []
                }));

                if (ITINERARY_DATA.length > 0) {
                    if (!ACTIVE_DATE) {
                        ACTIVE_DATE = ITINERARY_DATA[0].id; // ä½¿ç”¨ id ä½œç‚ºæ—¥æœŸéµ
                    }
                    window.generateDateTabs();
                    window.renderItinerary();
                    window.populateItineraryModalDates();
                } else {
                    document.getElementById('itinerary-container').innerHTML = '<p class="text-center text-gray-500 mt-8">è«‹åœ¨ Firebase Console ä¸­æ–°å¢è¡Œç¨‹æ•¸æ“šã€‚</p>';
                }
            }, (error) => {
                console.error("Error listening to itineraries: ", error);
            });
            
            // 2. è¨˜å¸³æ•¸æ“š (Expenses) - æŒ‰æ—¥æœŸæ’åº
            const expenseQuery = query(collection(db, "expenses"), orderBy("date", "desc"), orderBy("timestamp", "desc"));
            onSnapshot(expenseQuery, (snapshot) => {
                EXPENSES_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                window.renderExpenseTracking(); // æ•¸æ“šæ›´æ–°æ™‚é‡æ–°æ¸²æŸ“è¨˜å¸³é 
            }, (error) => {
                console.error("Error listening to expenses: ", error);
            });
            
            // 3. æ…¾æœ›æ¸…å–® (Wishlist) - æŒ‰è³¼è²·ç‹€æ…‹å’Œæ™‚é–“æ’åº
            const wishlistQuery = query(collection(db, "wishlists"), orderBy("purchased", "asc"), orderBy("timestamp", "desc"));
            onSnapshot(wishlistQuery, (snapshot) => {
                WISHLIST_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // åªæœ‰åœ¨ wishlist é ç±¤è¢«é¸ä¸­æ™‚æ‰å¼·åˆ¶æ¸²æŸ“ï¼Œé¿å…ä¸å¿…è¦çš„é–‹éŠ·
                if (document.getElementById('wishlist-tab').classList.contains('hidden') === false) {
                     window.renderWishlist(); 
                }
            }, (error) => {
                console.error("Error listening to wishlists: ", error);
            });

            // 4. â­ï¸ æ–°å¢ï¼šæ‰“åŒ…æ¸…å–® (PackingList) - æŒ‰æ‰“åŒ…ç‹€æ…‹å’Œæ™‚é–“æ’åº
            const packingQuery = query(collection(db, "packinglist"), orderBy("packed", "asc"), orderBy("timestamp", "desc"));
            onSnapshot(packingQuery, (snapshot) => {
                PACKING_DATA = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                if (document.getElementById('packing-tab') && document.getElementById('packing-tab').classList.contains('hidden') === false) {
                    window.renderPackingList();
                }
            }, (error) => {
                console.error("Error listening to packinglist: ", error);
            });
            
            // æ¸²æŸ“åŒ¯ç‡ (éœæ…‹)
            document.getElementById('exchange-rate-display').textContent = EXCHANGE_RATE_JPY_TWD.toFixed(4);
        }

        /* ===================================================
          è¡Œç¨‹ (ITINERARY) ç›¸é—œå‡½å¼
        =================================================== */

        // æ¸²æŸ“æ—¥æœŸæŒ‰éˆ•
        window.generateDateTabs = function() {
            const tabContainer = document.getElementById('date-buttons-container');
            if (!tabContainer) return;
            tabContainer.innerHTML = ''; 

            ITINERARY_DATA.forEach((day, index) => {
                const isActive = day.id === ACTIVE_DATE;
                const button = document.createElement('button');
                
                // ç¢ºä¿ä½¿ç”¨ HTML ä¸­å®šç¾©çš„ CSS class
                button.className = `tab-button ${isActive ? 'active' : ''}`;
                button.innerHTML = `
                    <div class="font-bold">Day ${index + 1}</div>
                    <div class="text-xs">${day.date.substring(5)} (${day.day_of_week})</div>
                `;
                
                button.onclick = () => {
                    window.setActiveDate(day.id);
                };
                
                tabContainer.appendChild(button);
            });
        }
        
        // åˆ‡æ›ç•¶å‰é¸ä¸­æ—¥æœŸ
        window.setActiveDate = function(dateId) {
            ACTIVE_DATE = dateId;
            window.generateDateTabs(); 
            window.renderItinerary();  
        }

        // æ¸²æŸ“è¡Œç¨‹å…§å®¹
        window.renderItinerary = function() {
            const contentContainer = document.getElementById('itinerary-container'); 
            if (!contentContainer) return;
            contentContainer.innerHTML = ''; 

            const currentDay = ITINERARY_DATA.find(day => day.id === ACTIVE_DATE);

            if (!currentDay || !currentDay.activities || currentDay.activities.length === 0) {
                contentContainer.innerHTML = `
                    <h2 class="text-xl font-bold p-4 bg-gray-100 border-b border-gray-200">${currentDay ? currentDay.city : 'ç„¡è³‡æ–™'} - ${currentDay ? currentDay.date : 'ç„¡è³‡æ–™'}</h2>
                    <p class="text-center text-gray-500 mt-8">æœ¬æ—¥ç„¡è¡Œç¨‹ï¼Œé»æ“Šå³ä¸‹è§’æ–°å¢ã€‚</p>`;
                return;
            }
            
            let html = `
                <h2 class="text-xl font-bold p-4 bg-gray-100 border-b border-gray-200">${currentDay.city} - ${currentDay.date}</h2>
                <div class="timeline-container p-4">
                `;

            currentDay.activities.forEach((activity, index) => {
                const clickHandler = `window.openEditModal('${currentDay.id}', ${index})`;
                
                // â­ï¸ æ–°å¢ï¼šæ ¹æ“šæ´»å‹•é¡å‹çµ¦äºˆä¸åŒåœ–æ¨™ (å¯æ ¹æ“š title é—œéµå­—æ“´å……)
                const activityIcon = activity.title.includes('é¤') ? 'fa-utensils' : 
                                     activity.title.includes('é£¯åº—') || activity.title.includes('ä½å®¿') ? 'fa-bed' : 
                                     activity.title.includes('æ©Ÿ') ? 'fa-plane' : 
                                     'fa-location-dot';

                
                html += `
                    <div class="flex items-start mb-6" onclick="${clickHandler}">
                        <div class="w-1/4 text-sm font-semibold text-gray-600 pt-1">${activity.time}</div>
                        <div class="w-3/4">
                            <div class="timeline-item relative">
                                <span class="absolute -left-[1.3rem] top-1 h-3 w-3 rounded-full bg-custom-primary border-2 border-white"></span>
                                <div class="font-bold text-gray-800 flex items-center">
                                    <i class="fa-solid ${activityIcon} text-custom-primary mr-2 text-sm"></i>
                                    <span>${activity.title}</span>
                                </div>
                                <div class="text-sm text-gray-500">${activity.location || ''}</div>
                                ${activity.notes ? `<div class="text-xs text-gray-700 mt-1 italic">${activity.notes}</div>` : ''}
                                ${activity.link ? `<a href="${activity.link}" target="_blank" class="text-xs font-semibold mt-1 inline-block" onclick="event.stopPropagation();"><i class="fas fa-map-marker-alt"></i> å°èˆª</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            contentContainer.innerHTML = html;
        }
        
        // å¡«å……æ–°å¢è¡Œç¨‹ Modal ä¸­çš„æ—¥æœŸé¸é …
        window.populateItineraryModalDates = function() {
            const select = document.getElementById('new-date');
            if (!select) return;
            select.innerHTML = ''; 
            
            ITINERARY_DATA.forEach(day => {
                const option = document.createElement('option');
                option.value = day.id;
                option.textContent = `${day.date.substring(5)} (${day.day_of_week}) - ${day.city}`;
                if (day.id === ACTIVE_DATE) {
                    option.selected = true; 
                }
                select.appendChild(option);
            });
        }
        
        // æ–°å¢è¡Œç¨‹é …ç›® (Add)
        window.addItineraryItem = async function(event) {
            event.preventDefault();
            const dateId = document.getElementById('new-date').value;
            const time = document.getElementById('new-time').value;
            const title = document.getElementById('new-title').value;
            const note = document.getElementById('new-note').value;
            
            if (!dateId || !time || !title) return;

            const newActivity = {
                time: time,
                title: title,
                location: note, // å‡è¨­å‚™è¨»/åœ°é»
                notes: '', 
                link: ''
            };

            try {
                const dayDocRef = doc(db, 'itineraries', dateId);
                const currentDay = ITINERARY_DATA.find(d => d.id === dateId);
                
                if (currentDay) {
                     // è¤‡è£½ä¸¦åŠ å…¥æ–°æ´»å‹•
                    const updatedActivities = [...(currentDay.activities || []), newActivity];

                    // æ ¹æ“šæ™‚é–“æ’åº (å¯é¸ï¼Œä½†å¼·çƒˆå»ºè­°)
                    updatedActivities.sort((a, b) => a.time.localeCompare(b.time));
                    
                    await updateDoc(dayDocRef, {
                        activities: updatedActivities
                    });
                } else {
                    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯ä»¥é¸æ“‡å‰µå»ºä¸€å€‹æ–°çš„æ—¥æœŸæ–‡ä»¶ (é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œå‡è¨­æ–‡ä»¶å·²å­˜åœ¨)
                    alert('æ‰¾ä¸åˆ°å°æ‡‰æ—¥æœŸæ–‡ä»¶ï¼Œè«‹å…ˆåœ¨ Firestore æ–°å¢æ–‡ä»¶ã€‚');
                    return;
                }


                window.closeModal('addItineraryModal');
                document.getElementById('add-itinerary-form').reset(); 
                alert('è¡Œç¨‹æ–°å¢æˆåŠŸï¼');

            } catch (e) {
                console.error("Error adding itinerary item: ", e);
                alert('æ–°å¢è¡Œç¨‹å¤±æ•—ã€‚');
            }
        }

        // é–‹å•Ÿç·¨è¼¯ Modal
        window.openEditModal = function(dateId, index) {
            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay || !currentDay.activities || !currentDay.activities[index]) return;

            const activity = currentDay.activities[index];
            const dayIndex = ITINERARY_DATA.indexOf(currentDay);

            document.getElementById('edit-modal-date-info').textContent = `${currentDay.city} - ${currentDay.date} (Day ${dayIndex + 1})`;
            
            document.getElementById('edit-date-key').value = dateId;
            document.getElementById('edit-item-index').value = index;
            document.getElementById('edit-time').value = activity.time || '';
            document.getElementById('edit-title').value = activity.title || '';
            document.getElementById('edit-note').value = activity.location || activity.notes || ''; 

            window.openModal('editItineraryModal');
        }

        // å„²å­˜ä¿®æ”¹ (Update)
        window.saveItineraryItem = async function(event) {
            event.preventDefault();
            const dateId = document.getElementById('edit-date-key').value;
            const index = parseInt(document.getElementById('edit-item-index').value);
            const time = document.getElementById('edit-time').value;
            const title = document.getElementById('edit-title').value;
            const note = document.getElementById('edit-note').value;

            if (!dateId || index === undefined || !time || !title) return;

            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay) return;

            const updatedActivities = [...currentDay.activities];
            
            updatedActivities[index] = {
                ...updatedActivities[index], 
                time: time,
                title: title,
                location: note, 
                notes: '',
            };
            
            updatedActivities.sort((a, b) => a.time.localeCompare(b.time));

            try {
                await updateDoc(doc(db, 'itineraries', dateId), {
                    activities: updatedActivities
                });
                window.closeModal('editItineraryModal');
                alert('è¡Œç¨‹ä¿®æ”¹æˆåŠŸï¼');
            } catch (e) {
                console.error("Error updating document: ", e);
                alert('è¡Œç¨‹ä¿®æ”¹å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤è¡Œç¨‹é …ç›® (Delete)
        window.deleteItineraryItem = async function(dateId, index) {
            if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹é …ç›®å—ï¼Ÿ')) return;

            const currentDay = ITINERARY_DATA.find(day => day.id === dateId);
            if (!currentDay) return;

            const updatedActivities = currentDay.activities.filter((_, i) => i !== index);

            try {
                await updateDoc(doc(db, 'itineraries', dateId), {
                    activities: updatedActivities
                });
                window.closeModal('editItineraryModal');
                alert('è¡Œç¨‹åˆªé™¤æˆåŠŸï¼');
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert('è¡Œç¨‹åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        /* ===================================================
          è¨˜å¸³ (EXPENSE) ç›¸é—œå‡½å¼ (æ–°å¢ç·¨è¼¯åŠŸèƒ½)
        =================================================== */
        
        // â­ï¸ æ–°å¢ï¼šåˆ‡æ›è¨˜å¸³/æ˜ç´°é ç±¤
        window.switchExpenseView = function(view) {
            const addContainer = document.getElementById('add-expense-container');
            const detailsContainer = document.getElementById('expense-details-container');
            const addBtn = document.getElementById('tab-add-expense-btn');
            const detailsBtn = document.getElementById('tab-view-details-btn');

            // ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å­˜åœ¨
            if (!addContainer || !detailsContainer || !addBtn || !detailsBtn) return; 

            // é‡è¨­æŒ‰éˆ•æ¨£å¼
            addBtn.classList.remove('active-expense-tab-btn', 'bg-custom-primary', 'text-white');
            detailsBtn.classList.remove('active-expense-tab-btn', 'bg-custom-primary', 'text-white');
            addBtn.classList.add('bg-white', 'text-gray-700');
            detailsBtn.classList.add('bg-white', 'text-gray-700');
            
            // ç¢ºä¿ inactive æŒ‰éˆ•æœ‰ hover æ•ˆæœ
            addBtn.classList.remove('hover:bg-[#3A7AD0]');
            detailsBtn.classList.remove('hover:bg-[#3A7AD0]');
            addBtn.classList.add('hover:bg-gray-100');
            detailsBtn.classList.add('hover:bg-gray-100');


            if (view === 'add') {
                // é¡¯ç¤ºæ–°å¢è¡¨å–®ï¼Œéš±è—æ˜ç´°
                addContainer.classList.remove('hidden');
                detailsContainer.classList.add('hidden');
                
                // è¨­å®šæŒ‰éˆ•æ¨£å¼
                addBtn.classList.add('active-expense-tab-btn', 'bg-custom-primary', 'text-white');
                addBtn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                addBtn.classList.add('hover:bg-[#3A7AD0]');

            } else if (view === 'details') {
                // é¡¯ç¤ºæ˜ç´°ï¼Œéš±è—æ–°å¢è¡¨å–®
                addContainer.classList.add('hidden');
                detailsContainer.classList.remove('hidden');
                
                // è¨­å®šæŒ‰éˆ•æ¨£å¼
                detailsBtn.classList.add('active-expense-tab-btn', 'bg-custom-primary', 'text-white');
                detailsBtn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                detailsBtn.classList.add('hover:bg-[#3A7AD0]');
                
                // å‘¼å«æ¸²æŸ“å‡½å¼
                window.renderExpenseTracking(); 
            }
        }


        // é¸æ“‡å¹£åˆ¥ (é€šç”¨å‡½å¼ï¼Œç”¨æ–¼æ–°å¢å’Œç·¨è¼¯)
        window.selectCurrency = function(currency, prefix = 'expense') {
            const currencyId = `${prefix}-currency`;
            const containerId = `${prefix}-currency-select`;
            
            ACTIVE_CURRENCY = currency;

            document.querySelectorAll(`#${containerId} .block-select-btn`).forEach(btn => {
                btn.classList.remove('active-currency');
                if (btn.getAttribute('data-currency') === currency) {
                    btn.classList.add('active-currency');
                }
            });
            document.getElementById(currencyId).value = currency;
        }

        // é¸æ“‡ä»˜æ¬¾äºº (é€šç”¨å‡½å¼ï¼Œç”¨æ–¼æ–°å¢å’Œç·¨è¼¯)
        window.selectPayer = function(payer, prefix = 'expense') {
            const payerId = `${prefix}-payer`;
            const containerId = `${prefix}-payer-select`;
            
            ACTIVE_PAYER = payer;

            document.querySelectorAll(`#${containerId} .block-select-btn`).forEach(btn => {
                btn.classList.remove('active-payer');
                if (btn.getAttribute('data-payer') === payer) {
                    btn.classList.add('active-payer');
                }
            });
            document.getElementById(payerId).value = payer;
        }
        
        // é¸æ“‡é¡åˆ¥ (é€šç”¨å‡½å¼ï¼Œç”¨æ–¼æ–°å¢å’Œç·¨è¼¯)
        window.selectCategory = function(category, prefix = 'expense') {
            const categoryId = `${prefix}-category`;
            const containerId = `${prefix}-category-select`;
            
            ACTIVE_CATEGORY = category;

            document.querySelectorAll(`#${containerId} .block-select-btn`).forEach(btn => {
                btn.classList.remove('active-category');
                if (btn.getAttribute('data-category') === category) {
                    btn.classList.add('active-category');
                }
            });
            document.getElementById(categoryId).value = category;
        }
        
        // é¸æ“‡æ”¯ä»˜æ–¹å¼ (é€šç”¨å‡½å¼ï¼Œç”¨æ–¼æ–°å¢å’Œç·¨è¼¯)
        window.selectPayment = function(payment, prefix = 'expense') {
            const paymentId = `${prefix}-payment`;
            const containerId = `${prefix}-payment-select`;
            
            ACTIVE_PAYMENT = payment;

            document.querySelectorAll(`#${containerId} .block-select-btn`).forEach(btn => {
                btn.classList.remove('active-payment');
                if (btn.getAttribute('data-payment') === payment) {
                    btn.classList.add('active-payment');
                }
            });
            document.getElementById(paymentId).value = payment;
        }

        // é¸æ“‡é¡åˆ¥ (ç¯©é¸æ¸…å–®)
        window.filterExpenses = function(category) {
            EXPENSE_FILTER = category;
            window.renderExpenseTracking(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }

        // æ–°å¢æ”¯å‡º (Add Expense)
        window.addExpense = async function() {
            const date = document.getElementById('expense-date').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const description = document.getElementById('expense-description').value;

            if (!date || isNaN(amount) || amount <= 0 || !description) {
                alert('è«‹æª¢æŸ¥æ—¥æœŸã€é‡‘é¡å’Œç”¨é€”æ˜¯å¦æ­£ç¢ºå¡«å¯«ï¼');
                return;
            }

            const newExpense = {
                date: date,
                amount: amount,
                currency: ACTIVE_CURRENCY,
                payer: ACTIVE_PAYER,
                category: ACTIVE_CATEGORY,
                payment: ACTIVE_PAYMENT,
                description: description,
                timestamp: serverTimestamp() // ä½¿ç”¨ Firestore æœå‹™å™¨æ™‚é–“æˆ³
            };

            try {
                await addDoc(collection(db, "expenses"), newExpense);
                alert('æ”¯å‡ºç´€éŒ„æ–°å¢æˆåŠŸï¼');
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-description').value = '';
                // ä¸é‡è¨­æ—¥æœŸï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥
            } catch (e) {
                console.error("Error adding expense: ", e);
                alert('æ–°å¢æ”¯å‡ºç´€éŒ„å¤±æ•—ã€‚');
            }
        }

        // â­ï¸ æ–°å¢ï¼šé–‹å•Ÿç·¨è¼¯æ”¯å‡º Modal
        window.openEditExpenseModal = function(expenseId) {
            const expense = EXPENSES_DATA.find(e => e.id === expenseId);
            if (!expense) return;

            document.getElementById('edit-expense-id').value = expense.id;
            document.getElementById('edit-expense-date').value = expense.date || '';
            document.getElementById('edit-expense-amount').value = expense.amount || '';
            document.getElementById('edit-expense-description').value = expense.description || '';
            
            // é‡æ–°è¨­å®šé¸æ“‡å™¨ç‹€æ…‹ (å‚³å…¥ 'edit-expense' ä½œç‚º prefix)
            window.selectCurrency(expense.currency, 'edit-expense');
            window.selectPayer(expense.payer, 'edit-expense');
            window.selectCategory(expense.category, 'edit-expense');
            window.selectPayment(expense.payment, 'edit-expense');

            window.openModal('editExpenseModal');
        }

        // â­ï¸ æ–°å¢ï¼šå„²å­˜ç·¨è¼¯å¾Œçš„æ”¯å‡º (Update Expense)
        window.saveExpenseUpdate = async function(event) {
            event.preventDefault();
            const id = document.getElementById('edit-expense-id').value;
            const date = document.getElementById('edit-expense-date').value;
            const amount = parseFloat(document.getElementById('edit-expense-amount').value);
            const description = document.getElementById('edit-expense-description').value;
            const currency = document.getElementById('edit-expense-currency').value;
            const payer = document.getElementById('edit-expense-payer').value;
            const category = document.getElementById('edit-expense-category').value;
            const payment = document.getElementById('edit-expense-payment').value;


            if (!id || !date || isNaN(amount) || amount <= 0 || !description) {
                alert('è«‹æª¢æŸ¥æ‰€æœ‰æ¬„ä½æ˜¯å¦æ­£ç¢ºå¡«å¯«ï¼');
                return;
            }

            const updatedExpense = {
                date: date,
                amount: amount,
                currency: currency,
                payer: payer,
                category: category,
                payment: payment,
                description: description,
            };

            try {
                const docRef = doc(db, "expenses", id);
                await updateDoc(docRef, updatedExpense);
                alert('æ”¯å‡ºç´€éŒ„ä¿®æ”¹æˆåŠŸï¼');
                window.closeModal('editExpenseModal');
            } catch (e) {
                console.error("Error updating expense: ", e);
                alert('ä¿®æ”¹æ”¯å‡ºç´€éŒ„å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤æ”¯å‡º
        window.deleteExpense = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "expenses", id));
                alert('æ”¯å‡ºç´€éŒ„å·²åˆªé™¤ã€‚');
            } catch (e) {
                console.error("Error deleting expense: ", e);
                alert('åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        // è¨ˆç®—ä¸¦æ›´æ–°çµç®—æ‘˜è¦
        window.updateSettlementSummary = function() {
            let joshPaidTWD = 0;
            let candicePaidTWD = 0;
            
            EXPENSES_DATA.forEach(expense => {
                let amountTWD = expense.amount;
                if (expense.currency === 'JPY') {
                    amountTWD = expense.amount * EXCHANGE_RATE_JPY_TWD;
                }
                
                if (expense.payer === 'Josh') {
                    joshPaidTWD += amountTWD;
                } else if (expense.payer === 'Candice') {
                    candicePaidTWD += amountTWD;
                }
            });

            // ç¸½æ”¯å‡ºèˆ‡é ç®—
            const totalSpentTWD = joshPaidTWD + candicePaidTWD;
            const remainingBudget = TOTAL_BUDGET_TWD - totalSpentTWD;

            // ç¢ºä¿å…ƒç´ å­˜åœ¨
            const totalBudgetEl = document.getElementById('total-budget');
            const totalSpentEl = document.getElementById('total-spent');
            const remainingBudgetEl = document.getElementById('remaining-budget');
            const joshPaidEl = document.getElementById('josh-paid');
            const candicePaidEl = document.getElementById('candice-paid');
            const settlementElement = document.getElementById('settlement-result');

            if (totalBudgetEl) totalBudgetEl.textContent = TOTAL_BUDGET_TWD.toLocaleString();
            if (totalSpentEl) totalSpentEl.textContent = Math.round(totalSpentTWD).toLocaleString();
            if (remainingBudgetEl) remainingBudgetEl.textContent = Math.round(remainingBudget).toLocaleString();
            
            // çµç®—çµæœ
            if (joshPaidEl) joshPaidEl.textContent = Math.round(joshPaidTWD).toLocaleString();
            if (candicePaidEl) candicePaidEl.textContent = Math.round(candicePaidTWD).toLocaleString();

            if (settlementElement) {
                const diff = joshPaidTWD - candicePaidTWD;
                const halfDiff = Math.abs(diff) / 2;
                
                settlementElement.classList.remove('text-red-600', 'text-green-600', 'text-gray-900');

                if (Math.abs(diff) < 1) { // å¿½ç•¥å¾®å°å·®ç•°
                    settlementElement.textContent = "ç„¡éœ€çµç®—ã€‚";
                    settlementElement.classList.add('text-gray-900');
                } else if (diff > 0) {
                    settlementElement.textContent = `Candice éœ€æ”¯ä»˜ Josh $ ${Math.round(halfDiff).toLocaleString()} TWD`;
                    settlementElement.classList.add('text-red-600');
                } else {
                    settlementElement.textContent = `Josh éœ€æ”¯ä»˜ Candice $ ${Math.round(halfDiff).toLocaleString()} TWD`;
                    settlementElement.classList.add('text-green-600');
                }
            }
        }
        
        // æ¸²æŸ“è¨˜å¸³æ¸…å–®
        window.renderExpenseTracking = function() {
            const expenseList = document.getElementById('expense-list');
            const filterContainer = document.getElementById('category-filter-buttons');
            
            // å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœå…ƒç´ ä¸å­˜åœ¨å‰‡ç›´æ¥é€€å‡º
            if (!expenseList || !filterContainer) return;

            const categories = [...new Set(EXPENSES_DATA.map(e => e.category)), 'All']; // æ‰¾å‡ºæ‰€æœ‰é¡åˆ¥
            
            // æ¸²æŸ“ç¯©é¸æŒ‰éˆ•
            filterContainer.innerHTML = '';
            categories.forEach(cat => {
                const isActive = cat === EXPENSE_FILTER;
                 filterContainer.innerHTML += `
                    <button type="button" class="block-select-btn px-2 py-1 text-xs ${isActive ? 'active-filter' : ''}" onclick="window.filterExpenses('${cat}')">
                        ${cat}
                    </button>
                `;
            });
            
            // ç¯©é¸æ•¸æ“š
            const filteredExpenses = EXPENSES_DATA.filter(e => EXPENSE_FILTER === 'All' || e.category === EXPENSE_FILTER);

            // æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨
            if (filteredExpenses.length === 0) {
                expenseList.innerHTML = '<p class="text-center text-gray-500 text-sm">å°šç„¡ç¬¦åˆç¯©é¸æ¢ä»¶çš„æ”¯å‡ºç´€éŒ„</p>';
            } else {
                expenseList.innerHTML = filteredExpenses.map(expense => {
                    const amountTWD = expense.currency === 'JPY' 
                        ? (expense.amount * EXCHANGE_RATE_JPY_TWD).toFixed(0) 
                        : expense.amount.toFixed(0);
                        
                    const categoryIcon = ICON_MAP[expense.category] || 'fa-ellipsis';
                    
                    return `
                        <div class="p-3 border-b border-gray-100 flex justify-between items-center hover:bg-gray-50 transition duration-150">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-custom-secondary/20 flex items-center justify-center mr-3 text-custom-secondary">
                                    <i class="fa-solid ${categoryIcon}"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">${expense.description}</p>
                                    <p class="text-xs text-gray-500">${expense.date} (${expense.payer} / ${expense.payment})</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-red-600">${expense.currency} ${expense.amount.toLocaleString()}</p>
                                <p class="text-xs text-gray-600">ç´„ $ ${amountTWD.toLocaleString()} TWD</p>
                                <div class="flex justify-end space-x-2 mt-1">
                                    <button onclick="window.openEditExpenseModal('${expense.id}')" class="text-custom-primary hover:text-custom-primary-dark text-xs">
                                        <i class="fa-solid fa-pen-to-square"></i> ç·¨è¼¯
                                    </button>
                                    <button onclick="window.deleteExpense('${expense.id}')" class="text-red-400 hover:text-red-600 text-xs">
                                        <i class="fa-solid fa-trash-can"></i> åˆªé™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            window.updateSettlementSummary();
        }

        /* ===================================================
          æ…¾æœ›æ¸…å–® (WISHLIST) ç›¸é—œå‡½å¼
        =================================================== */
        
        // æ–°å¢æ…¾æœ›æ¸…å–®é …ç›® (Add)
        window.addWishlistItem = async function(event) {
            event.preventDefault();
            const name = document.getElementById('wishlist-name').value;
            const price = parseFloat(document.getElementById('wishlist-price').value);
            const category = document.getElementById('wishlist-category').value;
            
            if (!name || isNaN(price) || price <= 0 || !category) {
                alert('è«‹å¡«å¯«å®Œæ•´é …ç›®åç¨±ã€åƒ¹æ ¼å’Œåˆ†é¡ï¼');
                return;
            }

            const newItem = {
                name: name,
                price: price,
                category: category,
                purchased: false, // é è¨­ç‚ºæœªè³¼è²·
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "wishlists"), newItem);
                alert('æ…¾æœ›æ¸…å–®æ–°å¢æˆåŠŸï¼');
                document.getElementById('wishlist-form').reset();
            } catch (e) {
                console.error("Error adding wishlist item: ", e);
                alert('æ–°å¢æ…¾æœ›æ¸…å–®å¤±æ•—ã€‚');
            }
        }
        
        // åˆ‡æ›è³¼è²·ç‹€æ…‹ (Update)
        window.toggleWishlistStatus = async function(id, currentStatus) {
            try {
                const docRef = doc(db, "wishlists", id);
                await updateDoc(docRef, {
                    purchased: !currentStatus
                });
            } catch (e) {
                console.error("Error updating wishlist status: ", e);
                alert('æ›´æ–°ç‹€æ…‹å¤±æ•—ã€‚');
            }
        }
        
        // åˆªé™¤æ…¾æœ›æ¸…å–®é …ç›®
        window.deleteWishlistItem = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ…¾æœ›æ¸…å–®å—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "wishlists", id));
            } catch (e) {
                console.error("Error deleting wishlist item: ", e);
                alert('åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        // æ¸²æŸ“æ…¾æœ›æ¸…å–®
        window.renderWishlist = function() {
            const wishlistList = document.getElementById('wishlist-list');
            if (!wishlistList) return;
            
            if (WISHLIST_DATA.length === 0) {
                wishlistList.innerHTML = '<p class="text-center text-gray-500 text-sm">å°šç„¡å¾…è³¼é …ç›®</p>';
                return;
            }

            wishlistList.innerHTML = WISHLIST_DATA.map(item => {
                const statusClass = item.purchased ? 'purchased' : 'pending';
                const statusText = item.purchased ? 'âœ… å·²è³¼' : 'âŒ æœªè³¼';
                
                return `
                    <div class="p-3 border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.category}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-custom-primary">Â¥ ${item.price.toLocaleString()}</p>
                            <div class="flex items-center mt-1 space-x-2">
                                <button class="wishlist-status-btn ${statusClass}" 
                                        onclick="window.toggleWishlistStatus('${item.id}', ${item.purchased})">
                                    ${statusText}
                                </button>
                                <button onclick="window.deleteWishlistItem('${item.id}')" class="text-red-400 hover:text-red-600 text-xs">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /* ===================================================
          â­ï¸ æ–°å¢ï¼šæ‰“åŒ…è¡Œæ (PACKING LIST) ç›¸é—œå‡½å¼
        =================================================== */
        
        // â­ï¸ æ–°å¢ï¼šæ¸²æŸ“æ‰“åŒ…æ¸…å–®
        window.renderPackingList = function() {
            const packingListContainer = document.getElementById('packing-list-container');
            if (!packingListContainer) return;

            if (PACKING_DATA.length === 0) {
                packingListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm mt-6">æ‚¨çš„è¡Œææ¸…å–®æ˜¯ç©ºçš„ï¼</p>';
                return;
            }

            packingListContainer.innerHTML = PACKING_DATA.map(item => {
                const isPacked = item.packed;
                const statusClass = isPacked ? 'packed' : 'not-packed';
                const statusIcon = isPacked ? 'fa-check-circle' : 'fa-circle';
                const statusText = isPacked ? 'å·²æ‰“åŒ…' : 'æœªæ‰“åŒ…';
                const itemClass = isPacked ? 'line-through text-gray-400 italic' : 'text-gray-800 font-semibold';
                
                return `
                    <div class="p-3 border-b border-gray-100 flex justify-between items-center hover:bg-gray-50 transition duration-150">
                        <div class="flex items-center flex-1 min-w-0">
                            <button class="packing-status-btn mr-3" onclick="window.togglePackingStatus('${item.id}', ${item.packed})">
                                <i class="fa-solid ${statusIcon} ${isPacked ? 'text-custom-secondary' : 'text-red-500'}"></i>
                            </button>
                            <div class="min-w-0">
                                <p class="${itemClass} truncate">${item.name}</p>
                                <p class="text-xs text-gray-500">${item.category}</p>
                            </div>
                        </div>
                        <div class="text-right ml-4">
                            <button onclick="window.deletePackingItem('${item.id}')" class="text-red-400 hover:text-red-600 text-xs">
                                <i class="fa-solid fa-trash-can"></i> åˆªé™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // â­ï¸ æ–°å¢ï¼šæ–°å¢æ‰“åŒ…é …ç›® (Add Packing Item)
        window.addPackingItem = async function(event) {
            event.preventDefault();
            const name = document.getElementById('packing-name').value;
            const category = document.getElementById('packing-category').value;
            
            if (!name || !category) {
                alert('è«‹å¡«å¯«é …ç›®åç¨±å’Œé¡åˆ¥ï¼');
                return;
            }

            const newItem = {
                name: name,
                category: category,
                packed: false, // é è¨­ç‚ºæœªæ‰“åŒ…
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "packinglist"), newItem);
                alert('æ‰“åŒ…æ¸…å–®æ–°å¢æˆåŠŸï¼');
                document.getElementById('packing-form').reset();
            } catch (e) {
                console.error("Error adding packing item: ", e);
                alert('æ–°å¢æ‰“åŒ…æ¸…å–®å¤±æ•—ã€‚');
            }
        }

        // â­ï¸ æ–°å¢ï¼šåˆ‡æ›æ‰“åŒ…ç‹€æ…‹ (Update Packing Status)
        window.togglePackingStatus = async function(id, currentStatus) {
            try {
                const docRef = doc(db, "packinglist", id);
                await updateDoc(docRef, {
                    packed: !currentStatus
                });
            } catch (e) {
                console.error("Error updating packing status: ", e);
                alert('æ›´æ–°ç‹€æ…‹å¤±æ•—ã€‚');
            }
        }

        // â­ï¸ æ–°å¢ï¼šåˆªé™¤æ‰“åŒ…æ¸…å–®é …ç›®
        window.deletePackingItem = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ‰“åŒ…æ¸…å–®é …ç›®å—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "packinglist", id));
            } catch (e) {
                console.error("Error deleting packing item: ", e);
                alert('åˆªé™¤å¤±æ•—ã€‚');
            }
        }
        
        /* ===================================================
          é€šç”¨å‡½å¼ (Modal, Navigation, Initialization)
        =================================================== */

        // é–‹å•Ÿ Modal
        window.openModal = function(id) {
            document.getElementById(id).style.display = 'flex';
        }

        // é—œé–‰ Modal
        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        // æ¸²æŸ“ç¸½è¦½å¤©æ°£ (ä¿æŒéœæ…‹ï¼Œå› ç‚ºå¤©æ°£æŸ¥è©¢å¯èƒ½éœ€è¦é¡å¤–çš„ API key)
        window.renderOverviewWeather = function() {
            // é€™å€‹å‡½å¼ä¿æŒéœæ…‹æ¸²æŸ“ï¼Œå¯ä»¥è®“ç”¨æˆ¶è‡ªè¡Œå¡«å……æ¯æ—¥å¤©æ°£
        }
        
        // æ¸²æŸ“æ¯æ—¥å¤©æ°£ (ç›®å‰ç‚ºç©ºï¼Œå¯è‡ªè¡Œå¯¦ä½œ)
        window.renderWeather = function() {
            const weatherContent = document.getElementById('weather-content');
            weatherContent.innerHTML = '<p class="text-center text-gray-500 mt-8">æ¯æ—¥è©³ç´°å¤©æ°£åŠŸèƒ½å¾…å¯¦ä½œ (éœ€ä¸²æ¥ç¬¬ä¸‰æ–¹å¤©æ°£ API)ã€‚</p>';
        }

        // ä¸»è¦å°èˆªå‡½å¼
        window.switchMainNav = function(targetId) {
            // éš±è—æ‰€æœ‰å…§å®¹å€
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
            document.querySelectorAll('.main-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // é¡¯ç¤ºç›®æ¨™å…§å®¹å€
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                targetContent.classList.remove('hidden');
                
                // ç‰¹æ®Šè™•ç†ï¼šç•¶åˆ‡æ›åˆ°ç‰¹å®šé ç±¤æ™‚å‘¼å«æ¸²æŸ“å‡½å¼
                if (targetId === 'expense-tab') {
                    // ç¢ºä¿ Expense Tab å§‹çµ‚é¡¯ç¤ºæ˜ç´°
                    window.switchExpenseView('details'); 
                } else if (targetId === 'wishlist-tab') {
                    window.renderWishlist();
                } else if (targetId === 'packing-tab') { // â­ï¸ æ–°å¢ï¼šè™•ç†æ‰“åŒ…æ¸…å–®æ¸²æŸ“
                    window.renderPackingList();
                }
            }

            // è¨­ç½®ç›®æ¨™æŒ‰éˆ•çš„ active ç‹€æ…‹
            const targetButton = document.querySelector(`.main-nav-btn[data-target="${targetId}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // é è¨­é¸æ“‡ç¬¬ä¸€å€‹ tab
            window.switchMainNav('itinerary-tab');
            // åˆå§‹åŒ–è¨˜å¸³é¸æ“‡å™¨
            window.selectCurrency(ACTIVE_CURRENCY);
            window.selectPayer(ACTIVE_PAYER);
            window.selectCategory(ACTIVE_CATEGORY);
            window.selectPayment(ACTIVE_PAYMENT);

            // åˆå§‹åŒ–æ•¸æ“šåŒæ­¥
            startDataSync();
        });

    </script>
</head>
<body class="bg-gray-50 font-sans">

    <div class="max-w-xl mx-auto bg-white min-h-screen shadow-lg">

        <header class="p-4 bg-white border-b sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fa-solid fa-plane-departure text-custom-primary mr-2"></i> ç¦å²¡ç†Šæœ¬è¡Œç¨‹åŠ©æ‰‹
                </h1>
                <div class="text-sm text-gray-600">
                    åŒ¯ç‡ (1 JPY = TWD): <span id="exchange-rate-display" class="font-bold text-custom-secondary">0.2150</span>
                </div>
            </div>
        </header>

        <nav id="main-nav" class="flex justify-around border-b text-sm sticky top-[72px] bg-white z-10">
            <button class="main-nav-btn active" data-target="itinerary-tab" onclick="window.switchMainNav('itinerary-tab')">
                <i class="fa-solid fa-route mr-2"></i> è¡Œç¨‹
            </button>
            <button class="main-nav-btn" data-target="expense-tab" onclick="window.switchMainNav('expense-tab')">
                <i class="fa-solid fa-receipt mr-2"></i> è¨˜å¸³
            </button>
            <button class="main-nav-btn" data-target="wishlist-tab" onclick="window.switchMainNav('wishlist-tab')">
                <i class="fa-solid fa-cart-shopping mr-2"></i> æ…¾æœ›æ¸…å–®
            </button>
            <button class="main-nav-btn" data-target="packing-tab" onclick="window.switchMainNav('packing-tab')">
                <i class="fa-solid fa-suitcase-rolling mr-2"></i> æ‰“åŒ…è¡Œæ
            </button>
            <button class="main-nav-btn" data-target="weather-tab" onclick="window.switchMainNav('weather-tab')">
                <i class="fa-solid fa-cloud-sun mr-2"></i> å¤©æ°£
            </button>
            <button class="main-nav-btn" data-target="overview-tab" onclick="window.switchMainNav('overview-tab')">
                <i class="fa-solid fa-chart-pie mr-2"></i> ç¸½è¦½
            </button>
        </nav>

        <main id="app-content" class="pb-20">

            <div id="itinerary-tab" class="main-tab-content">
                <div id="date-buttons-container" class="flex p-4 overflow-x-auto whitespace-nowrap border-b bg-gray-50">
                    </div>
                <div id="itinerary-container">
                    </div>

                <button onclick="window.openModal('addItineraryModal')" class="fixed right-4 bottom-4 w-12 h-12 rounded-full bg-custom-primary text-white shadow-lg flex items-center justify-center text-xl hover:bg-custom-primary-dark z-20">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div id="expense-tab" class="main-tab-content hidden p-4">
                <div class="flex mb-4 p-1 bg-gray-100 rounded-lg">
                    <button id="tab-add-expense-btn" class="flex-1 py-2 rounded-lg text-sm bg-white text-gray-700 hover:bg-gray-100" onclick="window.switchExpenseView('add')">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> ç´€éŒ„æ”¯å‡º
                    </button>
                    <button id="tab-view-details-btn" class="flex-1 py-2 rounded-lg text-sm active-expense-tab-btn bg-custom-primary text-white" onclick="window.switchExpenseView('details')">
                        <i class="fa-solid fa-list-ul mr-1"></i> æ”¯å‡ºæ˜ç´°
                    </button>
                </div>

                <div id="add-expense-container" class="hidden">
                    <form onsubmit="event.preventDefault(); window.addExpense();">
                        <label for="expense-date" class="text-sm font-semibold text-gray-700 block mb-1">æ—¥æœŸ:</label>
                        <input type="date" id="expense-date" value="2024-05-18" class="w-full p-2 border rounded-lg mb-3 text-sm" required>

                        <label for="expense-amount" class="text-sm font-semibold text-gray-700 block mb-1">é‡‘é¡:</label>
                        <div class="flex mb-3">
                            <input type="number" step="0.01" id="expense-amount" placeholder="è¼¸å…¥é‡‘é¡" class="flex-1 p-2 border rounded-lg text-sm" required>
                            <div id="expense-currency-select" class="flex ml-2">
                                <button type="button" class="block-select-btn px-2 py-1 text-sm active-currency" data-currency="TWD" onclick="window.selectCurrency('TWD')">TWD</button>
                                <button type="button" class="block-select-btn px-2 py-1 text-sm" data-currency="JPY" onclick="window.selectCurrency('JPY')">JPY</button>
                            </div>
                            <input type="hidden" id="expense-currency" value="TWD">
                        </div>

                        <label for="expense-description" class="text-sm font-semibold text-gray-700 block mb-1">ç”¨é€”/èªªæ˜:</label>
                        <input type="text" id="expense-description" placeholder="è¼¸å…¥ç”¨é€” (å¦‚: åˆé¤/ä¼´æ‰‹ç¦®)" class="w-full p-2 border rounded-lg mb-3 text-sm" required>

                        <label class="text-sm font-semibold text-gray-700 block mb-1">ä»˜æ¬¾äºº:</label>
                        <div id="expense-payer-select" class="flex mb-3">
                            <button type="button" class="block-select-btn" data-payer="Josh" onclick="window.selectPayer('Josh')">Josh</button>
                            <button type="button" class="block-select-btn" data-payer="Candice" onclick="window.selectPayer('Candice')">Candice</button>
                            <input type="hidden" id="expense-payer" value="Josh">
                        </div>
                        
                        <label class="text-sm font-semibold text-gray-700 block mb-1">é¡åˆ¥:</label>
                        <div id="expense-category-select" class="flex flex-wrap mb-3">
                            <button type="button" class="block-select-btn" data-category="Food" onclick="window.selectCategory('Food')">é¤é£²</button>
                            <button type="button" class="block-select-btn" data-category="Transport" onclick="window.selectCategory('Transport')">äº¤é€š</button>
                            <button type="button" class="block-select-btn" data-category="Accommodation" onclick="window.selectCategory('Accommodation')">ä½å®¿</button>
                            <button type="button" class="block-select-btn" data-category="Shopping" onclick="window.selectCategory('Shopping')">è³¼ç‰©</button>
                            <button type="button" class="block-select-btn" data-category="Ticket" onclick="window.selectCategory('Ticket')">é–€ç¥¨</button>
                            <button type="button" class="block-select-btn" data-category="Other" onclick="window.selectCategory('Other')">å…¶ä»–</button>
                            <input type="hidden" id="expense-category" value="Food">
                        </div>

                        <label class="text-sm font-semibold text-gray-700 block mb-1">æ”¯ä»˜æ–¹å¼:</label>
                        <div id="expense-payment-select" class="flex mb-4">
                            <button type="button" class="block-select-btn" data-payment="Cash" onclick="window.selectPayment('Cash')">ç¾é‡‘</button>
                            <button type="button" class="block-select-btn" data-payment="Card" onclick="window.selectPayment('Card')">ä¿¡ç”¨å¡</button>
                            <input type="hidden" id="expense-payment" value="Cash">
                        </div>

                        <button type="submit" class="w-full bg-custom-secondary text-white p-3 rounded-lg font-bold hover:bg-opacity-90 transition">
                            <i class="fa-solid fa-receipt mr-1"></i> ç¢ºèªç´€éŒ„
                        </button>
                    </form>
                </div>

                <div id="expense-details-container" class="">
                    <div class="bg-blue-50 p-4 rounded-xl mb-4 border border-blue-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                            <i class="fa-solid fa-calculator mr-2 text-custom-primary"></i> çµç®—èˆ‡é ç®—æ‘˜è¦
                        </h3>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="p-2 bg-white rounded-lg shadow-sm border">
                                <p class="text-gray-500">é ç®—ç¸½é¡ (TWD)</p>
                                <p class="font-bold text-gray-800">$ <span id="total-budget">50,000</span></p>
                            </div>
                            <div class="p-2 bg-white rounded-lg shadow-sm border">
                                <p class="text-gray-500">å·²èŠ±ç¸½é¡ (TWD)</p>
                                <p class="font-bold text-red-600">$ <span id="total-spent">0</span></p>
                            </div>
                            <div class="p-2 bg-white rounded-lg shadow-sm border">
                                <p class="text-gray-500">Josh æ”¯ä»˜ (TWD)</p>
                                <p class="font-bold text-gray-800">$ <span id="josh-paid">0</span></p>
                            </div>
                            <div class="p-2 bg-white rounded-lg shadow-sm border">
                                <p class="text-gray-500">Candice æ”¯ä»˜ (TWD)</p>
                                <p class="font-bold text-gray-800">$ <span id="candice-paid">0</span></p>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-blue-100 text-center">
                            <p class="text-gray-500 text-sm mb-1">æ‡‰ä»˜çµç®—çµæœ (TWD)</p>
                            <p id="settlement-result" class="text-xl font-extrabold"></p>
                        </div>
                    </div>

                    <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fa-solid fa-list-check mr-2 text-custom-primary"></i> æ”¯å‡ºæ˜ç´°æ¸…å–®
                    </h3>
                    
                    <div id="category-filter-buttons" class="flex flex-wrap mb-4 border-b pb-2">
                        </div>
                    
                    <div id="expense-list">
                        </div>
                </div>
            </div>

            <div id="wishlist-tab" class="main-tab-content hidden p-4">
                <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fa-solid fa-list-ol mr-2 text-custom-primary"></i> æ–°å¢å¾…è³¼é …ç›®
                </h3>
                
                <form id="wishlist-form" onsubmit="window.addWishlistItem(event)" class="bg-gray-100 p-3 rounded-lg mb-6 border">
                    <label for="wishlist-name" class="text-sm font-semibold text-gray-700 block mb-1">é …ç›®åç¨±:</label>
                    <input type="text" id="wishlist-name" placeholder="å¦‚: ç†Šæœ¬ç†Šé¤…ä¹¾" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                    
                    <label for="wishlist-price" class="text-sm font-semibold text-gray-700 block mb-1">é è¨ˆåƒ¹æ ¼ (JPY):</label>
                    <input type="number" step="1" id="wishlist-price" placeholder="è¼¸å…¥æ—¥å¹£é‡‘é¡" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                    
                    <label for="wishlist-category" class="text-sm font-semibold text-gray-700 block mb-1">åˆ†é¡:</label>
                    <select id="wishlist-category" class="w-full p-2 border rounded-lg mb-4 text-sm">
                        <option value="ä¼´æ‰‹ç¦®">ä¼´æ‰‹ç¦®</option>
                        <option value="é›»å™¨">é›»å™¨</option>
                        <option value="æœé£¾">æœé£¾</option>
                        <option value="è—¥å¦">è—¥å¦</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>

                    <button type="submit" class="w-full bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-custom-primary-dark transition">
                        <i class="fa-solid fa-cart-arrow-down mr-1"></i> åŠ å…¥æ¸…å–®
                    </button>
                </form>

                <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center border-t pt-4">
                    <i class="fa-solid fa-tags mr-2 text-custom-primary"></i> æˆ‘çš„æ…¾æœ›æ¸…å–®
                </h3>
                <div id="wishlist-list">
                    </div>
            </div>
            
            <div id="packing-tab" class="main-tab-content hidden p-4">
                <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fa-solid fa-plus-circle mr-2 text-custom-primary"></i> æ–°å¢æ‰“åŒ…é …ç›®
                </h3>
                
                <form id="packing-form" onsubmit="window.addPackingItem(event)" class="bg-gray-100 p-3 rounded-lg mb-6 border">
                    <label for="packing-name" class="text-sm font-semibold text-gray-700 block mb-1">é …ç›®åç¨±:</label>
                    <input type="text" id="packing-name" placeholder="å¦‚: è­·ç…§/å……é›»ç·š/å¤–å¥—" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                    
                    <label for="packing-category" class="text-sm font-semibold text-gray-700 block mb-1">åˆ†é¡:</label>
                    <select id="packing-category" class="w-full p-2 border rounded-lg mb-4 text-sm">
                        <option value="è­‰ä»¶">è­‰ä»¶</option>
                        <option value="è¡£ç‰©">è¡£ç‰©</option>
                        <option value="é›»å­ç”¨å“">é›»å­ç”¨å“</option>
                        <option value="è—¥å“">è—¥å“</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>

                    <button type="submit" class="w-full bg-custom-secondary text-white p-2 rounded-lg font-bold hover:bg-opacity-90 transition">
                        <i class="fa-solid fa-box-open mr-1"></i> åŠ å…¥æ‰“åŒ…æ¸…å–®
                    </button>
                </form>

                <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center border-t pt-4">
                    <i class="fa-solid fa-list-ul mr-2 text-custom-primary"></i> è¡Œææ¸…å–®
                </h3>
                <div id="packing-list-container">
                    </div>
            </div>

            <div id="weather-tab" class="main-tab-content hidden p-4">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-sun-cloud mr-2 text-custom-primary"></i> æ¯æ—¥å¤©æ°£
                </h2>
                <div id="weather-content">
                    </div>
            </div>

            <div id="overview-tab" class="main-tab-content hidden p-4">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-chart-line mr-2 text-custom-primary"></i> æ—…ç¨‹ç¸½è¦½
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-yellow-100 rounded-lg shadow-md">
                        <p class="text-sm text-yellow-800 font-semibold">æ—…éŠæ—¥æœŸ</p>
                        <p class="text-2xl font-bold text-yellow-900">7 å¤© 6 å¤œ</p>
                    </div>
                    <div class="p-4 bg-green-100 rounded-lg shadow-md">
                        <p class="text-sm text-green-800 font-semibold">ç¸½é ç®—</p>
                        <p class="text-2xl font-bold text-green-900">$50,000 TWD</p>
                    </div>
                </div>
                </div>

        </main>

        <div id="addItineraryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4" onclick="window.closeModal('addItineraryModal')">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4 flex justify-between items-center">
                    æ–°å¢è¡Œç¨‹é …ç›®
                    <button onclick="window.closeModal('addItineraryModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <form id="add-itinerary-form" onsubmit="window.addItineraryItem(event)">
                    <label for="new-date" class="text-sm font-semibold text-gray-700 mb-1 block">æ—¥æœŸ:</label>
                    <select id="new-date" class="w-full p-2 border rounded-lg mb-3 text-sm" required>
                        </select>

                    <label for="new-time" class="text-sm font-semibold text-gray-700 mb-1 block">æ™‚é–“:</label>
                    <div class="flex items-center mb-3">
                        <input type="time" id="new-time" placeholder="--:--" pattern="[0-2][0-9]:[0-5][0-9]" class="flex-1 p-2 border rounded-lg text-sm mr-2" required>
                        <i class="fa-solid fa-clock text-gray-500"></i>
                    </div>

                    <label for="new-title" class="text-sm font-semibold text-gray-700 mb-1 block">è¡Œç¨‹æ¨™é¡Œ:</label>
                    <input type="text" id="new-title" placeholder="è¡Œç¨‹æ¨™é¡Œ (å¦‚: æ™šé¤)" class="w-full p-2 border rounded-lg mb-3 text-sm" required>

                    <label for="new-note" class="text-sm font-semibold text-gray-700 mb-1 block">åœ°é»/å‚™è¨»:</label>
                    <textarea id="new-note" rows="2" placeholder="åœ°é»æˆ–å‚™è¨» (å¦‚: ä¸€è˜­æ‹‰éºµ/é£¯åº— check in)" class="w-full p-2 border rounded-lg mb-4 text-sm"></textarea>

                    <button type="submit" class="w-full bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-custom-primary-dark">
                        <i class="fa-solid fa-plus-circle mr-1"></i> æ–°å¢è¡Œç¨‹
                    </button>
                </form>
            </div>
        </div>

        <div id="editItineraryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4" onclick="window.closeModal('editItineraryModal')">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4 flex justify-between items-center">
                    ç·¨è¼¯è¡Œç¨‹é …ç›®
                    <button onclick="window.closeModal('editItineraryModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <p id="edit-modal-date-info" class="text-sm text-gray-500 mb-3 border-b pb-2"></p>
                <form id="edit-itinerary-form" onsubmit="window.saveItineraryItem(event)">
                    <input type="hidden" id="edit-date-key">
                    <input type="hidden" id="edit-item-index">

                    <label for="edit-time" class="text-sm font-semibold text-gray-700 mb-1 block">æ™‚é–“:</label>
                    <div class="flex items-center mb-3">
                        <input type="time" id="edit-time" placeholder="--:--" pattern="[0-2][0-9]:[0-5][0-9]" class="flex-1 p-2 border rounded-lg text-sm mr-2" required>
                        <i class="fa-solid fa-clock text-gray-500"></i>
                    </div>

                    <label for="edit-title" class="text-sm font-semibold text-gray-700 mb-1 block">è¡Œç¨‹æ¨™é¡Œ:</label>
                    <input type="text" id="edit-title" placeholder="è¡Œç¨‹æ¨™é¡Œ (å¦‚: æ™šé¤)" class="w-full p-2 border rounded-lg mb-3 text-sm" required>

                    <label for="edit-note" class="text-sm font-semibold text-gray-700 mb-1 block">å‚™è¨»/åœ°é»:</label>
                    <textarea id="edit-note" rows="2" placeholder="å‚™è¨» (å¦‚: é˜¿è˜‡èµ¤ç‰›ä¸¼/é£¯åº—)" class="w-full p-2 border rounded-lg mb-4 text-sm"></textarea>

                    <div class="flex space-x-2">
                        <button type="button" onclick="window.deleteItineraryItem(document.getElementById('edit-date-key').value, parseInt(document.getElementById('edit-item-index').value))" class="flex-1 bg-red-500 text-white p-2 rounded-lg font-bold hover:bg-red-600">
                            <i class="fa-solid fa-trash-can mr-1"></i> åˆªé™¤
                        </button>
                        <button type="submit" class="flex-1 bg-custom-primary text-white p-2 rounded-lg font-bold hover:bg-custom-primary-dark">
                            <i class="fa-solid fa-floppy-disk mr-1"></i> å„²å­˜ä¿®æ”¹
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="editExpenseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4" onclick="window.closeModal('editExpenseModal')">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4 flex justify-between items-center text-custom-primary">
                    <i class="fa-solid fa-pen-to-square mr-2"></i> ç·¨è¼¯æ”¯å‡ºç´€éŒ„
                    <button onclick="window.closeModal('editExpenseModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </h3>
                <form onsubmit="window.saveExpenseUpdate(event)">
                    <input type="hidden" id="edit-expense-id">
                    
                    <label for="edit-expense-date" class="text-sm font-semibold text-gray-700 block mb-1">æ—¥æœŸ:</label>
                    <input type="date" id="edit-expense-date" class="w-full p-2 border rounded-lg mb-3 text-sm" required>

                    <label for="edit-expense-amount" class="text-sm font-semibold text-gray-700 block mb-1">é‡‘é¡:</label>
                    <div class="flex mb-3">
                        <input type="number" step="0.01" id="edit-expense-amount" placeholder="è¼¸å…¥é‡‘é¡" class="flex-1 p-2 border rounded-lg text-sm" required>
                        <div id="edit-expense-currency-select" class="flex ml-2">
                            <button type="button" class="block-select-btn px-2 py-1 text-sm" data-currency="TWD" onclick="window.selectCurrency('TWD', 'edit-expense')">TWD</button>
                            <button type="button" class="block-select-btn px-2 py-1 text-sm" data-currency="JPY" onclick="window.selectCurrency('JPY', 'edit-expense')">JPY</button>
                        </div>
                        <input type="hidden" id="edit-expense-currency" value="TWD">
                    </div>

                    <label for="edit-expense-description" class="text-sm font-semibold text-gray-700 block mb-1">ç”¨é€”/èªªæ˜:</label>
                    <input type="text" id="edit-expense-description" placeholder="è¼¸å…¥ç”¨é€”" class="w-full p-2 border rounded-lg mb-3 text-sm" required>

                    <label class="text-sm font-semibold text-gray-700 block mb-1">ä»˜æ¬¾äºº:</label>
                    <div id="edit-expense-payer-select" class="flex mb-3">
                        <button type="button" class="block-select-btn" data-payer="Josh" onclick="window.selectPayer('Josh', 'edit-expense')">Josh</button>
                        <button type="button" class="block-select-btn" data-payer="Candice" onclick="window.selectPayer('Candice', 'edit-expense')">Candice</button>
                        <input type="hidden" id="edit-expense-payer" value="Josh">
                    </div>
                    
                    <label class="text-sm font-semibold text-gray-700 block mb-1">é¡åˆ¥:</label>
                    <div id="edit-expense-category-select" class="flex flex-wrap mb-3">
                        <button type="button" class="block-select-btn" data-category="Food" onclick="window.selectCategory('Food', 'edit-expense')">é¤é£²</button>
                        <button type="button" class="block-select-btn" data-category="Transport" onclick="window.selectCategory('Transport', 'edit-expense')">äº¤é€š</button>
                        <button type="button" class="block-select-btn" data-category="Accommodation" onclick="window.selectCategory('Accommodation', 'edit-expense')">ä½å®¿</button>
                        <button type="button" class="block-select-btn" data-category="Shopping" onclick="window.selectCategory('Shopping', 'edit-expense')">è³¼ç‰©</button>
                        <button type="button" class="block-select-btn" data-category="Ticket" onclick="window.selectCategory('Ticket', 'edit-expense')">é–€ç¥¨</button>
                        <button type="button" class="block-select-btn" data-category="Other" onclick="window.selectCategory('Other', 'edit-expense')">å…¶ä»–</button>
                        <input type="hidden" id="edit-expense-category" value="Food">
                    </div>

                    <label class="text-sm font-semibold text-gray-700 block mb-1">æ”¯ä»˜æ–¹å¼:</label>
                    <div id="edit-expense-payment-select" class="flex mb-4">
                        <button type="button" class="block-select-btn" data-payment="Cash" onclick="window.selectPayment('Cash', 'edit-expense')">ç¾é‡‘</button>
                        <button type="button" class="block-select-btn" data-payment="Card" onclick="window.selectPayment('Card', 'edit-expense')">ä¿¡ç”¨å¡</button>
                        <input type="hidden" id="edit-expense-payment" value="Cash">
                    </div>

                    <button type="submit" class="w-full bg-custom-primary text-white p-3 rounded-lg font-bold hover:bg-custom-primary-dark transition">
                        <i class="fa-solid fa-floppy-disk mr-1"></i> å„²å­˜ä¿®æ”¹
                    </button>
                </form>
            </div>
        </div>

    </div>

</body>
</html>