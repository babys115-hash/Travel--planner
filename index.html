<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Travel</title>
    <link rel="icon" type="image/png" href="./luggage.png">
    <link rel="apple-touch-icon" href="./luggage.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss" >
        :root {
            --custom-primary: #FF8BA7; /* Sweet Pink */
            --custom-secondary: #4ECDC4; /* Lively Mint */
            --custom-danger: #FF6B6B; /* Soft Coral */
            --custom-bg: #FFFDF9; /* Creamy White */
            --custom-text: #595959; /* Softer Dark Gray */
        }
        body { font-family: 'Zen Maru Gothic', sans-serif !important; color: var(--custom-text); background-color: var(--custom-bg); }
        .bg-gray-50 { background-color: var(--custom-bg) !important; } .bg-white { background-color: #ffffff; }
        .bg-custom-primary { background-color: var(--custom-primary); } .text-custom-primary { color: var(--custom-primary); }
        .bg-custom-secondary { background-color: var(--custom-secondary); } .text-custom-secondary { color: var(--custom-secondary); }
        .border-custom-primary { border-color: var(--custom-primary); }
        .rounded-lg { border-radius: 16px !important; } .rounded-xl { border-radius: 20px !important; }
        
        .tab-button {
            padding: 8px 16px; margin-right: 8px; border-radius: 20px; cursor: pointer; text-align: center;
            transition: all 0.3s; min-width: 80px; font-size: 0.9rem; border: 2px solid #F0F0F0; color: #7D7D7D; background: white; font-weight: bold;
        }
        .tab-button.active { background-color: var(--custom-primary); color: white; border-color: var(--custom-primary); transform: scale(1.05); box-shadow: 0 4px 10px rgba(255, 139, 167, 0.4); }
        
        .main-nav-btn { @apply flex-1 py-4 text-center transition duration-200 text-gray-500 border-b-4 border-transparent; }
        .main-nav-btn i { font-size: 1.2rem; margin-bottom: 2px; display: inline-block; }
        .main-nav-btn.active { color: var(--custom-primary); border-color: var(--custom-primary); font-weight: 800; }
        
        .block-select-btn {
            @apply px-4 py-1 border-2 rounded-full text-sm font-bold transition-all duration-200 mr-2 mb-2 bg-white flex-shrink-0;
            border-color: #D1D5DB !important; color: #6B7280; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center;
        }
        .block-select-btn:hover:not([class*="active-"]) { border-color: #FF748D; background-color: #FFF1F2; color: #FF748D; }
        
        .active-filter, .active-currency, .active-payer, .active-category, .active-payment, .active-split-type {
            background-color: #FF7596!important; border-color: #FF748D !important; color: white !important; @apply shadow-md; transform: scale(1.05);
        }
        
        .active-beneficiary {
            background-color: #4ECDC4 !important; border-color: #4ECDC4 !important; color: white !important; @apply shadow-sm;
        }

        .timeline-container { position: relative; }
        .timeline-container::before {
            content: ''; position: absolute; top: 30px; bottom: 30px; left: 28.5%; width: 2px;
            background-image: linear-gradient(to bottom, #FFE5EA 50%, transparent 50%); background-size: 2px 10px; z-index: 0;
        }
        .timeline-item { padding-left: 1.5rem; min-height: 20px; cursor: pointer; }
        .timeline-dot { box-shadow: 0 0 0 3px #FFF0F3; }
        
        .wishlist-status-btn { @apply px-3 py-1 rounded-full text-xs font-bold shadow-sm min-w-[60px]; }
        .wishlist-status-btn.purchased { @apply bg-custom-secondary text-white; }
        .wishlist-status-btn.pending { @apply bg-orange-100 text-orange-600; }
        .wishlist-status-btn.skipped { @apply bg-gray-200 text-gray-500; }
        
        input, select, textarea { border: 2px solid #F3F4F6 !important; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--custom-primary) !important; outline: none; box-shadow: 0 0 0 3px rgba(255, 139, 167, 0.1); }

        /* Lightbox 樣式 */
        #imagePreviewModal { transition: opacity 0.3s ease; }
        #imagePreviewModal img { max-height: 90vh; max-width: 95vw; object-fit: contain; }
    </style>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBRjYjvwvCNTRHdI8vH8n3GPabzSnSDbvI",
        authDomain: "jp-b0e03.firebaseapp.com",
        projectId: "jp-b0e03",
        storageBucket: "jp-b0e03.firebasestorage.app", 
        messagingSenderId: "689610031212",
        appId: "1:689610031212:web:f63f2efe61d4ad562bd849",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // 全域變數
    window.ITINERARY_DATA = [];
    window.EXPENSES_DATA = [];
    window.WISHLIST_DATA = [];
    window.PACKING_DATA = [];
    window.SPOTS_DATA = [];
    window.TRIP_PARTICIPANTS = ['Josh', 'Candice'];
    
    let ACTIVE_DATE = '', ACTIVE_CURRENCY = 'TWD', ACTIVE_PAYER = 'Josh', ACTIVE_CATEGORY = 'Food', ACTIVE_PAYMENT = 'Cash', EXPENSE_FILTER = 'All', WISHLIST_FILTER = 'All', EXCHANGE_RATE_JPY_TWD = 0.215;
    let PAYMENT_FILTER = 'All';
    let PAYER_FILTER = 'All';

    // ★★★ 新增：分帳模式變數 ★★★
    let ACTIVE_SPLIT_TYPE = 'shared'; // 'shared' or 'personal'
    let ACTIVE_BENEFICIARIES = []; // 誰受益

    // --- 基礎工具 ---
    window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).style.display = 'flex'; };
    window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).style.display = 'none'; };
    window.editExpense = (id) => window.openEditExpenseModal(id);

    // ★★★ 圖片預覽 Lightbox (修復版) ★★★
    window.openImagePreview = (url) => {
        if (!url) return;
        const modal = document.getElementById('imagePreviewModal');
        const img = document.getElementById('preview-full-image');
        if(modal && img) {
            img.src = url;
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }
    };
    
    window.closeImagePreview = () => {
        const modal = document.getElementById('imagePreviewModal');
        if(modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
            document.getElementById('preview-full-image').src = '';
        }
    };

    // --- 圖片預覽 (通用) ---
    window.previewImageGeneric = (input, imgId, containerId) => {
        if (input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => { 
                const img = document.getElementById(imgId);
                const container = document.getElementById(containerId);
                if(img && container) {
                    img.src = e.target.result; 
                    container.classList.remove('hidden'); 
                    img.onclick = () => window.openImagePreview(e.target.result);
                }
            };
            r.readAsDataURL(input.files[0]);
        }
    };

    window.previewImage = (input) => window.previewImageGeneric(input, 'photo-preview', 'photo-preview-container');
    window.previewItemImage = (input) => window.previewImageGeneric(input, 'item-photo-preview', 'item-photo-preview-container');
    window.previewExpenseImage = (input) => window.previewImageGeneric(input, 'expense-photo-preview', 'expense-photo-preview-container');
    window.previewEditExpenseImage = (input) => window.previewImageGeneric(input, 'edit-expense-photo-preview', 'edit-expense-photo-preview-container');
    window.previewEditWishlistImage = (input) => window.previewImageGeneric(input, 'edit-wishlist-preview', 'edit-wishlist-preview-container');
    window.previewEditImage = (input) => window.previewImageGeneric(input, 'edit-photo-preview', 'edit-photo-preview-container');

    window.clearPhotoGeneric = (inputId, containerId) => { document.getElementById(inputId).value = ""; document.getElementById(containerId).classList.add('hidden'); };
    window.clearPhoto = () => window.clearPhotoGeneric('spot-camera-input', 'photo-preview-container');
    window.clearItemPhoto = () => window.clearPhotoGeneric('item-camera-input', 'item-photo-preview-container');
    window.clearExpensePhoto = () => window.clearPhotoGeneric('expense-camera-input', 'expense-photo-preview-container');

    window.removeEditExpensePhoto = () => { document.getElementById('edit-expense-old-image').value = ''; document.getElementById('edit-expense-file').value = ''; document.getElementById('edit-expense-photo-preview-container').classList.add('hidden'); };
    window.removeEditSpotPhoto = () => { document.getElementById('edit-spot-old-image').value = ''; document.getElementById('edit-spot-file').value = ''; document.getElementById('edit-photo-preview').parentElement.classList.add('hidden'); };
    window.removeEditWishlistPhoto = () => { document.getElementById('edit-wishlist-old-image').value = ''; document.getElementById('edit-wishlist-file').value = ''; document.getElementById('edit-wishlist-preview-container').classList.add('hidden'); };

    /* =========================
       數據監聽 (資料同步中心)
    ========================= */
    function startDataSync() {
        updateLiveExchangeRate();
        onSnapshot(query(collection(db, "itineraries"), orderBy("date", "asc")), (snap) => {
            window.ITINERARY_DATA = snap.docs.map(d => ({id: d.id, ...d.data(), activities: d.data().activities?.sort((a,b)=>a.time.localeCompare(b.time))||[]}));
            if(window.ITINERARY_DATA.length > 0 && !ACTIVE_DATE) ACTIVE_DATE = window.ITINERARY_DATA[0].id;
            window.generateDateTabs(); window.renderItinerary(); window.populateItineraryModalDates();
            const durationEl = document.getElementById('overview-duration-display'); if(durationEl) durationEl.innerText = window.ITINERARY_DATA.length;
        });
        
        onSnapshot(query(collection(db, "expenses"), orderBy("date", "desc")), (snap) => { 
            window.EXPENSES_DATA = snap.docs.map(d => ({id: d.id, ...d.data()})); 
            window.renderExpenseTracking(); 
        });

        onSnapshot(doc(db, "trips", "currentTrip"), (doc) => { 
            if(doc.exists()) { 
                const data = doc.data();
                window.TOTAL_BUDGET = data.totalBudget || 0; 
                document.getElementById('total-budget').innerText = window.TOTAL_BUDGET.toLocaleString(); 
                document.getElementById('overview-budget-display').innerText = window.TOTAL_BUDGET.toLocaleString(); 
                
                if(data.participants && Array.isArray(data.participants)) {
                    window.TRIP_PARTICIPANTS = data.participants;
                }
                window.renderParticipantsUI(); 
                window.renderExpensePayerButtons(); 
                window.renderBeneficiaryButtons(); // ★★★ 初始化分帳人頭 ★★★
                window.renderExpenseTracking();
            }
        });

        onSnapshot(query(collection(db, "wishlists")), (snap) => { window.WISHLIST_DATA = snap.docs.map(d => ({id: d.id, ...d.data()})); if(!document.getElementById('wishlist-tab').classList.contains('hidden')) window.renderWishlist(); });
        onSnapshot(collection(db, "packinglist"), (snap) => { let data = snap.docs.map(d => ({ id: d.id, ...d.data() })); data.sort((a, b) => { if (a.packed !== b.packed) return a.packed ? 1 : -1; const t1 = a.createdAt?.seconds || 0; const t2 = b.createdAt?.seconds || 0; return t1 - t2; }); window.PACKING_DATA = data; window.renderPackingList(); });
        onSnapshot(collection(db, "spots"), (snap) => { let data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); window.SPOTS_DATA = data; window.renderSpots(); });
    }

    async function updateLiveExchangeRate() {
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/JPY');
            const data = await res.json();
            if(data.result === 'success') {
                EXCHANGE_RATE_JPY_TWD = data.rates.TWD;
                document.getElementById('exchange-rate-display').textContent = EXCHANGE_RATE_JPY_TWD.toFixed(4);
                const calcRate = document.getElementById('calc-rate-display');
                if(calcRate) calcRate.innerText = EXCHANGE_RATE_JPY_TWD.toFixed(4);
                if(window.calculateTwd) window.calculateTwd();
                if(window.updateSettlementSummary) window.updateSettlementSummary();
            }
        } catch(e) { console.error('匯率失敗', e); }
    }
    
    window.calculateTwd = () => {
        const jpyInput = document.getElementById('calc-jpy');
        const twdOutput = document.getElementById('calc-twd');
        if(!jpyInput || !twdOutput) return;
        const jpy = parseFloat(jpyInput.value);
        if(isNaN(jpy)) { twdOutput.innerText = '0'; return; }
        const twd = Math.round(jpy * EXCHANGE_RATE_JPY_TWD);
        twdOutput.innerText = twd.toLocaleString(); 
    };

    /* =========================
       頁面渲染與邏輯
    ========================= */
    window.switchExpenseView = function(v) {
        document.getElementById('add-expense-container').classList.toggle('hidden', v!=='add');
        document.getElementById('expense-details-container').classList.toggle('hidden', v!=='details');
        document.getElementById('tab-add-expense-btn').className = v==='add' ? 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-custom-primary text-white shadow-md' : 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-gray-500';
        document.getElementById('tab-view-details-btn').className = v==='details' ? 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-custom-primary text-white shadow-md' : 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-gray-500';
        if(v==='details') window.renderExpenseTracking();
        // ★★★ 重置分帳表單 ★★★
        if(v==='add') {
             window.selectSplitType('shared');
             ACTIVE_BENEFICIARIES = [...window.TRIP_PARTICIPANTS]; // 預設全選
             window.renderBeneficiaryButtons();
        }
    };
    window.selectCurrency = (v) => { ACTIVE_CURRENCY=v; updateSelectUI('expense-currency', v); document.getElementById('expense-currency').value=v; };
    window.selectPayer = (v) => { ACTIVE_PAYER=v; updateSelectUI('expense-payer', v); document.getElementById('expense-payer').value=v; };
    window.selectCategory = (v) => { ACTIVE_CATEGORY=v; updateSelectUI('expense-category', v); document.getElementById('expense-category').value=v; };
    window.selectPayment = (v) => { ACTIVE_PAYMENT=v; updateSelectUI('expense-payment', v); document.getElementById('expense-payment').value=v; };
    
    window.selectEditCurrency = (v) => { updateSelectUI('edit-expense-currency', v); document.getElementById('edit-expense-currency').value=v; };
    window.selectEditPayer = (v) => { updateSelectUI('edit-expense-payer', v); document.getElementById('edit-expense-payer').value=v; };
    window.selectEditCategory = (v) => { updateSelectUI('edit-expense-category', v); document.getElementById('edit-expense-category').value=v; };
    window.selectEditPayment = (v) => { updateSelectUI('edit-expense-payment', v); document.getElementById('edit-expense-payment').value=v; };

    function updateSelectUI(id, val) {
        const c = document.getElementById(id+'-select');
        if(c) c.querySelectorAll('.block-select-btn').forEach(b => {
             const key = b.getAttribute('data-currency') || b.getAttribute('data-payer') || b.getAttribute('data-category') || b.getAttribute('data-payment');
             if(key===val) b.classList.add('active-filter'); else b.classList.remove('active-filter');
        });
    }

    // ★★★ 新增：分帳模式選擇邏輯 ★★★
    window.selectSplitType = (type) => {
        ACTIVE_SPLIT_TYPE = type;
        const container = document.getElementById('expense-split-type-select');
        if(container) {
             container.querySelectorAll('button').forEach(b => {
                 if(b.dataset.type === type) b.classList.add('active-split-type');
                 else b.classList.remove('active-split-type');
             });
        }
        
        // 切換模式時的行為
        if (type === 'shared') {
            ACTIVE_BENEFICIARIES = [...window.TRIP_PARTICIPANTS]; // 共同預設全選
        } else {
            ACTIVE_BENEFICIARIES = []; // 個人預設全空 (讓使用者點選)
        }
        window.renderBeneficiaryButtons();
    };

    window.toggleBeneficiary = (name) => {
        if (ACTIVE_SPLIT_TYPE === 'shared') {
            // 共同模式：多選 toggle
            if (ACTIVE_BENEFICIARIES.includes(name)) {
                ACTIVE_BENEFICIARIES = ACTIVE_BENEFICIARIES.filter(n => n !== name);
            } else {
                ACTIVE_BENEFICIARIES.push(name);
            }
        } else {
            // 個人模式：單選
            ACTIVE_BENEFICIARIES = [name];
        }
        window.renderBeneficiaryButtons();
    };

    window.renderBeneficiaryButtons = () => {
        // 渲染新增介面
        const container = document.getElementById('expense-beneficiaries-container');
        if(container) {
             container.innerHTML = window.TRIP_PARTICIPANTS.map(p => {
                 const isActive = ACTIVE_BENEFICIARIES.includes(p);
                 return `<button type="button" onclick="window.toggleBeneficiary('${p}')" 
                     class="px-3 py-1.5 rounded-full text-sm font-bold border-2 border-gray-100 mr-2 mb-2 transition-all ${isActive ? 'active-beneficiary' : 'bg-white text-gray-400'}">
                     ${isActive ? '<i class="fa-solid fa-check mr-1"></i>' : ''}${p}
                 </button>`;
             }).join('');
        }
        
        // 渲染編輯介面 (如果開啟中)
        // 編輯介面的邏輯會稍微不同，稍後在 openEditExpenseModal 處理
    };

    // ★★★ 編輯模式的分帳邏輯 ★★★
    let EDIT_SPLIT_TYPE = 'shared';
    let EDIT_BENEFICIARIES = [];

    window.selectEditSplitType = (type) => {
        EDIT_SPLIT_TYPE = type;
        const container = document.getElementById('edit-expense-split-type-select');
        if(container) {
             container.querySelectorAll('button').forEach(b => {
                 if(b.dataset.type === type) b.classList.add('active-split-type');
                 else b.classList.remove('active-split-type');
             });
        }
        // 切換模式時不主動清空，除非使用者去點人頭，保持原本的資料顯示
        window.renderEditBeneficiaryButtons();
    };

    window.toggleEditBeneficiary = (name) => {
        if (EDIT_SPLIT_TYPE === 'shared') {
            if (EDIT_BENEFICIARIES.includes(name)) {
                EDIT_BENEFICIARIES = EDIT_BENEFICIARIES.filter(n => n !== name);
            } else {
                EDIT_BENEFICIARIES.push(name);
            }
        } else {
            EDIT_BENEFICIARIES = [name];
        }
        window.renderEditBeneficiaryButtons();
    };

    window.renderEditBeneficiaryButtons = () => {
        const container = document.getElementById('edit-expense-beneficiaries-container');
        if(container) {
             container.innerHTML = window.TRIP_PARTICIPANTS.map(p => {
                 const isActive = EDIT_BENEFICIARIES.includes(p);
                 return `<button type="button" onclick="window.toggleEditBeneficiary('${p}')" 
                     class="px-3 py-1.5 rounded-full text-sm font-bold border-2 border-gray-100 mr-2 mb-2 transition-all ${isActive ? 'active-beneficiary' : 'bg-white text-gray-400'}">
                     ${isActive ? '<i class="fa-solid fa-check mr-1"></i>' : ''}${p}
                 </button>`;
             }).join('');
        }
    };

    window.renderExpensePayerButtons = () => {
        const generateButtons = (containerId, hiddenInputId, onClickFunc) => {
            const container = document.getElementById(containerId);
            const hiddenInput = document.getElementById(hiddenInputId);
            if(!container || !hiddenInput) return;
            
            const currentVal = hiddenInput.value;
            if(!window.TRIP_PARTICIPANTS.includes(currentVal) && window.TRIP_PARTICIPANTS.length > 0) {
                 hiddenInput.value = window.TRIP_PARTICIPANTS[0];
                 if(containerId === 'expense-payer-select') ACTIVE_PAYER = window.TRIP_PARTICIPANTS[0];
            }

            container.innerHTML = window.TRIP_PARTICIPANTS.map(p => 
                `<button type="button" class="flex-1 block-select-btn ${hiddenInput.value === p ? 'active-filter' : ''}" 
                  data-payer="${p}" onclick="window.${onClickFunc}('${p}')">${p}</button>`
            ).join('');
        };

        generateButtons('expense-payer-select', 'expense-payer', 'selectPayer');
        generateButtons('edit-expense-payer-select', 'edit-expense-payer', 'selectEditPayer');
    };

    window.addExpense = async function() {
        const date = document.getElementById('expense-date').value;
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const desc = document.getElementById('expense-description').value;
        const currency = document.getElementById('expense-currency').value;
        const fileIn = document.getElementById('expense-camera-input');
        const btn = document.getElementById('add-expense-btn');

        if(!date || !amount || !desc) return alert('請填寫完整');
        if(ACTIVE_BENEFICIARIES.length === 0) return alert('請至少選擇一位分帳對象');

        btn.innerText = '儲存中...'; btn.disabled = true;

        try {
            let imgUrl = '';
            if(fileIn.files[0]) {
                const sRef = ref(storage, `expenses/${Date.now()}_${fileIn.files[0].name}`);
                const snap = await uploadBytes(sRef, fileIn.files[0]);
                imgUrl = await getDownloadURL(snap.ref);
            }
            await addDoc(collection(db, "expenses"), { 
                date, amount, description: desc, currency: currency, 
                payer: ACTIVE_PAYER, category: ACTIVE_CATEGORY, payment: ACTIVE_PAYMENT, 
                splitType: ACTIVE_SPLIT_TYPE, beneficiaries: ACTIVE_BENEFICIARIES, // ★★★ 儲存分帳資訊 ★★★
                imageUrl: imgUrl, timestamp: serverTimestamp() 
            });
            alert('記帳成功'); document.getElementById('expense-amount').value = ''; document.getElementById('expense-description').value = ''; window.clearExpensePhoto();
            // 重置分帳選單
            window.selectSplitType('shared');
        } catch(err) { console.error(err); alert('儲存失敗'); } finally { btn.innerText = '確認紀錄'; btn.disabled = false; }
    };
    
    window.openEditExpenseModal = function(id) {
        const e = window.EXPENSES_DATA.find(x => x.id === id); if(!e) return;
        document.getElementById('edit-expense-id').value = id;
        document.getElementById('edit-expense-date').value = e.date;
        document.getElementById('edit-expense-amount').value = e.amount;
        document.getElementById('edit-expense-description').value = e.description;
        document.getElementById('edit-expense-old-image').value = e.imageUrl || '';
        document.getElementById('edit-expense-file').value = "";
        
        const img = document.getElementById('edit-expense-photo-preview');
        const container = document.getElementById('edit-expense-photo-preview-container');
        if(e.imageUrl) { 
            img.src = e.imageUrl; 
            container.classList.remove('hidden'); 
            img.onclick = () => window.openImagePreview(e.imageUrl); 
        } else { 
            container.classList.add('hidden'); 
        }

        window.selectEditCurrency(e.currency); 
        window.renderExpensePayerButtons();
        window.selectEditPayer(e.payer); 
        window.selectEditCategory(e.category); 
        window.selectEditPayment(e.payment || 'Cash');

        // ★★★ 設定編輯模式的分帳狀態 ★★★
        EDIT_SPLIT_TYPE = e.splitType || 'shared';
        EDIT_BENEFICIARIES = e.beneficiaries || [...window.TRIP_PARTICIPANTS]; // 相容舊資料
        window.selectEditSplitType(EDIT_SPLIT_TYPE);
        window.renderEditBeneficiaryButtons();

        window.openModal('editExpenseModal');
    };
    window.saveExpenseUpdate = async function(evt) {
        evt.preventDefault();
        const id = document.getElementById('edit-expense-id').value;
        const file = document.getElementById('edit-expense-file').files[0];
        const btn = document.getElementById('save-expense-btn');

        if(EDIT_BENEFICIARIES.length === 0) return alert('請至少選擇一位分帳對象');

        btn.innerText = '更新中...'; btn.disabled = true;

        try {
            let url = document.getElementById('edit-expense-old-image').value;
            if(file) {
                const sRef = ref(storage, `expenses/updated_${Date.now()}_${file.name}`);
                const snap = await uploadBytes(sRef, file);
                url = await getDownloadURL(snap.ref);
            }
            await updateDoc(doc(db, "expenses", id), {
                 date: document.getElementById('edit-expense-date').value, amount: parseFloat(document.getElementById('edit-expense-amount').value),
                 description: document.getElementById('edit-expense-description').value, currency: document.getElementById('edit-expense-currency').value,
                 payer: document.getElementById('edit-expense-payer').value, category: document.getElementById('edit-expense-category').value,
                 payment: document.getElementById('edit-expense-payment').value, 
                 splitType: EDIT_SPLIT_TYPE, beneficiaries: EDIT_BENEFICIARIES, // ★★★ 更新分帳資訊 ★★★
                 imageUrl: url
            });
            window.closeModal('editExpenseModal');
        } catch(err) { alert('更新失敗'); } finally { btn.innerText = '儲存修改'; btn.disabled = false; }
    };
    window.deleteExpense = async function(id) { if(confirm('刪除?')) await deleteDoc(doc(db, "expenses", id)); };

    window.filterExpenses = function(cat) { EXPENSE_FILTER=cat; window.renderExpenseTracking(); };
    window.filterExpensePayment = function(pay) { 
        if(PAYMENT_FILTER === pay) PAYMENT_FILTER = 'All'; else PAYMENT_FILTER = pay;
        window.renderExpenseTracking(); 
    };
    window.filterExpensePayer = function(payer) {
        if(PAYER_FILTER === payer) PAYER_FILTER = 'All'; else PAYER_FILTER = payer;
        window.renderExpenseTracking();
    };

    window.renderExpenseTracking = function() {
        const list = document.getElementById('expense-list');
        const catFilterContainer = document.getElementById('category-filter-buttons');
        const payerSummaryContainer = document.getElementById('payer-summary-container');
        if(!list) return;

        // --- 1. 動態生成付款人統計卡片 ---
        if(payerSummaryContainer) {
            let payerTotals = {};
            window.TRIP_PARTICIPANTS.forEach(p => payerTotals[p] = 0);
            
            window.EXPENSES_DATA.forEach(e => {
                const v = e.currency==='JPY' ? e.amount*EXCHANGE_RATE_JPY_TWD : e.amount;
                if(payerTotals[e.payer] !== undefined) {
                    payerTotals[e.payer] += v;
                } else {
                    if(!payerTotals['Other']) payerTotals['Other'] = 0;
                    payerTotals['Other'] += v;
                }
            });

            const colors = ['blue', 'pink', 'yellow', 'indigo', 'orange'];
            let cardsHtml = window.TRIP_PARTICIPANTS.map((p, idx) => {
                const color = colors[idx % colors.length];
                const isActive = PAYER_FILTER === p;
                const activeClass = isActive ? `bg-${color}-100 border-${color}-300 transform scale-105 shadow-md` : `bg-white border-${color}-100 hover:bg-${color}-50`;
                
                return `
                <div onclick="window.filterExpensePayer('${p}')" class="p-3 shadow-sm rounded-2xl border-2 cursor-pointer transition relative group ${activeClass}">
                    <p class="mb-1 text-sm font-bold text-${color}-400 flex justify-between items-center">${p} 付 <i class="fa-solid fa-filter opacity-0 group-hover:opacity-50 text-xs ${isActive?'opacity-100':''}"></i></p>
                    <p class="text-2xl font-bold text-gray-700">$ <span id="payer-total-${p}">${Math.round(payerTotals[p]).toLocaleString()}</span></p>
                </div>`;
            }).join('');
            
            payerSummaryContainer.innerHTML = cardsHtml;
        }

        // --- 2. 篩選與列表渲染 ---
        const cats = ['All', ...new Set(window.EXPENSES_DATA.map(e=>e.category))];
        catFilterContainer.innerHTML = cats.map(c => `<button onclick="window.filterExpenses('${c}')" class="block-select-btn px-3 py-1 text-xs rounded-full ${EXPENSE_FILTER===c?'active-filter':''}">${c==='All'?'全部':c}</button>`).join('');
        
        const data = window.EXPENSES_DATA.filter(e => {
            const catMatch = EXPENSE_FILTER === 'All' || e.category === EXPENSE_FILTER;
            const payerMatch = PAYER_FILTER === 'All' || e.payer === PAYER_FILTER;
            let payMatch = true;
            const payment = e.payment || 'Cash';
            if (PAYMENT_FILTER === 'Cash') payMatch = (payment === 'Cash');
            else if (PAYMENT_FILTER === 'NonCash') payMatch = (payment !== 'Cash');
            return catMatch && payMatch && payerMatch;
        });

        const categoryNameMap = {
            Food: '餐飲', Transport: '交通', Accommodation: '住宿',
            Shopping: '購物', Ticket: '門票', Other: '其他', Purchasing: '代購'
        };

        list.innerHTML = data.map(e => {
            const twd = e.currency==='JPY' ? Math.round(e.amount*EXCHANGE_RATE_JPY_TWD) : e.amount;
            const iconMap = { Food: 'fa-utensils', Transport: 'fa-train', Accommodation: 'fa-bed', Shopping: 'fa-bag-shopping', Ticket: 'fa-ticket', Other: 'fa-shapes', Purchasing: 'fa-cart-plus' };
            const imageHtml = e.imageUrl ? `<img src="${e.imageUrl}" class="w-12 h-12 object-cover rounded-lg mr-3 border border-gray-200 cursor-pointer" onclick="event.stopPropagation(); window.openImagePreview(this.src)">` : `<div class="w-12 h-12 rounded-full bg-pink-100 flex items-center justify-center mr-3 text-custom-primary"><i class="fa-solid ${iconMap[e.category]||'fa-circle'}"></i></div>`;
            const catName = categoryNameMap[e.category] || e.category;

            // ★★★ 新增：顯示分帳類型 ★★★
            let splitIcon = '';
            if (e.splitType === 'personal') {
                const ben = e.beneficiaries ? e.beneficiaries[0] : '?';
                splitIcon = `<span class="ml-1 text-[10px] bg-yellow-100 text-yellow-600 px-1.5 py-0.5 rounded"><i class="fa-solid fa-user"></i> ${ben}</span>`;
            } else {
                splitIcon = `<span class="ml-1 text-[10px] bg-blue-100 text-blue-500 px-1.5 py-0.5 rounded"><i class="fa-solid fa-users"></i> 共同</span>`;
            }

            return `<div class="p-4 mb-3 bg-white rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center transition cursor-pointer hover:shadow-md" onclick="window.editExpense('${e.id}')">
                <div class="flex items-center">${imageHtml}<div><div class="flex items-center"><p class="font-bold text-gray-700 mr-1">${e.description}</p>${splitIcon}</div>
                <p class="text-xs text-gray-400">${e.date} · ${e.payer} 付 · <span class="text-custom-secondary">${catName}</span></p></div></div>
                <div class="text-right flex items-center gap-2"><div class="text-right"><p class="font-bold text-custom-danger">${e.currency} ${e.amount.toLocaleString()}</p><p class="text-[10px] text-gray-400">約 TWD $${twd.toLocaleString()}</p></div><button onclick="event.stopPropagation(); window.deleteExpense('${e.id}')" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button></div>
            </div>`;
        }).join('');
        window.updateSettlementSummary();
    };
    
    // ★★★ 智慧結算邏輯升級 ★★★
    window.updateSettlementSummary = function() {
        let total = 0;
        let cashTotal = 0, otherTotal = 0;
        
        // 1. 計算總支出與付款方式統計
        window.EXPENSES_DATA.forEach(e => {
            const v = e.currency==='JPY' ? e.amount*EXCHANGE_RATE_JPY_TWD : e.amount;
            total += v;
            if(e.payment === 'Cash') cashTotal += v; else otherTotal += v;
        });
        document.getElementById('total-spent').innerText = Math.round(total).toLocaleString();
        
        const cashEl = document.getElementById('cash-paid'), cardEl = document.getElementById('card-paid');
        if(cashEl) cashEl.innerText = Math.round(cashTotal).toLocaleString();
        if(cardEl) cardEl.innerText = Math.round(otherTotal).toLocaleString();
        
        // 2. 計算每個人「實際支付」與「應付金額」
        let balanceSheet = {}; // { Josh: { paid: 0, shouldPay: 0 }, Candice: ... }
        window.TRIP_PARTICIPANTS.forEach(p => balanceSheet[p] = { paid: 0, shouldPay: 0 });

        window.EXPENSES_DATA.forEach(e => {
            const val = e.currency==='JPY' ? e.amount*EXCHANGE_RATE_JPY_TWD : e.amount;
            const payer = e.payer;
            
            // 記錄實際支付
            if (!balanceSheet[payer]) balanceSheet[payer] = { paid: 0, shouldPay: 0 };
            balanceSheet[payer].paid += val;

            // 計算誰該付這筆錢
            const beneficiaries = e.beneficiaries && e.beneficiaries.length > 0 ? e.beneficiaries : window.TRIP_PARTICIPANTS; // 相容舊資料
            const splitAmount = val / beneficiaries.length;

            beneficiaries.forEach(ben => {
                if (!balanceSheet[ben]) balanceSheet[ben] = { paid: 0, shouldPay: 0 };
                balanceSheet[ben].shouldPay += splitAmount;
            });
        });

        // 3. 顯示結算建議 (顯示最大債權/債務關係)
        const resEl = document.getElementById('settlement-result');
        let debtors = [];
        let creditors = [];

        Object.keys(balanceSheet).forEach(p => {
            const net = balanceSheet[p].paid - balanceSheet[p].shouldPay;
            if (net < -1) debtors.push({ name: p, amount: Math.abs(net) }); // 欠錢的人
            else if (net > 1) creditors.push({ name: p, amount: net }); // 被欠錢的人
        });

        // 簡單顯示邏輯：列出誰該付錢
        if (debtors.length === 0) {
            resEl.innerText = '目前已結清 / 無需分帳';
            resEl.className = "text-lg font-bold text-gray-400";
        } else {
            // 找出欠最多的人
            debtors.sort((a,b) => b.amount - a.amount);
            const debtor = debtors[0];
            resEl.innerText = `${debtor.name} 需再付出 $${Math.round(debtor.amount).toLocaleString()}`;
            resEl.className = "text-lg font-bold text-custom-primary";
        }
    };
    
    window.enableBudgetEdit = () => { document.getElementById('budget-display').classList.add('hidden'); document.getElementById('budget-edit-form').classList.remove('hidden'); document.getElementById('budget-input').focus(); };
    window.cancelBudgetEdit = () => { document.getElementById('budget-display').classList.remove('hidden'); document.getElementById('budget-edit-form').classList.add('hidden'); };
    window.saveBudget = async () => {
        const v = parseFloat(document.getElementById('budget-input').value);
        if(isNaN(v)) return;
        await updateDoc(doc(db, "trips", "currentTrip"), {totalBudget: v});
        window.cancelBudgetEdit();
    };

    window.addParticipant = async () => {
        const input = document.getElementById('new-participant-name');
        const name = input.value.trim();
        if(!name) return;
        if(window.TRIP_PARTICIPANTS.includes(name)) return alert('名字已存在');
        
        const newList = [...window.TRIP_PARTICIPANTS, name];
        await updateDoc(doc(db, "trips", "currentTrip"), { participants: newList });
        input.value = '';
    };

    window.removeParticipant = async (name) => {
        if(!confirm(`確定要移除 ${name} 嗎？\n(注意：之前的記帳紀錄若使用此名字不會被刪除，但會歸類為其他)`)) return;
        const newList = window.TRIP_PARTICIPANTS.filter(p => p !== name);
        await updateDoc(doc(db, "trips", "currentTrip"), { participants: newList });
    };

    window.renderParticipantsUI = () => {
        const list = document.getElementById('participants-list');
        if(!list) return;
        if(window.TRIP_PARTICIPANTS.length === 0) {
            list.innerHTML = '<span class="text-sm text-gray-400">尚無名單，請新增。</span>';
            return;
        }
        list.innerHTML = window.TRIP_PARTICIPANTS.map(p => `
            <div class="inline-flex items-center bg-gray-100 rounded-full px-3 py-1 mr-2 mb-2 border border-gray-200">
                <span class="text-sm font-bold text-gray-700 mr-2">${p}</span>
                <button onclick="window.removeParticipant('${p}')" class="text-gray-400 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
        `).join('');
    };

    // --- 慾望清單邏輯 (含數量) ---
    window.addWishlistItem = async function(e) {
        e.preventDefault();
        const name = document.getElementById('wishlist-name').value;
        const price = parseFloat(document.getElementById('wishlist-price').value);
        const cat = document.getElementById('wishlist-category').value;
        const qty = parseInt(document.getElementById('wishlist-quantity').value) || 1;
        const fileIn = document.getElementById('item-camera-input');
        const btn = document.getElementById('add-wishlist-btn');

        if(!name || !price) return;
        btn.innerText = '上傳中...'; btn.disabled = true;

        try {
            let imgUrl = '';
            if(fileIn.files[0]) {
                const sRef = ref(storage, `wishlist/${Date.now()}_${fileIn.files[0].name}`);
                const snap = await uploadBytes(sRef, fileIn.files[0]);
                imgUrl = await getDownloadURL(snap.ref);
            }

            await addDoc(collection(db, "wishlists"), {
                name, price, category: cat, quantity: qty,
                imageUrl: imgUrl, 
                purchased: false,
                status: 'pending', // ★★★ 預設狀態 ★★★
                timestamp: serverTimestamp()
            });

            document.getElementById('wishlist-form').reset();
            window.clearItemPhoto();

        } catch(err) {
            console.error(err);
            alert('儲存失敗');
        } finally {
            btn.innerText = '新增清單項目';
            btn.disabled = false;
        }
    };
    
    // ★★★ 新增：狀態切換邏輯 (三段式：想買 -> 已買 -> 沒買到) ★★★
    window.cycleWishlistStatus = async function(id, currentStatus) {
        let nextStatus = 'pending';
        let isPurchased = false;

        // 邏輯：Pending(想買) -> Bought(已買) -> Skipped(沒買到) -> Pending
        if (currentStatus === 'pending') {
            nextStatus = 'bought';
            isPurchased = true;
        } else if (currentStatus === 'bought') {
            nextStatus = 'skipped';
            isPurchased = false; 
        } else {
            nextStatus = 'pending';
            isPurchased = false;
        }

        await updateDoc(doc(db, "wishlists", id), {
            status: nextStatus,
            purchased: isPurchased
        });
    };

    window.deleteWishlistItem = async function(id) { if(confirm('刪除?')) await deleteDoc(doc(db, "wishlists", id)); };
    
    window.filterWishlist = function(cat) {
        WISHLIST_FILTER = cat;
        window.renderWishlist();
    };

    window.renderWishlist = function() {
        const listContainer = document.getElementById('wishlist-list'), filterContainer = document.getElementById('wishlist-filter-buttons');
        if(!listContainer) return;
        const searchText = document.getElementById('wishlist-search')?.value.toLowerCase() || '';
        const cleanText = (text) => (text || '').replace(/['"]/g, '').trim();
        const defaultCats = ['伴手禮', '電器', '3C', '服飾', '藥妝', '其他'];
        const existingCats = window.WISHLIST_DATA.map(i => cleanText(i.category));
        const allCats = ['All', ...new Set([...defaultCats, ...existingCats])].filter(c => c);
        if(filterContainer) { filterContainer.innerHTML = allCats.map(c => `<button onclick="window.filterWishlist('${c}')" class="block-select-btn px-3 py-1 text-xs rounded-full ${c === WISHLIST_FILTER ? 'active-filter' : ''}">${c === 'All' ? '全部' : c}</button>`).join(''); }
        const filteredData = window.WISHLIST_DATA.filter(i => {
            const catMatch = WISHLIST_FILTER === 'All' || cleanText(i.category) === WISHLIST_FILTER;
            const searchMatch = i.name.toLowerCase().includes(searchText);
            return catMatch && searchMatch;
        });
        listContainer.innerHTML = filteredData.map(i => {
            const qtyDisplay = (i.quantity && i.quantity > 1) ? `<span class="ml-2 text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">x${i.quantity}</span>` : '';
            
            // ★★★ 處理狀態顯示邏輯 ★★★
            let status = i.status;
            if(!status) status = i.purchased ? 'bought' : 'pending'; // 相容舊資料
            
            let statusText = '想買';
            let statusClass = 'pending';
            let rowClass = 'bg-white';

            if(status === 'bought') {
                statusText = '已買';
                statusClass = 'purchased';
                rowClass = 'bg-gray-100 opacity-60';
            } else if(status === 'skipped') {
                statusText = '沒買到';
                statusClass = 'skipped';
                rowClass = 'bg-gray-50 opacity-40 grayscale';
            }

            return `
            <div class="p-3 mb-2 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center ${rowClass}">
                <div><p class="font-bold text-gray-700">${i.name} ${qtyDisplay}</p><div class="flex items-center gap-2"><span class="text-[10px] text-white bg-gray-400 px-2 py-0.5 rounded-full">${cleanText(i.category)}</span>${i.imageUrl ? `<span onclick="window.openImagePreview('${i.imageUrl}')" class="text-[#4ECDC4] text-xs underline cursor-pointer hover:opacity-70"><i class="fa-solid fa-image"></i> 查看照片</span>` : ''}</div></div>
                <div class="text-right"><p class="font-bold text-custom-primary">¥${i.price.toLocaleString()}</p>
                <div class="flex justify-end gap-2 mt-1">
                    <button onclick="window.cycleWishlistStatus('${i.id}', '${status}')" class="wishlist-status-btn ${statusClass}">${statusText}</button>
                    <button onclick="window.openEditWishlistModal('${i.id}')" class="text-gray-300 hover:text-blue-400 px-1"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="window.deleteWishlistItem('${i.id}')" class="text-gray-300 hover:text-red-400 px-1"><i class="fa-solid fa-trash-can"></i></button>
                </div></div>
            </div>`;
        }).join('');
    };

    window.openEditWishlistModal = function(id) {
        const item = window.WISHLIST_DATA.find(i => i.id === id); if(!item) return;
        document.getElementById('edit-wishlist-id').value = id;
        document.getElementById('edit-wishlist-name').value = item.name;
        document.getElementById('edit-wishlist-price').value = item.price;
        document.getElementById('edit-wishlist-quantity').value = item.quantity || 1; 
        document.getElementById('edit-wishlist-category').value = (item.category || '').replace(/['"]/g, '').trim();
        document.getElementById('edit-wishlist-old-image').value = item.imageUrl || '';
        document.getElementById('edit-wishlist-file').value = ""; 
        const img = document.getElementById('edit-wishlist-preview'), container = document.getElementById('edit-wishlist-preview-container');
        if (item.imageUrl) { img.src = item.imageUrl; container.classList.remove('hidden'); img.onclick = () => window.openImagePreview(item.imageUrl); } else { container.classList.add('hidden'); }
        window.openModal('editWishlistModal');
    };

    window.saveWishlistUpdate = async function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-wishlist-id').value, file = document.getElementById('edit-wishlist-file').files[0], btn = document.getElementById('save-wishlist-btn');
        const qty = parseInt(document.getElementById('edit-wishlist-quantity').value) || 1;
        btn.innerText = '上傳中...'; btn.disabled = true;
        try {
            let url = document.getElementById('edit-wishlist-old-image').value;
            if(file) { const sRef = ref(storage, `wishlist/updated_${Date.now()}_${file.name}`); const snap = await uploadBytes(sRef, file); url = await getDownloadURL(snap.ref); }
            await updateDoc(doc(db, "wishlists", id), { name: document.getElementById('edit-wishlist-name').value, price: parseFloat(document.getElementById('edit-wishlist-price').value), category: document.getElementById('edit-wishlist-category').value, quantity: qty, imageUrl: url });
            window.closeModal('editWishlistModal');
        } catch(err) { alert('更新失敗'); } finally { btn.innerText = '儲存修改'; btn.disabled = false; }
    };

    window.renderPackingList = function() {
        const container = document.getElementById('packing-list-container'); if (!container) return;
        if (window.PACKING_DATA.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 py-10">行李清單是空的！</p>'; return; }
        container.innerHTML = window.PACKING_DATA.map(item => `
             <div class="p-3 rounded-xl shadow-sm border flex justify-between items-center mb-2 ${item.packed ? 'bg-gray-50' : 'bg-white'}">
                <div class="flex items-center cursor-pointer flex-1" onclick="window.togglePackingStatus('${item.id}', ${item.packed})">
                  <i class="fa-solid ${item.packed ? 'fa-check-circle text-teal-500' : 'fa-circle text-gray-300'} mr-3 text-lg"></i>
                  <div><p class="${item.packed ? 'line-through text-gray-400 italic' : 'text-gray-700 font-bold'}">${item.name}</p><p class="text-xs text-gray-400">${item.category}</p></div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="window.openEditPackingModal('${item.id}')" class="text-gray-300 hover:text-blue-400 p-2"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="window.deletePackingItem('${item.id}')" class="text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>
             </div>`).join('');
    };
    window.togglePackingStatus = async function(id, s) { await updateDoc(doc(db, "packinglist", id), { packed: !s }); };
    window.deletePackingItem = async function(id) { if(confirm('刪除?')) await deleteDoc(doc(db, "packinglist", id)); };
    window.openEditPackingModal = function(id) {
        const item = window.PACKING_DATA.find(i => i.id === id); if(!item) return;
        document.getElementById('edit-packing-id').value = id;
        document.getElementById('edit-packing-name').value = item.name;
        document.getElementById('edit-packing-category').value = item.category || '';
        window.openModal('editPackingModal');
    };
    window.savePackingUpdate = async function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-packing-id').value, name = document.getElementById('edit-packing-name').value.trim(), category = document.getElementById('edit-packing-category').value;
        const btn = document.getElementById('save-packing-btn'); if (!name) return;
        btn.innerText = '儲存中...'; btn.disabled = true;
        try { await updateDoc(doc(db, "packinglist", id), { name, category }); window.closeModal('editPackingModal'); } 
        catch(err) { alert('更新失敗'); } finally { btn.innerText = '儲存修改'; btn.disabled = false; }
    };

    window.addSpot = async function() {
        const name = document.getElementById('new-spot-name').value, desc = document.getElementById('new-spot-desc').value, link = document.getElementById('new-spot-link').value;
        if(!name) return alert('請輸入名稱');
        const btn = document.getElementById('add-spot-btn'), fileIn = document.getElementById('spot-camera-input');
        btn.innerText = '上傳中...'; btn.disabled = true;
        try {
            let imgUrl = '';
            if(fileIn.files[0]) {
                const sRef = ref(storage, `spots/${Date.now()}_${fileIn.files[0].name}`);
                const snap = await uploadBytes(sRef, fileIn.files[0]);
                imgUrl = await getDownloadURL(snap.ref);
            }
            await addDoc(collection(db, "spots"), { name, description: desc, link, imageUrl: imgUrl, createdAt: serverTimestamp() });
            document.getElementById('new-spot-name').value = ''; document.getElementById('new-spot-desc').value = ''; document.getElementById('new-spot-link').value = ''; window.clearPhoto();
        } catch(e) { alert('失敗'); } finally { btn.innerText = '新增景點'; btn.disabled = false; }
    };
    window.renderSpots = function() {
        const container = document.getElementById('spots-list'); if (!container) return;
        container.innerHTML = window.SPOTS_DATA.map(s => {
            const hasLink = s.link && s.link.trim() !== "";
            const clickAction = hasLink ? `onclick="window.open('${s.link}', '_blank')"` : '';
            const cursorClass = hasLink ? 'cursor-pointer hover:opacity-70' : '';
            const titleColor = hasLink ? 'text-custom-secondary underline decoration-2 underline-offset-4 decoration-pink-200' : 'text-gray-700';
            const iconColor = hasLink ? 'text-custom-secondary' : 'text-[#FF8BA7]';
            const imageHtml = s.imageUrl ? `<img src="${s.imageUrl}" class="w-full h-32 object-cover rounded-xl mb-3 border border-gray-100 cursor-pointer" onclick="event.stopPropagation(); window.openImagePreview('${s.imageUrl}')">` : '';
            return `
            <div class="bg-white p-4 rounded-2xl border border-gray-100 mb-4 shadow-sm relative transition hover:shadow-md">
                ${imageHtml}
                <div class="flex justify-between items-start">
                    <div class="flex-1 pr-2">
                        <div class="flex items-center mb-2 transition ${cursorClass}" ${clickAction}>
                            <i class="fa-solid fa-location-dot ${iconColor} text-lg mr-2"></i>
                            <h3 class="font-bold ${titleColor} text-lg tracking-wide">${s.name}</h3>
                            ${hasLink ? '<i class="fa-solid fa-arrow-up-right-from-square text-xs text-gray-300 ml-2"></i>' : ''}
                        </div>
                        ${s.description ? `<div class="bg-[#FFF8F0] p-2 rounded-lg text-sm text-gray-500 mb-2 leading-relaxed tracking-wide">${s.description}</div>` : ''}
                        ${hasLink ? `<a href="${s.link}" target="_blank" onclick="event.stopPropagation()" class="text-gray-400 text-xs flex items-center hover:text-custom-secondary mt-1"><i class="fa-solid fa-link mr-1"></i> 連結已設定 (點擊標題開啟)</a>` : ''}
                    </div>
                    <div class="flex flex-col gap-3 ml-2 pt-1">
                        <button onclick="window.deleteSpot('${s.id}')" class="text-gray-300 hover:text-red-400 transition transform hover:scale-110 p-2"><i class="fa-solid fa-trash-can text-sm"></i></button>
                        <button onclick="window.openEditSpotModal('${s.id}')" class="text-gray-300 hover:text-blue-400 transition transform hover:scale-110 p-2"><i class="fa-solid fa-pen text-sm"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
    };
    window.openEditSpotModal = function(id) {
        const spot = window.SPOTS_DATA.find(s => s.id === id); if(!spot) return;
        document.getElementById('edit-spot-id').value = spot.id; document.getElementById('edit-spot-name').value = spot.name; document.getElementById('edit-spot-desc').value = spot.description || '';
        document.getElementById('edit-spot-link').value = spot.link || ''; document.getElementById('edit-spot-old-image').value = spot.imageUrl || '';
        const img = document.getElementById('edit-photo-preview');
        if (spot.imageUrl) { img.src = spot.imageUrl; img.parentElement.classList.remove('hidden'); img.onclick = () => window.openImagePreview(spot.imageUrl); } else { img.parentElement.classList.add('hidden'); }
        window.openModal('editSpotModal');
    };
    window.saveSpotUpdate = async function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-spot-id').value, file = document.getElementById('edit-spot-file').files[0], btn = document.getElementById('save-spot-btn');
        btn.innerText = '上傳中...'; btn.disabled = true;
        try {
            let url = document.getElementById('edit-spot-old-image').value;
            if(file) { const sRef = ref(storage, `spots/updated_${Date.now()}_${file.name}`); const snap = await uploadBytes(sRef, file); url = await getDownloadURL(snap.ref); }
            await updateDoc(doc(db, "spots", id), { name: document.getElementById('edit-spot-name').value, description: document.getElementById('edit-spot-desc').value, link: document.getElementById('edit-spot-link').value, imageUrl: url });
            window.closeModal('editSpotModal');
        } catch(err) { alert('更新失敗'); } finally { btn.innerText = '儲存修改'; btn.disabled = false; }
    };
    window.deleteSpot = async (id) => { if(confirm('刪除?')) await deleteDoc(doc(db, "spots", id)); };

    // ★★★ 新增：生成行程日期邏輯 ★★★
    window.generateTripDates = async () => {
        const startStr = document.getElementById('trip-start-date').value;
        const days = parseInt(document.getElementById('trip-days').value);
        
        if(!startStr || !days || days <= 0) return alert('請選擇正確的出發日期與天數');

        if(!confirm(`即將建立從 ${startStr} 開始，共 ${days} 天的行程。\n(既有日期的行程內容會保留，但會更新星期幾)`)) return;

        const btn = document.getElementById('generate-trip-btn');
        btn.innerText = '生成中...'; 
        btn.disabled = true;

        try {
            // 使用 Date 物件處理日期計算
            const startParts = startStr.split('-');
            // 注意：月份在 JS Date 中是 0-11，所以要減 1
            const startDate = new Date(startParts[0], startParts[1] - 1, startParts[2]);
            const promises = [];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            for (let i = 0; i < days; i++) {
                // 計算每一天的日期
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                // 格式化成 YYYY-MM-DD (作為 Firebase ID)
                const yyyy = currentDate.getFullYear();
                const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
                const dd = String(currentDate.getDate()).padStart(2, '0');
                const dateId = `${yyyy}-${mm}-${dd}`;
                const dayOfWeek = dayNames[currentDate.getDay()];

                // 使用 setDoc + merge: true，這樣如果那天原本就有排行程，內容不會被洗掉
                const docRef = doc(db, "itineraries", dateId);
                promises.push(setDoc(docRef, {
                    date: dateId,
                    day_of_week: dayOfWeek,
                    // 如果該日期文件不存在，city 預設為 "待定"
                    // 如果存在，因為 merge: true，所以不會覆蓋既有的 city 或 activities
                }, { merge: true }));
            }

            await Promise.all(promises);
            alert('行程日期已更新！請切換到「行程」分頁查看。');
            window.switchMainNav('itinerary-tab'); // 自動跳轉回行程頁

        } catch (err) {
            console.error(err);
            alert('生成失敗，請檢查網路或權限');
        } finally {
            btn.innerText = '生成/更新行程表';
            btn.disabled = false;
        }
    };

    window.generateDateTabs = () => {
        const c = document.getElementById('date-buttons-container'); if(!c) return; c.innerHTML = '';
        window.ITINERARY_DATA.forEach((d, i) => {
            const btn = document.createElement('button'); btn.className = `tab-button ${d.id === ACTIVE_DATE ? 'active' : ''}`;
            btn.innerHTML = `<div class="font-bold">Day ${i+1}</div><div class="text-xs font-normal">${d.date.substring(5)} (${d.day_of_week})</div>`;
            btn.onclick = () => { ACTIVE_DATE = d.id; window.generateDateTabs(); window.renderItinerary(); };
            c.appendChild(btn);
        });
    };
    window.renderItinerary = () => {
        const c = document.getElementById('itinerary-container'); if(!c) return;
        const d = window.ITINERARY_DATA.find(x => x.id === ACTIVE_DATE);
        if(!d || !d.activities?.length) { c.innerHTML = `<div class="m-4 p-6 bg-white rounded-xl shadow-sm text-center border border-pink-100"><p class="text-gray-400">本日尚無行程</p></div>`; return; }
        c.innerHTML = `<div class="mx-4 mt-4 p-4 bg-white rounded-xl shadow-sm border border-pink-100 flex justify-between items-center"><h2 class="text-lg font-bold text-gray-700">${d.city}</h2><span class="bg-pink-50 text-custom-primary px-3 py-1 rounded-full text-sm font-bold">${d.date}</span></div><div class="timeline-container p-4">` + d.activities.map((a, i) => {
            const icon = a.title.includes('餐')?'fa-utensils':a.title.includes('宿')?'fa-bed':'fa-location-dot';
            const linkBtn = a.link ? `<a href="${a.link}" target="_blank" onclick="event.stopPropagation()" class="text-custom-secondary text-sm ml-2 hover:underline">(地圖 <i class="fa-solid fa-map-location-dot"></i>)</a>` : '';
            return `<div class="flex items-start mb-6 group" onclick="window.openEditModal('${d.id}', ${i})"><div class="w-1/4 text-sm font-bold text-gray-400 pt-1 text-center font-mono bg-gray-50 rounded-lg mr-3">${a.time}</div><div class="flex-1 bg-white p-3 rounded-xl shadow-sm border border-gray-100 relative z-10"><div class="timeline-item relative !pl-0"><span class="absolute -left-[2.1rem] top-2 h-4 w-4 rounded-full bg-custom-primary border-4 border-white timeline-dot z-20"></span><div class="font-bold text-gray-700 mb-1"><i class="fa-solid ${icon} text-custom-primary mr-2"></i>${a.title}${linkBtn}</div><div class="text-sm text-gray-500 ml-8">${a.location||''}</div></div></div></div>`;
        }).join('') + '</div>';
    };
    window.addItineraryItem = async (e) => {
        e.preventDefault();
        const dId = document.getElementById('new-date').value, act = { time: document.getElementById('new-time').value, title: document.getElementById('new-title').value, location: document.getElementById('new-note').value, link: document.getElementById('new-link').value, notes: '' };
        if(!dId||!act.time||!act.title) return;
        const d = window.ITINERARY_DATA.find(x=>x.id===dId);
        if(d) { await updateDoc(doc(db,'itineraries',dId), {activities: [...(d.activities||[]), act].sort((a,b)=>a.time.localeCompare(b.time))}); window.closeModal('addItineraryModal'); document.getElementById('add-itinerary-form').reset(); }
    };
    window.populateItineraryModalDates = () => { const s = document.getElementById('new-date'); if(!s) return; s.innerHTML = window.ITINERARY_DATA.map(d=>`<option value="${d.id}" ${d.id===ACTIVE_DATE?'selected':''}>${d.date.substring(5)} - ${d.city}</option>`).join(''); };
    window.openEditModal = (dId, idx) => {
        const d = window.ITINERARY_DATA.find(x=>x.id===dId); const act = d.activities[idx];
        document.getElementById('edit-modal-date-info').textContent = `${d.city} ${d.date}`;
        document.getElementById('edit-date-key').value = dId; document.getElementById('edit-item-index').value = idx;
        document.getElementById('edit-time').value = act.time; document.getElementById('edit-title').value = act.title; document.getElementById('edit-note').value = act.location||''; document.getElementById('edit-link').value = act.link||'';
        window.openModal('editItineraryModal');
    };
    window.saveItineraryItem = async (e) => {
        e.preventDefault();
        const dId = document.getElementById('edit-date-key').value, idx = document.getElementById('edit-item-index').value;
        const d = window.ITINERARY_DATA.find(x=>x.id===dId); const acts = [...d.activities];
        acts[idx] = { ...acts[idx], time: document.getElementById('edit-time').value, title: document.getElementById('edit-title').value, location: document.getElementById('edit-note').value, link: document.getElementById('edit-link').value };
        await updateDoc(doc(db,'itineraries',dId), {activities: acts.sort((a,b)=>a.time.localeCompare(b.time))}); window.closeModal('editItineraryModal');
    };
    window.deleteItineraryItem = async (dId, idx) => { if(!confirm('刪除?')) return; const d = window.ITINERARY_DATA.find(x=>x.id===dId); await updateDoc(doc(db,'itineraries',dId), {activities: d.activities.filter((_,i)=>i!==parseInt(idx))}); window.closeModal('editItineraryModal'); };

    window.switchMainNav = (tid) => {
        document.querySelectorAll('.main-tab-content').forEach(e => {
            e.classList.add('hidden');
            e.style.display = 'none'; // 確保加上 inline style 隱藏
        });
        document.querySelectorAll('.main-nav-btn').forEach(b => b.classList.remove('active'));
        const target = document.getElementById(tid);
        if(target) {
            target.classList.remove('hidden');
            target.style.display = ''; // ★關鍵：把 inline style 清空，讓它顯示出來
        }
        document.querySelector(`.main-nav-btn[data-target="${tid}"]`).classList.add('active');
        if(tid==='packing-tab') window.renderPackingList();
        if(tid==='wishlist-tab') window.renderWishlist();
        if(tid==='expense-tab') window.renderExpenseTracking();
        if(tid==='overview-tab') window.renderSpots();
    };

    document.addEventListener('DOMContentLoaded', () => { 
        // ★★★ 修改：預設開啟總覽頁面 (因為總覽移到了第一個) ★★★
        window.switchMainNav('overview-tab'); 
        window.scrollTo(0, 0);
        startDataSync(); 
        const now = new Date();
        const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        const dateInput = document.getElementById('expense-date');
        if(dateInput) dateInput.value = localDate;
    });
</script>
</head>
<body class="bg-gray-50 font-sans">

    <!-- ★★★ 新增：圖片預覽 Lightbox (預設隱藏) ★★★ -->
    <div id="imagePreviewModal" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-all" onclick="window.closeImagePreview()">
        <img id="preview-full-image" src="" class="max-w-full max-h-[85vh] rounded-2xl shadow-2xl transition-transform duration-300 scale-95 hover:scale-100 object-contain" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 focus:outline-none w-12 h-12 flex items-center justify-center rounded-full bg-white/10 backdrop-blur-md">&times;</button>
    </div>

    <div class="max-w-xl mx-auto bg-white min-h-screen shadow-2xl overflow-hidden rounded-none sm:rounded-3xl sm:my-8 border border-gray-100">

        <header class="p-4 bg-white border-b border-gray-100 sticky top-0 z-10 shadow-sm">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-700 flex items-center tracking-wide">
                    <i class="fa-solid fa-plane-departure text-custom-primary mr-2 transform -rotate-12"></i> 福岡熊本之旅
                </h1>
                <div class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-lg">
                    匯率: <span id="exchange-rate-display" class="font-bold text-custom-secondary text-base">0.2150</span>
                </div>
            </div>
        </header>

        <!-- ★★★ 修改：導覽列順序調整 (總覽移至最前) ★★★ -->
        <nav id="main-nav" class="flex justify-around border-b border-gray-100 text-sm sticky top-[72px] bg-white/95 backdrop-blur-sm z-10 shadow-sm">
            <button class="main-nav-btn active" data-target="overview-tab" onclick="window.switchMainNav('overview-tab')"><i class="fa-solid fa-star"></i><br>總覽</button>
            <button class="main-nav-btn" data-target="itinerary-tab" onclick="window.switchMainNav('itinerary-tab')"><i class="fa-solid fa-map-location-dot"></i><br>行程</button>
            <button class="main-nav-btn" data-target="expense-tab" onclick="window.switchMainNav('expense-tab')"><i class="fa-solid fa-wallet"></i><br>記帳</button>
            <button class="main-nav-btn" data-target="wishlist-tab" onclick="window.switchMainNav('wishlist-tab')"><i class="fa-solid fa-gift"></i><br>清單</button>
            <button class="main-nav-btn" data-target="packing-tab" onclick="window.switchMainNav('packing-tab')"><i class="fa-solid fa-suitcase"></i><br>打包</button>
        </nav>
        
        <!-- 行程天氣總覽區塊 -->
        <div class="bg-white p-2 rounded-3xl shadow-lg m-4 mb-2 border-2 border-pink-100">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa-solid fa-cloud-sun-rain text-custom-primary mr-2"></i> 行程天氣總覽 (tenki.jp)
            </h2>
            <div class="flex justify-around items-stretch mb-4 space-x-2 flex-wrap sm:flex-nowrap">
                <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm mb-3 sm:mb-0"><p class="text-sm font-semibold text-gray-700 mb-1">福岡 (26日)</p><i class="fa-solid fa-cloud-sun-rain text-3xl text-custom-primary mb-1"></i><p class="text-lg font-bold text-gray-800">8°C / 13°C</p><p class="text-xs text-red-500 mt-1">降雨率: 20%</p></div>
                <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm mb-3 sm:mb-0"><p class="text-sm font-semibold text-gray-700 mb-1">長崎 (27-28日)</p><i class="fa-solid fa-sun text-3xl text-orange-400 mb-1"></i> <p class="text-lg font-bold text-gray-800">5°C / 10°C</p><p class="text-xs text-gray-500 mt-1">降雨率: 0%</p></div>
                <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm"><p class="text-sm font-semibold text-gray-700 mb-1">熊本 (29-31日)</p><i class="fa-solid fa-cloud-showers-heavy text-3xl text-custom-secondary mb-1"></i><p class="text-lg font-bold text-gray-800">3°C / 9°C</p><p class="text-xs text-red-500 mt-1">降雨率: 40%</p></div>
            </div>
            <a href="https://www.tenki.jp/" target="_blank" class="w-full block text-center bg-gray-100 text-gray-700 p-3 rounded-2xl font-semibold hover:bg-gray-200 transition duration-200 text-sm"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> 點擊查看 tenki.jp 詳細預報</a>
        </div>

        <main id="app-content" class="pb-24 bg-[#FFFDF9]">

            <!-- 1. 行程 TAB -->
            <div id="itinerary-tab" class="main-tab-content hidden">
                <div id="date-buttons-container" class="flex p-4 overflow-x-auto whitespace-nowrap border-b border-gray-100 bg-white no-scrollbar"></div>
                <div id="itinerary-container"></div>
                <button onclick="window.openModal('addItineraryModal')" class="fixed right-6 bottom-6 w-14 h-14 rounded-full bg-custom-primary text-white shadow-xl flex items-center justify-center text-2xl hover:bg-custom-primary-dark z-20 transition transform hover:scale-110">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- 2. 記帳 TAB -->
            <div id="expense-tab" class="main-tab-content hidden p-4" style="display: none;">
                <div class="flex mb-4 p-1.5 bg-gray-100 rounded-2xl">
                    <button id="tab-add-expense-btn" class="flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-gray-500 shadow-sm transition-all" onclick="window.switchExpenseView('add')"><i class="fa-solid fa-pen mr-1"></i> 記一筆</button>
                    <button id="tab-view-details-btn" class="flex-1 py-2.5 rounded-xl text-sm font-bold text-gray-500 hover:bg-white/50 transition-all" onclick="window.switchExpenseView('details')"><i class="fa-solid fa-list mr-1"></i> 查明細</button>
                </div>
                <!-- 記帳表單 -->
                <div id="add-expense-container" class="hidden bg-white p-5 rounded-3xl shadow-sm border border-pink-100">
                    <form onsubmit="event.preventDefault(); window.addExpense();">
                        <label class="block mb-1 text-sm font-bold text-gray-500">日期</label>
                        <input type="date" id="expense-date" value="2024-05-18" class="w-full p-3 mb-4 font-bold border-0 bg-gray-50 rounded-xl" required>
                        <label class="block mb-1 text-sm font-bold text-gray-500">金額 & 幣別</label>
                        <div class="flex items-center gap-2 mb-4">
                            <input type="number" step="0.01" id="expense-amount" placeholder="0" class="flex-1 min-w-0 p-3 text-xl font-bold border-0 bg-gray-50 rounded-xl" required>
                            <div id="expense-currency-select" class="flex shrink-0">
                                <button type="button" class="block-select-btn active-filter !mr-1 !mb-0 px-4" data-currency="TWD" onclick="window.selectCurrency('TWD')">TWD</button>
                                <button type="button" class="block-select-btn !mr-0 !mb-0 px-4" data-currency="JPY" onclick="window.selectCurrency('JPY')">JPY</button>
                            </div>
                            <input type="hidden" id="expense-currency" value="TWD">
                        </div>
                        <label class="block mb-1 text-sm font-bold text-gray-500">用途</label>
                        <input type="text" id="expense-description" placeholder="例如: 一蘭拉麵" class="w-full p-3 mb-4 border-0 bg-gray-50 rounded-xl" required>
                        <label class="block mb-2 text-sm font-bold text-gray-500">誰付錢?</label>
                        
                        <!-- 動態生成付款人選項 -->
                        <div id="expense-payer-select" class="flex mb-4 gap-1 overflow-x-auto no-scrollbar">
                            <!-- JS will populate this -->
                        </div>
                        <input type="hidden" id="expense-payer" value="Josh">

                        <!-- ★★★ 新增：分帳模式與人頭選擇 ★★★ -->
                        <label class="block mb-2 text-sm font-bold text-gray-500">分帳方式 (誰該付這筆錢?)</label>
                        <div class="bg-gray-50 p-3 rounded-xl mb-4 border-2 border-dashed border-gray-200">
                            <div id="expense-split-type-select" class="flex gap-2 mb-3">
                                <button type="button" class="flex-1 py-1.5 px-3 rounded-lg text-sm font-bold bg-white border border-gray-200 active-split-type transition shadow-sm" data-type="shared" onclick="window.selectSplitType('shared')"><i class="fa-solid fa-users mr-1"></i> 共同分擔</button>
                                <button type="button" class="flex-1 py-1.5 px-3 rounded-lg text-sm font-bold bg-white border border-gray-200 transition shadow-sm" data-type="personal" onclick="window.selectSplitType('personal')"><i class="fa-solid fa-user mr-1"></i> 個人獨享</button>
                            </div>
                            <div id="expense-beneficiaries-container" class="flex flex-wrap">
                                <!-- JS will populate buttons here -->
                            </div>
                        </div>

                        <label class="block mb-2 text-sm font-bold text-gray-500">類別</label>
                        <div id="expense-category-select" class="grid grid-cols-3 gap-2 mb-4">
                            <button type="button" class="w-full block-select-btn active-filter !m-0" data-category="Food" onclick="window.selectCategory('Food')">餐飲</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Transport" onclick="window.selectCategory('Transport')">交通</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Accommodation" onclick="window.selectCategory('Accommodation')">住宿</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Shopping" onclick="window.selectCategory('Shopping')">購物</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Ticket" onclick="window.selectCategory('Ticket')">門票</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Other" onclick="window.selectCategory('Other')">其他</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Purchasing" onclick="window.selectCategory('Purchasing')">代購</button>
                            <input type="hidden" id="expense-category" value="Food">
                        </div>
                        <label class="block mb-2 text-sm font-bold text-gray-500">支付</label>
                        <div id="expense-payment-select" class="flex mb-6 gap-2">
                            <button type="button" class="flex-1 block-select-btn active-filter !m-0" data-payment="Cash" onclick="window.selectPayment('Cash')">現金</button>
                            <button type="button" class="flex-1 block-select-btn !m-0" data-payment="Card" onclick="window.selectPayment('Card')">信用卡</button>
                            <button type="button" class="flex-1 block-select-btn !m-0" data-payment="Paypay" onclick="window.selectPayment('Paypay')">Paypay</button>
                        </div>
                        <input type="hidden" id="expense-payment" value="Cash">
                        <input type="file" id="expense-camera-input" accept="image/*" class="hidden" onchange="window.previewExpenseImage(this)">
                        <button type="button" onclick="document.getElementById('expense-camera-input').click()" class="w-full p-2 mb-2 text-sm font-bold text-pink-500 bg-pink-50 rounded-xl border border-pink-100"><i class="fa-solid fa-camera"></i> 拍照 (選填)</button>
                        <div id="expense-photo-preview-container" class="hidden mb-3"><img id="expense-photo-preview" src="" class="object-cover w-full h-40 border-2 border-pink-100 rounded-xl"><button type="button" onclick="window.clearExpensePhoto()" class="block w-full mt-1 text-xs text-red-400 underline">移除照片</button></div>
                        <button type="submit" id="add-expense-btn" class="w-full p-4 font-bold text-white transition bg-custom-secondary rounded-2xl shadow-lg active:scale-95">確認紀錄</button>
                    </form>
                </div>
                <div id="expense-details-container">
                    <div class="p-5 mb-6 border border-blue-100 shadow-inner bg-gradient-to-br from-blue-50 to-purple-50 rounded-3xl">
                        <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                            <div class="p-3 bg-white shadow-sm rounded-2xl"><div id="budget-display-container"><p class="mb-1 text-xs text-gray-400">總預算</p><div class="flex items-center"><p id="budget-display" class="text-2xl font-bold text-gray-700 cursor-pointer" onclick="window.enableBudgetEdit()">$ <span id="total-budget">0</span></p><i class="ml-2 text-sm text-gray-400 cursor-pointer fa-solid fa-pen-to-square" onclick="window.enableBudgetEdit()"></i></div><div id="budget-edit-form" class="hidden flex items-center mt-1"><input type="number" id="budget-input" class="w-20 border-b p-1 mr-1 text-sm"><button onclick="window.saveBudget()" class="text-custom-primary"><i class="fa-solid fa-check"></i></button></div></div></div>
                            <div class="p-3 bg-white shadow-sm rounded-2xl"><p class="mb-1 text-xs text-gray-400">已支出 (TWD)</p><p class="text-2xl font-bold text-custom-danger">$ <span id="total-spent">0</span></p></div>
                            
                            <!-- 動態生成付款人統計卡片 -->
                            <div id="payer-summary-container" class="col-span-2 grid grid-cols-2 gap-3">
                                <!-- JS will populate this -->
                            </div>
                            
                            <!-- 加上 ID 和 onclick 事件 (付款方式) -->
                            <div id="btn-filter-cash" onclick="window.filterExpensePayment('Cash')" class="p-3 bg-white shadow-sm rounded-2xl border-2 border-green-100 cursor-pointer hover:bg-green-50 transition relative group">
                                <p class="mb-1 text-sm font-bold text-green-500 flex justify-between items-center">現金支付 <i class="fa-solid fa-filter opacity-0 group-hover:opacity-50 text-xs"></i></p>
                                <p class="text-2xl font-bold text-gray-700">$ <span id="cash-paid">0</span></p>
                            </div>
                            <div id="btn-filter-card" onclick="window.filterExpensePayment('NonCash')" class="p-3 bg-white shadow-sm rounded-2xl border-2 border-purple-100 cursor-pointer hover:bg-purple-50 transition relative group">
                                <p class="mb-1 text-sm font-bold text-purple-500 flex justify-between items-center">刷卡/Paypay <i class="fa-solid fa-filter opacity-0 group-hover:opacity-50 text-xs"></i></p>
                                <p class="text-2xl font-bold text-gray-700">$ <span id="card-paid">0</span></p>
                            </div>
                        </div>
                        <div class="p-2 text-center bg-white border-t border-blue-100 rounded-xl"><p class="mb-1 text-xs text-gray-400">結算建議</p><p id="settlement-result" class="text-lg font-bold text-custom-primary">計算中...</p></div>
                    </div>
                    
                    <div class="mb-2"><span class="text-xs font-bold text-gray-400 ml-1">消費類別</span></div>
                    <div id="category-filter-buttons" class="flex flex-wrap gap-2 px-1 pb-2 mb-4 overflow-x-auto no-scrollbar"></div>
                    <div id="expense-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- 3. 慾望清單 TAB -->
            <div id="wishlist-tab" class="main-tab-content hidden p-4" style="display: none;">
                <div class="p-6 mb-6 bg-white border-2 border-pink-100 shadow-lg rounded-3xl">
                    <h3 class="flex items-center mb-4 text-xl font-bold text-gray-700"><i class="mr-2 fa-solid fa-cart-plus text-custom-primary"></i> 新增慾望</h3>
                    <form onsubmit="window.addWishlistItem(event)" id="wishlist-form">
                        <!-- ★★★ 修改：加入 datalist 預設選項 ★★★ -->
                        <input type="text" id="wishlist-name" list="wishlist-suggestions" placeholder="商品名稱" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl" required>
                        <datalist id="wishlist-suggestions">
                            <option value="Panasonic 吹風機">
                            <option value="Dyson 吸塵器">
                            <option value="EVE 止痛藥">
                            <option value="合利他命 EX Plus">
                            <option value="Wakamoto 若元錠">
                            <option value="DHC 維他命C">
                            <option value="UNIQLO 發熱衣">
                            <option value="GU 服飾">
                            <option value="白色戀人">
                            <option value="東京香蕉">
                            <option value="一蘭拉麵泡麵">
                            <option value="KitKat 巧克力">
                        </datalist>

                        <div class="flex gap-2 mb-3"><input type="number" id="wishlist-price" placeholder="價格 (JPY)" class="flex-1 p-3 border-0 bg-gray-50 rounded-xl" required>
                            <!-- ★★★ 新增：數量欄位 (預設 1) ★★★ -->
                            <input type="number" id="wishlist-quantity" placeholder="數量" class="w-20 p-3 border-0 bg-gray-50 rounded-xl text-center" value="1" min="1">
                        </div>
                        <div class="relative mb-3">
                             <select id="wishlist-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl"><option value="伴手禮">🎁 伴手禮</option><option value="電器">⚡ 電器</option><option value="3C">📱 3C</option><option value="服飾">👕 服飾</option><option value="藥妝">💊 藥妝</option><option value="其他">✨ 其他</option></select><i class="absolute top-4 right-4 text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i>
                        </div>
                        <input type="file" id="item-camera-input" accept="image/*" class="hidden" onchange="window.previewItemImage(this)"><button type="button" onclick="document.getElementById('item-camera-input').click()" class="w-full p-2 mb-2 text-sm font-bold text-pink-500 bg-pink-50 rounded-xl border border-pink-100"><i class="fa-solid fa-camera"></i> 拍照 (選填)</button>
                        <div id="item-photo-preview-container" class="hidden mb-3"><img id="item-photo-preview" src="" class="object-cover w-full h-40 border-2 border-pink-100 rounded-xl"><button type="button" onclick="window.clearItemPhoto()" class="block w-full mt-1 text-xs text-center text-red-400 underline">移除照片</button></div>
                        <button type="submit" id="add-wishlist-btn" class="w-full py-3 font-bold text-white shadow-md bg-custom-primary rounded-xl active:scale-95">新增清單項目</button>
                    </form>
                </div>

                <!-- ★★★ 新增：搜尋功能 ★★★ -->
                <input type="text" id="wishlist-search" placeholder="搜尋清單..." class="w-full p-2 mb-2 border border-pink-100 rounded-xl text-sm" oninput="window.renderWishlist()">
                
                <div id="wishlist-filter-buttons" class="flex flex-wrap gap-2 px-1 pb-2 mb-4 overflow-x-auto no-scrollbar"></div>

                <div id="wishlist-list" class="space-y-3"></div>
            </div>
            
            <!-- 4. 打包清單 TAB -->
            <div id="packing-tab" class="main-tab-content hidden p-4" style="display: none;">
                <div class="p-5 mb-6 bg-white border border-blue-100 shadow-sm rounded-3xl">
                    <h3 class="flex items-center mb-4 text-lg font-bold text-gray-700"><i class="mr-2 fa-solid fa-shirt text-custom-secondary"></i> 新增行李</h3>
                    <form id="packing-form" onsubmit="window.addPackingItem(event)">
                        <div class="flex gap-2 mb-3"><div class="flex-1"><input type="text" id="packing-name" placeholder="護照" class="w-full p-3 border-0 bg-gray-50 rounded-xl" required></div>
                        <div class="w-1/3 relative"><select id="packing-category" class="w-full p-3 bg-gray-50 rounded-xl appearance-none border-0"><option value="證件">🪪 證件</option><option value="衣物">👕 衣物</option><option value="電子">📱 3C</option><option value="藥品">💊 藥品</option><option value="盥洗">🚿 盥洗</option><option value="其他">🧩 其他</option></select><i class="absolute right-3 top-4 text-xs text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i></div></div>
                        <button type="submit" class="w-full p-3 font-bold text-white bg-custom-secondary rounded-2xl shadow-lg">加入行李箱</button>
                    </form>
                </div>
                <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center px-2"><i class="fa-solid fa-clipboard-check mr-2 text-custom-primary"></i> 檢查清單</h3>
                <div id="packing-list-container" class="space-y-2"></div>
            </div>

            <!-- 5. 總覽 TAB -->
            <div id="overview-tab" class="main-tab-content hidden p-4">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-6 text-center border border-yellow-100 bg-yellow-50 rounded-3xl shadow-sm"><i class="block mb-2 text-2xl text-yellow-500 fa-regular fa-calendar"></i><p class="mb-1 text-xs font-bold text-yellow-700 uppercase">Duration</p><p class="text-2xl font-bold font-mono"><span id="overview-duration-display">0</span> Days</p></div>
                    <div class="p-6 text-center border border-green-100 bg-green-50 rounded-3xl shadow-sm"><i class="block mb-2 text-2xl text-green-500 fa-solid fa-sack-dollar"></i><p class="mb-1 text-xs font-bold text-green-700 uppercase">Budget</p><p class="text-2xl font-bold font-mono">$<span id="overview-budget-display">0</span></p></div>
                </div>
                
                <!-- 旅程夥伴設定區塊 -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-blue-100 mb-6 relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-50 rounded-full opacity-50 pointer-events-none"></div>
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center relative z-10">
                        <i class="fa-solid fa-user-group text-blue-400 text-xl mr-2"></i> 旅程夥伴設定
                    </h3>
                    <div class="flex gap-2 mb-3 relative z-10">
                        <input type="text" id="new-participant-name" placeholder="輸入名字..." class="flex-1 p-3 bg-blue-50 border-0 rounded-xl font-bold text-gray-700 focus:ring-2 focus:ring-blue-200 outline-none">
                        <button onclick="window.addParticipant()" class="w-12 bg-blue-400 text-white font-bold rounded-xl shadow-md hover:bg-blue-500 transition active:scale-95"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="participants-list" class="relative z-10"></div>
                </div>

                <!-- 行程日期設定區塊 -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-purple-100 mb-6 relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-purple-50 rounded-full opacity-50 pointer-events-none"></div>
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center relative z-10">
                        <i class="fa-regular fa-calendar-check text-purple-400 text-xl mr-2"></i> 設定旅程日期
                    </h3>
                    <div class="flex gap-3 mb-4 relative z-10">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1 font-bold">出發日期</label>
                            <input type="date" id="trip-start-date" class="w-full p-3 bg-purple-50 border-0 rounded-xl font-bold text-gray-700 focus:ring-2 focus:ring-purple-200 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-gray-400 block mb-1 font-bold">天數</label>
                            <input type="number" id="trip-days" value="5" min="1" class="w-full p-3 bg-purple-50 border-0 rounded-xl font-bold text-center text-gray-700 focus:ring-2 focus:ring-purple-200 outline-none">
                        </div>
                    </div>
                    <button onclick="window.generateTripDates()" id="generate-trip-btn" class="w-full p-3 bg-purple-400 text-white font-bold rounded-xl shadow-md hover:bg-purple-500 transition active:scale-95 relative z-10">
                        生成/更新行程表
                    </button>
                    <p class="text-[10px] text-gray-400 mt-2 text-center relative z-10">* 若日期已有行程，不會刪除內容，僅更新日期順序。</p>
                </div>
 
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-green-100 mb-6">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fa-solid fa-calculator text-custom-secondary mr-2"></i> 簡易換算</h3>
                    <div class="flex items-center gap-3">
                        <div class="flex-1"><label class="text-xs text-gray-400 block mb-1">日幣 (JPY)</label><input type="number" id="calc-jpy" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-lg border-2 border-gray-100" placeholder="0" oninput="window.calculateTwd()"></div>
                        <i class="fa-solid fa-arrow-right text-gray-300 mt-4"></i>
                        <div class="flex-1"><label class="text-xs text-gray-400 block mb-1">台幣 (TWD)</label><div id="calc-twd" class="w-full p-3 bg-green-50 text-custom-secondary rounded-xl font-bold text-lg border-2 border-green-100 flex items-center h-[54px]">0</div></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-right">匯率: <span id="calc-rate-display" class="font-bold text-custom-primary">0.2150</span></p>
                </div>
                <div class="p-6 mb-6 bg-white border border-pink-100 shadow-sm rounded-3xl">
                    <div class="flex items-center mb-4"><i class="fa-solid fa-location-dot text-[#FF8BA7] text-lg mr-2"></i><h2 class="text-lg font-bold text-gray-700">想去地點清單</h2></div>
                    <div class="space-y-3">
                        <input type="text" id="new-spot-name" placeholder="景點名稱 (必填)" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                        <input type="text" id="new-spot-desc" placeholder="簡單附註 (選填)" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                        <input type="text" id="new-spot-link" placeholder="Google Map 連結" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                        <input type="file" id="spot-camera-input" accept="image/*" class="hidden" onchange="window.previewImage(this)"><button type="button" onclick="document.getElementById('spot-camera-input').click()" class="w-full p-3 font-bold text-gray-500 bg-gray-100 rounded-xl transition hover:bg-gray-200"><i class="fa-solid fa-camera"></i> 點我拍照或選照片</button>
                        <div id="photo-preview-container" class="relative hidden mt-1"><img id="photo-preview" src="" class="object-cover w-full h-40 border-2 border-gray-200 rounded-xl cursor-pointer hover:opacity-80 transition" onclick="window.open(this.src, '_blank')" title="點擊查看原圖"><button type="button" onclick="window.clearPhoto()" class="absolute top-2 right-2 flex items-center justify-center w-7 h-7 text-white bg-red-400 rounded-full shadow top-2 right-2"><i class="fa-solid fa-xmark"></i></button></div>
                        <button onclick="window.addSpot()" id="add-spot-btn" class="w-full p-3 font-bold text-white bg-[#FF8BA7] rounded-xl shadow-md active:scale-95">新增景點</button>
                    </div>
                </div>
                <div id="spots-list" class="space-y-4"></div>
            </div>
            
        </main>
    </div>

    <!-- Modals -->
    <div id="addItineraryModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('addItineraryModal')">
        <div class="w-full max-w-sm p-6 transition-all transform bg-white shadow-2xl rounded-3xl scale-100" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-6 text-xl font-bold text-gray-700">新增行程<button onclick="window.closeModal('addItineraryModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 bg-gray-100 rounded-full"><i class="fa-solid fa-xmark"></i></button></h3>
            <form id="add-itinerary-form" onsubmit="window.addItineraryItem(event)">
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">哪一天?</label><div class="relative mb-3"><select id="new-date" class="w-full p-3 font-bold border-0 appearance-none bg-gray-50 rounded-xl text-gray-700" required></select><i class="absolute pointer-events-none fa-solid fa-chevron-down right-4 top-4 text-gray-400"></i></div>
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">幾點?</label><input type="time" id="new-time" class="w-full p-3 mb-3 text-lg font-bold text-center border-0 bg-gray-50 rounded-xl text-gray-700" required>
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">做什麼?</label><input type="text" id="new-title" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl text-gray-700" required>
                <!-- Add Link Field -->
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">地圖連結</label>
                <input type="text" id="new-link" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl text-gray-700" placeholder="貼上 Google Maps 網址">
                <!-- End Add Link Field -->
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">備註</label><textarea id="new-note" rows="3" class="w-full p-3 mb-6 border-0 bg-gray-50 rounded-xl text-gray-700"></textarea>
                <button type="submit" class="w-full p-3 font-bold text-white shadow-lg bg-custom-primary rounded-2xl hover:bg-custom-primary-dark">完成</button>
            </form>
        </div>
    </div>

    <div id="editItineraryModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editItineraryModal')">
        <div class="w-full max-w-sm p-6 bg-white shadow-2xl rounded-3xl" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-2 text-xl font-bold text-gray-700">編輯行程<button onclick="window.closeModal('editItineraryModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 transition bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            <p id="edit-modal-date-info" class="inline-block px-3 py-1 mb-6 text-sm font-bold rounded-lg text-custom-primary bg-pink-50"></p>
            <form id="edit-itinerary-form" onsubmit="window.saveItineraryItem(event)">
                <input type="hidden" id="edit-date-key"><input type="hidden" id="edit-item-index">
                <input type="time" id="edit-time" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>
                <input type="text" id="edit-title" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl" required>
                <input type="text" id="edit-link" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl" placeholder="地圖連結">
                <textarea id="edit-note" rows="3" class="w-full p-3 mb-6 border-0 bg-gray-50 rounded-xl"></textarea>
                <div class="flex space-x-3"><button type="button" onclick="window.deleteItineraryItem(document.getElementById('edit-date-key').value, document.getElementById('edit-item-index').value)" class="flex-1 p-3 font-bold text-red-400 transition bg-white border-2 border-red-100 rounded-2xl hover:bg-red-50">刪除</button><button type="submit" class="flex-[2] p-3 font-bold text-white transition shadow-lg bg-custom-primary rounded-2xl">儲存</button></div>
            </form>
        </div>
    </div>

    <!-- 編輯支出 Modal (已修復支付方式顯示問題、圖片上傳與滑動) -->
    <div id="editExpenseModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="window.closeModal('editExpenseModal')">
        <!-- ★★★ 修改：加入 max-h-[90vh] 和 overflow-y-auto 以修復滑動問題 ★★★ -->
        <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-4 text-gray-700 flex items-center"><i class="fa-solid fa-pen-to-square text-custom-primary mr-2"></i> 編輯支出</h3>
            <form onsubmit="window.saveExpenseUpdate(event)">
                <input type="hidden" id="edit-expense-id">
                <label class="block mb-2 text-sm font-bold">日期</label><input type="date" id="edit-expense-date" class="w-full p-3 border rounded-xl mb-4 bg-gray-50 border-0">
                <label class="block mb-2 text-sm font-bold">金額 & 幣別</label>
                <div class="flex items-center gap-2 mb-4">
                    <input type="number" step="0.01" id="edit-expense-amount" class="flex-1 min-w-0 p-3 border-0 bg-gray-50 rounded-xl font-bold text-lg">
                    <div id="edit-expense-currency-select" class="flex shrink-0">
                        <button type="button" class="block-select-btn !mr-1 !mb-0 px-3" data-currency="TWD" onclick="window.selectEditCurrency('TWD')">TWD</button>
                        <button type="button" class="block-select-btn !mr-0 !mb-0 px-3" data-currency="JPY" onclick="window.selectEditCurrency('JPY')">JPY</button>
                    </div>
                    <input type="hidden" id="edit-expense-currency">
                </div>
                <label class="block mb-2 text-sm font-bold">用途</label><input type="text" id="edit-expense-description" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-4">
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2 text-sm font-bold">付款人</label>
                        <!-- 動態生成編輯表單付款人選項 -->
                        <div id="edit-expense-payer-select" class="flex gap-1 overflow-x-auto no-scrollbar">
                             <!-- JS will populate this -->
                        </div>
                        <input type="hidden" id="edit-expense-payer">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-bold">支付方式</label>
                        <div id="edit-expense-payment-select" class="flex gap-1">
                            <button type="button" class="block-select-btn !text-xs !p-1 !m-0 !flex-1" data-payment="Cash" onclick="window.selectEditPayment('Cash')">現金</button>
                            <button type="button" class="block-select-btn !text-xs !p-1 !m-0 !flex-1" data-payment="Card" onclick="window.selectEditPayment('Card')">信用卡</button>
                            <button type="button" class="block-select-btn !text-xs !p-1 !m-0 !flex-1" data-payment="Paypay" onclick="window.selectEditPayment('Paypay')">Paypay</button>
                        </div>
                        <input type="hidden" id="edit-expense-payment">
                    </div>
                </div>

                <!-- ★★★ 新增：編輯模式的分帳設定 ★★★ -->
                <label class="block mb-2 text-sm font-bold text-gray-500">分帳方式 (誰該付這筆錢?)</label>
                <div class="bg-gray-50 p-3 rounded-xl mb-4 border-2 border-dashed border-gray-200">
                    <div id="edit-expense-split-type-select" class="flex gap-2 mb-3">
                        <button type="button" class="flex-1 py-1.5 px-3 rounded-lg text-sm font-bold bg-white border border-gray-200 transition shadow-sm" data-type="shared" onclick="window.selectEditSplitType('shared')"><i class="fa-solid fa-users mr-1"></i> 共同分擔</button>
                        <button type="button" class="flex-1 py-1.5 px-3 rounded-lg text-sm font-bold bg-white border border-gray-200 transition shadow-sm" data-type="personal" onclick="window.selectEditSplitType('personal')"><i class="fa-solid fa-user mr-1"></i> 個人獨享</button>
                    </div>
                    <div id="edit-expense-beneficiaries-container" class="flex flex-wrap">
                        <!-- JS will populate buttons here -->
                    </div>
                </div>

                <label class="block mb-2 text-sm font-bold">類別</label>
                <div id="edit-expense-category-select" class="grid grid-cols-3 gap-2 mb-6">
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Food" onclick="window.selectEditCategory('Food')">餐飲</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Transport" onclick="window.selectEditCategory('Transport')">交通</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Accommodation" onclick="window.selectEditCategory('Accommodation')">住宿</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Shopping" onclick="window.selectEditCategory('Shopping')">購物</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Ticket" onclick="window.selectEditCategory('Ticket')">門票</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Other" onclick="window.selectEditCategory('Other')">其他</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Purchasing" onclick="window.selectEditCategory('Purchasing')">代購</button>
                </div>
                <input type="hidden" id="edit-expense-category">
                <input type="file" id="edit-expense-file" accept="image/*" class="hidden" onchange="window.previewEditExpenseImage(this)">
                <button type="button" onclick="document.getElementById('edit-expense-file').click()" class="w-full p-2 mb-2 text-sm font-bold text-pink-500 bg-pink-50 rounded-xl border border-pink-100"><i class="fa-solid fa-camera"></i> 更換照片</button>
                <input type="hidden" id="edit-expense-old-image">
                <div id="edit-expense-photo-preview-container" class="hidden mb-3 text-center">
                    <img id="edit-expense-photo-preview" src="" class="object-cover w-full h-40 border-2 border-pink-100 rounded-xl mb-2">
                    <button type="button" onclick="window.removeEditExpensePhoto()" class="text-red-500 text-sm font-bold hover:underline">🗑️ 移除照片</button>
                </div>
                
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="window.closeModal('editExpenseModal')" class="px-4 py-2 bg-gray-100 rounded-xl font-bold">取消</button>
                    <button type="submit" id="save-expense-btn" class="px-6 py-2 bg-custom-primary text-white rounded-xl font-bold shadow-md">儲存修改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 編輯景點 Modal -->
    <div id="editSpotModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editSpotModal')">
        <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">編輯景點<button onclick="window.closeModal('editSpotModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            <form onsubmit="window.saveSpotUpdate(event)">
                <input type="hidden" id="edit-spot-id"><input type="hidden" id="edit-spot-old-image">
                <input type="text" id="edit-spot-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>
                <textarea id="edit-spot-desc" rows="2" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl"></textarea>
                <input type="text" id="edit-spot-link" class="w-full p-3 mb-4 text-sm border-0 bg-gray-50 rounded-xl">
                
                <div id="edit-photo-preview-container" class="relative hidden mb-3 text-center">
                    <img id="edit-photo-preview" src="" class="object-cover w-full h-40 border border-gray-200 rounded-xl mb-2">
                    <button type="button" onclick="window.removeEditSpotPhoto()" class="text-red-500 text-sm font-bold hover:underline">🗑️ 移除照片</button>
                </div>

                <button type="button" onclick="document.getElementById('edit-spot-file').click()" class="flex items-center justify-center w-full gap-2 p-2 mb-2 text-sm font-bold text-pink-500 transition border border-pink-100 bg-pink-50 rounded-xl hover:bg-pink-100"><i class="fa-solid fa-camera"></i> 更換照片</button>
                <input type="file" id="edit-spot-file" accept="image/*" class="hidden" onchange="window.previewEditImage(this)">
                <button type="submit" id="save-spot-btn" class="w-full p-3 mt-4 font-bold text-white shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">儲存修改</button>
            </form>
        </div>
    </div>

    <!-- 編輯慾望清單 Modal -->
    <div id="editWishlistModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editWishlistModal')">
        <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">編輯物品<button onclick="window.closeModal('editWishlistModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            
            <form onsubmit="window.saveWishlistUpdate(event)">
                <input type="hidden" id="edit-wishlist-id">
                <input type="hidden" id="edit-wishlist-old-image">

                <label class="block mb-1 text-sm font-bold text-gray-500">名稱</label>
                <input type="text" id="edit-wishlist-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>

                <label class="block mb-1 text-sm font-bold text-gray-500">價格 (JPY)</label>
                <input type="number" id="edit-wishlist-price" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>

                <div class="flex gap-2 mb-3">
                    <div class="flex-1">
                        <label class="block mb-1 text-sm font-bold text-gray-500">數量</label>
                        <input type="number" id="edit-wishlist-quantity" class="w-full p-3 border-0 bg-gray-50 rounded-xl text-center" min="1">
                    </div>
                </div>

                <label class="block mb-1 text-sm font-bold text-gray-500">分類</label>
                <div class="relative mb-3">
                    <select id="edit-wishlist-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl">
                        <option value="伴手禮">🎁 伴手禮</option>
                        <option value="電器">⚡ 電器</option>
                        <option value="3C">📱 3C</option>
                        <option value="服飾">👕 服飾</option>
                        <option value="藥妝">💊 藥妝</option>
                        <option value="其他">✨ 其他</option>
                    </select>
                    <i class="absolute top-4 right-4 text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i>
                </div>

                <div id="edit-wishlist-preview-container" class="relative hidden mb-3 text-center">
                    <p class="mb-1 text-xs text-gray-400">目前圖片：</p>
                    <img id="edit-wishlist-preview" src="" class="object-cover w-full h-40 border border-gray-200 rounded-xl mb-2">
                    <button type="button" onclick="window.removeEditWishlistPhoto()" class="text-red-500 text-sm font-bold hover:underline">🗑️ 移除照片</button>
                </div>

                <button type="button" onclick="document.getElementById('edit-wishlist-file').click()" class="flex items-center justify-center w-full gap-2 p-2 mb-2 text-sm font-bold text-pink-500 transition border border-pink-100 bg-pink-50 rounded-xl hover:bg-pink-100">
                    <i class="fa-solid fa-camera"></i> 更換照片
                </button>
                <input type="file" id="edit-wishlist-file" accept="image/*" class="hidden" onchange="window.previewEditWishlistImage(this)">

                <button type="submit" id="save-wishlist-btn" class="w-full p-3 mt-4 font-bold text-white transition shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">儲存修改</button>
            </form>
        </div>
    </div>

    <!-- 新增：編輯行李清單 Modal -->
    <div id="editPackingModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editPackingModal')">
        <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700"><i class="mr-2 fa-solid fa-pen-to-square text-custom-secondary"></i> 編輯行李項目<button onclick="window.closeModal('editPackingModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 transition bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            
            <form onsubmit="window.savePackingUpdate(event)">
                <input type="hidden" id="edit-packing-id">

                <label class="block mb-1 text-sm font-bold text-gray-500">物品名稱</label>
                <input type="text" id="edit-packing-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>

                <label class="block mb-1 text-sm font-bold text-gray-500">分類</label>
                <div class="relative mb-3">
                    <select id="edit-packing-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl">
                        <option value="證件">🪪 證件</option>
                        <option value="衣物">👕 衣物</option>
                        <option value="電子">📱 3C</option>
                        <option value="藥品">💊 藥品</option>
                        <option value="盥洗">🚿 盥洗</option>
                        <option value="其他">🧩 其他</option>
                    </select>
                    <i class="absolute top-4 right-4 text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i>
                </div>

                <button type="submit" id="save-packing-btn" class="w-full p-3 mt-4 font-bold text-white transition shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">儲存修改</button>
            </form>
        </div>
    </div>
</body>
</html>
```
Model
ThinkingThoughts
Expand to view model thoughts

chevron_right
這是一個很棒的介面升級，讓您可以為這趟旅程「命名」，並且讓它看起來更像是一個完整的旅遊紀錄 App。

我已經完成了以下修改：

1.  **網頁標題與 Header 更新**：標題改為 **My Travel History**，且左上角的標題會隨著您在總覽設定的名稱自動變更。
2.  **總覽頁面 (Overview) 新增「旅程資訊卡片」**：
    *   **命名欄位**：您可以手動輸入旅程名稱（例如：2024 東京大爆買）。
    *   **自動日期抓取**：系統會自動掃描您的「行程 Tab」裡所有的日期，抓出**最早**跟**最晚**的日期，組合成「年月日」顯示。
    *   **旅程標題區塊**：即時顯示「日期 + 旅程名稱」的卡片，符合您要求的顯示方式。

您可以直接複製下方的完整程式碼覆蓋：

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Travel History</title>
    <link rel="icon" type="image/png" href="./luggage.png">
    <link rel="apple-touch-icon" href="./luggage.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss" >
        :root {
            --custom-primary: #FF8BA7; /* Sweet Pink */
            --custom-secondary: #4ECDC4; /* Lively Mint */
            --custom-danger: #FF6B6B; /* Soft Coral */
            --custom-bg: #FFFDF9; /* Creamy White */
            --custom-text: #595959; /* Softer Dark Gray */
        }
        body { font-family: 'Zen Maru Gothic', sans-serif !important; color: var(--custom-text); background-color: var(--custom-bg); }
        .bg-gray-50 { background-color: var(--custom-bg) !important; } .bg-white { background-color: #ffffff; }
        .bg-custom-primary { background-color: var(--custom-primary); } .text-custom-primary { color: var(--custom-primary); }
        .bg-custom-secondary { background-color: var(--custom-secondary); } .text-custom-secondary { color: var(--custom-secondary); }
        .border-custom-primary { border-color: var(--custom-primary); }
        .rounded-lg { border-radius: 16px !important; } .rounded-xl { border-radius: 20px !important; }
        
        .tab-button {
            padding: 8px 16px; margin-right: 8px; border-radius: 20px; cursor: pointer; text-align: center;
            transition: all 0.3s; min-width: 80px; font-size: 0.9rem; border: 2px solid #F0F0F0; color: #7D7D7D; background: white; font-weight: bold;
        }
        .tab-button.active { background-color: var(--custom-primary); color: white; border-color: var(--custom-primary); transform: scale(1.05); box-shadow: 0 4px 10px rgba(255, 139, 167, 0.4); }
        
        .main-nav-btn { @apply flex-1 py-4 text-center transition duration-200 text-gray-500 border-b-4 border-transparent; }
        .main-nav-btn i { font-size: 1.2rem; margin-bottom: 2px; display: inline-block; }
        .main-nav-btn.active { color: var(--custom-primary); border-color: var(--custom-primary); font-weight: 800; }
        
        .block-select-btn {
            @apply px-4 py-1 border-2 rounded-full text-sm font-bold transition-all duration-200 mr-2 mb-2 bg-white flex-shrink-0;
            border-color: #D1D5DB !important; color: #6B7280; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center;
        }
        .block-select-btn:hover:not([class*="active-"]) { border-color: #FF748D; background-color: #FFF1F2; color: #FF748D; }
        
        .active-filter, .active-currency, .active-payer, .active-category, .active-payment, .active-split-type {
            background-color: #FF7596!important; border-color: #FF748D !important; color: white !important; @apply shadow-md; transform: scale(1.05);
        }
        
        .active-beneficiary {
            background-color: #4ECDC4 !important; border-color: #4ECDC4 !important; color: white !important; @apply shadow-sm;
        }

        .timeline-container { position: relative; }
        .timeline-container::before {
            content: ''; position: absolute; top: 30px; bottom: 30px; left: 28.5%; width: 2px;
            background-image: linear-gradient(to bottom, #FFE5EA 50%, transparent 50%); background-size: 2px 10px; z-index: 0;
        }
        .timeline-item { padding-left: 1.5rem; min-height: 20px; cursor: pointer; }
        .timeline-dot { box-shadow: 0 0 0 3px #FFF0F3; }
        
        .wishlist-status-btn { @apply px-3 py-1 rounded-full text-xs font-bold shadow-sm min-w-[60px]; }
        .wishlist-status-btn.purchased { @apply bg-custom-secondary text-white; }
        .wishlist-status-btn.pending { @apply bg-orange-100 text-orange-600; }
        .wishlist-status-btn.skipped { @apply bg-gray-200 text-gray-500; }
        
        input, select, textarea { border: 2px solid #F3F4F6 !important; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--custom-primary) !important; outline: none; box-shadow: 0 0 0 3px rgba(255, 139, 167, 0.1); }

        /* Lightbox 樣式 */
        #imagePreviewModal { transition: opacity 0.3s ease; }
        #imagePreviewModal img { max-height: 90vh; max-width: 95vw; object-fit: contain; }
    </style>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBRjYjvwvCNTRHdI8vH8n3GPabzSnSDbvI",
        authDomain: "jp-b0e03.firebaseapp.com",
        projectId: "jp-b0e03",
        storageBucket: "jp-b0e03.firebasestorage.app", 
        messagingSenderId: "689610031212",
        appId: "1:689610031212:web:f63f2efe61d4ad562bd849",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // 全域變數
    window.ITINERARY_DATA = [];
    window.EXPENSES_DATA = [];
    window.WISHLIST_DATA = [];
    window.PACKING_DATA = [];
    window.SPOTS_DATA = [];
    window.TRIP_PARTICIPANTS = ['Josh', 'Candice'];
    
    let ACTIVE_DATE = '', ACTIVE_CURRENCY = 'TWD', ACTIVE_PAYER = 'Josh', ACTIVE_CATEGORY = 'Food', ACTIVE_PAYMENT = 'Cash', EXPENSE_FILTER = 'All', WISHLIST_FILTER = 'All', EXCHANGE_RATE_JPY_TWD = 0.215;
    let PAYMENT_FILTER = 'All';
    let PAYER_FILTER = 'All';
    let ACTIVE_SPLIT_TYPE = 'shared'; 
    let ACTIVE_BENEFICIARIES = []; 
    // ★★★ 新增：旅程名稱變數 ★★★
    let CURRENT_TRIP_NAME = 'My Travel';

    // --- 基礎工具 ---
    window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).style.display = 'flex'; };
    window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).style.display = 'none'; };
    window.editExpense = (id) => window.openEditExpenseModal(id);

    // ★★★ 圖片預覽 Lightbox (修復版) ★★★
    window.openImagePreview = (url) => {
        if (!url) return;
        const modal = document.getElementById('imagePreviewModal');
        const img = document.getElementById('preview-full-image');
        if(modal && img) {
            img.src = url;
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }
    };
    
    window.closeImagePreview = () => {
        const modal = document.getElementById('imagePreviewModal');
        if(modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
            document.getElementById('preview-full-image').src = '';
        }
    };

    // --- 圖片預覽 (通用) ---
    window.previewImageGeneric = (input, imgId, containerId) => {
        if (input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => { 
                const img = document.getElementById(imgId);
                const container = document.getElementById(containerId);
                if(img && container) {
                    img.src = e.target.result; 
                    container.classList.remove('hidden'); 
                    img.onclick = () => window.openImagePreview(e.target.result);
                }
            };
            r.readAsDataURL(input.files[0]);
        }
    };

    window.previewImage = (input) => window.previewImageGeneric(input, 'photo-preview', 'photo-preview-container');
    window.previewItemImage = (input) => window.previewImageGeneric(input, 'item-photo-preview', 'item-photo-preview-container');
    window.previewExpenseImage = (input) => window.previewImageGeneric(input, 'expense-photo-preview', 'expense-photo-preview-container');
    window.previewEditExpenseImage = (input) => window.previewImageGeneric(input, 'edit-expense-photo-preview', 'edit-expense-photo-preview-container');
    window.previewEditWishlistImage = (input) => window.previewImageGeneric(input, 'edit-wishlist-preview', 'edit-wishlist-preview-container');
    window.previewEditImage = (input) => window.previewImageGeneric(input, 'edit-photo-preview', 'edit-photo-preview-container');

    window.clearPhotoGeneric = (inputId, containerId) => { document.getElementById(inputId).value = ""; document.getElementById(containerId).classList.add('hidden'); };
    window.clearPhoto = () => window.clearPhotoGeneric('spot-camera-input', 'photo-preview-container');
    window.clearItemPhoto = () => window.clearPhotoGeneric('item-camera-input', 'item-photo-preview-container');
    window.clearExpensePhoto = () => window.clearPhotoGeneric('expense-camera-input', 'expense-photo-preview-container');

    window.removeEditExpensePhoto = () => { document.getElementById('edit-expense-old-image').value = ''; document.getElementById('edit-expense-file').value = ''; document.getElementById('edit-expense-photo-preview-container').classList.add('hidden'); };
    window.removeEditSpotPhoto = () => { document.getElementById('edit-spot-old-image').value = ''; document.getElementById('edit-spot-file').value = ''; document.getElementById('edit-photo-preview').parentElement.classList.add('hidden'); };
    window.removeEditWishlistPhoto = () => { document.getElementById('edit-wishlist-old-image').value = ''; document.getElementById('edit-wishlist-file').value = ''; document.getElementById('edit-wishlist-preview-container').classList.add('hidden'); };

    /* =========================
       數據監聽 (資料同步中心)
    ========================= */
    function startDataSync() {
        updateLiveExchangeRate();
        onSnapshot(query(collection(db, "itineraries"), orderBy("date", "asc")), (snap) => {
            window.ITINERARY_DATA = snap.docs.map(d => ({id: d.id, ...d.data(), activities: d.data().activities?.sort((a,b)=>a.time.localeCompare(b.time))||[]}));
            if(window.ITINERARY_DATA.length > 0 && !ACTIVE_DATE) ACTIVE_DATE = window.ITINERARY_DATA[0].id;
            window.generateDateTabs(); window.renderItinerary(); window.populateItineraryModalDates();
            window.renderTripSummaryBlock(); // ★★★ 更新日期顯示 ★★★
            const durationEl = document.getElementById('overview-duration-display'); if(durationEl) durationEl.innerText = window.ITINERARY_DATA.length;
        });
        
        onSnapshot(query(collection(db, "expenses"), orderBy("date", "desc")), (snap) => { 
            window.EXPENSES_DATA = snap.docs.map(d => ({id: d.id, ...d.data()})); 
            window.renderExpenseTracking(); 
        });

        onSnapshot(doc(db, "trips", "currentTrip"), (doc) => { 
            if(doc.exists()) { 
                const data = doc.data();
                window.TOTAL_BUDGET = data.totalBudget || 0; 
                document.getElementById('total-budget').innerText = window.TOTAL_BUDGET.toLocaleString(); 
                document.getElementById('overview-budget-display').innerText = window.TOTAL_BUDGET.toLocaleString(); 
                
                // ★★★ 更新旅程名稱 ★★★
                if(data.tripName) {
                    CURRENT_TRIP_NAME = data.tripName;
                    document.getElementById('header-trip-name').innerText = CURRENT_TRIP_NAME;
                    const nameInput = document.getElementById('trip-name-input');
                    if(nameInput && document.activeElement !== nameInput) {
                        nameInput.value = CURRENT_TRIP_NAME;
                    }
                    window.renderTripSummaryBlock();
                }

                if(data.participants && Array.isArray(data.participants)) {
                    window.TRIP_PARTICIPANTS = data.participants;
                }
                window.renderParticipantsUI(); 
                window.renderExpensePayerButtons(); 
                window.renderBeneficiaryButtons(); 
                window.renderExpenseTracking();
            }
        });

        onSnapshot(query(collection(db, "wishlists")), (snap) => { window.WISHLIST_DATA = snap.docs.map(d => ({id: d.id, ...d.data()})); if(!document.getElementById('wishlist-tab').classList.contains('hidden')) window.renderWishlist(); });
        onSnapshot(collection(db, "packinglist"), (snap) => { let data = snap.docs.map(d => ({ id: d.id, ...d.data() })); data.sort((a, b) => { if (a.packed !== b.packed) return a.packed ? 1 : -1; const t1 = a.createdAt?.seconds || 0; const t2 = b.createdAt?.seconds || 0; return t1 - t2; }); window.PACKING_DATA = data; window.renderPackingList(); });
        onSnapshot(collection(db, "spots"), (snap) => { let data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); window.SPOTS_DATA = data; window.renderSpots(); });
    }

    async function updateLiveExchangeRate() {
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/JPY');
            const data = await res.json();
            if(data.result === 'success') {
                EXCHANGE_RATE_JPY_TWD = data.rates.TWD;
                document.getElementById('exchange-rate-display').textContent = EXCHANGE_RATE_JPY_TWD.toFixed(4);
                const calcRate = document.getElementById('calc-rate-display');
                if(calcRate) calcRate.innerText = EXCHANGE_RATE_JPY_TWD.toFixed(4);
                if(window.calculateTwd) window.calculateTwd();
                if(window.updateSettlementSummary) window.updateSettlementSummary();
            }
        } catch(e) { console.error('匯率失敗', e); }
    }
    
    window.calculateTwd = () => {
        const jpyInput = document.getElementById('calc-jpy');
        const twdOutput = document.getElementById('calc-twd');
        if(!jpyInput || !twdOutput) return;
        const jpy = parseFloat(jpyInput.value);
        if(isNaN(jpy)) { twdOutput.innerText = '0'; return; }
        const twd = Math.round(jpy * EXCHANGE_RATE_JPY_TWD);
        twdOutput.innerText = twd.toLocaleString(); 
    };

    /* =========================
       頁面渲染與邏輯
    ========================= */
    window.switchExpenseView = function(v) {
        document.getElementById('add-expense-container').classList.toggle('hidden', v!=='add');
        document.getElementById('expense-details-container').classList.toggle('hidden', v!=='details');
        document.getElementById('tab-add-expense-btn').className = v==='add' ? 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-custom-primary text-white shadow-md' : 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-gray-500';
        document.getElementById('tab-view-details-btn').className = v==='details' ? 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-custom-primary text-white shadow-md' : 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-gray-500';
        if(v==='details') window.renderExpenseTracking();
        if(v==='add') {
             window.selectSplitType('shared');
             ACTIVE_BENEFICIARIES = [...window.TRIP_PARTICIPANTS]; 
             window.renderBeneficiaryButtons();
        }
    };
    window.selectCurrency = (v) => { ACTIVE_CURRENCY=v; updateSelectUI('expense-currency', v); document.getElementById('expense-currency').value=v; };
    window.selectPayer = (v) => { ACTIVE_PAYER=v; updateSelectUI('expense-payer', v); document.getElementById('expense-payer').value=v; };
    window.selectCategory = (v) => { ACTIVE_CATEGORY=v; updateSelectUI('expense-category', v); document.getElementById('expense-category').value=v; };
    window.selectPayment = (v) => { ACTIVE_PAYMENT=v; updateSelectUI('expense-payment', v); document.getElementById('expense-payment').value=v; };
    
    window.selectEditCurrency = (v) => { updateSelectUI('edit-expense-currency', v); document.getElementById('edit-expense-currency').value=v; };
    window.selectEditPayer = (v) => { updateSelectUI('edit-expense-payer', v); document.getElementById('edit-expense-payer').value=v; };
    window.selectEditCategory = (v) => { updateSelectUI('edit-expense-category', v); document.getElementById('edit-expense-category').value=v; };
    window.selectEditPayment = (v) => { updateSelectUI('edit-expense-payment', v); document.getElementById('edit-expense-payment').value=v; };

    function updateSelectUI(id, val) {
        const c = document.getElementById(id+'-select');
        if(c) c.querySelectorAll('.block-select-btn').forEach(b => {
             const key = b.getAttribute('data-currency') || b.getAttribute('data-payer') || b.getAttribute('data-category') || b.getAttribute('data-payment');
             if(key===val) b.classList.add('active-filter'); else b.classList.remove('active-filter');
        });
    }

    // 分帳模式選擇邏輯
    window.selectSplitType = (type) => {
        ACTIVE_SPLIT_TYPE = type;
        const container = document.getElementById('expense-split-type-select');
        if(container) {
             container.querySelectorAll('button').forEach(b => {
                 if(b.dataset.type === type) b.classList.add('active-split-type');
                 else b.classList.remove('active-split-type');
             });
        }
        if (type === 'shared') {
            ACTIVE_BENEFICIARIES = [...window.TRIP_PARTICIPANTS]; 
        } else {
            ACTIVE_BENEFICIARIES = []; 
        }
        window.renderBeneficiaryButtons();
    };

    window.toggleBeneficiary = (name) => {
        if (ACTIVE_SPLIT_TYPE === 'shared') {
            if (ACTIVE_BENEFICIARIES.includes(name)) {
                ACTIVE_BENEFICIARIES = ACTIVE_BENEFICIARIES.filter(n => n !== name);
            } else {
                ACTIVE_BENEFICIARIES.push(name);
            }
        } else {
            ACTIVE_BENEFICIARIES = [name];
        }
        window.renderBeneficiaryButtons();
    };

    window.renderBeneficiaryButtons = () => {
        const container = document.getElementById('expense-beneficiaries-container');
        if(container) {
             container.innerHTML = window.TRIP_PARTICIPANTS.map(p => {
                 const isActive = ACTIVE_BENEFICIARIES.includes(p);
                 return `<button type="button" onclick="window.toggleBeneficiary('${p}')" 
                     class="px-3 py-1.5 rounded-full text-sm font-bold border-2 border-gray-100 mr-2 mb-2 transition-all ${isActive ? 'active-beneficiary' : 'bg-white text-gray-400'}">
                     ${isActive ? '<i class="fa-solid fa-check mr-1"></i>' : ''}${p}
                 </button>`;
             }).join('');
        }
    };

    let EDIT_SPLIT_TYPE = 'shared';
    let EDIT_BENEFICIARIES = [];

    window.selectEditSplitType = (type) => {
        EDIT_SPLIT_TYPE = type;
        const container = document.getElementById('edit-expense-split-type-select');
        if(container) {
             container.querySelectorAll('button').forEach(b => {
                 if(b.dataset.type === type) b.classList.add('active-split-type');
                 else b.classList.remove('active-split-type');
             });
        }
        window.renderEditBeneficiaryButtons();
    };

    window.toggleEditBeneficiary = (name) => {
        if (EDIT_SPLIT_TYPE === 'shared') {
            if (EDIT_BENEFICIARIES.includes(name)) {
                EDIT_BENEFICIARIES = EDIT_BENEFICIARIES.filter(n => n !== name);
            } else {
                EDIT_BENEFICIARIES.push(name);
            }
        } else {
            EDIT_BENEFICIARIES = [name];
        }
        window.renderEditBeneficiaryButtons();
    };

    window.renderEditBeneficiaryButtons = () => {
        const container = document.getElementById('edit-expense-beneficiaries-container');
        if(container) {
             container.innerHTML = window.TRIP_PARTICIPANTS.map(p => {
                 const isActive = EDIT_BENEFICIARIES.includes(p);
                 return `<button type="button" onclick="window.toggleEditBeneficiary('${p}')" 
                     class="px-3 py-1.5 rounded-full text-sm font-bold border-2 border-gray-100 mr-2 mb-2 transition-all ${isActive ? 'active-beneficiary' : 'bg-white text-gray-400'}">
                     ${isActive ? '<i class="fa-solid fa-check mr-1"></i>' : ''}${p}
                 </button>`;
             }).join('');
        }
    };

    window.renderExpensePayerButtons = () => {
        const generateButtons = (containerId, hiddenInputId, onClickFunc) => {
            const container = document.getElementById(containerId);
            const hiddenInput = document.getElementById(hiddenInputId);
            if(!container || !hiddenInput) return;
            
            const currentVal = hiddenInput.value;
            if(!window.TRIP_PARTICIPANTS.includes(currentVal) && window.TRIP_PARTICIPANTS.length > 0) {
                 hiddenInput.value = window.TRIP_PARTICIPANTS[0];
                 if(containerId === 'expense-payer-select') ACTIVE_PAYER = window.TRIP_PARTICIPANTS[0];
            }

            container.innerHTML = window.TRIP_PARTICIPANTS.map(p => 
                `<button type="button" class="flex-1 block-select-btn ${hiddenInput.value === p ? 'active-filter' : ''}" 
                  data-payer="${p}" onclick="window.${onClickFunc}('${p}')">${p}</button>`
            ).join('');
        };

        generateButtons('expense-payer-select', 'expense-payer', 'selectPayer');
        generateButtons('edit-expense-payer-select', 'edit-expense-payer', 'selectEditPayer');
    };

    window.addExpense = async function() {
        const date = document.getElementById('expense-date').value;
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const desc = document.getElementById('expense-description').value;
        const currency = document.getElementById('expense-currency').value;
        const fileIn = document.getElementById('expense-camera-input');
        const btn = document.getElementById('add-expense-btn');

        if(!date || !amount || !desc) return alert('請填寫完整');
        if(ACTIVE_BENEFICIARIES.length === 0) return alert('請至少選擇一位分帳對象');

        btn.innerText = '儲存中...'; btn.disabled = true;

        try {
            let imgUrl = '';
            if(fileIn.files[0]) {
                const sRef = ref(storage, `expenses/${Date.now()}_${fileIn.files[0].name}`);
                const snap = await uploadBytes(sRef, fileIn.files[0]);
                imgUrl = await getDownloadURL(snap.ref);
            }
            await addDoc(collection(db, "expenses"), { 
                date, amount, description: desc, currency: currency, 
                payer: ACTIVE_PAYER, category: ACTIVE_CATEGORY, payment: ACTIVE_PAYMENT, 
                splitType: ACTIVE_SPLIT_TYPE, beneficiaries: ACTIVE_BENEFICIARIES, 
                imageUrl: imgUrl, timestamp: serverTimestamp() 
            });
            alert('記帳成功'); document.getElementById('expense-amount').value = ''; document.getElementById('expense-description').value = ''; window.clearExpensePhoto();
            window.selectSplitType('shared');
        } catch(err) { console.error(err); alert('儲存失敗'); } finally { btn.innerText = '確認紀錄'; btn.disabled = false; }
    };
    
    window.openEditExpenseModal = function(id) {
        const e = window.EXPENSES_DATA.find(x => x.id === id); if(!e) return;
        document.getElementById('edit-expense-id').value = id;
        document.getElementById('edit-expense-date').value = e.date;
        document.getElementById('edit-expense-amount').value = e.amount;
        document.getElementById('edit-expense-description').value = e.description;
        document.getElementById('edit-expense-old-image').value = e.imageUrl || '';
        document.getElementById('edit-expense-file').value = "";
        
        const img = document.getElementById('edit-expense-photo-preview');
        const container = document.getElementById('edit-expense-photo-preview-container');
        if(e.imageUrl) { 
            img.src = e.imageUrl; 
            container.classList.remove('hidden'); 
            img.onclick = () => window.openImagePreview(e.imageUrl); 
        } else { 
            container.classList.add('hidden'); 
        }

        window.selectEditCurrency(e.currency); 
        window.renderExpensePayerButtons();
        window.selectEditPayer(e.payer); 
        window.selectEditCategory(e.category); 
        window.selectEditPayment(e.payment || 'Cash');

        EDIT_SPLIT_TYPE = e.splitType || 'shared';
        EDIT_BENEFICIARIES = e.beneficiaries || [...window.TRIP_PARTICIPANTS]; 
        window.selectEditSplitType(EDIT_SPLIT_TYPE);
        window.renderEditBeneficiaryButtons();

        window.openModal('editExpenseModal');
    };
    window.saveExpenseUpdate = async function(evt) {
        evt.preventDefault();
        const id = document.getElementById('edit-expense-id').value;
        const file = document.getElementById('edit-expense-file').files[0];
        const btn = document.getElementById('save-expense-btn');

        if(EDIT_BENEFICIARIES.length === 0) return alert('請至少選擇一位分帳對象');

        btn.innerText = '更新中...'; btn.disabled = true;

        try {
            let url = document.getElementById('edit-expense-old-image').value;
            if(file) {
                const sRef = ref(storage, `expenses/updated_${Date.now()}_${file.name}`);
                const snap = await uploadBytes(sRef, file);
                url = await getDownloadURL(snap.ref);
            }
            await updateDoc(doc(db, "expenses", id), {
                 date: document.getElementById('edit-expense-date').value, amount: parseFloat(document.getElementById('edit-expense-amount').value),
                 description: document.getElementById('edit-expense-description').value, currency: document.getElementById('edit-expense-currency').value,
                 payer: document.getElementById('edit-expense-payer').value, category: document.getElementById('edit-expense-category').value,
                 payment: document.getElementById('edit-expense-payment').value, 
                 splitType: EDIT_SPLIT_TYPE, beneficiaries: EDIT_BENEFICIARIES, 
                 imageUrl: url
            });
            window.closeModal('editExpenseModal');
        } catch(err) { alert('更新失敗'); } finally { btn.innerText = '儲存修改'; btn.disabled = false; }
    };
    window.deleteExpense = async function(id) { if(confirm('刪除?')) await deleteDoc(doc(db, "expenses", id)); };

    window.filterExpenses = function(cat) { EXPENSE_FILTER=cat; window.renderExpenseTracking(); };
    window.filterExpensePayment = function(pay) { 
        if(PAYMENT_FILTER === pay) PAYMENT_FILTER = 'All'; else PAYMENT_FILTER = pay;
        window.renderExpenseTracking(); 
    };
    window.filterExpensePayer = function(payer) {
        if(PAYER_FILTER === payer) PAYER_FILTER = 'All'; else PAYER_FILTER = payer;
        window.renderExpenseTracking();
    };

    window.renderExpenseTracking = function() {
        const list = document.getElementById('expense-list');
        const catFilterContainer = document.getElementById('category-filter-buttons');
        const payerSummaryContainer = document.getElementById('payer-summary-container');
        if(!list) return;

        if(payerSummaryContainer) {
            let payerTotals = {};
            window.TRIP_PARTICIPANTS.forEach(p => payerTotals[p] = 0);
            
            window.EXPENSES_DATA.forEach(e => {
                const v = e.currency==='JPY' ? e.amount*EXCHANGE_RATE_JPY_TWD : e.amount;
                if(payerTotals[e.payer] !== undefined) {
                    payerTotals[e.payer] += v;
                } else {
                    if(!payerTotals['Other']) payerTotals['Other'] = 0;
                    payerTotals['Other'] += v;
                }
            });

            const colors = ['blue', 'pink', 'yellow', 'indigo', 'orange'];
            let cardsHtml = window.TRIP_PARTICIPANTS.map((p, idx) => {
                const color = colors[idx % colors.length];
                const isActive = PAYER_FILTER === p;
                const activeClass = isActive ? `bg-${color}-100 border-${color}-300 transform scale-105 shadow-md` : `bg-white border-${color}-100 hover:bg-${color}-50`;
                
                return `
                <div onclick="window.filterExpensePayer('${p}')" class="p-3 shadow-sm rounded-2xl border-2 cursor-pointer transition relative group ${activeClass}">
                    <p class="mb-1 text-sm font-bold text-${color}-400 flex justify-between items-center">${p} 付 <i class="fa-solid fa-filter opacity-0 group-hover:opacity-50 text-xs ${isActive?'opacity-100':''}"></i></p>
                    <p class="text-2xl font-bold text-gray-700">$ <span id="payer-total-${p}">${Math.round(payerTotals[p]).toLocaleString()}</span></p>
                </div>`;
            }).join('');
            
            payerSummaryContainer.innerHTML = cardsHtml;
        }

        const cats = ['All', ...new Set(window.EXPENSES_DATA.map(e=>e.category))];
        catFilterContainer.innerHTML = cats.map(c => `<button onclick="window.filterExpenses('${c}')" class="block-select-btn px-3 py-1 text-xs rounded-full ${EXPENSE_FILTER===c?'active-filter':''}">${c==='All'?'全部':c}</button>`).join('');
        
        const data = window.EXPENSES_DATA.filter(e => {
            const catMatch = EXPENSE_FILTER === 'All' || e.category === EXPENSE_FILTER;
            const payerMatch = PAYER_FILTER === 'All' || e.payer === PAYER_FILTER;
            let payMatch = true;
            const payment = e.payment || 'Cash';
            if (PAYMENT_FILTER === 'Cash') payMatch = (payment === 'Cash');
            else if (PAYMENT_FILTER === 'NonCash') payMatch = (payment !== 'Cash');
            return catMatch && payMatch && payerMatch;
        });

        const categoryNameMap = {
            Food: '餐飲', Transport: '交通', Accommodation: '住宿',
            Shopping: '購物', Ticket: '門票', Other: '其他', Purchasing: '代購'
        };

        list.innerHTML = data.map(e => {
            const twd = e.currency==='JPY' ? Math.round(e.amount*EXCHANGE_RATE_JPY_TWD) : e.amount;
            const iconMap = { Food: 'fa-utensils', Transport: 'fa-train', Accommodation: 'fa-bed', Shopping: 'fa-bag-shopping', Ticket: 'fa-ticket', Other: 'fa-shapes', Purchasing: 'fa-cart-plus' };
            const imageHtml = e.imageUrl ? `<img src="${e.imageUrl}" class="w-12 h-12 object-cover rounded-lg mr-3 border border-gray-200 cursor-pointer" onclick="event.stopPropagation(); window.openImagePreview(this.src)">` : `<div class="w-12 h-12 rounded-full bg-pink-100 flex items-center justify-center mr-3 text-custom-primary"><i class="fa-solid ${iconMap[e.category]||'fa-circle'}"></i></div>`;
            const catName = categoryNameMap[e.category] || e.category;

            let splitIcon = '';
            if (e.splitType === 'personal') {
                const ben = e.beneficiaries ? e.beneficiaries[0] : '?';
                splitIcon = `<span class="ml-1 text-[10px] bg-yellow-100 text-yellow-600 px-1.5 py-0.5 rounded"><i class="fa-solid fa-user"></i> ${ben}</span>`;
            } else {
                splitIcon = `<span class="ml-1 text-[10px] bg-blue-100 text-blue-500 px-1.5 py-0.5 rounded"><i class="fa-solid fa-users"></i> 共同</span>`;
            }

            return `<div class="p-4 mb-3 bg-white rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center transition cursor-pointer hover:shadow-md" onclick="window.editExpense('${e.id}')">
                <div class="flex items-center">${imageHtml}<div><div class="flex items-center"><p class="font-bold text-gray-700 mr-1">${e.description}</p>${splitIcon}</div>
                <p class="text-xs text-gray-400">${e.date} · ${e.payer} 付 · <span class="text-custom-secondary">${catName}</span></p></div></div>
                <div class="text-right flex items-center gap-2"><div class="text-right"><p class="font-bold text-custom-danger">${e.currency} ${e.amount.toLocaleString()}</p><p class="text-[10px] text-gray-400">約 TWD $${twd.toLocaleString()}</p></div><button onclick="event.stopPropagation(); window.deleteExpense('${e.id}')" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button></div>
            </div>`;
        }).join('');
        window.updateSettlementSummary();
    };
    
    window.updateSettlementSummary = function() {
        let total = 0;
        let cashTotal = 0, otherTotal = 0;
        
        window.EXPENSES_DATA.forEach(e => {
            const v = e.currency==='JPY' ? e.amount*EXCHANGE_RATE_JPY_TWD : e.amount;
            total += v;
            if(e.payment === 'Cash') cashTotal += v; else otherTotal += v;
        });
        document.getElementById('total-spent').innerText = Math.round(total).toLocaleString();
        
        const cashBtn = document.getElementById('btn-filter-cash');
        const cardBtn = document.getElementById('btn-filter-card');
        if(cashBtn) {
            cashBtn.className = PAYMENT_FILTER === 'Cash' ? "p-3 bg-green-100 shadow-md rounded-2xl border-2 border-green-300 cursor-pointer transition transform scale-105" : "p-3 bg-white shadow-sm rounded-2xl border-2 border-green-100 cursor-pointer hover:bg-green-50 transition relative group";
        }
        if(cardBtn) {
            cardBtn.className = PAYMENT_FILTER === 'NonCash' ? "p-3 bg-purple-100 shadow-md rounded-2xl border-2 border-purple-300 cursor-pointer transition transform scale-105" : "p-3 bg-white shadow-sm rounded-2xl border-2 border-purple-100 cursor-pointer hover:bg-purple-50 transition relative group";
        }

        const cashEl = document.getElementById('cash-paid'), cardEl = document.getElementById('card-paid');
        if(cashEl) cashEl.innerText = Math.round(cashTotal).toLocaleString();
        if(cardEl) cardEl.innerText = Math.round(otherTotal).toLocaleString();
        
        let balanceSheet = {}; 
        window.TRIP_PARTICIPANTS.forEach(p => balanceSheet[p] = { paid: 0, shouldPay: 0 });

        window.EXPENSES_DATA.forEach(e => {
            const val = e.currency==='JPY' ? e.amount*EXCHANGE_RATE_JPY_TWD : e.amount;
            const payer = e.payer;
            
            if (!balanceSheet[payer]) balanceSheet[payer] = { paid: 0, shouldPay: 0 };
            balanceSheet[payer].paid += val;

            const beneficiaries = e.beneficiaries && e.beneficiaries.length > 0 ? e.beneficiaries : window.TRIP_PARTICIPANTS; 
            const splitAmount = val / beneficiaries.length;

            beneficiaries.forEach(ben => {
                if (!balanceSheet[ben]) balanceSheet[ben] = { paid: 0, shouldPay: 0 };
                balanceSheet[ben].shouldPay += splitAmount;
            });
        });

        const resEl = document.getElementById('settlement-result');
        let debtors = [];
        let creditors = [];

        Object.keys(balanceSheet).forEach(p => {
            const net = balanceSheet[p].paid - balanceSheet[p].shouldPay;
            if (net < -1) debtors.push({ name: p, amount: Math.abs(net) }); 
            else if (net > 1) creditors.push({ name: p, amount: net }); 
        });

        if (debtors.length === 0) {
            resEl.innerText = '目前已結清 / 無需分帳';
            resEl.className = "text-lg font-bold text-gray-400";
        } else {
            debtors.sort((a,b) => b.amount - a.amount);
            const debtor = debtors[0];
            resEl.innerText = `${debtor.name} 需再付出 $${Math.round(debtor.amount).toLocaleString()}`;
            resEl.className = "text-lg font-bold text-custom-primary";
        }
    };
    
    window.enableBudgetEdit = () => { document.getElementById('budget-display').classList.add('hidden'); document.getElementById('budget-edit-form').classList.remove('hidden'); document.getElementById('budget-input').focus(); };
    window.cancelBudgetEdit = () => { document.getElementById('budget-display').classList.remove('hidden'); document.getElementById('budget-edit-form').classList.add('hidden'); };
    window.saveBudget = async () => {
        const v = parseFloat(document.getElementById('budget-input').value);
        if(isNaN(v)) return;
        await updateDoc(doc(db, "trips", "currentTrip"), {totalBudget: v});
        window.cancelBudgetEdit();
    };

    window.addParticipant = async () => {
        const input = document.getElementById('new-participant-name');
        const name = input.value.trim();
        if(!name) return;
        if(window.TRIP_PARTICIPANTS.includes(name)) return alert('名字已存在');
        
        const newList = [...window.TRIP_PARTICIPANTS, name];
        await updateDoc(doc(db, "trips", "currentTrip"), { participants: newList });
        input.value = '';
    };

    window.removeParticipant = async (name) => {
        if(!confirm(`確定要移除 ${name} 嗎？\n(注意：之前的記帳紀錄若使用此名字不會被刪除，但會歸類為其他)`)) return;
        const newList = window.TRIP_PARTICIPANTS.filter(p => p !== name);
        await updateDoc(doc(db, "trips", "currentTrip"), { participants: newList });
    };

    window.renderParticipantsUI = () => {
        const list = document.getElementById('participants-list');
        if(!list) return;
        if(window.TRIP_PARTICIPANTS.length === 0) {
            list.innerHTML = '<span class="text-sm text-gray-400">尚無名單，請新增。</span>';
            return;
        }
        list.innerHTML = window.TRIP_PARTICIPANTS.map(p => `
            <div class="inline-flex items-center bg-gray-100 rounded-full px-3 py-1 mr-2 mb-2 border border-gray-200">
                <span class="text-sm font-bold text-gray-700 mr-2">${p}</span>
                <button onclick="window.removeParticipant('${p}')" class="text-gray-400 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
        `).join('');
    };

    // ★★★ 新增：旅程命名與日期摘要功能 ★★★
    window.saveTripName = async () => {
        const name = document.getElementById('trip-name-input').value;
        if(name) {
            await updateDoc(doc(db, "trips", "currentTrip"), { tripName: name });
        }
    };

    window.renderTripSummaryBlock = () => {
        const container = document.getElementById('trip-summary-block');
        if(!container) return;

        let dateStr = '日期未定';
        if (window.ITINERARY_DATA.length > 0) {
            const dates = window.ITINERARY_DATA.map(d => d.date).sort();
            dateStr = `${dates[0]} - ${dates[dates.length - 1]}`;
        }

        container.innerHTML = `
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-pink-400 font-bold mb-1"><i class="fa-regular fa-calendar mr-1"></i> ${dateStr}</p>
                    <h3 class="text-lg font-bold text-gray-700">${CURRENT_TRIP_NAME}</h3>
                </div>
                <div class="bg-pink-100 text-pink-500 w-10 h-10 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-plane"></i>
                </div>
            </div>
        `;
    };

    // --- 慾望清單邏輯 (含數量) ---
    window.addWishlistItem = async function(e) {
        e.preventDefault();
        const name = document.getElementById('wishlist-name').value;
        const price = parseFloat(document.getElementById('wishlist-price').value);
        const cat = document.getElementById('wishlist-category').value;
        const qty = parseInt(document.getElementById('wishlist-quantity').value) || 1;
        const fileIn = document.getElementById('item-camera-input');
        const btn = document.getElementById('add-wishlist-btn');

        if(!name || !price) return;
        btn.innerText = '上傳中...'; btn.disabled = true;

        try {
            let imgUrl = '';
            if(fileIn.files[0]) {
                const sRef = ref(storage, `wishlist/${Date.now()}_${fileIn.files[0].name}`);
                const snap = await uploadBytes(sRef, fileIn.files[0]);
                imgUrl = await getDownloadURL(snap.ref);
            }

            await addDoc(collection(db, "wishlists"), {
                name, price, category: cat, quantity: qty,
                imageUrl: imgUrl, 
                purchased: false,
                status: 'pending', 
                timestamp: serverTimestamp()
            });

            document.getElementById('wishlist-form').reset();
            window.clearItemPhoto();

        } catch(err) {
            console.error(err);
            alert('儲存失敗');
        } finally {
            btn.innerText = '新增清單項目';
            btn.disabled = false;
        }
    };
    
    window.cycleWishlistStatus = async function(id, currentStatus) {
        let nextStatus = 'pending';
        let isPurchased = false;

        if (currentStatus === 'pending') {
            nextStatus = 'bought';
            isPurchased = true;
        } else if (currentStatus === 'bought') {
            nextStatus = 'skipped';
            isPurchased = false; 
        } else {
            nextStatus = 'pending';
            isPurchased = false;
        }

        await updateDoc(doc(db, "wishlists", id), {
            status: nextStatus,
            purchased: isPurchased
        });
    };

    window.deleteWishlistItem = async function(id) { if(confirm('刪除?')) await deleteDoc(doc(db, "wishlists", id)); };
    
    window.filterWishlist = function(cat) {
        WISHLIST_FILTER = cat;
        window.renderWishlist();
    };

    window.renderWishlist = function() {
        const listContainer = document.getElementById('wishlist-list'), filterContainer = document.getElementById('wishlist-filter-buttons');
        if(!listContainer) return;
        const searchText = document.getElementById('wishlist-search')?.value.toLowerCase() || '';
        const cleanText = (text) => (text || '').replace(/['"]/g, '').trim();
        const defaultCats = ['伴手禮', '電器', '3C', '服飾', '藥妝', '其他'];
        const existingCats = window.WISHLIST_DATA.map(i => cleanText(i.category));
        const allCats = ['All', ...new Set([...defaultCats, ...existingCats])].filter(c => c);
        if(filterContainer) { filterContainer.innerHTML = allCats.map(c => `<button onclick="window.filterWishlist('${c}')" class="block-select-btn px-3 py-1 text-xs rounded-full ${c === WISHLIST_FILTER ? 'active-filter' : ''}">${c === 'All' ? '全部' : c}</button>`).join(''); }
        const filteredData = window.WISHLIST_DATA.filter(i => {
            const catMatch = WISHLIST_FILTER === 'All' || cleanText(i.category) === WISHLIST_FILTER;
            const searchMatch = i.name.toLowerCase().includes(searchText);
            return catMatch && searchMatch;
        });
        listContainer.innerHTML = filteredData.map(i => {
            const qtyDisplay = (i.quantity && i.quantity > 1) ? `<span class="ml-2 text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">x${i.quantity}</span>` : '';
            
            let status = i.status;
            if(!status) status = i.purchased ? 'bought' : 'pending'; 
            
            let statusText = '想買';
            let statusClass = 'pending';
            let rowClass = 'bg-white';

            if(status === 'bought') {
                statusText = '已買';
                statusClass = 'purchased';
                rowClass = 'bg-gray-100 opacity-60';
            } else if(status === 'skipped') {
                statusText = '沒買到';
                statusClass = 'skipped';
                rowClass = 'bg-gray-50 opacity-40 grayscale';
            }

            return `
            <div class="p-3 mb-2 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center ${rowClass}">
                <div><p class="font-bold text-gray-700">${i.name} ${qtyDisplay}</p><div class="flex items-center gap-2"><span class="text-[10px] text-white bg-gray-400 px-2 py-0.5 rounded-full">${cleanText(i.category)}</span>${i.imageUrl ? `<span onclick="window.openImagePreview('${i.imageUrl}')" class="text-[#4ECDC4] text-xs underline cursor-pointer hover:opacity-70"><i class="fa-solid fa-image"></i> 查看照片</span>` : ''}</div></div>
                <div class="text-right"><p class="font-bold text-custom-primary">¥${i.price.toLocaleString()}</p>
                <div class="flex justify-end gap-2 mt-1">
                    <button onclick="window.cycleWishlistStatus('${i.id}', '${status}')" class="wishlist-status-btn ${statusClass}">${statusText}</button>
                    <button onclick="window.openEditWishlistModal('${i.id}')" class="text-gray-300 hover:text-blue-400 px-1"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="window.deleteWishlistItem('${i.id}')" class="text-gray-300 hover:text-red-400 px-1"><i class="fa-solid fa-trash-can"></i></button>
                </div></div>
            </div>`;
        }).join('');
    };

    window.openEditWishlistModal = function(id) {
        const item = window.WISHLIST_DATA.find(i => i.id === id); if(!item) return;
        document.getElementById('edit-wishlist-id').value = id;
        document.getElementById('edit-wishlist-name').value = item.name;
        document.getElementById('edit-wishlist-price').value = item.price;
        document.getElementById('edit-wishlist-quantity').value = item.quantity || 1; 
        document.getElementById('edit-wishlist-category').value = (item.category || '').replace(/['"]/g, '').trim();
        document.getElementById('edit-wishlist-old-image').value = item.imageUrl || '';
        document.getElementById('edit-wishlist-file').value = ""; 
        const img = document.getElementById('edit-wishlist-preview'), container = document.getElementById('edit-wishlist-preview-container');
        if (item.imageUrl) { img.src = item.imageUrl; container.classList.remove('hidden'); img.onclick = () => window.openImagePreview(item.imageUrl); } else { container.classList.add('hidden'); }
        window.openModal('editWishlistModal');
    };

    window.saveWishlistUpdate = async function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-wishlist-id').value, file = document.getElementById('edit-wishlist-file').files[0], btn = document.getElementById('save-wishlist-btn');
        const qty = parseInt(document.getElementById('edit-wishlist-quantity').value) || 1;
        btn.innerText = '上傳中...'; btn.disabled = true;
        try {
            let url = document.getElementById('edit-wishlist-old-image').value;
            if(file) { const sRef = ref(storage, `wishlist/updated_${Date.now()}_${file.name}`); const snap = await uploadBytes(sRef, file); url = await getDownloadURL(snap.ref); }
            await updateDoc(doc(db, "wishlists", id), { name: document.getElementById('edit-wishlist-name').value, price: parseFloat(document.getElementById('edit-wishlist-price').value), category: document.getElementById('edit-wishlist-category').value, quantity: qty, imageUrl: url });
            window.closeModal('editWishlistModal');
        } catch(err) { alert('更新失敗'); } finally { btn.innerText = '儲存修改'; btn.disabled = false; }
    };

    window.renderPackingList = function() {
        const container = document.getElementById('packing-list-container'); if (!container) return;
        if (window.PACKING_DATA.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 py-10">行李清單是空的！</p>'; return; }
        container.innerHTML = window.PACKING_DATA.map(item => `
             <div class="p-3 rounded-xl shadow-sm border flex justify-between items-center mb-2 ${item.packed ? 'bg-gray-50' : 'bg-white'}">
                <div class="flex items-center cursor-pointer flex-1" onclick="window.togglePackingStatus('${item.id}', ${item.packed})">
                  <i class="fa-solid ${item.packed ? 'fa-check-circle text-teal-500' : 'fa-circle text-gray-300'} mr-3 text-lg"></i>
                  <div><p class="${item.packed ? 'line-through text-gray-400 italic' : 'text-gray-700 font-bold'}">${item.name}</p><p class="text-xs text-gray-400">${item.category}</p></div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="window.openEditPackingModal('${item.id}')" class="text-gray-300 hover:text-blue-400 p-2"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="window.deletePackingItem('${item.id}')" class="text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>
             </div>`).join('');
    };
    window.togglePackingStatus = async function(id, s) { await updateDoc(doc(db, "packinglist", id), { packed: !s }); };
    window.deletePackingItem = async function(id) { if(confirm('刪除?')) await deleteDoc(doc(db, "packinglist", id)); };
    window.openEditPackingModal = function(id) {
        const item = window.PACKING_DATA.find(i => i.id === id); if(!item) return;
        document.getElementById('edit-packing-id').value = id;
        document.getElementById('edit-packing-name').value = item.name;
        document.getElementById('edit-packing-category').value = item.category || '';
        window.openModal('editPackingModal');
    };
    window.savePackingUpdate = async function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-packing-id').value, name = document.getElementById('edit-packing-name').value.trim(), category = document.getElementById('edit-packing-category').value;
        const btn = document.getElementById('save-packing-btn'); if (!name) return;
        btn.innerText = '儲存中...'; btn.disabled = true;
        try { await updateDoc(doc(db, "packinglist", id), { name, category }); window.closeModal('editPackingModal'); } 
        catch(err) { alert('更新失敗'); } finally { btn.innerText = '儲存修改'; btn.disabled = false; }
    };

    window.addSpot = async function() {
        const name = document.getElementById('new-spot-name').value, desc = document.getElementById('new-spot-desc').value, link = document.getElementById('new-spot-link').value;
        if(!name) return alert('請輸入名稱');
        const btn = document.getElementById('add-spot-btn'), fileIn = document.getElementById('spot-camera-input');
        btn.innerText = '上傳中...'; btn.disabled = true;
        try {
            let imgUrl = '';
            if(fileIn.files[0]) {
                const sRef = ref(storage, `spots/${Date.now()}_${fileIn.files[0].name}`);
                const snap = await uploadBytes(sRef, fileIn.files[0]);
                imgUrl = await getDownloadURL(snap.ref);
            }
            await addDoc(collection(db, "spots"), { name, description: desc, link, imageUrl: imgUrl, createdAt: serverTimestamp() });
            document.getElementById('new-spot-name').value = ''; document.getElementById('new-spot-desc').value = ''; document.getElementById('new-spot-link').value = ''; window.clearPhoto();
        } catch(e) { alert('失敗'); } finally { btn.innerText = '新增景點'; btn.disabled = false; }
    };
    window.renderSpots = function() {
        const container = document.getElementById('spots-list'); if (!container) return;
        container.innerHTML = window.SPOTS_DATA.map(s => {
            const hasLink = s.link && s.link.trim() !== "";
            const clickAction = hasLink ? `onclick="window.open('${s.link}', '_blank')"` : '';
            const cursorClass = hasLink ? 'cursor-pointer hover:opacity-70' : '';
            const titleColor = hasLink ? 'text-custom-secondary underline decoration-2 underline-offset-4 decoration-pink-200' : 'text-gray-700';
            const iconColor = hasLink ? 'text-custom-secondary' : 'text-[#FF8BA7]';
            const imageHtml = s.imageUrl ? `<img src="${s.imageUrl}" class="w-full h-32 object-cover rounded-xl mb-3 border border-gray-100 cursor-pointer" onclick="event.stopPropagation(); window.openImagePreview('${s.imageUrl}')">` : '';
            return `
            <div class="bg-white p-4 rounded-2xl border border-gray-100 mb-4 shadow-sm relative transition hover:shadow-md">
                ${imageHtml}
                <div class="flex justify-between items-start">
                    <div class="flex-1 pr-2">
                        <div class="flex items-center mb-2 transition ${cursorClass}" ${clickAction}>
                            <i class="fa-solid fa-location-dot ${iconColor} text-lg mr-2"></i>
                            <h3 class="font-bold ${titleColor} text-lg tracking-wide">${s.name}</h3>
                            ${hasLink ? '<i class="fa-solid fa-arrow-up-right-from-square text-xs text-gray-300 ml-2"></i>' : ''}
                        </div>
                        ${s.description ? `<div class="bg-[#FFF8F0] p-2 rounded-lg text-sm text-gray-500 mb-2 leading-relaxed tracking-wide">${s.description}</div>` : ''}
                        ${hasLink ? `<a href="${s.link}" target="_blank" onclick="event.stopPropagation()" class="text-gray-400 text-xs flex items-center hover:text-custom-secondary mt-1"><i class="fa-solid fa-link mr-1"></i> 連結已設定 (點擊標題開啟)</a>` : ''}
                    </div>
                    <div class="flex flex-col gap-3 ml-2 pt-1">
                        <button onclick="window.deleteSpot('${s.id}')" class="text-gray-300 hover:text-red-400 transition transform hover:scale-110 p-2"><i class="fa-solid fa-trash-can text-sm"></i></button>
                        <button onclick="window.openEditSpotModal('${s.id}')" class="text-gray-300 hover:text-blue-400 transition transform hover:scale-110 p-2"><i class="fa-solid fa-pen text-sm"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
    };
    window.openEditSpotModal = function(id) {
        const spot = window.SPOTS_DATA.find(s => s.id === id); if(!spot) return;
        document.getElementById('edit-spot-id').value = spot.id; document.getElementById('edit-spot-name').value = spot.name; document.getElementById('edit-spot-desc').value = spot.description || '';
        document.getElementById('edit-spot-link').value = spot.link || ''; document.getElementById('edit-spot-old-image').value = spot.imageUrl || '';
        const img = document.getElementById('edit-photo-preview');
        if (spot.imageUrl) { img.src = spot.imageUrl; img.parentElement.classList.remove('hidden'); img.onclick = () => window.openImagePreview(spot.imageUrl); } else { img.parentElement.classList.add('hidden'); }
        window.openModal('editSpotModal');
    };
    window.saveSpotUpdate = async function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-spot-id').value, file = document.getElementById('edit-spot-file').files[0], btn = document.getElementById('save-spot-btn');
        btn.innerText = '上傳中...'; btn.disabled = true;
        try {
            let url = document.getElementById('edit-spot-old-image').value;
            if(file) { const sRef = ref(storage, `spots/updated_${Date.now()}_${file.name}`); const snap = await uploadBytes(sRef, file); url = await getDownloadURL(snap.ref); }
            await updateDoc(doc(db, "spots", id), { name: document.getElementById('edit-spot-name').value, description: document.getElementById('edit-spot-desc').value, link: document.getElementById('edit-spot-link').value, imageUrl: url });
            window.closeModal('editSpotModal');
        } catch(err) { alert('更新失敗'); } finally { btn.innerText = '儲存修改'; btn.disabled = false; }
    };
    window.deleteSpot = async (id) => { if(confirm('刪除?')) await deleteDoc(doc(db, "spots", id)); };

    // ★★★ 新增：生成行程日期邏輯 ★★★
    window.generateTripDates = async () => {
        const startStr = document.getElementById('trip-start-date').value;
        const days = parseInt(document.getElementById('trip-days').value);
        
        if(!startStr || !days || days <= 0) return alert('請選擇正確的出發日期與天數');

        if(!confirm(`即將建立從 ${startStr} 開始，共 ${days} 天的行程。\n(既有日期的行程內容會保留，但會更新星期幾)`)) return;

        const btn = document.getElementById('generate-trip-btn');
        btn.innerText = '生成中...'; 
        btn.disabled = true;

        try {
            // 使用 Date 物件處理日期計算
            const startParts = startStr.split('-');
            // 注意：月份在 JS Date 中是 0-11，所以要減 1
            const startDate = new Date(startParts[0], startParts[1] - 1, startParts[2]);
            const promises = [];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            for (let i = 0; i < days; i++) {
                // 計算每一天的日期
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                // 格式化成 YYYY-MM-DD (作為 Firebase ID)
                const yyyy = currentDate.getFullYear();
                const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
                const dd = String(currentDate.getDate()).padStart(2, '0');
                const dateId = `${yyyy}-${mm}-${dd}`;
                const dayOfWeek = dayNames[currentDate.getDay()];

                // 使用 setDoc + merge: true，這樣如果那天原本就有排行程，內容不會被洗掉
                const docRef = doc(db, "itineraries", dateId);
                promises.push(setDoc(docRef, {
                    date: dateId,
                    day_of_week: dayOfWeek,
                    // 如果該日期文件不存在，city 預設為 "待定"
                    // 如果存在，因為 merge: true，所以不會覆蓋既有的 city 或 activities
                }, { merge: true }));
            }

            await Promise.all(promises);
            alert('行程日期已更新！請切換到「行程」分頁查看。');
            window.switchMainNav('itinerary-tab'); // 自動跳轉回行程頁

        } catch (err) {
            console.error(err);
            alert('生成失敗，請檢查網路或權限');
        } finally {
            btn.innerText = '生成/更新行程表';
            btn.disabled = false;
        }
    };

    window.generateDateTabs = () => {
        const c = document.getElementById('date-buttons-container'); if(!c) return; c.innerHTML = '';
        window.ITINERARY_DATA.forEach((d, i) => {
            const btn = document.createElement('button'); btn.className = `tab-button ${d.id === ACTIVE_DATE ? 'active' : ''}`;
            btn.innerHTML = `<div class="font-bold">Day ${i+1}</div><div class="text-xs font-normal">${d.date.substring(5)} (${d.day_of_week})</div>`;
            btn.onclick = () => { ACTIVE_DATE = d.id; window.generateDateTabs(); window.renderItinerary(); };
            c.appendChild(btn);
        });
    };
    window.renderItinerary = () => {
        const c = document.getElementById('itinerary-container'); if(!c) return;
        const d = window.ITINERARY_DATA.find(x => x.id === ACTIVE_DATE);
        if(!d || !d.activities?.length) { c.innerHTML = `<div class="m-4 p-6 bg-white rounded-xl shadow-sm text-center border border-pink-100"><p class="text-gray-400">本日尚無行程</p></div>`; return; }
        c.innerHTML = `<div class="mx-4 mt-4 p-4 bg-white rounded-xl shadow-sm border border-pink-100 flex justify-between items-center"><h2 class="text-lg font-bold text-gray-700">${d.city}</h2><span class="bg-pink-50 text-custom-primary px-3 py-1 rounded-full text-sm font-bold">${d.date}</span></div><div class="timeline-container p-4">` + d.activities.map((a, i) => {
            const icon = a.title.includes('餐')?'fa-utensils':a.title.includes('宿')?'fa-bed':'fa-location-dot';
            const linkBtn = a.link ? `<a href="${a.link}" target="_blank" onclick="event.stopPropagation()" class="text-custom-secondary text-sm ml-2 hover:underline">(地圖 <i class="fa-solid fa-map-location-dot"></i>)</a>` : '';
            return `<div class="flex items-start mb-6 group" onclick="window.openEditModal('${d.id}', ${i})"><div class="w-1/4 text-sm font-bold text-gray-400 pt-1 text-center font-mono bg-gray-50 rounded-lg mr-3">${a.time}</div><div class="flex-1 bg-white p-3 rounded-xl shadow-sm border border-gray-100 relative z-10"><div class="timeline-item relative !pl-0"><span class="absolute -left-[2.1rem] top-2 h-4 w-4 rounded-full bg-custom-primary border-4 border-white timeline-dot z-20"></span><div class="font-bold text-gray-700 mb-1"><i class="fa-solid ${icon} text-custom-primary mr-2"></i>${a.title}${linkBtn}</div><div class="text-sm text-gray-500 ml-8">${a.location||''}</div></div></div></div>`;
        }).join('') + '</div>';
    };
    window.addItineraryItem = async (e) => {
        e.preventDefault();
        const dId = document.getElementById('new-date').value, act = { time: document.getElementById('new-time').value, title: document.getElementById('new-title').value, location: document.getElementById('new-note').value, link: document.getElementById('new-link').value, notes: '' };
        if(!dId||!act.time||!act.title) return;
        const d = window.ITINERARY_DATA.find(x=>x.id===dId);
        if(d) { await updateDoc(doc(db,'itineraries',dId), {activities: [...(d.activities||[]), act].sort((a,b)=>a.time.localeCompare(b.time))}); window.closeModal('addItineraryModal'); document.getElementById('add-itinerary-form').reset(); }
    };
    window.populateItineraryModalDates = () => { const s = document.getElementById('new-date'); if(!s) return; s.innerHTML = window.ITINERARY_DATA.map(d=>`<option value="${d.id}" ${d.id===ACTIVE_DATE?'selected':''}>${d.date.substring(5)} - ${d.city}</option>`).join(''); };
    window.openEditModal = (dId, idx) => {
        const d = window.ITINERARY_DATA.find(x=>x.id===dId); const act = d.activities[idx];
        document.getElementById('edit-modal-date-info').textContent = `${d.city} ${d.date}`;
        document.getElementById('edit-date-key').value = dId; document.getElementById('edit-item-index').value = idx;
        document.getElementById('edit-time').value = act.time; document.getElementById('edit-title').value = act.title; document.getElementById('edit-note').value = act.location||''; document.getElementById('edit-link').value = act.link||'';
        window.openModal('editItineraryModal');
    };
    window.saveItineraryItem = async (e) => {
        e.preventDefault();
        const dId = document.getElementById('edit-date-key').value, idx = document.getElementById('edit-item-index').value;
        const d = window.ITINERARY_DATA.find(x=>x.id===dId); const acts = [...d.activities];
        acts[idx] = { ...acts[idx], time: document.getElementById('edit-time').value, title: document.getElementById('edit-title').value, location: document.getElementById('edit-note').value, link: document.getElementById('edit-link').value };
        await updateDoc(doc(db,'itineraries',dId), {activities: acts.sort((a,b)=>a.time.localeCompare(b.time))}); window.closeModal('editItineraryModal');
    };
    window.deleteItineraryItem = async (dId, idx) => { if(!confirm('刪除?')) return; const d = window.ITINERARY_DATA.find(x=>x.id===dId); await updateDoc(doc(db,'itineraries',dId), {activities: d.activities.filter((_,i)=>i!==parseInt(idx))}); window.closeModal('editItineraryModal'); };

    window.switchMainNav = (tid) => {
        document.querySelectorAll('.main-tab-content').forEach(e => {
            e.classList.add('hidden');
            e.style.display = 'none'; // 確保加上 inline style 隱藏
        });
        document.querySelectorAll('.main-nav-btn').forEach(b => b.classList.remove('active'));
        const target = document.getElementById(tid);
        if(target) {
            target.classList.remove('hidden');
            target.style.display = ''; // ★關鍵：把 inline style 清空，讓它顯示出來
        }
        document.querySelector(`.main-nav-btn[data-target="${tid}"]`).classList.add('active');
        if(tid==='packing-tab') window.renderPackingList();
        if(tid==='wishlist-tab') window.renderWishlist();
        if(tid==='expense-tab') window.renderExpenseTracking();
        if(tid==='overview-tab') window.renderSpots();
    };

    document.addEventListener('DOMContentLoaded', () => { 
        // ★★★ 修改：預設開啟總覽頁面 (因為總覽移到了第一個) ★★★
        window.switchMainNav('overview-tab'); 
        window.scrollTo(0, 0);
        startDataSync(); 
        const now = new Date();
        const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        const dateInput = document.getElementById('expense-date');
        if(dateInput) dateInput.value = localDate;
    });
</script>
</head>
<body class="bg-gray-50 font-sans">

    <!-- ★★★ 新增：圖片預覽 Lightbox (預設隱藏) ★★★ -->
    <div id="imagePreviewModal" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-all" onclick="window.closeImagePreview()">
        <img id="preview-full-image" src="" class="max-w-full max-h-[85vh] rounded-2xl shadow-2xl transition-transform duration-300 scale-95 hover:scale-100 object-contain" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 focus:outline-none w-12 h-12 flex items-center justify-center rounded-full bg-white/10 backdrop-blur-md">&times;</button>
    </div>

    <div class="max-w-xl mx-auto bg-white min-h-screen shadow-2xl overflow-hidden rounded-none sm:rounded-3xl sm:my-8 border border-gray-100">

        <header class="p-4 bg-white border-b border-gray-100 sticky top-0 z-10 shadow-sm">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-700 flex items-center tracking-wide">
                    <i class="fa-solid fa-plane-departure text-custom-primary mr-2 transform -rotate-12"></i> 
                    <!-- ★★★ 動態標題 ★★★ -->
                    <span id="header-trip-name">My Travel History</span>
                </h1>
                <div class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-lg">
                    匯率: <span id="exchange-rate-display" class="font-bold text-custom-secondary text-base">0.2150</span>
                </div>
            </div>
        </header>

        <!-- ★★★ 修改：導覽列順序調整 (總覽移至最前) ★★★ -->
        <nav id="main-nav" class="flex justify-around border-b border-gray-100 text-sm sticky top-[72px] bg-white/95 backdrop-blur-sm z-10 shadow-sm">
            <button class="main-nav-btn active" data-target="overview-tab" onclick="window.switchMainNav('overview-tab')"><i class="fa-solid fa-star"></i><br>總覽</button>
            <button class="main-nav-btn" data-target="itinerary-tab" onclick="window.switchMainNav('itinerary-tab')"><i class="fa-solid fa-map-location-dot"></i><br>行程</button>
            <button class="main-nav-btn" data-target="expense-tab" onclick="window.switchMainNav('expense-tab')"><i class="fa-solid fa-wallet"></i><br>記帳</button>
            <button class="main-nav-btn" data-target="wishlist-tab" onclick="window.switchMainNav('wishlist-tab')"><i class="fa-solid fa-gift"></i><br>清單</button>
            <button class="main-nav-btn" data-target="packing-tab" onclick="window.switchMainNav('packing-tab')"><i class="fa-solid fa-suitcase"></i><br>打包</button>
        </nav>
        
        <!-- 行程天氣總覽區塊 -->
        <div class="bg-white p-2 rounded-3xl shadow-lg m-4 mb-2 border-2 border-pink-100">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa-solid fa-cloud-sun-rain text-custom-primary mr-2"></i> 行程天氣總覽 (tenki.jp)
            </h2>
            <div class="flex justify-around items-stretch mb-4 space-x-2 flex-wrap sm:flex-nowrap">
                <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm mb-3 sm:mb-0"><p class="text-sm font-semibold text-gray-700 mb-1">福岡 (26日)</p><i class="fa-solid fa-cloud-sun-rain text-3xl text-custom-primary mb-1"></i><p class="text-lg font-bold text-gray-800">8°C / 13°C</p><p class="text-xs text-red-500 mt-1">降雨率: 20%</p></div>
                <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm mb-3 sm:mb-0"><p class="text-sm font-semibold text-gray-700 mb-1">長崎 (27-28日)</p><i class="fa-solid fa-sun text-3xl text-orange-400 mb-1"></i> <p class="text-lg font-bold text-gray-800">5°C / 10°C</p><p class="text-xs text-gray-500 mt-1">降雨率: 0%</p></div>
                <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm"><p class="text-sm font-semibold text-gray-700 mb-1">熊本 (29-31日)</p><i class="fa-solid fa-cloud-showers-heavy text-3xl text-custom-secondary mb-1"></i><p class="text-lg font-bold text-gray-800">3°C / 9°C</p><p class="text-xs text-red-500 mt-1">降雨率: 40%</p></div>
            </div>
            <a href="https://www.tenki.jp/" target="_blank" class="w-full block text-center bg-gray-100 text-gray-700 p-3 rounded-2xl font-semibold hover:bg-gray-200 transition duration-200 text-sm"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> 點擊查看 tenki.jp 詳細預報</a>
        </div>

        <main id="app-content" class="pb-24 bg-[#FFFDF9]">

            <!-- 1. 行程 TAB -->
            <div id="itinerary-tab" class="main-tab-content hidden">
                <div id="date-buttons-container" class="flex p-4 overflow-x-auto whitespace-nowrap border-b border-gray-100 bg-white no-scrollbar"></div>
                <div id="itinerary-container"></div>
                <button onclick="window.openModal('addItineraryModal')" class="fixed right-6 bottom-6 w-14 h-14 rounded-full bg-custom-primary text-white shadow-xl flex items-center justify-center text-2xl hover:bg-custom-primary-dark z-20 transition transform hover:scale-110">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- 2. 記帳 TAB -->
            <div id="expense-tab" class="main-tab-content hidden p-4" style="display: none;">
                <div class="flex mb-4 p-1.5 bg-gray-100 rounded-2xl">
                    <button id="tab-add-expense-btn" class="flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-gray-500 shadow-sm transition-all" onclick="window.switchExpenseView('add')"><i class="fa-solid fa-pen mr-1"></i> 記一筆</button>
                    <button id="tab-view-details-btn" class="flex-1 py-2.5 rounded-xl text-sm font-bold text-gray-500 hover:bg-white/50 transition-all" onclick="window.switchExpenseView('details')"><i class="fa-solid fa-list mr-1"></i> 查明細</button>
                </div>
                <!-- 記帳表單 -->
                <div id="add-expense-container" class="hidden bg-white p-5 rounded-3xl shadow-sm border border-pink-100">
                    <form onsubmit="event.preventDefault(); window.addExpense();">
                        <label class="block mb-1 text-sm font-bold text-gray-500">日期</label>
                        <input type="date" id="expense-date" value="2024-05-18" class="w-full p-3 mb-4 font-bold border-0 bg-gray-50 rounded-xl" required>
                        <label class="block mb-1 text-sm font-bold text-gray-500">金額 & 幣別</label>
                        <div class="flex items-center gap-2 mb-4">
                            <input type="number" step="0.01" id="expense-amount" placeholder="0" class="flex-1 min-w-0 p-3 text-xl font-bold border-0 bg-gray-50 rounded-xl" required>
                            <div id="expense-currency-select" class="flex shrink-0">
                                <button type="button" class="block-select-btn active-filter !mr-1 !mb-0 px-4" data-currency="TWD" onclick="window.selectCurrency('TWD')">TWD</button>
                                <button type="button" class="block-select-btn !mr-0 !mb-0 px-4" data-currency="JPY" onclick="window.selectCurrency('JPY')">JPY</button>
                            </div>
                            <input type="hidden" id="expense-currency" value="TWD">
                        </div>
                        <label class="block mb-1 text-sm font-bold text-gray-500">用途</label>
                        <input type="text" id="expense-description" placeholder="例如: 一蘭拉麵" class="w-full p-3 mb-4 border-0 bg-gray-50 rounded-xl" required>
                        <label class="block mb-2 text-sm font-bold text-gray-500">誰付錢?</label>
                        
                        <!-- 動態生成付款人選項 -->
                        <div id="expense-payer-select" class="flex mb-4 gap-1 overflow-x-auto no-scrollbar">
                            <!-- JS will populate this -->
                        </div>
                        <input type="hidden" id="expense-payer" value="Josh">

                        <!-- 分帳模式與人頭選擇 -->
                        <label class="block mb-2 text-sm font-bold text-gray-500">分帳方式 (誰該付這筆錢?)</label>
                        <div class="bg-gray-50 p-3 rounded-xl mb-4 border-2 border-dashed border-gray-200">
                            <div id="expense-split-type-select" class="flex gap-2 mb-3">
                                <button type="button" class="flex-1 py-1.5 px-3 rounded-lg text-sm font-bold bg-white border border-gray-200 active-split-type transition shadow-sm" data-type="shared" onclick="window.selectSplitType('shared')"><i class="fa-solid fa-users mr-1"></i> 共同分擔</button>
                                <button type="button" class="flex-1 py-1.5 px-3 rounded-lg text-sm font-bold bg-white border border-gray-200 transition shadow-sm" data-type="personal" onclick="window.selectSplitType('personal')"><i class="fa-solid fa-user mr-1"></i> 個人獨享</button>
                            </div>
                            <div id="expense-beneficiaries-container" class="flex flex-wrap">
                                <!-- JS will populate buttons here -->
                            </div>
                        </div>

                        <label class="block mb-2 text-sm font-bold text-gray-500">類別</label>
                        <div id="expense-category-select" class="grid grid-cols-3 gap-2 mb-4">
                            <button type="button" class="w-full block-select-btn active-filter !m-0" data-category="Food" onclick="window.selectCategory('Food')">餐飲</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Transport" onclick="window.selectCategory('Transport')">交通</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Accommodation" onclick="window.selectCategory('Accommodation')">住宿</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Shopping" onclick="window.selectCategory('Shopping')">購物</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Ticket" onclick="window.selectCategory('Ticket')">門票</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Other" onclick="window.selectCategory('Other')">其他</button>
                            <button type="button" class="w-full block-select-btn !m-0" data-category="Purchasing" onclick="window.selectCategory('Purchasing')">代購</button>
                            <input type="hidden" id="expense-category" value="Food">
                        </div>
                        <label class="block mb-2 text-sm font-bold text-gray-500">支付</label>
                        <div id="expense-payment-select" class="flex mb-6 gap-2">
                            <button type="button" class="flex-1 block-select-btn active-filter !m-0" data-payment="Cash" onclick="window.selectPayment('Cash')">現金</button>
                            <button type="button" class="flex-1 block-select-btn !m-0" data-payment="Card" onclick="window.selectPayment('Card')">信用卡</button>
                            <button type="button" class="flex-1 block-select-btn !m-0" data-payment="Paypay" onclick="window.selectPayment('Paypay')">Paypay</button>
                        </div>
                        <input type="hidden" id="expense-payment" value="Cash">
                        <input type="file" id="expense-camera-input" accept="image/*" class="hidden" onchange="window.previewExpenseImage(this)">
                        <button type="button" onclick="document.getElementById('expense-camera-input').click()" class="w-full p-2 mb-2 text-sm font-bold text-pink-500 bg-pink-50 rounded-xl border border-pink-100"><i class="fa-solid fa-camera"></i> 拍照 (選填)</button>
                        <div id="expense-photo-preview-container" class="hidden mb-3"><img id="expense-photo-preview" src="" class="object-cover w-full h-40 border-2 border-pink-100 rounded-xl"><button type="button" onclick="window.clearExpensePhoto()" class="block w-full mt-1 text-xs text-red-400 underline">移除照片</button></div>
                        <button type="submit" id="add-expense-btn" class="w-full p-4 font-bold text-white transition bg-custom-secondary rounded-2xl shadow-lg active:scale-95">確認紀錄</button>
                    </form>
                </div>
                <div id="expense-details-container">
                    <div class="p-5 mb-6 border border-blue-100 shadow-inner bg-gradient-to-br from-blue-50 to-purple-50 rounded-3xl">
                        <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                            <div class="p-3 bg-white shadow-sm rounded-2xl"><div id="budget-display-container"><p class="mb-1 text-xs text-gray-400">總預算</p><div class="flex items-center"><p id="budget-display" class="text-2xl font-bold text-gray-700 cursor-pointer" onclick="window.enableBudgetEdit()">$ <span id="total-budget">0</span></p><i class="ml-2 text-sm text-gray-400 cursor-pointer fa-solid fa-pen-to-square" onclick="window.enableBudgetEdit()"></i></div><div id="budget-edit-form" class="hidden flex items-center mt-1"><input type="number" id="budget-input" class="w-20 border-b p-1 mr-1 text-sm"><button onclick="window.saveBudget()" class="text-custom-primary"><i class="fa-solid fa-check"></i></button></div></div></div>
                            <div class="p-3 bg-white shadow-sm rounded-2xl"><p class="mb-1 text-xs text-gray-400">已支出 (TWD)</p><p class="text-2xl font-bold text-custom-danger">$ <span id="total-spent">0</span></p></div>
                            
                            <!-- 動態生成付款人統計卡片 -->
                            <div id="payer-summary-container" class="col-span-2 grid grid-cols-2 gap-3">
                                <!-- JS will populate this -->
                            </div>
                            
                            <!-- 加上 ID 和 onclick 事件 (付款方式) -->
                            <div id="btn-filter-cash" onclick="window.filterExpensePayment('Cash')" class="p-3 bg-white shadow-sm rounded-2xl border-2 border-green-100 cursor-pointer hover:bg-green-50 transition relative group">
                                <p class="mb-1 text-sm font-bold text-green-500 flex justify-between items-center">現金支付 <i class="fa-solid fa-filter opacity-0 group-hover:opacity-50 text-xs"></i></p>
                                <p class="text-2xl font-bold text-gray-700">$ <span id="cash-paid">0</span></p>
                            </div>
                            <div id="btn-filter-card" onclick="window.filterExpensePayment('NonCash')" class="p-3 bg-white shadow-sm rounded-2xl border-2 border-purple-100 cursor-pointer hover:bg-purple-50 transition relative group">
                                <p class="mb-1 text-sm font-bold text-purple-500 flex justify-between items-center">刷卡/Paypay <i class="fa-solid fa-filter opacity-0 group-hover:opacity-50 text-xs"></i></p>
                                <p class="text-2xl font-bold text-gray-700">$ <span id="card-paid">0</span></p>
                            </div>
                        </div>
                        <div class="p-2 text-center bg-white border-t border-blue-100 rounded-xl"><p class="mb-1 text-xs text-gray-400">結算建議</p><p id="settlement-result" class="text-lg font-bold text-custom-primary">計算中...</p></div>
                    </div>
                    
                    <div class="mb-2"><span class="text-xs font-bold text-gray-400 ml-1">消費類別</span></div>
                    <div id="category-filter-buttons" class="flex flex-wrap gap-2 px-1 pb-2 mb-4 overflow-x-auto no-scrollbar"></div>
                    <div id="expense-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- 3. 慾望清單 TAB -->
            <div id="wishlist-tab" class="main-tab-content hidden p-4" style="display: none;">
                <div class="p-6 mb-6 bg-white border-2 border-pink-100 shadow-lg rounded-3xl">
                    <h3 class="flex items-center mb-4 text-xl font-bold text-gray-700"><i class="mr-2 fa-solid fa-cart-plus text-custom-primary"></i> 新增慾望</h3>
                    <form onsubmit="window.addWishlistItem(event)" id="wishlist-form">
                        <!-- ★★★ 修改：加入 datalist 預設選項 ★★★ -->
                        <input type="text" id="wishlist-name" list="wishlist-suggestions" placeholder="商品名稱" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl" required>
                        <datalist id="wishlist-suggestions">
                            <option value="Panasonic 吹風機">
                            <option value="Dyson 吸塵器">
                            <option value="EVE 止痛藥">
                            <option value="合利他命 EX Plus">
                            <option value="Wakamoto 若元錠">
                            <option value="DHC 維他命C">
                            <option value="UNIQLO 發熱衣">
                            <option value="GU 服飾">
                            <option value="白色戀人">
                            <option value="東京香蕉">
                            <option value="一蘭拉麵泡麵">
                            <option value="KitKat 巧克力">
                        </datalist>

                        <div class="flex gap-2 mb-3"><input type="number" id="wishlist-price" placeholder="價格 (JPY)" class="flex-1 p-3 border-0 bg-gray-50 rounded-xl" required>
                            <!-- ★★★ 新增：數量欄位 (預設 1) ★★★ -->
                            <input type="number" id="wishlist-quantity" placeholder="數量" class="w-20 p-3 border-0 bg-gray-50 rounded-xl text-center" value="1" min="1">
                        </div>
                        <div class="relative mb-3">
                             <select id="wishlist-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl"><option value="伴手禮">🎁 伴手禮</option><option value="電器">⚡ 電器</option><option value="3C">📱 3C</option><option value="服飾">👕 服飾</option><option value="藥妝">💊 藥妝</option><option value="其他">✨ 其他</option></select><i class="absolute top-4 right-4 text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i>
                        </div>
                        <input type="file" id="item-camera-input" accept="image/*" class="hidden" onchange="window.previewItemImage(this)"><button type="button" onclick="document.getElementById('item-camera-input').click()" class="w-full p-2 mb-2 text-sm font-bold text-pink-500 bg-pink-50 rounded-xl border border-pink-100"><i class="fa-solid fa-camera"></i> 拍照 (選填)</button>
                        <div id="item-photo-preview-container" class="hidden mb-3"><img id="item-photo-preview" src="" class="object-cover w-full h-40 border-2 border-pink-100 rounded-xl"><button type="button" onclick="window.clearItemPhoto()" class="block w-full mt-1 text-xs text-center text-red-400 underline">移除照片</button></div>
                        <button type="submit" id="add-wishlist-btn" class="w-full py-3 font-bold text-white shadow-md bg-custom-primary rounded-xl active:scale-95">新增清單項目</button>
                    </form>
                </div>

                <!-- ★★★ 新增：搜尋功能 ★★★ -->
                <input type="text" id="wishlist-search" placeholder="搜尋清單..." class="w-full p-2 mb-2 border border-pink-100 rounded-xl text-sm" oninput="window.renderWishlist()">
                
                <div id="wishlist-filter-buttons" class="flex flex-wrap gap-2 px-1 pb-2 mb-4 overflow-x-auto no-scrollbar"></div>

                <div id="wishlist-list" class="space-y-3"></div>
            </div>
            
            <!-- 4. 打包清單 TAB -->
            <div id="packing-tab" class="main-tab-content hidden p-4" style="display: none;">
                <div class="p-5 mb-6 bg-white border border-blue-100 shadow-sm rounded-3xl">
                    <h3 class="flex items-center mb-4 text-lg font-bold text-gray-700"><i class="mr-2 fa-solid fa-shirt text-custom-secondary"></i> 新增行李</h3>
                    <form id="packing-form" onsubmit="window.addPackingItem(event)">
                        <div class="flex gap-2 mb-3"><div class="flex-1"><input type="text" id="packing-name" placeholder="護照" class="w-full p-3 border-0 bg-gray-50 rounded-xl" required></div>
                        <div class="w-1/3 relative"><select id="packing-category" class="w-full p-3 bg-gray-50 rounded-xl appearance-none border-0"><option value="證件">🪪 證件</option><option value="衣物">👕 衣物</option><option value="電子">📱 3C</option><option value="藥品">💊 藥品</option><option value="盥洗">🚿 盥洗</option><option value="其他">🧩 其他</option></select><i class="absolute right-3 top-4 text-xs text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i></div></div>
                        <button type="submit" class="w-full p-3 font-bold text-white bg-custom-secondary rounded-2xl shadow-lg">加入行李箱</button>
                    </form>
                </div>
                <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center px-2"><i class="fa-solid fa-clipboard-check mr-2 text-custom-primary"></i> 檢查清單</h3>
                <div id="packing-list-container" class="space-y-2"></div>
            </div>

            <!-- 5. 總覽 TAB -->
            <div id="overview-tab" class="main-tab-content hidden p-4">
                
                <!-- ★★★ 新增：旅程資訊卡片 (最上方) ★★★ -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-orange-100 mb-6 relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-orange-50 rounded-full opacity-50 pointer-events-none"></div>
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center relative z-10">
                        <i class="fa-solid fa-map-location text-orange-400 text-xl mr-2"></i> 旅程資訊
                    </h3>
                    
                    <!-- 旅程名稱輸入 -->
                    <div class="mb-4 relative z-10">
                        <label class="text-xs text-gray-400 block mb-1 font-bold">旅程名稱 (為這次旅行命名)</label>
                        <div class="flex gap-2">
                            <input type="text" id="trip-name-input" placeholder="例如: 2024 東京大爆買" class="flex-1 p-3 bg-orange-50 border-0 rounded-xl font-bold text-gray-700 focus:ring-2 focus:ring-orange-200 outline-none" onchange="window.saveTripName()">
                        </div>
                    </div>

                    <!-- 旅程歷史顯示區塊 (日期+標題) -->
                    <div id="trip-summary-block" class="bg-white border-l-4 border-orange-400 p-4 rounded-r-xl shadow-sm relative z-10">
                        <!-- JS will populate this with Date - Title -->
                        <p class="text-sm text-gray-400">載入行程日期中...</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-6 text-center border border-yellow-100 bg-yellow-50 rounded-3xl shadow-sm"><i class="block mb-2 text-2xl text-yellow-500 fa-regular fa-calendar"></i><p class="mb-1 text-xs font-bold text-yellow-700 uppercase">Duration</p><p class="text-2xl font-bold font-mono"><span id="overview-duration-display">0</span> Days</p></div>
                    <div class="p-6 text-center border border-green-100 bg-green-50 rounded-3xl shadow-sm"><i class="block mb-2 text-2xl text-green-500 fa-solid fa-sack-dollar"></i><p class="mb-1 text-xs font-bold text-green-700 uppercase">Budget</p><p class="text-2xl font-bold font-mono">$<span id="overview-budget-display">0</span></p></div>
                </div>
                
                <!-- 旅程夥伴設定區塊 -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-blue-100 mb-6 relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-50 rounded-full opacity-50 pointer-events-none"></div>
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center relative z-10">
                        <i class="fa-solid fa-user-group text-blue-400 text-xl mr-2"></i> 旅程夥伴設定
                    </h3>
                    <div class="flex gap-2 mb-3 relative z-10">
                        <input type="text" id="new-participant-name" placeholder="輸入名字..." class="flex-1 p-3 bg-blue-50 border-0 rounded-xl font-bold text-gray-700 focus:ring-2 focus:ring-blue-200 outline-none">
                        <button onclick="window.addParticipant()" class="w-12 bg-blue-400 text-white font-bold rounded-xl shadow-md hover:bg-blue-500 transition active:scale-95"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="participants-list" class="relative z-10"></div>
                </div>

                <!-- 行程日期設定區塊 -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-purple-100 mb-6 relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-purple-50 rounded-full opacity-50 pointer-events-none"></div>
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center relative z-10">
                        <i class="fa-regular fa-calendar-check text-purple-400 text-xl mr-2"></i> 設定旅程日期
                    </h3>
                    <div class="flex gap-3 mb-4 relative z-10">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1 font-bold">出發日期</label>
                            <input type="date" id="trip-start-date" class="w-full p-3 bg-purple-50 border-0 rounded-xl font-bold text-gray-700 focus:ring-2 focus:ring-purple-200 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-gray-400 block mb-1 font-bold">天數</label>
                            <input type="number" id="trip-days" value="5" min="1" class="w-full p-3 bg-purple-50 border-0 rounded-xl font-bold text-center text-gray-700 focus:ring-2 focus:ring-purple-200 outline-none">
                        </div>
                    </div>
                    <button onclick="window.generateTripDates()" id="generate-trip-btn" class="w-full p-3 bg-purple-400 text-white font-bold rounded-xl shadow-md hover:bg-purple-500 transition active:scale-95 relative z-10">
                        生成/更新行程表
                    </button>
                    <p class="text-[10px] text-gray-400 mt-2 text-center relative z-10">* 若日期已有行程，不會刪除內容，僅更新日期順序。</p>
                </div>
 
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-green-100 mb-6">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fa-solid fa-calculator text-custom-secondary mr-2"></i> 簡易換算</h3>
                    <div class="flex items-center gap-3">
                        <div class="flex-1"><label class="text-xs text-gray-400 block mb-1">日幣 (JPY)</label><input type="number" id="calc-jpy" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-lg border-2 border-gray-100" placeholder="0" oninput="window.calculateTwd()"></div>
                        <i class="fa-solid fa-arrow-right text-gray-300 mt-4"></i>
                        <div class="flex-1"><label class="text-xs text-gray-400 block mb-1">台幣 (TWD)</label><div id="calc-twd" class="w-full p-3 bg-green-50 text-custom-secondary rounded-xl font-bold text-lg border-2 border-green-100 flex items-center h-[54px]">0</div></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-right">匯率: <span id="calc-rate-display" class="font-bold text-custom-primary">0.2150</span></p>
                </div>
                <div class="p-6 mb-6 bg-white border border-pink-100 shadow-sm rounded-3xl">
                    <div class="flex items-center mb-4"><i class="fa-solid fa-location-dot text-[#FF8BA7] text-lg mr-2"></i><h2 class="text-lg font-bold text-gray-700">想去地點清單</h2></div>
                    <div class="space-y-3">
                        <input type="text" id="new-spot-name" placeholder="景點名稱 (必填)" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                        <input type="text" id="new-spot-desc" placeholder="簡單附註 (選填)" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                        <input type="text" id="new-spot-link" placeholder="Google Map 連結" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                        <input type="file" id="spot-camera-input" accept="image/*" class="hidden" onchange="window.previewImage(this)"><button type="button" onclick="document.getElementById('spot-camera-input').click()" class="w-full p-3 font-bold text-gray-500 bg-gray-100 rounded-xl transition hover:bg-gray-200"><i class="fa-solid fa-camera"></i> 點我拍照或選照片</button>
                        <div id="photo-preview-container" class="relative hidden mt-1"><img id="photo-preview" src="" class="object-cover w-full h-40 border-2 border-gray-200 rounded-xl cursor-pointer hover:opacity-80 transition" onclick="window.open(this.src, '_blank')" title="點擊查看原圖"><button type="button" onclick="window.clearPhoto()" class="absolute top-2 right-2 flex items-center justify-center w-7 h-7 text-white bg-red-400 rounded-full shadow top-2 right-2"><i class="fa-solid fa-xmark"></i></button></div>
                        <button onclick="window.addSpot()" id="add-spot-btn" class="w-full p-3 font-bold text-white bg-[#FF8BA7] rounded-xl shadow-md active:scale-95">新增景點</button>
                    </div>
                </div>
                <div id="spots-list" class="space-y-4"></div>
            </div>
            
        </main>
    </div>

    <!-- Modals -->
    <div id="addItineraryModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('addItineraryModal')">
        <div class="w-full max-w-sm p-6 transition-all transform bg-white shadow-2xl rounded-3xl scale-100" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-6 text-xl font-bold text-gray-700">新增行程<button onclick="window.closeModal('addItineraryModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 bg-gray-100 rounded-full"><i class="fa-solid fa-xmark"></i></button></h3>
            <form id="add-itinerary-form" onsubmit="window.addItineraryItem(event)">
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">哪一天?</label><div class="relative mb-3"><select id="new-date" class="w-full p-3 font-bold border-0 appearance-none bg-gray-50 rounded-xl text-gray-700" required></select><i class="absolute pointer-events-none fa-solid fa-chevron-down right-4 top-4 text-gray-400"></i></div>
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">幾點?</label><input type="time" id="new-time" class="w-full p-3 mb-3 text-lg font-bold text-center border-0 bg-gray-50 rounded-xl text-gray-700" required>
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">做什麼?</label><input type="text" id="new-title" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl text-gray-700" required>
                <!-- Add Link Field -->
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">地圖連結</label>
                <input type="text" id="new-link" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl text-gray-700" placeholder="貼上 Google Maps 網址">
                <!-- End Add Link Field -->
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">備註</label><textarea id="new-note" rows="3" class="w-full p-3 mb-6 border-0 bg-gray-50 rounded-xl text-gray-700"></textarea>
                <button type="submit" class="w-full p-3 font-bold text-white shadow-lg bg-custom-primary rounded-2xl hover:bg-custom-primary-dark">完成</button>
            </form>
        </div>
    </div>

    <div id="editItineraryModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editItineraryModal')">
        <div class="w-full max-w-sm p-6 bg-white shadow-2xl rounded-3xl" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-2 text-xl font-bold text-gray-700">編輯行程<button onclick="window.closeModal('editItineraryModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 transition bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            <p id="edit-modal-date-info" class="inline-block px-3 py-1 mb-6 text-sm font-bold rounded-lg text-custom-primary bg-pink-50"></p>
            <form id="edit-itinerary-form" onsubmit="window.saveItineraryItem(event)">
                <input type="hidden" id="edit-date-key"><input type="hidden" id="edit-item-index">
                <input type="time" id="edit-time" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>
                <input type="text" id="edit-title" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl" required>
                <input type="text" id="edit-link" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl" placeholder="地圖連結">
                <textarea id="edit-note" rows="3" class="w-full p-3 mb-6 border-0 bg-gray-50 rounded-xl"></textarea>
                <div class="flex space-x-3"><button type="button" onclick="window.deleteItineraryItem(document.getElementById('edit-date-key').value, document.getElementById('edit-item-index').value)" class="flex-1 p-3 font-bold text-red-400 transition bg-white border-2 border-red-100 rounded-2xl hover:bg-red-50">刪除</button><button type="submit" class="flex-[2] p-3 font-bold text-white transition shadow-lg bg-custom-primary rounded-2xl">儲存</button></div>
            </form>
        </div>
    </div>

    <!-- 編輯支出 Modal (已修復支付方式顯示問題、圖片上傳與滑動) -->
    <div id="editExpenseModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="window.closeModal('editExpenseModal')">
        <!-- ★★★ 修改：加入 max-h-[90vh] 和 overflow-y-auto 以修復滑動問題 ★★★ -->
        <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-4 text-gray-700 flex items-center"><i class="fa-solid fa-pen-to-square text-custom-primary mr-2"></i> 編輯支出</h3>
            <form onsubmit="window.saveExpenseUpdate(event)">
                <input type="hidden" id="edit-expense-id">
                <label class="block mb-2 text-sm font-bold">日期</label><input type="date" id="edit-expense-date" class="w-full p-3 border rounded-xl mb-4 bg-gray-50 border-0">
                <label class="block mb-2 text-sm font-bold">金額 & 幣別</label>
                <div class="flex items-center gap-2 mb-4">
                    <input type="number" step="0.01" id="edit-expense-amount" class="flex-1 min-w-0 p-3 border-0 bg-gray-50 rounded-xl font-bold text-lg">
                    <div id="edit-expense-currency-select" class="flex shrink-0">
                        <button type="button" class="block-select-btn !mr-1 !mb-0 px-3" data-currency="TWD" onclick="window.selectEditCurrency('TWD')">TWD</button>
                        <button type="button" class="block-select-btn !mr-0 !mb-0 px-3" data-currency="JPY" onclick="window.selectEditCurrency('JPY')">JPY</button>
                    </div>
                    <input type="hidden" id="edit-expense-currency">
                </div>
                <label class="block mb-2 text-sm font-bold">用途</label><input type="text" id="edit-expense-description" class="w-full p-3 bg-gray-50 border-0 rounded-xl mb-4">
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2 text-sm font-bold">付款人</label>
                        <!-- 動態生成編輯表單付款人選項 -->
                        <div id="edit-expense-payer-select" class="flex gap-1 overflow-x-auto no-scrollbar">
                             <!-- JS will populate this -->
                        </div>
                        <input type="hidden" id="edit-expense-payer">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-bold">支付方式</label>
                        <div id="edit-expense-payment-select" class="flex gap-1">
                            <button type="button" class="block-select-btn !text-xs !p-1 !m-0 !flex-1" data-payment="Cash" onclick="window.selectEditPayment('Cash')">現金</button>
                            <button type="button" class="block-select-btn !text-xs !p-1 !m-0 !flex-1" data-payment="Card" onclick="window.selectEditPayment('Card')">信用卡</button>
                            <button type="button" class="block-select-btn !text-xs !p-1 !m-0 !flex-1" data-payment="Paypay" onclick="window.selectEditPayment('Paypay')">Paypay</button>
                        </div>
                        <input type="hidden" id="edit-expense-payment">
                    </div>
                </div>

                <!-- ★★★ 新增：編輯模式的分帳設定 ★★★ -->
                <label class="block mb-2 text-sm font-bold text-gray-500">分帳方式 (誰該付這筆錢?)</label>
                <div class="bg-gray-50 p-3 rounded-xl mb-4 border-2 border-dashed border-gray-200">
                    <div id="edit-expense-split-type-select" class="flex gap-2 mb-3">
                        <button type="button" class="flex-1 py-1.5 px-3 rounded-lg text-sm font-bold bg-white border border-gray-200 transition shadow-sm" data-type="shared" onclick="window.selectEditSplitType('shared')"><i class="fa-solid fa-users mr-1"></i> 共同分擔</button>
                        <button type="button" class="flex-1 py-1.5 px-3 rounded-lg text-sm font-bold bg-white border border-gray-200 transition shadow-sm" data-type="personal" onclick="window.selectEditSplitType('personal')"><i class="fa-solid fa-user mr-1"></i> 個人獨享</button>
                    </div>
                    <div id="edit-expense-beneficiaries-container" class="flex flex-wrap">
                        <!-- JS will populate buttons here -->
                    </div>
                </div>

                <label class="block mb-2 text-sm font-bold">類別</label>
                <div id="edit-expense-category-select" class="grid grid-cols-3 gap-2 mb-6">
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Food" onclick="window.selectEditCategory('Food')">餐飲</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Transport" onclick="window.selectEditCategory('Transport')">交通</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Accommodation" onclick="window.selectEditCategory('Accommodation')">住宿</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Shopping" onclick="window.selectEditCategory('Shopping')">購物</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Ticket" onclick="window.selectEditCategory('Ticket')">門票</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Other" onclick="window.selectEditCategory('Other')">其他</button>
                    <button type="button" class="block-select-btn !text-xs !p-1 !m-0" data-category="Purchasing" onclick="window.selectEditCategory('Purchasing')">代購</button>
                </div>
                <input type="hidden" id="edit-expense-category">
                <input type="file" id="edit-expense-file" accept="image/*" class="hidden" onchange="window.previewEditExpenseImage(this)">
                <button type="button" onclick="document.getElementById('edit-expense-file').click()" class="w-full p-2 mb-2 text-sm font-bold text-pink-500 bg-pink-50 rounded-xl border border-pink-100"><i class="fa-solid fa-camera"></i> 更換照片</button>
                <input type="hidden" id="edit-expense-old-image">
                <div id="edit-expense-photo-preview-container" class="hidden mb-3 text-center">
                    <img id="edit-expense-photo-preview" src="" class="object-cover w-full h-40 border-2 border-pink-100 rounded-xl mb-2">
                    <button type="button" onclick="window.removeEditExpensePhoto()" class="text-red-500 text-sm font-bold hover:underline">🗑️ 移除照片</button>
                </div>
                
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="window.closeModal('editExpenseModal')" class="px-4 py-2 bg-gray-100 rounded-xl font-bold">取消</button>
                    <button type="submit" id="save-expense-btn" class="px-6 py-2 bg-custom-primary text-white rounded-xl font-bold shadow-md">儲存修改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 編輯景點 Modal -->
    <div id="editSpotModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editSpotModal')">
        <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">編輯景點<button onclick="window.closeModal('editSpotModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            <form onsubmit="window.saveSpotUpdate(event)">
                <input type="hidden" id="edit-spot-id"><input type="hidden" id="edit-spot-old-image">
                <input type="text" id="edit-spot-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>
                <textarea id="edit-spot-desc" rows="2" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl"></textarea>
                <input type="text" id="edit-spot-link" class="w-full p-3 mb-4 text-sm border-0 bg-gray-50 rounded-xl">
                
                <div id="edit-photo-preview-container" class="relative hidden mb-3 text-center">
                    <img id="edit-photo-preview" src="" class="object-cover w-full h-40 border border-gray-200 rounded-xl mb-2">
                    <button type="button" onclick="window.removeEditSpotPhoto()" class="text-red-500 text-sm font-bold hover:underline">🗑️ 移除照片</button>
                </div>

                <button type="button" onclick="document.getElementById('edit-spot-file').click()" class="flex items-center justify-center w-full gap-2 p-2 mb-2 text-sm font-bold text-pink-500 transition border border-pink-100 bg-pink-50 rounded-xl hover:bg-pink-100"><i class="fa-solid fa-camera"></i> 更換照片</button>
                <input type="file" id="edit-spot-file" accept="image/*" class="hidden" onchange="window.previewEditImage(this)">
                <button type="submit" id="save-spot-btn" class="w-full p-3 mt-4 font-bold text-white shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">儲存修改</button>
            </form>
        </div>
    </div>

    <!-- 編輯慾望清單 Modal -->
    <div id="editWishlistModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editWishlistModal')">
        <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">編輯物品<button onclick="window.closeModal('editWishlistModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            
            <form onsubmit="window.saveWishlistUpdate(event)">
                <input type="hidden" id="edit-wishlist-id">
                <input type="hidden" id="edit-wishlist-old-image">

                <label class="block mb-1 text-sm font-bold text-gray-500">名稱</label>
                <input type="text" id="edit-wishlist-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>

                <label class="block mb-1 text-sm font-bold text-gray-500">價格 (JPY)</label>
                <input type="number" id="edit-wishlist-price" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>

                <div class="flex gap-2 mb-3">
                    <div class="flex-1">
                        <label class="block mb-1 text-sm font-bold text-gray-500">數量</label>
                        <input type="number" id="edit-wishlist-quantity" class="w-full p-3 border-0 bg-gray-50 rounded-xl text-center" min="1">
                    </div>
                </div>

                <label class="block mb-1 text-sm font-bold text-gray-500">分類</label>
                <div class="relative mb-3">
                    <select id="edit-wishlist-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl">
                        <option value="伴手禮">🎁 伴手禮</option>
                        <option value="電器">⚡ 電器</option>
                        <option value="3C">📱 3C</option>
                        <option value="服飾">👕 服飾</option>
                        <option value="藥妝">💊 藥妝</option>
                        <option value="其他">✨ 其他</option>
                    </select>
                    <i class="absolute top-4 right-4 text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i>
                </div>

                <div id="edit-wishlist-preview-container" class="relative hidden mb-3 text-center">
                    <p class="mb-1 text-xs text-gray-400">目前圖片：</p>
                    <img id="edit-wishlist-preview" src="" class="object-cover w-full h-40 border border-gray-200 rounded-xl mb-2">
                    <button type="button" onclick="window.removeEditWishlistPhoto()" class="text-red-500 text-sm font-bold hover:underline">🗑️ 移除照片</button>
                </div>

                <button type="button" onclick="document.getElementById('edit-wishlist-file').click()" class="flex items-center justify-center w-full gap-2 p-2 mb-2 text-sm font-bold text-pink-500 transition border border-pink-100 bg-pink-50 rounded-xl hover:bg-pink-100">
                    <i class="fa-solid fa-camera"></i> 更換照片
                </button>
                <input type="file" id="edit-wishlist-file" accept="image/*" class="hidden" onchange="window.previewEditWishlistImage(this)">

                <button type="submit" id="save-wishlist-btn" class="w-full p-3 mt-4 font-bold text-white transition shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">儲存修改</button>
            </form>
        </div>
    </div>

    <!-- 新增：編輯行李清單 Modal -->
    <div id="editPackingModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editPackingModal')">
        <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700"><i class="mr-2 fa-solid fa-pen-to-square text-custom-secondary"></i> 編輯行李項目<button onclick="window.closeModal('editPackingModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 transition bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            
            <form onsubmit="window.savePackingUpdate(event)">
                <input type="hidden" id="edit-packing-id">

                <label class="block mb-1 text-sm font-bold text-gray-500">物品名稱</label>
                <input type="text" id="edit-packing-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>

                <label class="block mb-1 text-sm font-bold text-gray-500">分類</label>
                <div class="relative mb-3">
                    <select id="edit-packing-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl">
                        <option value="證件">🪪 證件</option>
                        <option value="衣物">👕 衣物</option>
                        <option value="電子">📱 3C</option>
                        <option value="藥品">💊 藥品</option>
                        <option value="盥洗">🚿 盥洗</option>
                        <option value="其他">🧩 其他</option>
                    </select>
                    <i class="absolute top-4 right-4 text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i>
                </div>

                <button type="submit" id="save-packing-btn" class="w-full p-3 mt-4 font-bold text-white transition shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">儲存修改</button>
            </form>
        </div>
    </div>
</body>
</html>
