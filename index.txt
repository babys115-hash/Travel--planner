				<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Travel</title>
    <link rel="icon" type="image/png" href="./luggage.png">
    <link rel="apple-touch-icon" href="./luggage.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss" >
        :root {
            --custom-primary: #FF8BA7; /* Sweet Pink */
            --custom-secondary: #4ECDC4; /* Lively Mint */
            --custom-danger: #FF6B6B; /* Soft Coral */
            --custom-bg: #FFFDF9; /* Creamy White */
            --custom-text: #595959; /* Softer Dark Gray */
        }
        body { font-family: 'Zen Maru Gothic', sans-serif !important; color: var(--custom-text); background-color: var(--custom-bg); }
        .bg-gray-50 { background-color: var(--custom-bg) !important; } .bg-white { background-color: #ffffff; }
        .bg-custom-primary { background-color: var(--custom-primary); } .text-custom-primary { color: var(--custom-primary); }
        .bg-custom-secondary { background-color: var(--custom-secondary); } .text-custom-secondary { color: var(--custom-secondary); }
        .border-custom-primary { border-color: var(--custom-primary); }
        .rounded-lg { border-radius: 16px !important; } .rounded-xl { border-radius: 20px !important; }
        
        .tab-button {
            padding: 8px 16px; margin-right: 8px; border-radius: 20px; cursor: pointer; text-align: center;
            transition: all 0.3s; min-width: 80px; font-size: 0.9rem; border: 2px solid #F0F0F0; color: #7D7D7D; background: white; font-weight: bold;
        }
        .tab-button.active { background-color: var(--custom-primary); color: white; border-color: var(--custom-primary); transform: scale(1.05); box-shadow: 0 4px 10px rgba(255, 139, 167, 0.4); }
        
        .main-nav-btn { @apply flex-1 py-4 text-center transition duration-200 text-gray-500 border-b-4 border-transparent; }
        .main-nav-btn i { font-size: 1.2rem; margin-bottom: 2px; display: inline-block; }
        .main-nav-btn.active { color: var(--custom-primary); border-color: var(--custom-primary); font-weight: 800; }
        
        .block-select-btn {
            @apply px-4 py-1 border-2 rounded-full text-sm font-bold transition-all duration-200 mr-2 mb-2 bg-white;
            border-color: #D1D5DB !important; color: #6B7280; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center;
        }
        .block-select-btn:hover:not([class*="active-"]) { border-color: #FF748D; background-color: #FFF1F2; color: #FF748D; }
        
        .active-filter, .active-currency, .active-payer, .active-category, .active-payment {
            background-color: #FF7596!important; border-color: #FF748D !important; color: white !important; @apply shadow-md; transform: scale(1.05);
        }
        
        .timeline-container { position: relative; }
        .timeline-container::before {
            content: ''; position: absolute; top: 30px; bottom: 30px; left: 28.5%; width: 2px;
            background-image: linear-gradient(to bottom, #FFE5EA 50%, transparent 50%); background-size: 2px 10px; z-index: 0;
        }
        .timeline-item { padding-left: 1.5rem; min-height: 20px; cursor: pointer; }
        .timeline-dot { box-shadow: 0 0 0 3px #FFF0F3; }
        
        .wishlist-status-btn { @apply px-3 py-1 rounded-full text-xs font-bold shadow-sm; }
        .wishlist-status-btn.purchased { @apply bg-custom-secondary text-white; }
        .wishlist-status-btn.pending { @apply bg-orange-100 text-orange-600; }
        
        input, select, textarea { border: 2px solid #F3F4F6 !important; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--custom-primary) !important; outline: none; box-shadow: 0 0 0 3px rgba(255, 139, 167, 0.1); }
    </style>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBRjYjvwvCNTRHdI8vH8n3GPabzSnSDbvI",
        authDomain: "jp-b0e03.firebaseapp.com",
        projectId: "jp-b0e03",
        storageBucket: "jp-b0e03.firebasestorage.app", 
        messagingSenderId: "689610031212",
        appId: "1:689610031212:web:f63f2efe61d4ad562bd849",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // 全域變數
    window.ITINERARY_DATA = [];
    window.EXPENSES_DATA = [];
    window.WISHLIST_DATA = [];
    window.PACKING_DATA = [];
    window.SPOTS_DATA = [];
    
    let ACTIVE_DATE = '', ACTIVE_CURRENCY = 'TWD', ACTIVE_PAYER = 'Josh', ACTIVE_CATEGORY = 'Food', ACTIVE_PAYMENT = 'Cash', EXPENSE_FILTER = 'All', WISHLIST_FILTER = 'All', EXCHANGE_RATE_JPY_TWD = 0.215;

    // --- 基礎工具 ---
    window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).style.display = 'flex'; };
    window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).style.display = 'none'; };
    window.editExpense = (id) => window.openEditExpenseModal(id);

    // --- 圖片預覽 ---
    window.previewImage = (input) => {
        if (input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => { document.getElementById('photo-preview').src = e.target.result; document.getElementById('photo-preview-container').classList.remove('hidden'); };
            r.readAsDataURL(input.files[0]);
        }
    };
    window.clearPhoto = () => { document.getElementById('spot-camera-input').value = ""; document.getElementById('photo-preview-container').classList.add('hidden'); };

    // --- 圖片預覽 (慾望清單) ---
    window.previewItemImage = (input) => {
        if (input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => { 
                document.getElementById('item-photo-preview').src = e.target.result; 
                document.getElementById('item-photo-preview-container').classList.remove('hidden'); 
            };
            r.readAsDataURL(input.files[0]);
        }
    };
    window.clearItemPhoto = () => {
        document.getElementById('item-camera-input').value = ""; 
        document.getElementById('item-photo-preview-container').classList.add('hidden'); 
    };

    /* =========================
       數據監聽 (資料同步中心)
    ========================= */
    function startDataSync() {
        updateLiveExchangeRate();

        // 1. 行程
          onSnapshot(query(collection(db, "itineraries"), orderBy("date", "asc")), (snap) => {
            window.ITINERARY_DATA = snap.docs.map(d => ({id: d.id, ...d.data(), activities: d.data().activities?.sort((a,b)=>a.time.localeCompare(b.time))||[]}));
            if(window.ITINERARY_DATA.length > 0 && !ACTIVE_DATE) ACTIVE_DATE = window.ITINERARY_DATA[0].id;
            
            window.generateDateTabs(); 
            window.renderItinerary(); 
            window.populateItineraryModalDates();

            const durationEl = document.getElementById('overview-duration-display');
            if(durationEl) durationEl.innerText = window.ITINERARY_DATA.length;
        });

        // 2. 記帳
        onSnapshot(query(collection(db, "expenses"), orderBy("date", "desc")), (snap) => {
            window.EXPENSES_DATA = snap.docs.map(d => ({id: d.id, ...d.data()}));
            window.renderExpenseTracking();
        });

        // 3. 預算
        onSnapshot(doc(db, "trips", "currentTrip"), (doc) => {
            if(doc.exists()) {
                window.TOTAL_BUDGET = doc.data().totalBudget || 0;
                const expenseBudget = document.getElementById('total-budget');
                if(expenseBudget) expenseBudget.innerText = window.TOTAL_BUDGET.toLocaleString();
                const overviewBudget = document.getElementById('overview-budget-display');
                if(overviewBudget) overviewBudget.innerText = window.TOTAL_BUDGET.toLocaleString();
                window.renderExpenseTracking();
            }
        });

        // 4. 慾望清單
        onSnapshot(query(collection(db, "wishlists")), (snap) => {
            window.WISHLIST_DATA = snap.docs.map(d => ({id: d.id, ...d.data()}));
            if(!document.getElementById('wishlist-tab').classList.contains('hidden')) window.renderWishlist();
        });

        // 5. 打包清單
        onSnapshot(collection(db, "packinglist"), (snap) => {
             let data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
             data.sort((a, b) => {
                 if (a.packed !== b.packed) return a.packed ? 1 : -1;
                 const t1 = a.createdAt?.seconds || 0;
                 const t2 = b.createdAt?.seconds || 0;
                 return t1 - t2; 
             });
             window.PACKING_DATA = data;
             window.renderPackingList();
        });

        // 6. 景點
        onSnapshot(collection(db, "spots"), (snap) => {
            let data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            window.SPOTS_DATA = data;
            window.renderSpots(); 
        });
    }

    async function updateLiveExchangeRate() {
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/JPY');
            const data = await res.json();
            if(data.result === 'success') {
                EXCHANGE_RATE_JPY_TWD = data.rates.TWD;
                document.getElementById('exchange-rate-display').textContent = EXCHANGE_RATE_JPY_TWD.toFixed(4);
                
                const calcRate = document.getElementById('calc-rate-display');
                if(calcRate) calcRate.innerText = EXCHANGE_RATE_JPY_TWD.toFixed(4);
                if(window.calculateTwd) window.calculateTwd();

                if(window.updateSettlementSummary) window.updateSettlementSummary();
            }
        } catch(e) { console.error('匯率失敗', e); }
    }
    
    window.calculateTwd = () => {
        const jpyInput = document.getElementById('calc-jpy');
        const twdOutput = document.getElementById('calc-twd');
        if(!jpyInput || !twdOutput) return;

        const jpy = parseFloat(jpyInput.value);
        if(isNaN(jpy)) {
            twdOutput.innerText = '0';
            return;
        }
        
        const twd = Math.round(jpy * EXCHANGE_RATE_JPY_TWD);
        twdOutput.innerText = twd.toLocaleString(); 
    };

    /* =========================
       頁面渲染與邏輯
    ========================= */
    // --- 記帳 ---
    window.switchExpenseView = function(v) {
        document.getElementById('add-expense-container').classList.toggle('hidden', v!=='add');
        document.getElementById('expense-details-container').classList.toggle('hidden', v!=='details');
        document.getElementById('tab-add-expense-btn').className = v==='add' ? 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-custom-primary text-white shadow-md' : 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-gray-500';
        document.getElementById('tab-view-details-btn').className = v==='details' ? 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-custom-primary text-white shadow-md' : 'flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-gray-500';
        if(v==='details') window.renderExpenseTracking();
    };
    window.selectCurrency = (v) => { ACTIVE_CURRENCY=v; updateSelectUI('expense-currency', v); document.getElementById('expense-currency').value=v; };
    window.selectPayer = (v) => { ACTIVE_PAYER=v; updateSelectUI('expense-payer', v); document.getElementById('expense-payer').value=v; };
    window.selectCategory = (v) => { ACTIVE_CATEGORY=v; updateSelectUI('expense-category', v); document.getElementById('expense-category').value=v; };
    window.selectPayment = (v) => { ACTIVE_PAYMENT=v; updateSelectUI('expense-payment', v); document.getElementById('expense-payment').value=v; };
    
    window.selectEditCurrency = (v) => { updateSelectUI('edit-expense-currency', v); document.getElementById('edit-expense-currency').value=v; };
    window.selectEditPayer = (v) => { updateSelectUI('edit-expense-payer', v); document.getElementById('edit-expense-payer').value=v; };
    window.selectEditCategory = (v) => { updateSelectUI('edit-expense-category', v); document.getElementById('edit-expense-category').value=v; };
    window.selectEditPayment = (v) => { updateSelectUI('edit-expense-payment', v); document.getElementById('edit-expense-payment').value=v; };

    function updateSelectUI(id, val) {
        const c = document.getElementById(id+'-select');
        if(c) c.querySelectorAll('.block-select-btn').forEach(b => {
             const key = b.getAttribute('data-currency') || b.getAttribute('data-payer') || b.getAttribute('data-category') || b.getAttribute('data-payment');
             if(key===val) b.classList.add('active-filter'); else b.classList.remove('active-filter');
        });
    }

    window.addExpense = async function() {
        const date = document.getElementById('expense-date').value;
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const desc = document.getElementById('expense-description').value;
        if(!date || !amount || !desc) return alert('請填寫完整');
        await addDoc(collection(db, "expenses"), {
            date, amount, description: desc, currency: ACTIVE_CURRENCY, payer: ACTIVE_PAYER, category: ACTIVE_CATEGORY, payment: ACTIVE_PAYMENT, timestamp: serverTimestamp()
        });
        alert('記帳成功'); document.getElementById('expense-amount').value = ''; document.getElementById('expense-description').value = '';
    };
    
    window.openEditExpenseModal = function(id) {
        const e = window.EXPENSES_DATA.find(x => x.id === id);
        document.getElementById('edit-expense-id').value = id;
        document.getElementById('edit-expense-date').value = e.date;
        document.getElementById('edit-expense-amount').value = e.amount;
        document.getElementById('edit-expense-description').value = e.description;
        window.selectEditCurrency(e.currency); window.selectEditPayer(e.payer); window.selectEditCategory(e.category); window.selectEditPayment(e.payment);
        window.openModal('editExpenseModal');
    };
    window.saveExpenseUpdate = async function(evt) {
        evt.preventDefault();
        const id = document.getElementById('edit-expense-id').value;
        await updateDoc(doc(db, "expenses", id), {
             date: document.getElementById('edit-expense-date').value, amount: parseFloat(document.getElementById('edit-expense-amount').value),
             description: document.getElementById('edit-expense-description').value, currency: document.getElementById('edit-expense-currency').value,
             payer: document.getElementById('edit-expense-payer').value, category: document.getElementById('edit-expense-category').value,
             payment: document.getElementById('edit-expense-payment').value
        });
        window.closeModal('editExpenseModal');
    };
    window.deleteExpense = async function(id) { if(confirm('刪除?')) await deleteDoc(doc(db, "expenses", id)); };

    window.filterExpenses = function(cat) { EXPENSE_FILTER=cat; window.renderExpenseTracking(); };
    window.renderExpenseTracking = function() {
        const list = document.getElementById('expense-list');
        const filter = document.getElementById('category-filter-buttons');
        if(!list) return;
        const cats = ['All', ...new Set(window.EXPENSES_DATA.map(e=>e.category))];
        filter.innerHTML = cats.map(c => `<button onclick="window.filterExpenses('${c}')" class="block-select-btn px-3 py-1 text-xs rounded-full ${EXPENSE_FILTER===c?'active-filter':''}">${c==='All'?'全部':c}</button>`).join('');
        const data = window.EXPENSES_DATA.filter(e => EXPENSE_FILTER==='All' || e.category===EXPENSE_FILTER);
        list.innerHTML = data.map(e => {
            const twd = e.currency==='JPY' ? Math.round(e.amount*EXCHANGE_RATE_JPY_TWD) : e.amount;
            const iconMap = { Food: 'fa-utensils', Transport: 'fa-train', Accommodation: 'fa-bed', Shopping: 'fa-bag-shopping', Ticket: 'fa-ticket', Other: 'fa-shapes' };
            return `<div class="p-4 mb-3 bg-white rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center transition cursor-pointer hover:shadow-md" onclick="window.editExpense('${e.id}')">
                <div class="flex items-center"><div class="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center mr-3 text-custom-primary"><i class="fa-solid ${iconMap[e.category]||'fa-circle'}"></i></div><div><p class="font-bold text-gray-700">${e.description}</p><p class="text-xs text-gray-400">${e.date} · ${e.payer}</p></div></div>
                <div class="text-right flex items-center gap-2"><div class="text-right"><p class="font-bold text-custom-danger">${e.currency} ${e.amount}</p><p class="text-[10px] text-gray-400">約 $${twd}</p></div><button onclick="event.stopPropagation(); window.deleteExpense('${e.id}')" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button></div>
            </div>`;
        }).join('');
        window.updateSettlementSummary();
    };
    
    window.updateSettlementSummary = function() {
        let josh = 0, candice = 0;
        window.EXPENSES_DATA.forEach(e => {
            const v = e.currency==='JPY' ? e.amount*EXCHANGE_RATE_JPY_TWD : e.amount;
            if(e.payer==='Josh') josh+=v; else candice+=v;
        });
        const total = josh+candice;
        document.getElementById('total-spent').innerText = Math.round(total).toLocaleString();
        document.getElementById('josh-paid').innerText = Math.round(josh).toLocaleString();
        document.getElementById('candice-paid').innerText = Math.round(candice).toLocaleString();
        const diff = josh - candice; const half = Math.abs(diff)/2;
        const resEl = document.getElementById('settlement-result');
        if(Math.abs(diff)<1) { 
            resEl.innerText = '無需結算'; resEl.className="text-lg font-bold text-gray-400"; 
        }
        else if(diff>0) { 
            resEl.innerText = `Candice 給 Josh $${Math.round(half).toLocaleString()}`; 
            resEl.className="text-lg font-bold text-custom-primary"; 
        }
        else { 
            resEl.innerText = `Josh 給 Candice $${Math.round(half).toLocaleString()}`; 
            resEl.className="text-lg font-bold text-custom-primary"; 
        }
    };
    
    window.enableBudgetEdit = () => { 
        document.getElementById('budget-display').classList.add('hidden'); 
        document.getElementById('budget-edit-form').classList.remove('hidden'); 
        document.getElementById('budget-input').focus();
    };
    window.cancelBudgetEdit = () => { 
        document.getElementById('budget-display').classList.remove('hidden'); 
        document.getElementById('budget-edit-form').classList.add('hidden'); 
    };
    window.saveBudget = async () => {
        const v = parseFloat(document.getElementById('budget-input').value);
        if(isNaN(v)) return;
        await updateDoc(doc(db, "trips", "currentTrip"), {totalBudget: v});
        window.cancelBudgetEdit();
    };

    // --- 慾望清單邏輯 ---
    window.addWishlistItem = async function(e) {
        e.preventDefault();
        const name = document.getElementById('wishlist-name').value;
        const price = parseFloat(document.getElementById('wishlist-price').value);
        const cat = document.getElementById('wishlist-category').value;
        const fileIn = document.getElementById('item-camera-input');
        const btn = document.getElementById('add-wishlist-btn');

        if(!name || !price) return;
        
        btn.innerText = '上傳中...';
        btn.disabled = true;

        try {
            let imgUrl = '';
            if(fileIn.files[0]) {
                const sRef = ref(storage, `wishlist/${Date.now()}_${fileIn.files[0].name}`);
                const snap = await uploadBytes(sRef, fileIn.files[0]);
                imgUrl = await getDownloadURL(snap.ref);
            }

            await addDoc(collection(db, "wishlists"), {
                name, price, category: cat, 
                imageUrl: imgUrl, 
                purchased: false, 
                timestamp: serverTimestamp()
            });

            document.getElementById('wishlist-form').reset();
            window.clearItemPhoto();

        } catch(err) {
            console.error(err);
            alert('儲存失敗');
        } finally {
            btn.innerText = '新增清單項目';
            btn.disabled = false;
        }
    };
    
    window.toggleWishlistStatus = async function(id, status) { await updateDoc(doc(db, "wishlists", id), {purchased: !status}); };
    window.deleteWishlistItem = async function(id) { if(confirm('刪除?')) await deleteDoc(doc(db, "wishlists", id)); };
    
    window.filterWishlist = function(cat) {
        WISHLIST_FILTER = cat;
        window.renderWishlist();
    };

    // --- 慾望清單渲染 (含編輯按鈕) ---
    window.renderWishlist = function() {
        const listContainer = document.getElementById('wishlist-list');
        const filterContainer = document.getElementById('wishlist-filter-buttons');
        
        if(!listContainer) return;

        const cleanText = (text) => (text || '').replace(/['"]/g, '').trim();

        const defaultCats = ['伴手禮', '電器', '3C', '服飾', '藥妝', '其他'];
        const existingCats = window.WISHLIST_DATA.map(i => cleanText(i.category));
        const allCats = ['All', ...new Set([...defaultCats, ...existingCats])].filter(c => c);

        if(filterContainer) {
            filterContainer.innerHTML = allCats.map(c => {
                const label = c === 'All' ? '全部' : c;
                const activeClass = (c === WISHLIST_FILTER) ? 'active-filter' : ''; 
                return `<button onclick="window.filterWishlist('${c}')" class="block-select-btn px-3 py-1 text-xs rounded-full ${activeClass}">${label}</button>`;
            }).join('');
        }

        const filteredData = window.WISHLIST_DATA.filter(i => {
            const itemCat = cleanText(i.category);
            return WISHLIST_FILTER === 'All' || itemCat === WISHLIST_FILTER;
        });

        if (filteredData.length === 0) {
            listContainer.innerHTML = `<div class="text-center py-8 text-gray-300"><i class="fa-solid fa-box-open text-4xl mb-2"></i><p>沒有這個分類的項目</p></div>`;
            return;
        }

        listContainer.innerHTML = filteredData.map(i => {
            const photoLink = i.imageUrl ? `<a href="${i.imageUrl}" target="_blank" class="text-[#4ECDC4] text-xs underline block mt-1"><i class="fa-solid fa-image"></i> 查看照片</a>` : '';
            const displayCat = cleanText(i.category);

            return `
            <div class="p-3 mb-2 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center ${i.purchased?'bg-gray-100 opacity-60':'bg-white'}">
                <div>
                    <p class="font-bold text-gray-700">${i.name}</p>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-white bg-gray-400 px-2 py-0.5 rounded-full">${displayCat}</span>
                        ${photoLink}
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-custom-primary">¥${i.price}</p>
                    <div class="flex justify-end gap-2 mt-1">
                        <button onclick="window.toggleWishlistStatus('${i.id}', ${i.purchased})" class="wishlist-status-btn ${i.purchased?'purchased':'pending'}">${i.purchased?'已買':'想買'}</button>
                        <button onclick="window.openEditWishlistModal('${i.id}')" class="text-gray-300 hover:text-blue-400 px-1"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="window.deleteWishlistItem('${i.id}')" class="text-gray-300 hover:text-red-400 px-1"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
    };

    // --- 慾望清單編輯功能 (已修正) ---
    window.openEditWishlistModal = function(id) {
        const item = window.WISHLIST_DATA.find(i => i.id === id);
        if(!item) return;

        document.getElementById('edit-wishlist-id').value = id;
        document.getElementById('edit-wishlist-name').value = item.name;
        document.getElementById('edit-wishlist-price').value = item.price;
        const cleanCat = (item.category || '').replace(/['"]/g, '').trim();
        document.getElementById('edit-wishlist-category').value = cleanCat;
        document.getElementById('edit-wishlist-old-image').value = item.imageUrl || '';
        document.getElementById('edit-wishlist-file').value = ""; 

        const img = document.getElementById('edit-wishlist-preview');
        const container = document.getElementById('edit-wishlist-preview-container');
        if (item.imageUrl) { 
            img.src = item.imageUrl; 
            container.classList.remove('hidden'); 
        } else { 
            container.classList.add('hidden'); 
        }

        window.openModal('editWishlistModal');
    };

    window.previewEditWishlistImage = function(input) {
        if (input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => { 
                document.getElementById('edit-wishlist-preview').src = e.target.result; 
                document.getElementById('edit-wishlist-preview-container').classList.remove('hidden'); 
            };
            r.readAsDataURL(input.files[0]);
        }
    };

    window.saveWishlistUpdate = async function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-wishlist-id').value;
        const file = document.getElementById('edit-wishlist-file').files[0];
        const btn = document.getElementById('save-wishlist-btn');
        
        btn.innerText = '上傳中...'; 
        btn.disabled = true;

        try {
            let url = document.getElementById('edit-wishlist-old-image').value;
            if(file) {
                const sRef = ref(storage, `wishlist/updated_${Date.now()}_${file.name}`);
                const snap = await uploadBytes(sRef, file);
                url = await getDownloadURL(snap.ref);
            }

            await updateDoc(doc(db, "wishlists", id), {
                name: document.getElementById('edit-wishlist-name').value,
                price: parseFloat(document.getElementById('edit-wishlist-price').value),
                category: document.getElementById('edit-wishlist-category').value,
                imageUrl: url
            });

            window.closeModal('editWishlistModal');
        } catch(err) {
            console.error(err);
            alert('更新失敗');
        } finally {
            btn.innerText = '儲存修改'; 
            btn.disabled = false;
        }
    };

    // --- 打包清單邏輯 ---
    // ★★★ 修改：renderPackingList 增加編輯按鈕與刪除線 ★★★
    window.renderPackingList = function() {
        const container = document.getElementById('packing-list-container');
        if (!container) return;

        if (window.PACKING_DATA.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 py-10">您的行李清單是空的！</p>';
            return;
        }

        container.innerHTML = window.PACKING_DATA.map(item => {
            const isPacked = item.packed || false; // 確保有值
            return `
             <div class="p-3 rounded-xl shadow-sm border flex justify-between items-center mb-2 ${isPacked ? 'bg-gray-50' : 'bg-white'}">
                <div class="flex items-center cursor-pointer flex-1" onclick="window.togglePackingStatus('${item.id}', ${isPacked})">
                  <i class="fa-solid ${isPacked ? 'fa-check-circle text-teal-500' : 'fa-circle text-gray-300'} mr-3 text-lg"></i>
                  <div>
                    <p class="${isPacked ? 'line-through text-gray-400 italic' : 'text-gray-700 font-bold'}">${item.name}</p>
                    <p class="text-xs text-gray-400">${item.category}</p>
                  </div>
                </div>
                <div class="flex items-center gap-2"> <!-- 新增的 div 統一管理按鈕 -->
                    <button onclick="window.openEditPackingModal('${item.id}')" class="text-gray-300 hover:text-blue-400 p-2">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <button onclick="window.deletePackingItem('${item.id}')" class="text-gray-300 hover:text-red-400 p-2">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
             </div>
            `;
        }).join('');
    };

    window.togglePackingStatus = async function(id, currentStatus) {
        await updateDoc(doc(db, "packinglist", id), { packed: !currentStatus });
    };
    
    // ★★★ 補回缺失的 deletePackingItem 函式 ★★★
    window.deletePackingItem = async function(id) {
        if(confirm('確定要刪除這筆打包清單項目嗎？')) {
            await deleteDoc(doc(db, "packinglist", id));
        }
    };

    // ★★★ 新增：編輯行李清單功能 ★★★
    window.openEditPackingModal = function(id) {
        const item = window.PACKING_DATA.find(i => i.id === id);
        if(!item) return;

        document.getElementById('edit-packing-id').value = id;
        document.getElementById('edit-packing-name').value = item.name;
        document.getElementById('edit-packing-category').value = item.category || ''; // 確保分類預先填入

        window.openModal('editPackingModal');
    };

    window.savePackingUpdate = async function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-packing-id').value;
        const name = document.getElementById('edit-packing-name').value.trim();
        const category = document.getElementById('edit-packing-category').value;
        const btn = document.getElementById('save-packing-btn');

        if (!name) return alert('請輸入物品名稱');

        btn.innerText = '儲存中...';
        btn.disabled = true;

        try {
            await updateDoc(doc(db, "packinglist", id), {
                name: name,
                category: category
            });
            window.closeModal('editPackingModal');
        } catch(err) {
            console.error(err);
            alert('更新失敗');
        } finally {
            btn.innerText = '儲存修改';
            btn.disabled = false;
        }
    };

    // --- 景點 (Spots) 邏輯 ---
    window.addSpot = async function() {
        const name = document.getElementById('new-spot-name').value;
        const desc = document.getElementById('new-spot-desc').value;
        const link = document.getElementById('new-spot-link').value;
        if(!name) return alert('請輸入名稱');
        
        const btn = document.getElementById('add-spot-btn');
        btn.innerText = '上傳中...'; btn.disabled = true;
        const fileIn = document.getElementById('spot-camera-input');
        
        try {
            let imgUrl = '';
            if(fileIn.files[0]) {
                const sRef = ref(storage, `spots/${Date.now()}_${fileIn.files[0].name}`);
                const snap = await uploadBytes(sRef, fileIn.files[0]);
                imgUrl = await getDownloadURL(snap.ref);
            }
            await addDoc(collection(db, "spots"), { name, description: desc, link, imageUrl: imgUrl, createdAt: serverTimestamp() });
            document.getElementById('new-spot-name').value = ''; document.getElementById('new-spot-desc').value = ''; document.getElementById('new-spot-link').value = ''; window.clearPhoto();
        } catch(e) { console.error(e); alert('失敗: ' + e.message); }
        finally { btn.innerText = '新增景點'; btn.disabled = false; }
    };

    window.renderSpots = function() {
        const container = document.getElementById('spots-list');
        if (!container) return;
        
        container.innerHTML = window.SPOTS_DATA.map(s => {
            const img = s.imageUrl ? `<img src="${s.imageUrl}" class="w-full h-32 object-cover rounded-xl mb-3 border border-gray-100 cursor-pointer hover:opacity-90 transition" onclick="window.open(this.src, '_blank')" title="點擊查看原圖">` : '';
            return `
            <div class="bg-white p-4 rounded-2xl border border-gray-100 mb-4 shadow-sm relative">
                ${img}
                <div class="flex justify-between items-start">
                    <div class="flex-1 pr-2">
                        <div class="flex items-center mb-2">
                            <i class="fa-solid fa-location-dot text-[#FF8BA7] text-lg mr-2"></i>
                            <h3 class="font-bold text-gray-700 text-lg tracking-wide">${s.name}</h3>
                        </div>
                        ${s.description ? `<div class="bg-[#FFF8F0] p-2 rounded-lg text-sm text-gray-500 mb-2 leading-relaxed tracking-wide">${s.description}</div>` : ''}
                        ${s.link ? `<a href="${s.link}" target="_blank" class="text-[#4ECDC4] font-bold text-sm flex items-center hover:underline mt-1"><i class="fa-solid fa-map-location-dot mr-1"></i> 在地圖中開啟</a>` : ''}
                    </div>
                    <div class="flex flex-col gap-3 ml-2 pt-1">
                        <button onclick="window.deleteSpot('${s.id}')" class="text-gray-300 hover:text-red-400 transition transform hover:scale-110"><i class="fa-solid fa-trash-can text-sm"></i></button>
                        <button onclick="window.openEditSpotModal('${s.id}')" class="text-gray-300 hover:text-blue-400 transition transform hover:scale-110"><i class="fa-solid fa-pen text-sm"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
    };

    // --- 編輯景點 (Modal) ---
    window.openEditSpotModal = function(id) {
        const spot = window.SPOTS_DATA.find(s => s.id === id); if(!spot) return;
        document.getElementById('edit-spot-id').value = spot.id;
        document.getElementById('edit-spot-name').value = spot.name;
        document.getElementById('edit-spot-desc').value = spot.description || '';
        document.getElementById('edit-spot-link').value = spot.link || '';
        document.getElementById('edit-spot-old-image').value = spot.imageUrl || '';
        document.getElementById('edit-spot-file').value = "";
        const img = document.getElementById('edit-photo-preview');
        if (spot.imageUrl) { img.src = spot.imageUrl; img.parentElement.classList.remove('hidden'); } else { img.parentElement.classList.add('hidden'); }
        window.openModal('editSpotModal');
    };
    window.previewEditImage = function(input) {
        if (input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => { document.getElementById('edit-photo-preview').src = e.target.result; document.getElementById('edit-photo-preview-container').classList.remove('hidden'); };
            r.readAsDataURL(input.files[0]);
        }
    };
    window.saveSpotUpdate = async function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-spot-id').value;
        const file = document.getElementById('edit-spot-file').files[0];
        const btn = document.getElementById('save-spot-btn');
        btn.innerText = '上傳中...'; btn.disabled = true;
        try {
            let url = document.getElementById('edit-spot-old-image').value;
            if(file) {
                const sRef = ref(storage, `spots/updated_${Date.now()}_${file.name}`);
                const snap = await uploadBytes(sRef, file);
                url = await getDownloadURL(snap.ref);
            }
            await updateDoc(doc(db, "spots", id), {
                name: document.getElementById('edit-spot-name').value,
                description: document.getElementById('edit-spot-desc').value,
                link: document.getElementById('edit-spot-link').value,
                imageUrl: url
            });
            window.closeModal('editSpotModal');
        } catch(err) { alert('更新失敗'); console.error(err); }
        finally { btn.innerText = '儲存修改'; btn.disabled = false; }
    };
    window.deleteSpot = async (id) => { if(confirm('刪除?')) await deleteDoc(doc(db, "spots", id)); };

    // --- 行程功能 ---
    window.generateDateTabs = () => {
        const c = document.getElementById('date-buttons-container'); if(!c) return; c.innerHTML = '';
        window.ITINERARY_DATA.forEach((d, i) => {
            const btn = document.createElement('button');
            btn.className = `tab-button ${d.id === ACTIVE_DATE ? 'active' : ''}`;
            btn.innerHTML = `<div class="font-bold">Day ${i+1}</div><div class="text-xs font-normal">${d.date.substring(5)} (${d.day_of_week})</div>`;
            btn.onclick = () => { ACTIVE_DATE = d.id; window.generateDateTabs(); window.renderItinerary(); };
            c.appendChild(btn);
        });
    };
    // ★★★ 修改：渲染行程 (加上地圖按鈕) ★★★
    window.renderItinerary = () => {
        const c = document.getElementById('itinerary-container'); if(!c) return;
        const d = window.ITINERARY_DATA.find(x => x.id === ACTIVE_DATE);
        if(!d || !d.activities?.length) { c.innerHTML = `<div class="m-4 p-6 bg-white rounded-xl shadow-sm text-center border border-pink-100"><p class="text-gray-400">本日尚無行程</p></div>`; return; }
        c.innerHTML = `<div class="mx-4 mt-4 p-4 bg-white rounded-xl shadow-sm border border-pink-100 flex justify-between items-center"><h2 class="text-lg font-bold text-gray-700">${d.city}</h2><span class="bg-pink-50 text-custom-primary px-3 py-1 rounded-full text-sm font-bold">${d.date}</span></div><div class="timeline-container p-4">` + d.activities.map((a, i) => {
            const icon = a.title.includes('餐')?'fa-utensils':a.title.includes('宿')?'fa-bed':'fa-location-dot';
            
            // ★★★ 新增：如果有連結，顯示按鈕 ★★★
            const linkBtn = a.link ? `<a href="${a.link}" target="_blank" onclick="event.stopPropagation()" class="text-custom-secondary text-sm ml-2 hover:underline">(地圖 <i class="fa-solid fa-map-location-dot"></i>)</a>` : '';

            return `<div class="flex items-start mb-6 group" onclick="window.openEditModal('${d.id}', ${i})"><div class="w-1/4 text-sm font-bold text-gray-400 pt-1 text-center font-mono bg-gray-50 rounded-lg mr-3">${a.time}</div><div class="flex-1 bg-white p-3 rounded-xl shadow-sm border border-gray-100 relative z-10"><div class="timeline-item relative !pl-0"><span class="absolute -left-[2.1rem] top-2 h-4 w-4 rounded-full bg-custom-primary border-4 border-white timeline-dot z-20"></span><div class="font-bold text-gray-700 mb-1"><i class="fa-solid ${icon} text-custom-primary mr-2"></i>${a.title}${linkBtn}</div><div class="text-sm text-gray-500 ml-8">${a.location||''}</div></div></div></div>`;
        }).join('') + '</div>';
    };

    // ★★★ 修改：新增行程 (讀取連結) ★★★
    window.addItineraryItem = async (e) => {
        e.preventDefault();
        const dId = document.getElementById('new-date').value;
        // 注意：這裡新增了 link 欄位的讀取
        const act = { 
            time: document.getElementById('new-time').value, 
            title: document.getElementById('new-title').value, 
            location: document.getElementById('new-note').value, 
            link: document.getElementById('new-link').value, // 新增這一行
            notes: '' 
        };
        if(!dId||!act.time||!act.title) return;
        const d = window.ITINERARY_DATA.find(x=>x.id===dId);
        if(d) { await updateDoc(doc(db,'itineraries',dId), {activities: [...(d.activities||[]), act].sort((a,b)=>a.time.localeCompare(b.time))}); window.closeModal('addItineraryModal'); document.getElementById('add-itinerary-form').reset(); }
    };
    window.populateItineraryModalDates = () => { const s = document.getElementById('new-date'); if(!s) return; s.innerHTML = window.ITINERARY_DATA.map(d=>`<option value="${d.id}" ${d.id===ACTIVE_DATE?'selected':''}>${d.date.substring(5)} - ${d.city}</option>`).join(''); };
    
    // ★★★ 修改：打開編輯 Modal (填入連結) ★★★
    window.openEditModal = (dId, idx) => {
        const d = window.ITINERARY_DATA.find(x=>x.id===dId); const act = d.activities[idx];
        document.getElementById('edit-modal-date-info').textContent = `${d.city} ${d.date}`;
        document.getElementById('edit-date-key').value = dId; document.getElementById('edit-item-index').value = idx;
        document.getElementById('edit-time').value = act.time; 
        document.getElementById('edit-title').value = act.title; 
        document.getElementById('edit-note').value = act.location||'';
        document.getElementById('edit-link').value = act.link||''; // 新增這一行
        window.openModal('editItineraryModal');
    };

    // ★★★ 修改：儲存編輯 (更新連結) ★★★
    window.saveItineraryItem = async (e) => {
        e.preventDefault();
        const dId = document.getElementById('edit-date-key').value, idx = document.getElementById('edit-item-index').value;
        const d = window.ITINERARY_DATA.find(x=>x.id===dId); const acts = [...d.activities];
        // 更新 link 欄位
        acts[idx] = {
            ...acts[idx], 
            time: document.getElementById('edit-time').value, 
            title: document.getElementById('edit-title').value, 
            location: document.getElementById('edit-note').value,
            link: document.getElementById('edit-link').value // 新增這一行
        };
        await updateDoc(doc(db,'itineraries',dId), {activities: acts.sort((a,b)=>a.time.localeCompare(b.time))}); window.closeModal('editItineraryModal');
    };
    window.deleteItineraryItem = async (dId, idx) => {
        if(!confirm('刪除?')) return;
        const d = window.ITINERARY_DATA.find(x=>x.id===dId);
        await updateDoc(doc(db,'itineraries',dId), {activities: d.activities.filter((_,i)=>i!==parseInt(idx))});
        window.closeModal('editItineraryModal');
    };

    window.switchMainNav = (tid) => {
        document.querySelectorAll('.main-tab-content').forEach(e => e.classList.add('hidden'));
        document.querySelectorAll('.main-nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tid).classList.remove('hidden');
        document.querySelector(`.main-nav-btn[data-target="${tid}"]`).classList.add('active');
        if(tid==='packing-tab') window.renderPackingList();
        if(tid==='wishlist-tab') window.renderWishlist();
        if(tid==='expense-tab') window.renderExpenseTracking();
        if(tid==='overview-tab') window.renderSpots();
    };

    document.addEventListener('DOMContentLoaded', () => { 
        window.switchMainNav('itinerary-tab'); 
        startDataSync(); 
        
        // ★★★ 新增：設定記帳預設日期為今天 ★★★
        const now = new Date();
        const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        document.getElementById('expense-date').value = localDate;
    });
</script>
</head>
<body class="bg-gray-50 font-sans">

    <div class="max-w-xl mx-auto bg-white min-h-screen shadow-2xl overflow-hidden rounded-none sm:rounded-3xl sm:my-8 border border-gray-100">

        <header class="p-4 bg-white border-b border-gray-100 sticky top-0 z-10 shadow-sm">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-700 flex items-center tracking-wide">
                    <i class="fa-solid fa-plane-departure text-custom-primary mr-2 transform -rotate-12"></i> 福岡熊本之旅
                </h1>
                <div class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-lg">
                    匯率: <span id="exchange-rate-display" class="font-bold text-custom-secondary text-base">0.2150</span>
                </div>
            </div>
        </header>

        <nav id="main-nav" class="flex justify-around border-b border-gray-100 text-sm sticky top-[72px] bg-white/95 backdrop-blur-sm z-10 shadow-sm">
            <button class="main-nav-btn active" data-target="itinerary-tab" onclick="window.switchMainNav('itinerary-tab')"><i class="fa-solid fa-map-location-dot"></i><br>行程</button>
            <button class="main-nav-btn" data-target="expense-tab" onclick="window.switchMainNav('expense-tab')"><i class="fa-solid fa-wallet"></i><br>記帳</button>
            <button class="main-nav-btn" data-target="wishlist-tab" onclick="window.switchMainNav('wishlist-tab')"><i class="fa-solid fa-gift"></i><br>清單</button>
            <button class="main-nav-btn" data-target="packing-tab" onclick="window.switchMainNav('packing-tab')"><i class="fa-solid fa-suitcase"></i><br>打包</button>
            <button class="main-nav-btn" data-target="overview-tab" onclick="window.switchMainNav('overview-tab')"><i class="fa-solid fa-star"></i><br>總覽</button>
        </nav>
        
        <!-- 行程天氣總覽區塊 -->
        <div class="bg-white p-2 rounded-3xl shadow-lg m-4 mb-2 border-2 border-pink-100">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa-solid fa-cloud-sun-rain text-custom-primary mr-2"></i> 行程天氣總覽 (tenki.jp)
            </h2>
            <div class="flex justify-around items-stretch mb-4 space-x-2 flex-wrap sm:flex-nowrap">
                <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm mb-3 sm:mb-0"><p class="text-sm font-semibold text-gray-700 mb-1">福岡 (26日)</p><i class="fa-solid fa-cloud-sun-rain text-3xl text-custom-primary mb-1"></i><p class="text-lg font-bold text-gray-800">8°C / 13°C</p><p class="text-xs text-red-500 mt-1">降雨率: 20%</p></div>
                <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm mb-3 sm:mb-0"><p class="text-sm font-semibold text-gray-700 mb-1">長崎 (27-28日)</p><i class="fa-solid fa-sun text-3xl text-orange-400 mb-1"></i> <p class="text-lg font-bold text-gray-800">5°C / 10°C</p><p class="text-xs text-gray-500 mt-1">降雨率: 0%</p></div>
                <div class="flex-1 min-w-[100px] text-center p-3 border border-pink-200 rounded-2xl bg-pink-50 shadow-sm"><p class="text-sm font-semibold text-gray-700 mb-1">熊本 (29-31日)</p><i class="fa-solid fa-cloud-showers-heavy text-3xl text-custom-secondary mb-1"></i><p class="text-lg font-bold text-gray-800">3°C / 9°C</p><p class="text-xs text-red-500 mt-1">降雨率: 40%</p></div>
            </div>
            <a href="https://www.tenki.jp/" target="_blank" class="w-full block text-center bg-gray-100 text-gray-700 p-3 rounded-2xl font-semibold hover:bg-gray-200 transition duration-200 text-sm"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> 點擊查看 tenki.jp 詳細預報</a>
        </div>

        <main id="app-content" class="pb-24 bg-[#FFFDF9]">

            <!-- 1. 行程 TAB -->
            <div id="itinerary-tab" class="main-tab-content">
                <div id="date-buttons-container" class="flex p-4 overflow-x-auto whitespace-nowrap border-b border-gray-100 bg-white no-scrollbar"></div>
                <div id="itinerary-container"></div>
                <button onclick="window.openModal('addItineraryModal')" class="fixed right-6 bottom-6 w-14 h-14 rounded-full bg-custom-primary text-white shadow-xl flex items-center justify-center text-2xl hover:bg-custom-primary-dark z-20 transition transform hover:scale-110">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- 2. 記帳 TAB -->
            <div id="expense-tab" class="main-tab-content hidden p-4">
                <div class="flex mb-4 p-1.5 bg-gray-100 rounded-2xl">
                    <button id="tab-add-expense-btn" class="flex-1 py-2.5 rounded-xl text-sm font-bold bg-white text-gray-500 shadow-sm transition-all" onclick="window.switchExpenseView('add')"><i class="fa-solid fa-pen mr-1"></i> 記一筆</button>
                    <button id="tab-view-details-btn" class="flex-1 py-2.5 rounded-xl text-sm font-bold text-gray-500 hover:bg-white/50 transition-all" onclick="window.switchExpenseView('details')"><i class="fa-solid fa-list mr-1"></i> 查明細</button>
                </div>
                <!-- 記帳表單 -->
                <div id="add-expense-container" class="hidden bg-white p-5 rounded-3xl shadow-sm border border-pink-100">
                    <form onsubmit="event.preventDefault(); window.addExpense();">
                        <label class="block mb-1 text-sm font-bold text-gray-500">日期</label>
                        <input type="date" id="expense-date" value="2024-05-18" class="w-full p-3 mb-4 font-bold border-0 bg-gray-50 rounded-xl" required>
                        <label class="block mb-1 text-sm font-bold text-gray-500">金額</label>
                        <div class="flex mb-4">
                            <input type="number" step="0.01" id="expense-amount" placeholder="0" class="flex-1 p-3 text-xl font-bold border-0 bg-gray-50 rounded-xl" required>
                            <div id="expense-currency-select" class="flex items-center ml-2">
                                <button type="button" class="block-select-btn active-filter" data-currency="TWD" onclick="window.selectCurrency('TWD')">TWD</button>
                                <button type="button" class="block-select-btn" data-currency="JPY" onclick="window.selectCurrency('JPY')">JPY</button>
                            </div>
                            <input type="hidden" id="expense-currency" value="TWD">
                        </div>
                        <label class="block mb-1 text-sm font-bold text-gray-500">用途</label>
                        <input type="text" id="expense-description" placeholder="例如: 一蘭拉麵" class="w-full p-3 mb-4 border-0 bg-gray-50 rounded-xl" required>
                        <label class="block mb-2 text-sm font-bold text-gray-500">誰付錢?</label>
                        <div id="expense-payer-select" class="flex mb-4">
                            <button type="button" class="flex-1 block-select-btn active-filter" data-payer="Josh" onclick="window.selectPayer('Josh')">Josh</button>
                            <button type="button" class="flex-1 block-select-btn" data-payer="Candice" onclick="window.selectPayer('Candice')">Candice</button>
                            <input type="hidden" id="expense-payer" value="Josh">
                        </div>
                        <label class="block mb-2 text-sm font-bold text-gray-500">類別</label>
                        <div id="expense-category-select" class="grid grid-cols-3 gap-2 mb-4">
                            <button type="button" class="w-full block-select-btn active-filter" data-category="Food" onclick="window.selectCategory('Food')">餐飲</button>
                            <button type="button" class="w-full block-select-btn" data-category="Transport" onclick="window.selectCategory('Transport')">交通</button>
                            <button type="button" class="w-full block-select-btn" data-category="Accommodation" onclick="window.selectCategory('Accommodation')">住宿</button>
                            <button type="button" class="w-full block-select-btn" data-category="Shopping" onclick="window.selectCategory('Shopping')">購物</button>
                            <button type="button" class="w-full block-select-btn" data-category="Ticket" onclick="window.selectCategory('Ticket')">門票</button>
                            <button type="button" class="w-full block-select-btn" data-category="Other" onclick="window.selectCategory('Other')">其他</button>
                            <input type="hidden" id="expense-category" value="Food">
                        </div>
                        <label class="block mb-2 text-sm font-bold text-gray-500">支付</label>
                        <div id="expense-payment-select" class="flex mb-6 gap-2">
                            <button type="button" class="flex-1 block-select-btn active-filter" data-payment="Cash" onclick="window.selectPayment('Cash')">現金</button>
                            <button type="button" class="flex-1 block-select-btn" data-payment="Card" onclick="window.selectPayment('Card')">信用卡</button>
                            <button type="button" class="flex-1 block-select-btn" data-payment="Paypay" onclick="window.selectPayment('Paypay')">Paypay</button>
                        </div>
                        <input type="hidden" id="expense-payment" value="Cash">
                        <button type="submit" class="w-full p-4 font-bold text-white transition bg-custom-secondary rounded-2xl shadow-lg">確認紀錄</button>
                    </form>
                </div>
                <div id="expense-details-container">
                    <div class="p-5 mb-6 border border-blue-100 shadow-inner bg-gradient-to-br from-blue-50 to-purple-50 rounded-3xl">
                        <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                            <div class="p-3 bg-white shadow-sm rounded-2xl">
                                <div id="budget-display-container">
                                    <p class="mb-1 text-xs text-gray-400">總預算</p>
                                    <div class="flex items-center">
                                        <p id="budget-display" class="text-2xl font-bold text-gray-700 cursor-pointer" onclick="window.enableBudgetEdit()">$ <span id="total-budget">0</span></p>
                                        <i class="ml-2 text-sm text-gray-400 cursor-pointer fa-solid fa-pen-to-square hover:text-custom-primary" onclick="window.enableBudgetEdit()"></i>
                                    </div>
                                    <div id="budget-edit-form" class="hidden flex items-center mt-1"><input type="number" id="budget-input" class="w-20 border-b border-gray-400 font-bold p-1 mr-1 text-sm"><button onclick="window.saveBudget()" class="text-custom-primary"><i class="fa-solid fa-check"></i></button><button onclick="window.cancelBudgetEdit()" class="text-gray-400 ml-1"><i class="fa-solid fa-xmark"></i></button></div>
                                </div>
                            </div>
                            <div class="p-3 bg-white shadow-sm rounded-2xl"><p class="mb-1 text-xs text-gray-400">已支出</p><p class="text-2xl font-bold text-custom-danger">$ <span id="total-spent">0</span></p></div>
                            <div class="p-3 bg-white shadow-sm rounded-2xl border-2 border-blue-100"><p class="mb-1 text-sm font-bold text-blue-400">Josh 付</p><p class="text-2xl font-bold text-gray-700">$ <span id="josh-paid">0</span></p></div>
                            <div class="p-3 bg-white shadow-sm rounded-2xl border-2 border-pink-100"><p class="mb-1 text-sm font-bold text-pink-400">Candice 付</p><p class="text-2xl font-bold text-gray-700">$ <span id="candice-paid">0</span></p></div>
                        </div>
                        <div class="p-2 text-center bg-white border-t border-blue-100 rounded-xl"><p class="mb-1 text-xs text-gray-400">應付結算</p><p id="settlement-result" class="text-lg font-bold text-custom-primary">計算中...</p></div>
                    </div>
                    <div id="category-filter-buttons" class="flex flex-wrap gap-2 px-1 pb-2 mb-4 overflow-x-auto no-scrollbar"></div>
                    <div id="expense-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- 3. 慾望清單 TAB -->
            <div id="wishlist-tab" class="main-tab-content hidden p-4">
                <div class="p-6 mb-6 bg-white border-2 border-pink-100 shadow-lg rounded-3xl">
                    <h3 class="flex items-center mb-4 text-xl font-bold text-gray-700"><i class="mr-2 fa-solid fa-cart-plus text-custom-primary"></i> 新增慾望</h3>
                    <form onsubmit="window.addWishlistItem(event)" id="wishlist-form">
                        <input type="text" id="wishlist-name" placeholder="商品名稱" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl" required>
                        <div class="flex gap-2 mb-3">
                            <input type="number" id="wishlist-price" placeholder="價格 (JPY)" class="flex-1 p-3 border-0 bg-gray-50 rounded-xl" required>
                            <div class="relative w-1/2">
                                <select id="wishlist-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl">
                                    <option value="伴手禮">🎁 伴手禮</option>
                                    <option value="電器">⚡ 電器</option>
                                    <option value="3C">📱 3C</option>
                                    <option value="服飾">👕 服飾</option>
                                    <option value="藥妝">💊 藥妝</option>
                                    <option value="其他">✨ 其他</option>
                                </select>
                                <i class="absolute top-4 right-4 text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i>
                            </div>
                        </div>
                        <input type="file" id="item-camera-input" accept="image/*" class="hidden" onchange="window.previewItemImage(this)">
                        <button type="button" onclick="document.getElementById('item-camera-input').click()" class="flex items-center justify-center w-full gap-2 p-2 mb-2 text-sm font-bold text-pink-500 border border-pink-100 bg-pink-50 rounded-xl"><i class="fa-solid fa-camera"></i> 拍照 (選填)</button>
                        <div id="item-photo-preview-container" class="hidden mb-3"><img id="item-photo-preview" src="" class="object-cover w-full h-40 border-2 border-pink-100 cursor-pointer rounded-xl hover:opacity-90" onclick="window.open(this.src, '_blank')" title="點擊查看原圖"><button type="button" onclick="window.clearItemPhoto()" class="block w-full mt-1 text-xs text-center text-red-400 underline">移除照片</button></div>
                        <button type="submit" id="add-wishlist-btn" class="w-full py-3 font-bold text-white transition shadow-md bg-custom-primary rounded-xl active:scale-95">新增清單項目</button>
                    </form>
                </div>

                <div id="wishlist-filter-buttons" class="flex flex-wrap gap-2 px-1 pb-2 mb-4 overflow-x-auto no-scrollbar"></div>

                <div id="wishlist-list" class="space-y-3"></div>
            </div>
            
            <!-- 4. 打包清單 TAB -->
            <div id="packing-tab" class="main-tab-content hidden p-4">
                <div class="p-5 mb-6 bg-white border border-blue-100 shadow-sm rounded-3xl">
                    <h3 class="flex items-center mb-4 text-lg font-bold text-gray-700"><i class="mr-2 fa-solid fa-shirt text-custom-secondary"></i> 新增行李</h3>
                    <form id="packing-form" onsubmit="window.addPackingItem(event)">
                    <div class="flex gap-2 mb-3">
                        <div class="flex-1"><input type="text" id="packing-name" placeholder="護照" class="w-full p-3 border-0 bg-gray-50 rounded-xl" required></div>
                        <div class="relative w-1/3">
                            <select id="packing-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl"><option value="證件">🪪 證件</option><option value="衣物">👕 衣物</option><option value="電子">📱 3C</option><option value="藥品">💊 藥品</option><option value="盥洗">🚿 盥洗</option><option value="其他">🧩 其他</option></select>
                            <i class="absolute text-xs text-gray-400 fa-solid fa-chevron-down right-3 top-4"></i>
                        </div>
                    </div>
                    <button type="submit" class="w-full p-3 font-bold text-white transition bg-custom-secondary rounded-2xl shadow-lg">加入行李箱</button>
                    </form>
                </div>
                
                <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center px-2"><i class="fa-solid fa-clipboard-check mr-2 text-custom-primary"></i> 檢查清單</h3>
                <div id="packing-list-container" class="space-y-2"></div>
            </div>

            <!-- 5. 總覽 TAB -->
            <div id="overview-tab" class="main-tab-content hidden p-4">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-6 text-center border border-yellow-100 bg-yellow-50 rounded-3xl shadow-sm">
                        <i class="block mb-2 text-2xl text-yellow-500 fa-regular fa-calendar"></i>
                        <p class="mb-1 text-xs font-bold tracking-wider text-yellow-700 uppercase">Duration</p>
                       <p class="text-2xl font-bold text-yellow-900 font-mono"><span id="overview-duration-display">0</span> Days</p>
                    </div>
                    <div class="p-6 text-center border border-green-100 bg-green-50 rounded-3xl shadow-sm">
                        <i class="block mb-2 text-2xl text-green-500 fa-solid fa-sack-dollar"></i>
                        <p class="mb-1 text-xs font-bold tracking-wider text-green-700 uppercase">Budget</p>
                        <p class="text-2xl font-bold text-green-900 font-mono">$<span id="overview-budget-display">Loading...</span></p>
                    </div>
                </div> 

                <!-- ★★★ 新增：簡易換匯計算機 ★★★ -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-green-100 mb-6">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center">
                        <i class="fa-solid fa-calculator text-custom-secondary mr-2"></i> 簡易換算
                    </h3>
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1">日幣 (JPY)</label>
                            <input type="number" id="calc-jpy" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-lg border-2 border-gray-100 focus:border-green-300 transition-colors" placeholder="0" oninput="window.calculateTwd()">
                        </div>
                        <i class="fa-solid fa-arrow-right text-gray-300 mt-4"></i>
                        <div class="flex-1">
                            <label class="text-xs text-gray-400 block mb-1">台幣 (TWD)</label>
                            <div id="calc-twd" class="w-full p-3 bg-green-50 text-custom-secondary rounded-xl font-bold text-lg border-2 border-green-100 flex items-center h-[54px]">0</div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-right">即時匯率: <span id="calc-rate-display" class="font-bold text-custom-primary">0.2150</span></p>
                </div>

                <div class="p-6 mb-6 bg-white border border-pink-100 shadow-sm rounded-3xl">
                    <div class="flex items-center mb-4"><i class="fa-solid fa-location-dot text-[#FF8BA7] text-lg mr-2"></i><h2 class="text-lg font-bold text-gray-700">想去地點清單</h2></div>
                    <div class="space-y-3">
                        <input type="text" id="new-spot-name" placeholder="景點名稱 (必填)" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                        <input type="text" id="new-spot-desc" placeholder="簡單附註 (選填)" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                        <input type="text" id="new-spot-link" placeholder="Google Map 連結" class="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-xl focus:border-pink-300">
                        <button type="button" onclick="document.getElementById('spot-camera-input').click()" class="flex items-center justify-center w-full gap-2 p-3 font-bold text-gray-500 bg-gray-100 rounded-xl hover:bg-gray-200 transition"><i class="fa-solid fa-camera"></i> 點我拍照或選照片</button>
                        <input type="file" id="spot-camera-input" accept="image/*" class="hidden" onchange="window.previewImage(this)">
                        <div id="photo-preview-container" class="relative hidden mt-1"><img id="photo-preview" src="" class="object-cover w-full h-40 border-2 border-gray-200 rounded-xl cursor-pointer hover:opacity-80 transition" onclick="window.open(this.src, '_blank')" title="點擊查看原圖"><button type="button" onclick="window.clearPhoto()" class="absolute flex items-center justify-center w-7 h-7 text-white bg-red-400 rounded-full shadow top-2 right-2"><i class="fa-solid fa-xmark"></i></button></div>
                        <button onclick="window.addSpot()" id="add-spot-btn" class="w-full p-3 font-bold text-white bg-[#FF8BA7] rounded-xl shadow-md hover:bg-[#FF7596] transition transform active:scale-95">新增景點</button>
                    </div>
                </div>
                <div id="spots-list" class="space-y-4"></div>
            </div>
            
        </main>
    </div>

    <!-- Modals -->
    <div id="addItineraryModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('addItineraryModal')">
        <div class="w-full max-w-sm p-6 transition-all transform bg-white shadow-2xl rounded-3xl scale-100" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-6 text-xl font-bold text-gray-700">新增行程<button onclick="window.closeModal('addItineraryModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 transition bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            <form id="add-itinerary-form" onsubmit="window.addItineraryItem(event)">
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">哪一天?</label>
                <div class="relative mb-3"><select id="new-date" class="w-full p-3 font-bold border-0 appearance-none bg-gray-50 rounded-xl text-gray-700" required></select><i class="absolute pointer-events-none fa-solid fa-chevron-down right-4 top-4 text-gray-400"></i></div>
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">幾點?</label><input type="time" id="new-time" class="w-full p-3 mb-3 text-lg font-bold text-center border-0 bg-gray-50 rounded-xl text-gray-700" required>
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">做什麼?</label><input type="text" id="new-title" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl text-gray-700" required>
                <!-- Add Link Field -->
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">地圖連結</label>
                <input type="text" id="new-link" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl text-gray-700" placeholder="貼上 Google Maps 網址">
                <!-- End Add Link Field -->
                <label class="block mb-1 ml-1 text-sm font-bold text-gray-500">備註</label><textarea id="new-note" rows="3" class="w-full p-3 mb-6 border-0 bg-gray-50 rounded-xl text-gray-700"></textarea>
                <button type="submit" class="w-full p-3 font-bold text-white transition shadow-lg bg-custom-primary rounded-2xl hover:bg-custom-primary-dark">完成</button>
            </form>
        </div>
    </div>

    <div id="editItineraryModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editItineraryModal')">
        <div class="w-full max-w-sm p-6 bg-white shadow-2xl rounded-3xl" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-2 text-xl font-bold text-gray-700">編輯行程<button onclick="window.closeModal('editItineraryModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 transition bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            <p id="edit-modal-date-info" class="inline-block px-3 py-1 mb-6 text-sm font-bold rounded-lg text-custom-primary bg-pink-50"></p>
            <form id="edit-itinerary-form" onsubmit="window.saveItineraryItem(event)">
                <input type="hidden" id="edit-date-key"><input type="hidden" id="edit-item-index">
                <input type="time" id="edit-time" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>
                <input type="text" id="edit-title" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl" required>
                <!-- Add Link Field -->
                <input type="text" id="edit-link" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl" placeholder="地圖連結">
                <!-- End Add Link Field -->
                <textarea id="edit-note" rows="3" class="w-full p-3 mb-6 border-0 bg-gray-50 rounded-xl"></textarea>
                <div class="flex space-x-3"><button type="button" onclick="window.deleteItineraryItem(document.getElementById('edit-date-key').value, document.getElementById('edit-item-index').value)" class="flex-1 p-3 font-bold text-red-400 transition bg-white border-2 border-red-100 rounded-2xl hover:bg-red-50">刪除</button><button type="submit" class="flex-[2] p-3 font-bold text-white transition shadow-lg bg-custom-primary rounded-2xl hover:bg-custom-primary-dark">儲存</button></div>
            </form>
        </div>
    </div>

    <!-- 編輯支出 Modal -->
    <div id="editExpenseModal" class="fixed inset-0 bg-black bg-opacity-30 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-[90%] max-w-md">
            <h3 class="text-lg font-bold mb-4 text-gray-700 flex items-center"><i class="fa-solid fa-pen-to-square text-custom-primary mr-2"></i> 編輯支出</h3>
            <form onsubmit="window.saveExpenseUpdate(event)">
                <input type="hidden" id="edit-expense-id">
                <label class="block mb-2 text-sm font-bold">日期</label><input type="date" id="edit-expense-date" class="w-full p-3 border rounded-xl mb-4">
                <label class="block mb-2 text-sm font-bold">金額</label><input type="number" id="edit-expense-amount" class="w-full p-3 border rounded-xl mb-4">
                <label class="block mb-2 text-sm font-bold">說明</label><input type="text" id="edit-expense-description" class="w-full p-3 border rounded-xl mb-4">
                <label class="block mb-2 text-sm font-bold">幣別</label><div id="edit-expense-currency-select" class="flex gap-2 mb-4"><button type="button" class="block-select-btn" data-currency="TWD" onclick="window.selectEditCurrency('TWD')">TWD</button><button type="button" class="block-select-btn" data-currency="JPY" onclick="window.selectEditCurrency('JPY')">JPY</button></div><input type="hidden" id="edit-expense-currency">
                <label class="block mb-2 text-sm font-bold">付款</label><div id="edit-expense-payer-select" class="flex gap-2 mb-4"><button type="button" class="block-select-btn" data-payer="Josh" onclick="window.selectEditPayer('Josh')">Josh</button><button type="button" class="block-select-btn" data-payer="Candice" onclick="window.selectEditPayer('Candice')">Candice</button></div><input type="hidden" id="edit-expense-payer">
                <label class="block mb-2 text-sm font-bold">類別</label><div id="edit-expense-category-select" class="flex flex-wrap gap-2 mb-4"><button type="button" class="block-select-btn" data-category="Food" onclick="window.selectEditCategory('Food')">餐飲</button><button type="button" class="block-select-btn" data-category="Transport" onclick="window.selectEditCategory('Transport')">交通</button><button type="button" class="block-select-btn" data-category="Accommodation" onclick="window.selectEditCategory('Accommodation')">住宿</button><button type="button" class="block-select-btn" data-category="Shopping" onclick="window.selectEditCategory('Shopping')">購物</button><button type="button" class="block-select-btn" data-category="Ticket" onclick="window.selectEditCategory('Ticket')">門票</button><button type="button" class="block-select-btn" data-category="Other" onclick="window.selectEditCategory('Other')">其他</button></div><input type="hidden" id="edit-expense-category">
                <label class="block mb-2 text-sm font-bold">方式</label><div id="edit-expense-payment-select" class="flex gap-2 mb-4"><button type="button" class="block-select-btn" data-payment="Cash" onclick="window.selectEditPayment('Cash')">現金</button><button type="button" class="block-select-btn" data-payment="Card" onclick="window.selectEditPayment('Card')">信用卡</button><button type="button" class="block-select-btn" data-payment="Paypay" onclick="window.selectEditPayment('Paypay')">Paypay</button></div><input type="hidden" id="edit-expense-payment">
                <div class="flex justify-end gap-2 mt-4"><button type="button" onclick="window.closeModal('editExpenseModal')" class="px-4 py-2 bg-gray-200 rounded">取消</button><button type="submit" class="px-4 py-2 bg-custom-primary text-white rounded">儲存</button></div>
            </form>
        </div>
    </div>

    <!-- 編輯景點 Modal -->
    <div id="editSpotModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editSpotModal')">
        <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">編輯景點<button onclick="window.closeModal('editSpotModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 transition bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            <form onsubmit="window.saveSpotUpdate(event)">
                <input type="hidden" id="edit-spot-id"><input type="hidden" id="edit-spot-old-image">
                <input type="text" id="edit-spot-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>
                <textarea id="edit-spot-desc" rows="2" class="w-full p-3 mb-3 border-0 bg-gray-50 rounded-xl"></textarea>
                <input type="text" id="edit-spot-link" class="w-full p-3 mb-4 text-sm border-0 bg-gray-50 rounded-xl">
                <div id="edit-photo-preview-container" class="relative hidden mb-3"><img id="edit-photo-preview" src="" class="object-cover w-full h-40 border border-gray-200 rounded-xl"></div>
                <button type="button" onclick="document.getElementById('edit-spot-file').click()" class="flex items-center justify-center w-full gap-2 p-2 mb-2 text-sm font-bold text-pink-500 transition border border-pink-100 bg-pink-50 rounded-xl hover:bg-pink-100"><i class="fa-solid fa-camera"></i> 更換照片</button>
                <input type="file" id="edit-spot-file" accept="image/*" class="hidden" onchange="window.previewEditImage(this)">
                <button type="submit" id="save-spot-btn" class="w-full p-3 mt-4 font-bold text-white transition shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">儲存修改</button>
            </form>
        </div>
    </div>

    <!-- 編輯慾望清單 Modal -->
    <div id="editWishlistModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editWishlistModal')">
        <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700">編輯物品<button onclick="window.closeModal('editWishlistModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 transition bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            
            <form onsubmit="window.saveWishlistUpdate(event)">
                <input type="hidden" id="edit-wishlist-id">
                <input type="hidden" id="edit-wishlist-old-image">

                <label class="block mb-1 text-sm font-bold text-gray-500">名稱</label>
                <input type="text" id="edit-wishlist-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>

                <label class="block mb-1 text-sm font-bold text-gray-500">價格 (JPY)</label>
                <input type="number" id="edit-wishlist-price" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>

                <label class="block mb-1 text-sm font-bold text-gray-500">分類</label>
                <div class="relative mb-3">
                    <select id="edit-wishlist-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl">
                        <option value="伴手禮">🎁 伴手禮</option>
                        <option value="電器">⚡ 電器</option>
                        <option value="3C">📱 3C</option>
                        <option value="服飾">👕 服飾</option>
                        <option value="藥妝">💊 藥妝</option>
                        <option value="其他">✨ 其他</option>
                    </select>
                    <i class="absolute top-4 right-4 text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i>
                </div>

                <div id="edit-wishlist-preview-container" class="relative hidden mb-3">
                    <p class="mb-1 text-xs text-gray-400">目前圖片：</p>
                    <img id="edit-wishlist-preview" src="" class="object-cover w-full h-40 border border-gray-200 rounded-xl">
                </div>

                <button type="button" onclick="document.getElementById('edit-wishlist-file').click()" class="flex items-center justify-center w-full gap-2 p-2 mb-2 text-sm font-bold text-pink-500 transition border border-pink-100 bg-pink-50 rounded-xl hover:bg-pink-100">
                    <i class="fa-solid fa-camera"></i> 更換照片
                </button>
                <input type="file" id="edit-wishlist-file" accept="image/*" class="hidden" onchange="window.previewEditWishlistImage(this)">

                <button type="submit" id="save-wishlist-btn" class="w-full p-3 mt-4 font-bold text-white transition shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">儲存修改</button>
            </form>
        </div>
    </div>

    <!-- 新增：編輯行李清單 Modal -->
    <div id="editPackingModal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-gray-900/60 backdrop-blur-sm" onclick="window.closeModal('editPackingModal')">
        <div class="w-full max-w-sm p-6 overflow-y-auto bg-white shadow-2xl rounded-3xl max-h-[90vh]" onclick="event.stopPropagation()">
            <h3 class="flex items-center justify-between mb-4 text-xl font-bold text-gray-700"><i class="mr-2 fa-solid fa-pen-to-square text-custom-secondary"></i> 編輯行李項目<button onclick="window.closeModal('editPackingModal')" class="flex items-center justify-center w-8 h-8 text-gray-400 transition bg-gray-100 rounded-full hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button></h3>
            
            <form onsubmit="window.savePackingUpdate(event)">
                <input type="hidden" id="edit-packing-id">

                <label class="block mb-1 text-sm font-bold text-gray-500">物品名稱</label>
                <input type="text" id="edit-packing-name" class="w-full p-3 mb-3 font-bold border-0 bg-gray-50 rounded-xl" required>

                <label class="block mb-1 text-sm font-bold text-gray-500">分類</label>
                <div class="relative mb-3">
                    <select id="edit-packing-category" class="w-full p-3 border-0 appearance-none bg-gray-50 rounded-xl">
                        <option value="證件">🪪 證件</option>
                        <option value="衣物">👕 衣物</option>
                        <option value="電子">📱 3C</option>
                        <option value="藥品">💊 藥品</option>
                        <option value="盥洗">🚿 盥洗</option>
                        <option value="其他">🧩 其他</option>
                    </select>
                    <i class="absolute top-4 right-4 text-gray-400 fa-solid fa-chevron-down pointer-events-none"></i>
                </div>

                <button type="submit" id="save-packing-btn" class="w-full p-3 mt-4 font-bold text-white transition shadow-lg bg-custom-secondary rounded-2xl hover:opacity-90">儲存修改</button>
            </form>
        </div>
    </div>
</body>
</html>幫我新增行程的時候可以多一個連結的欄位嗎 行程卡上面會出現地圖的按鈕